{% extends "base.html" %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container stats-container">
    <h2 style="display: flex; align-items: center; justify-content: center; gap: 15px;">
        Tautulli Server Statistics
        {% if tautulli_active %}
            <span class="status-badge pulse-live" title="Live connection to Tautulli confirmed">üìä</span>
        {% endif %}
    </h2>
    <h1 class="stats-title-large">üìä Watch Statistics</h1>

    {% if has_tautulli %}
    <div class="card">
        
        <div class="stats-header-card">
            <h3 style="color: var(--accent-color); margin: 0; display: flex; align-items: center; gap: 10px;">
                <span>üìà</span> Server Trends
            </h3>
            
            <div class="stats-toggle-group">
                <button id="btn-count" onclick="toggleStats(0)" class="btn btn-primary" style="padding: 6px 15px; font-size: 0.9em;">Plays</button>
                <button id="btn-time" onclick="toggleStats(1)" class="btn btn-secondary" style="padding: 6px 15px; font-size: 0.9em;">Duration</button>
                
                <div class="stats-divider"></div>
                
                <span class="text-muted" style="font-size: 0.9em;">Last</span>
                <input type="number" id="days-input" class="days-input" value="30">
                <span class="text-muted" style="font-size: 0.9em; margin-right: 5px;">days</span>
                
                <button onclick="loadTautulli()" class="btn btn-secondary" style="padding: 6px 15px; font-size: 0.9em; color: white; border-color: #3498db; background: rgba(52, 152, 219, 0.2);">‚Üª Update</button>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card">
                <h4 class="chart-title">LIBRARIES BY ACTIVITY</h4>
                <canvas id="libraryChart" height="200"></canvas>
            </div>
            <div class="chart-card">
                <h4 class="chart-title">TOP USERS</h4>
                <canvas id="userChart" height="200"></canvas>
            </div>
        </div>

        <div id="tautulli-grid" class="tautulli-list-grid">
            <div style="grid-column: 1 / -1; padding: 60px; color: #777; font-style: italic; text-align: center;">
                Connecting to Tautulli...
            </div>
        </div>
    </div>
    {% else %}
    <div class="empty-state-box">
        <div class="empty-icon">üîå</div>
        <h3 style="color: #fff;">Tautulli is Not Connected</h3>
        <p class="empty-text">
            Connect your Tautulli server to view watch statistics, user trends, and library usage data directly in this dashboard.
        </p>
        <a href="{{ url_for('settings') }}">
            <button class="btn btn-primary">Go to Settings & Configure</button>
        </a>
    </div>
    {% endif %}

</div>

<script>
let currentStatType = 0; 
let libraryChart, userChart;

function toggleStats(type) {
    currentStatType = type;
    const btnCount = document.getElementById('btn-count');
    const btnTime = document.getElementById('btn-time');

    if (type === 0) {
        btnCount.className = "btn btn-primary";
        btnTime.className = "btn btn-secondary";
    } else {
        btnCount.className = "btn btn-secondary";
        btnTime.className = "btn btn-primary";
    }
    // Re-apply small padding utility if needed, or rely on CSS
    btnCount.style.padding = "6px 15px"; btnCount.style.fontSize = "0.9em";
    btnTime.style.padding = "6px 15px"; btnTime.style.fontSize = "0.9em";

    loadTautulli();
}

async function loadTautulli() {
    const days = document.getElementById('days-input').value;
    const grid = document.getElementById('tautulli-grid');
    grid.style.opacity = '0.5';
    
    try {
        const response = await fetch(`/api/tautulli_data?days=${days}&type=${currentStatType}`);
        const data = await response.json();
        
        grid.style.opacity = '1';
        
        if(data.error) {
            grid.innerHTML = `<div style="grid-column: 1 / -1; color: var(--error); padding: 20px; text-align: center;">Error: ${data.error}</div>`;
            return;
        }
        
        grid.innerHTML = '';
        renderCharts(data);

        data.forEach(panel => {
            const panelTitle = panel.stat_title || panel.title || 'Unknown Stats';
            if (!panel.rows || panel.rows.length === 0) return;

            let rows = '';
            panel.rows.forEach((row, index) => {
                const smartData = getSmartData(panel.stat_id, row);
                // Using inline flex for the generated rows to maintain specific alignment logic
                rows += `
                <div style="display:flex; justify-content:space-between; padding: 8px 0; border-bottom: 1px solid #333; font-size: 0.95em;">
                    <div style="display:flex; gap: 10px; align-items: center; max-width: 70%;">
                        <span style="color: #666; font-size: 0.8em; width: 20px;">${index + 1}</span>
                        <span style="color: #eee; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${smartData.label}">${smartData.label}</span>
                    </div>
                    <span style="color: var(--accent-color); font-weight:bold; font-size: 0.9em;">${smartData.value}</span>
                </div>`;
            });

            grid.innerHTML += `
            <div class="chart-card" style="padding: 0; display: flex; flex-direction: column;">
                <div style="background: rgba(255,255,255,0.05); padding: 12px 15px; border-bottom: 1px solid #333; display: flex; align-items: center; gap: 8px;">
                    <span style="color: var(--accent-color);">‚óè</span> 
                    <span style="font-weight: 600; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px; color: #ddd;">${panelTitle}</span>
                </div>
                <div style="padding: 15px;">${rows}</div>
            </div>`;
        });
    } catch (e) { console.error(e); }
}

function renderCharts(data) {
    const libPanel = data.find(p => p.rows && p.rows.some(r => r.section_name));
    const userPanel = data.find(p => p.stat_id === 'top_users');
    
    const libData = libPanel ? libPanel.rows : [];
    const userData = userPanel ? userPanel.rows : [];

    if (libraryChart) libraryChart.destroy();
    if (userChart) userChart.destroy();

    const commonOptions = { 
        plugins: { legend: { position: 'bottom', labels: { color: '#aaa' } } } 
    };

    libraryChart = new Chart(document.getElementById('libraryChart'), {
        type: 'doughnut',
        data: {
            labels: libData.map(r => r.section_name || "Unknown"),
            datasets: [{
                data: libData.map(r => currentStatType === 1 ? (r.total_duration / 3600) : r.total_plays),
                backgroundColor: ['#e5a00d', '#01d277', '#3498db', '#e74c3c'],
                borderWidth: 0
            }]
        },
        options: commonOptions
    });

    userChart = new Chart(document.getElementById('userChart'), {
        type: 'bar',
        data: {
            labels: userData.map(r => r.user || "User"),
            datasets: [{
                label: currentStatType === 1 ? 'Hours' : 'Plays',
                data: userData.map(r => currentStatType === 1 ? (r.total_duration / 3600).toFixed(1) : r.total_plays),
                backgroundColor: '#e5a00d'
            }]
        },
        options: { 
            scales: { 
                y: { ticks: { color: '#aaa' }, grid: { color: '#333' } },
                x: { ticks: { color: '#aaa' }, grid: { display: false } }
            },
            plugins: { legend: { display: false } }
        }
    });
}

function getSmartData(statId, row) {
    let label = 'Unknown';
    
    // Label Logic
    if (row.section_name) label = row.section_name;
    else if (row.user || row.friendly_name) label = row.user || row.friendly_name;
    else if (row.platform) label = row.platform;
    else label = row.title || row.name || 'Item';
    
    // Value Logic
    if (statId.includes('concurrent')) {
        const count = row.count || row.total_plays || 0;
        return { label: label, value: count + (count === 1 ? " Stream" : " Streams") };
    }

    if (statId === 'recent_plays' || (!row.total_plays && !row.count && row.user)) {
        return { label: label, value: row.user || row.friendly_name || 'User' };
    }

    if (statId && statId.includes('popular')) {
        return { label: label, value: (row.users_watched || 0) + " Users" };
    }

    let val = 0;
    if (currentStatType === 1) { // Duration Mode
        if (row.total_duration && row.total_duration > 0) {
            val = formatTime(row.total_duration);
        } else {
            val = row.total_plays || row.count || 0;
        }
    } else { // Play Count Mode
        val = row.total_plays || row.count || 0;
    }
    
    return { label: label, value: val };
}

function formatTime(seconds) {
    if (!seconds) return "0m";
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    return h > 0 ? `${h}h ${m}m` : `${m}m`;
}

window.onload = loadTautulli;
</script>
{% endblock %}