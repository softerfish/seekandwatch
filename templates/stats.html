{% extends "base.html" %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container" style="max-width: 1200px; margin-top: 30px; text-align: center;">
    <h2 style="display: flex; align-items: center; justify-content: center; gap: 15px;">
        Tautulli Server Statistics
        {% if tautulli_active %}
            <span class="status-badge pulse-live" title="Live connection to Tautulli confirmed">üìä</span>
        {% endif %}
    </h2>
    <h1 class="mb-4" style="font-weight: 800; font-size: 2.5em;">üìä Watch Statistics</h1>

    {% if has_tautulli %}
    <div class="card shadow mb-5" style="padding: 20px; background: #1a1a1a; border: 1px solid var(--border-color);">
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px; border-bottom: 1px solid #333; padding-bottom: 15px;">
            <h3 style="color: var(--accent-color); margin: 0; display: flex; align-items: center; gap: 10px;">
                <span>üìà</span> Server Trends
            </h3>
            
            <div style="display: flex; gap: 10px; align-items: center; background: #252525; padding: 5px; border-radius: 8px; border: 1px solid #333;">
                <button id="btn-count" onclick="toggleStats(0)" style="padding: 8px 15px; background: var(--accent-color); color: black; font-weight: bold; border: none; border-radius: 4px;">Plays</button>
                <button id="btn-time" onclick="toggleStats(1)" style="padding: 8px 15px; background: transparent; color: #aaa; border: none; border-radius: 4px;">Duration</button>
                
                <div style="width: 1px; height: 20px; background: #444; margin: 0 5px;"></div>
                
                <span style="color: #aaa; font-size: 0.9em;">Last</span>
                <input type="number" id="days-input" value="30" style="width: 60px; padding: 5px; text-align: center; background: #111; border: 1px solid #444; color: white; border-radius: 4px;">
                <span style="color: #aaa; font-size: 0.9em; margin-right: 5px;">days</span>
                
                <button onclick="loadTautulli()" style="background: #3498db; color: white; padding: 8px 15px;">‚Üª Update</button>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div style="background: #252525; padding: 15px; border-radius: 8px; border: 1px solid #333;">
                <h4 style="margin-top:0; font-size: 0.9em; color: #888;">LIBRARIES BY ACTIVITY</h4>
                <canvas id="libraryChart" height="200"></canvas>
            </div>
            <div style="background: #252525; padding: 15px; border-radius: 8px; border: 1px solid #333;">
                <h4 style="margin-top:0; font-size: 0.9em; color: #888;">TOP USERS</h4>
                <canvas id="userChart" height="200"></canvas>
            </div>
        </div>

        <div id="tautulli-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
            <div style="grid-column: 1 / -1; padding: 60px; color: #777; font-style: italic;">
                Connecting to Tautulli...
            </div>
        </div>
    </div>
    {% else %}
    {% endif %}

</div>

<script>
let currentStatType = 0; 
let libraryChart, userChart;

function toggleStats(type) {
    currentStatType = type;
    const active = "background: var(--accent-color); color: black; font-weight: bold; border: none; border-radius: 4px;";
    const inactive = "background: transparent; color: #aaa; font-weight: normal; border: none; border-radius: 4px;";
    document.getElementById('btn-count').style.cssText = type === 0 ? active : inactive;
    document.getElementById('btn-time').style.cssText = type === 1 ? active : inactive;
    loadTautulli();
}

async function loadTautulli() {
    const days = document.getElementById('days-input').value;
    const grid = document.getElementById('tautulli-grid');
    grid.style.opacity = '0.5';
    
    try {
        const response = await fetch(`/api/tautulli_data?days=${days}&type=${currentStatType}`);
        const data = await response.json();
        
        console.log("Full Tautulli Data received:", data); // Check your browser console to see field names
        grid.style.opacity = '1';
        
        if(data.error) {
            grid.innerHTML = `<div style="grid-column: 1 / -1; color: #e74c3c; padding: 20px;">Error: ${data.error}</div>`;
            return;
        }
        
        grid.innerHTML = '';
        renderCharts(data);

        data.forEach(panel => {
            const panelTitle = panel.stat_title || panel.title || 'Unknown Stats';
            if (!panel.rows || panel.rows.length === 0) return;

            let rows = '';
            panel.rows.forEach((row, index) => {
                const smartData = getSmartData(panel.stat_id, row);
                rows += `
                <div style="display:flex; justify-content:space-between; padding: 8px 0; border-bottom: 1px solid #333; font-size: 0.95em;">
                    <div style="display:flex; gap: 10px; align-items: center; max-width: 70%;">
                        <span style="color: #555; font-size: 0.8em; width: 20px;">${index + 1}</span>
                        <span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${smartData.label}">${smartData.label}</span>
                    </div>
                    <span style="color: var(--accent-color); font-weight:bold; font-size: 0.9em;">${smartData.value}</span>
                </div>`;
            });

            grid.innerHTML += `
            <div style="background: #252525; border-radius: 8px; border: 1px solid #333; overflow: hidden; display: flex; flex-direction: column;">
                <div style="background: #303030; padding: 12px 15px; border-bottom: 1px solid #333; display: flex; align-items: center; gap: 8px;">
                    <span style="color: var(--accent-color);">‚óè</span> 
                    <span style="font-weight: 600; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px; color: #ddd;">${panelTitle}</span>
                </div>
                <div style="padding: 15px;">${rows}</div>
            </div>`;
        });
    } catch (e) { console.error(e); }
}

function renderCharts(data) {
    // We filter for rows that have section_name to populate the library chart
    const libPanel = data.find(p => p.rows && p.rows.some(r => r.section_name));
    const userPanel = data.find(p => p.stat_id === 'top_users');
    
    const libData = libPanel ? libPanel.rows : [];
    const userData = userPanel ? userPanel.rows : [];

    if (libraryChart) libraryChart.destroy();
    if (userChart) userChart.destroy();

    libraryChart = new Chart(document.getElementById('libraryChart'), {
        type: 'doughnut',
        data: {
            labels: libData.map(r => r.section_name || "Unknown"),
            datasets: [{
                data: libData.map(r => currentStatType === 1 ? (r.total_duration / 3600) : r.total_plays),
                backgroundColor: ['#e5a00d', '#01d277', '#3498db', '#e74c3c'],
                borderWidth: 0
            }]
        },
        options: { plugins: { legend: { position: 'bottom', labels: { color: '#aaa' } } } }
    });

    userChart = new Chart(document.getElementById('userChart'), {
        type: 'bar',
        data: {
            labels: userData.map(r => r.user || "User"),
            datasets: [{
                label: currentStatType === 1 ? 'Hours' : 'Plays',
                data: userData.map(r => currentStatType === 1 ? (r.total_duration / 3600).toFixed(1) : r.total_plays),
                backgroundColor: '#e5a00d'
            }]
        },
        options: { 
            scales: { 
                y: { ticks: { color: '#aaa' }, grid: { color: '#333' } },
                x: { ticks: { color: '#aaa' }, grid: { display: false } }
            },
            plugins: { legend: { display: false } }
        }
    });
}

function getSmartData(statId, row) {
    let label = 'Unknown';
    
    // 1. Label Logic: Prioritize section_name for libraries
    if (row.section_name) {
        label = row.section_name;
    } 
    else if (row.user || row.friendly_name) {
        label = row.user || row.friendly_name;
    }
    else if (row.platform) {
        label = row.platform;
    }
    else {
        label = row.title || row.name || 'Item';
    }
    
    // 2. Value Logic
    
    // FIX: Concurrent Streams ignore Duration mode because they are "Live" counts
    if (statId.includes('concurrent')) {
        const count = row.count || row.total_plays || 0;
        return { 
            label: label, 
            value: count + (count === 1 ? " Stream" : " Streams") 
        };
    }

    // Special Case: Recently Watched (Timeline)
    if (statId === 'recent_plays' || (!row.total_plays && !row.count && row.user)) {
        return { label: label, value: row.user || row.friendly_name || 'User' };
    }

    // Special Case: Most Popular (Unique User Count)
    if (statId && statId.includes('popular')) {
        return { label: label, value: (row.users_watched || 0) + " Users" };
    }

    // Standard Logic: Duration vs Plays
    let val = 0;
    if (currentStatType === 1) { // Duration Mode
        // If duration exists, format it. If not (like on Concurrent cards), show the count.
        if (row.total_duration && row.total_duration > 0) {
            val = formatTime(row.total_duration);
        } else {
            val = row.total_plays || row.count || 0;
        }
    } else { // Play Count Mode
        val = row.total_plays || row.count || 0;
    }
    
    return { label: label, value: val };
}

function formatTime(seconds) {
    if (!seconds) return "0m";
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    return h > 0 ? `${h}h ${m}m` : `${m}m`;
}

window.onload = loadTautulli;
</script>
{% endblock %}