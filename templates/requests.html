{% extends "base.html" %}

{% block content %}
<style>
    /* 1. Fix Key Icon Alignment and Color */
    .input-group-text {
        background-color: #2a2a2a; /* Dark background */
        border-color: #444;       /* Dark border */
        color: #fff;              /* White Icon */
        display: flex;
        align-items: center;      /* Vertically align icon */
    }

    /* 2. Fix Input Field to match dark theme */
    #cloudApiKey {
        background-color: #1e1e1e;
        border-color: #444;
        color: #fff;
    }
    
    /* 3. Ensure Warning Badge text is readable (Black on Yellow) */
    .badge-warning {
        color: #212529 !important; 
    }

    /* Pending Queue: Type badge text black for readability */
    .pending-queue-type { color: #000 !important; }
    /* Push action buttons 30% to the right within the column */
    .pending-queue-actions { margin-left: 30%; }

    /* Promo dropdown */
    #seekandwatch-promo .card-header {
        cursor: pointer;
        user-select: none;
    }
    #seekandwatch-promo .card-header .btn-close-promo {
        cursor: pointer;
        opacity: 0.8;
    }
    #seekandwatch-promo .card-header .btn-close-promo:hover {
        opacity: 1;
    }
</style>

<div class="container mt-4">
    <!-- Promotional overview: default open, once closed stays closed (localStorage) -->
    <div id="seekandwatch-promo" class="card mb-4 border-info" style="display: none;">
        <div class="card-header bg-info text-dark d-flex justify-content-between align-items-center py-2">
            <span class="font-weight-bold"><i class="fas fa-info-circle mr-1"></i> What is SeekAndWatch?</span>
            <button type="button" class="btn btn-sm btn-outline-dark btn-close-promo" id="promo-dismiss" title="Close and don't show again" aria-label="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="card-body bg-dark text-white">
            <p class="mb-2"><strong>SeekAndWatch</strong> (<a href="https://seekandwatch.com" target="_blank" rel="noopener" class="text-info">seekandwatch.com</a>) lets your friends and family <strong>request movies and TV shows</strong> from your Plex server without needing access to Plex or Radarr/Sonarr. You stay in control: requests land here for you to approve or deny, then get sent to Radarr, Sonarr, or Overseerr.</p>
            <p class="mb-2"><strong>How it works:</strong> Users sign up on SeekAndWatch, add your server with a connection key, and browse or search for titles. When they request something, it appears in this queue. You approve or deny; approved items are sent to your chosen handler (Radarr, Sonarr, or Overseerr/Jellyseerr).</p>
            <p class="mb-2"><strong>Why it's safe:</strong> Your Plex URL and tokens stay on your machine. The cloud service only relays requests and connection keys; it does not store your media or control your server. You can revoke keys and turn off automation at any time.</p>
            <p class="mb-2"><strong>Why use it:</strong> Give requesters a simple, familiar way to ask for content without exposing Radarr/Sonarr or teaching them Plex requests. One place to manage all incoming requests and automation.</p>
            <p class="mb-0">
                <span class="badge badge-warning text-dark">Beta</span> SeekAndWatch is currently in <strong>beta</strong>. To request access, go to <a href="https://www.reddit.com/r/SeekAndWatch/" target="_blank" rel="noopener" class="text-info font-weight-bold">r/SeekAndWatch</a> and either <strong>post for access</strong> or <strong>send a mod a PM</strong>.
            </p>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Cloud Requests Management</h2>
        <div class="d-flex gap-2">
            <a href="{{ url_for('requests_page') }}" class="btn btn-outline-primary" title="Fetch latest from cloud"><i class="fas fa-sync-alt"></i> Refresh</a>
            <a href="{{ url_for('requests_settings_page') }}" class="btn btn-secondary"><i class="fas fa-cog"></i> Requests Settings</a>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-dark">Pending Queue</h5>
            <span class="badge badge-info">{{ requests|length }} Pending</span>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-striped mb-0">
                    <thead class="thead-dark">
                        <tr>
                            <th scope="col" style="width: 40%;">Title</th>
                            <th scope="col">Type</th>
                            <th scope="col">Requested By</th>
                            <th scope="col" class="text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for req in requests %}
                        <tr>
                            <td class="align-middle">
                                <strong>{{ req.title }}{% if req.year %} ({{ req.year }}){% endif %}</strong>
                                <br>
                                <small class="text-muted">
                                    <a href="https://www.themoviedb.org/{{ req.media_type }}/{{ req.tmdb_id }}" target="_blank" rel="noopener" class="text-info">TMDB</a>
                                    &middot;
                                    <a href="https://www.themoviedb.org/{{ req.media_type }}/{{ req.tmdb_id }}/videos" target="_blank" rel="noopener" class="text-info">Trailer</a>
                                    &middot; ID: {{ req.tmdb_id }}
                                </small>
                            </td>
                            <td class="align-middle">
                                {% if req.media_type == 'movie' %}
                                    <span class="badge badge-primary pending-queue-type">Movie</span>
                                {% else %}
                                    <span class="badge badge-warning pending-queue-type">TV Show</span>
                                {% endif %}
                            </td>
                            <td class="align-middle">
                                <span class="req-by-name">{{ (req.requested_by or 'Requester').split()|first }}</span>
                                <br>
                                <small class="text-muted">{{ req.created_at.strftime('%b %d, %Y %H:%M') }}</small>
                            </td>
                            <td class="align-middle text-right">
                                <div class="d-flex flex-wrap gap-1 align-items-center justify-content-end pending-queue-actions">
                                    <form action="/approve_request/{{ req.id }}" method="POST" class="d-inline m-0">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="btn btn-success btn-sm" title="Approve & Download"><i class="fas fa-check"></i> Approve</button>
                                    </form>
                                    <form action="/deny_request/{{ req.id }}" method="POST" class="d-inline m-0">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="btn btn-danger btn-sm" title="Deny" onclick="return confirm('Deny this request?');"><i class="fas fa-times"></i> Deny</button>
                                    </form>
                                    <form action="/delete_request/{{ req.id }}" method="POST" class="d-inline m-0">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="btn btn-secondary btn-sm" title="Delete from list" onclick="return confirm('Remove from list?');"><i class="fas fa-trash"></i></button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="text-center py-5">
                                <h4 class="text-muted">No pending requests</h4>
                                <p class="text-muted">Your friends haven't requested anything yet.</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    var STORAGE_KEY = 'seekandwatch_promo_dismissed';
    var promo = document.getElementById('seekandwatch-promo');
    var dismissBtn = document.getElementById('promo-dismiss');

    function isDismissed() {
        try {
            return localStorage.getItem(STORAGE_KEY) === 'true';
        } catch (e) {
            return false;
        }
    }

    function setDismissed() {
        try {
            localStorage.setItem(STORAGE_KEY, 'true');
        } catch (e) {}
        if (promo) promo.style.display = 'none';
    }

    if (promo) {
        if (isDismissed()) {
            promo.style.display = 'none';
        } else {
            promo.style.display = 'block';
        }
    }

    if (dismissBtn) {
        dismissBtn.addEventListener('click', function(e) {
            e.preventDefault();
            setDismissed();
        });
    }
})();
</script>
{% endblock %}