{% extends "base.html" %}
{% block page_title %}Reset Password{% endblock %}
{% block content %}
<div class="login-wrapper">
    <div class="login-card">
        <h3 class="auth-heading">Reset password with recovery code</h3>
        <p class="text-muted" style="margin-bottom:1rem;">Enter your username, one recovery code, and a new password.</p>
        <div class="auth-body">
            <form id="reset-form" onsubmit="return submitReset(event)">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" name="username" id="reset-username" required placeholder="Your username" autocomplete="username">
                </div>
                <div class="form-group">
                    <label>Recovery code</label>
                    <input type="text" name="code" id="reset-code" required placeholder="Paste one code (e.g. a1b2c3d4e5f6g7h8)" autocomplete="off" style="font-family:monospace;">
                </div>
                <div class="form-group">
                    <label>New password</label>
                    <input type="password" name="new_password" id="reset-new-password" required placeholder="At least 8 characters" autocomplete="new-password" minlength="8">
                </div>
                <div class="form-group">
                    <label>Confirm new password</label>
                    <input type="password" name="confirm_password" id="reset-confirm" required placeholder="Same again" autocomplete="new-password" minlength="8">
                </div>
                <button type="submit" class="login-btn" id="reset-submit">Set new password</button>
            </form>
            <div class="auth-footer" style="margin-top:1rem;">
                <a href="{{ url_for('login') }}">Back to log in</a>
            </div>
        </div>
    </div>
</div>
<script>
const API_USE_RECOVERY = "{{ url_for('api.use_recovery_code') }}";
const CSRF_TOKEN = "{{ csrf_token() }}";
const LOGIN_URL = "{{ url_for('login') }}";

function submitReset(e) {
    e.preventDefault();
    const username = document.getElementById('reset-username').value.trim();
    const code = document.getElementById('reset-code').value.trim().replace(/\s/g, '');
    const newPassword = document.getElementById('reset-new-password').value;
    const confirmPassword = document.getElementById('reset-confirm').value;
    if (newPassword !== confirmPassword) {
        alert('Passwords do not match.');
        return false;
    }
    if (newPassword.length < 8) {
        alert('Password must be at least 8 characters.');
        return false;
    }
    const btn = document.getElementById('reset-submit');
    btn.disabled = true;
    btn.textContent = 'Updating...';
    fetch(API_USE_RECOVERY, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
        body: JSON.stringify({ username: username, code: code, new_password: newPassword })
    })
    .then(r => r.json())
    .then(d => {
        if (d.status === 'success') {
            window.location.href = LOGIN_URL + '?recovery=success';
        } else {
            alert(d.message || 'Something went wrong.');
            btn.disabled = false;
            btn.textContent = 'Set new password';
        }
    })
    .catch(() => {
        alert('Request failed. Try again.');
        btn.disabled = false;
        btn.textContent = 'Set new password';
    });
    return false;
}
</script>
{% endblock %}
