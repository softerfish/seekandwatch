{% extends "base.html" %}

{% block content %}

<div class="results-header">
    <a href="{{ url_for('dashboard') }}" class="back-link">‚Üê Back to Dashboard</a>
    <h2 style="margin:0;">‚ú® Top Picks For You</h2>
    <button class="btn btn-primary" onclick="spinWheel()">üé° Spin Wheel</button>
</div>

<div class="results-container">
    
    <div class="filter-sidebar">
        <h3 style="margin-top:0; border-bottom:1px solid #444; padding-bottom:10px;">Refine Results</h3>
        
        <div class="filter-group">
            <label class="filter-label">Genre</label>
            <select id="filter-genre" class="filter-input" onchange="updateFilters()">
                <option value="all">All Genres</option>
                {% for g in genres %}
                <option value="{{ g.id }}" {% if current_genre|string == g.id|string %}selected{% endif %}>{{ g.name }}</option>
                {% endfor %}
            </select>
            <p class="helper-text" style="font-size:0.8em; margin-top:5px;">‚ö†Ô∏è Changing genre fetches NEW results.</p>
        </div>

        <div class="filter-group">
            <label class="filter-label">Released After (Year)</label>
            <input type="number" id="filter-year" class="filter-input" placeholder="e.g. 1990" 
                   value="{{ min_year if min_year > 0 else '' }}" 
                   onkeyup="filterVisibleCards()">
        </div>

        <div class="filter-group">
            <label class="filter-label">Min. Rating: <span id="rating-val">{{ min_rating }}</span>/10</label>
            <input type="range" id="filter-rating" min="0" max="10" step="0.5" 
                   value="{{ min_rating }}" style="width:100%;" 
                   oninput="document.getElementById('rating-val').innerText=this.value; filterVisibleCards();">
        </div>

		<div class="filter-group" style="position:relative;">
            <label class="filter-label" title="Search specific TMDB tags (e.g. 'zombies', 'time travel').">
                TMDB Keywords <span style="font-size: 0.8em; color: #888; font-weight: normal;">(Not Genres)</span>
            </label>
            <div style="font-size: 0.7em; color: #aaa; margin-top: -5px; margin-bottom: 5px;">
                <i>Searches tags & description only.</i>
            </div>
            <input type="text" id="keyword-search" class="filter-input" placeholder="Filter tags..." autocomplete="off">
            <div id="keyword-results" class="keyword-dropdown"></div>
            <div id="selected-keywords" class="tag-container"></div>
        </div>
		
        <button class="btn btn-lucky" style="width:100%; margin-top:10px;" onclick="updateFilters()">
            üîÑ Update Results
        </button>
    </div>

    <div class="results-main">
        <div id="loading" class="loading-container">
            <div class="loader"></div>
            <h2>Crunching the numbers...</h2>
        </div>

        <div id="results-grid" class="results-grid" style="display:none;"></div>
        
        <div class="load-more-wrapper">
            <button onclick="loadMore(this)" class="load-more-btn">Load More Results</button>
        </div>
    </div>
</div>

<div id="detail-modal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <div id="modal-body" class="modal-body"></div>
    </div>
</div>

<div id="trailer-modal" class="modal" style="z-index: 1100;">
    <div class="modal-content" style="background:black; width:90%; max-width:900px; aspect-ratio:16/9; display:flex; flex-direction:column;">
        <span class="close-modal" onclick="closeTrailer()" style="color:white; z-index:20;">&times;</span>
        <div id="trailer-body" style="flex:1; width:100%; height:100%;"></div>
    </div>
</div>

<script>
let page = 1;
const useCriticFilter = "{{ use_critic_filter|lower }}"; 
const serverMovies = {{ movies|tojson|safe if movies else '[]' }};

// --- SMART TAGS ---
let selectedKeywords = [];
const initialTags = "{{ session.get('keywords', '') }}";
if (initialTags) {
    const parts = initialTags.split('|');
    parts.forEach(p => { if(p && p.trim() !== '') selectedKeywords.push({ id: p, name: p }); });
}

document.getElementById('keyword-search').addEventListener('input', function(e) {
    const q = e.target.value;
    if(q.length < 3) { document.getElementById('keyword-results').style.display = 'none'; return; }
    fetch(`/tmdb_search_proxy?type=keyword&query=${q}`).then(res => res.json()).then(data => {
        const div = document.getElementById('keyword-results'); div.innerHTML = "";
        if(data.results && data.results.length > 0) {
            data.results.forEach(k => {
                const item = document.createElement('div'); item.className = 'dropdown-item'; item.innerText = k.name;
                item.onclick = () => addTag(k); div.appendChild(item);
            });
            div.style.display = 'block';
        } else { div.style.display = 'none'; }
    });
});

function addTag(k) {
    if(selectedKeywords.some(x => x.id === k.id || x.name === k.name)) return;
    selectedKeywords.push(k); renderTags();
    document.getElementById('keyword-search').value = ""; 
    document.getElementById('keyword-results').style.display = 'none';
    filterVisibleCards();
}
function removeTag(name) { selectedKeywords = selectedKeywords.filter(k => k.name !== name); renderTags(); filterVisibleCards(); }
function renderTags() {
    const container = document.getElementById('selected-keywords'); container.innerHTML = "";
    selectedKeywords.forEach(k => {
        const tag = document.createElement('span'); tag.className = 'keyword-tag';
        tag.innerHTML = `${k.name} <span onclick="removeTag('${k.name}')">&times;</span>`; 
        container.appendChild(tag);
    });
}
function getKeywordString() { return selectedKeywords.map(k => k.name).join('|'); }

// --- INIT ---
function init() {
    if (selectedKeywords.length > 0) renderTags();
    if (serverMovies && serverMovies.length > 0) {
        document.getElementById('loading').style.display = 'none';
        const grid = document.getElementById('results-grid');
        grid.style.display = 'grid'; grid.innerHTML = '';
        serverMovies.forEach(item => { try { grid.appendChild(createCard(item)); } catch(e) {} });
        // document.querySelector('.load-more-wrapper').style.display = 'none';
        filterVisibleCards();
    } else { loadMore(null); }
}

function filterVisibleCards() {
    const minYear = parseInt(document.getElementById('filter-year').value) || 0;
    const minRating = parseFloat(document.getElementById('filter-rating').value) || 0;
    const activeTags = selectedKeywords.map(k => k.name.toLowerCase());
    document.querySelectorAll('.result-card').forEach(card => {
        const year = parseInt(card.dataset.year) || 0;
        const rating = parseFloat(card.dataset.rating) || 0;
        const text = card.innerText.toLowerCase();
        let visible = true;
        if(year < minYear) visible = false;
        if(rating < minRating) visible = false;
        if(activeTags.length > 0) {
            const hasAllTags = activeTags.every(tag => text.includes(tag));
            if(!hasAllTags) visible = false;
        }
        card.style.display = visible ? 'block' : 'none';
    });
}

function updateFilters() {
    const genre = document.getElementById('filter-genre').value;
    const year = document.getElementById('filter-year').value;
    const rating = document.getElementById('filter-rating').value;
    const tags = getKeywordString();
    document.getElementById('results-grid').innerHTML = '';
    document.getElementById('loading').style.display = 'block';
    page = 1;
    fetch('/api/update_filters', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ genre_filter: genre, min_year: year, min_rating: rating, keywords: tags })
    }).then(() => { loadMore(null); }).catch(err => {
        document.getElementById('loading').innerHTML = '<h3 style="color:red">Server Error.</h3>';
    });
}

function loadMore(btn) {
    if(btn) { 
        btn.disabled = true; 
        btn.innerText = "Scanning Deep..."; 
    }
    
    // INCREASED TIMEOUT TO 60 SECONDS
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 60000); 

    fetch(`/load_more_recs?page=${page}&critic_filter=${useCriticFilter}`, { signal: controller.signal })
        .then(r => {
            clearTimeout(timeoutId);
            return r.ok ? r.json() : Promise.reject(r.status);
        })
        .then(data => {
            document.getElementById('loading').style.display = 'none';
            const grid = document.getElementById('results-grid'); 
            grid.style.display = 'grid';
            
            if (!Array.isArray(data)) { 
                alert("Server Error: " + (data.error || "Unknown")); 
                return; 
            }
            
            if (data.length === 0 && page === 1) {
                grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:50px; color:#777;">No matches found for these filters.</div>';
            } else {
                data.forEach(item => { try { grid.appendChild(createCard(item)); } catch(e){} });
                page++; 
                filterVisibleCards();
            }
            
            if(btn) { 
                btn.disabled = false; 
                btn.innerText = "Load More Results"; 
            }
        })
        .catch(err => {
            clearTimeout(timeoutId);
            document.getElementById('loading').style.display = 'none';
            
            // TIMEOUT FALLBACK UI
            if (!btn) {
                const grid = document.getElementById('results-grid');
                grid.style.display = 'grid';
                grid.innerHTML = `
                    <div style="grid-column:1/-1; text-align:center; padding:40px;">
                        <h3>‚ö†Ô∏è Still Working...</h3>
                        <p style="color:#aaa;">This first scan is taking a while to download tags.</p>
                        <button onclick="loadMore(this)" class="btn-primary" style="padding:10px 20px; margin-top:10px;">Show Results Now</button>
                    </div>
                `;
            } else {
                btn.innerText = "Timeout - Try Again";
                btn.disabled = false;
            }
        });
}

// --- CARD CREATION ---
function createCard(item) {
    const id = item.tmdb_id || item.id;
    const title = item.title || item.name || "Unknown";
    const rawDate = item.date || item.year || item.first_air_date || item.release_date || "";
    const dateStr = String(rawDate);
    const displayDate = dateStr.length >= 4 ? dateStr.substring(0, 4) : 'N/A';
    const rating = item.rating || item.vote_average || 0;
    const rtScore = item.rt_score || 0; // <--- Get RT Score
    const mediaType = item.media_type || 'movie'; 
    
    const card = document.createElement('div');
    card.className = 'result-card';
    card.dataset.year = parseInt(displayDate) || 0;
    card.dataset.rating = rating;
    
    const posterUrl = item.poster_path ? `https://image.tmdb.org/t/p/w500${item.poster_path}` : 'https://placehold.co/500x750/222/888?text=No+Poster';
    const searchableText = `<span style="display:none;">${title} ${item.overview || ''}</span>`;

    // --- BUILD BADGES HTML ---
    let badgesHtml = '<div class="poster-badges">';
    
    // 1. TMDB Badge
    if (rating > 0) {
        badgesHtml += `
            <div class="badge-item badge-tmdb" title="TMDB User Score">
                <span>‚≠ê</span> ${parseFloat(rating).toFixed(1)}
            </div>`;
    }

    // 2. Rotten Tomatoes Badge
    if (rtScore > 0) {
        const rtClass = rtScore >= 60 ? 'badge-rt-fresh' : 'badge-rt-rotten';
        const rtIcon = rtScore >= 60 ? 'üçÖ' : 'ü§¢';
        badgesHtml += `
            <div class="badge-item ${rtClass}" title="Rotten Tomatoes">
                <span>${rtIcon}</span> ${rtScore}%
            </div>`;
    }
    badgesHtml += '</div>';
    // -------------------------

    card.innerHTML = `
        <div class="poster-wrapper">
            ${badgesHtml} <img src="${posterUrl}" loading="lazy">
            <div class="card-icon-overlay">
                
                <div class="card-icon-group">
                    <div class="icon-btn btn-request" title="Request on Overseerr" onclick="requestMedia('${mediaType}', ${id}, this); event.stopPropagation();">üì•</div>
                    <div class="icon-btn" title="Watch Trailer" onclick="playTrailer(${id}, '${mediaType}'); event.stopPropagation();">‚ñ∂Ô∏è</div>
                </div>
                
                <div class="card-icon-group">
                    <a href="https://www.themoviedb.org/${mediaType}/${id}" target="_blank" class="icon-btn" title="TMDB" onclick="event.stopPropagation();" style="font-size:0.7em; font-weight:900;">T</a>
                    <div class="icon-btn" title="View Details" onclick="openModal(${id}, '${mediaType}'); event.stopPropagation();">üëÅÔ∏è</div>
                </div>

            </div>
        </div>
        <div class="card-info">
            <div class="movie-title">${title}</div>
            <div class="movie-meta"><span>${displayDate}</span><span style="color:var(--accent-color);">‚òÖ ${Math.round(rating*10)/10}</span></div>
            ${searchableText}
        </div>
    `;
    return card;
}

function requestMedia(type, id, btn) {
    if(!confirm("Send request to Overseerr?")) return;
    btn.style.background = "#e67e22"; 
    fetch('/request_media', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body:JSON.stringify({media_type:type, tmdb_id:id})
    }).then(r=>r.json()).then(d=>{
        if(d.status === 'success') { btn.innerHTML = "‚úÖ"; btn.style.background = "#2ecc71"; } 
        else { alert(d.message); btn.style.background = "rgba(255,255,255,0.1)"; }
    });
}

// --- TRAILER MODAL LOGIC ---
function playTrailer(id, type) {
    const modal = document.getElementById('trailer-modal');
    const body = document.getElementById('trailer-body');
    modal.style.display = 'flex'; // Flex to center
    modal.style.justifyContent = 'center';
    modal.style.alignItems = 'center';
    
    body.innerHTML = '<div style="color:white;text-align:center;padding:50px;font-size:1.5em;">Loading Trailer... <div class="loader-small"></div></div>';

    fetch(`/get_metadata/${type}/${id}`)
        .then(r => r.json())
        .then(data => {
            if(data.trailer_key) {
                // Embed YouTube
                body.innerHTML = `<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${data.trailer_key}?autoplay=1" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
            } else {
                body.innerHTML = `<div style="text-align:center; padding:50px; color:#ccc;">
                    <h3>No Trailer Found üòï</h3>
                    <a href="https://www.youtube.com/results?search_query=${encodeURIComponent(data.title)}+trailer" target="_blank" class="btn-secondary" style="margin-top:10px;">Search YouTube ‚Üó</a>
                </div>`;
            }
        });
}

function closeTrailer() {
    const modal = document.getElementById('trailer-modal');
    const body = document.getElementById('trailer-body');
    modal.style.display = 'none';
    body.innerHTML = ''; // Kill iframe/video
}

// --- DETAILS MODAL ---
function openModal(id, type) {
    const modal = document.getElementById('detail-modal');
    modal.style.display = "block";
    const body = document.getElementById('modal-body');
    body.innerHTML = '<div style="text-align:center; padding:50px;"><div class="loader-small"></div> Loading...</div>';
    
    fetch(`/get_metadata/${type}/${id}`)
        .then(r => r.json())
        .then(data => {
            if(data.error) { body.innerHTML = `<div style="padding:20px; color:var(--error);">Error loading details.</div>`; return; }
            const poster = data.poster_path ? `https://image.tmdb.org/t/p/w500${data.poster_path}` : 'https://placehold.co/300x450/333/888?text=No+Poster';
            
            // New Trailer Button inside Modal too
            const trailerBtn = `<button onclick="playTrailer(${id}, '${type}')" class="btn-secondary" style="margin-top:10px;">‚ñ∂ Watch Trailer</button>`;
            
            const tmdbLink = `https://www.themoviedb.org/${type}/${id}`;
            const providersHtml = data.providers && data.providers.length > 0 
                ? `<div style="margin-top:15px; margin-bottom:15px;"><strong>Streaming on:</strong><br>${data.providers.map(p => `<img src="https://image.tmdb.org/t/p/original${p.logo}" title="${p.name}" style="width:40px; border-radius:8px; margin:5px 5px 0 0;">`).join('')}</div>`
                : '';

            body.innerHTML = `
                <div class="modal-poster"><img src="${poster}" onerror="this.style.display='none'"></div>
                <div class="modal-info">
                    <h2 style="margin-top:0; font-size:1.8em;">${data.title} <span style="font-weight:normal; color:#888; font-size:0.6em;">(${data.year})</span></h2>
                    <p class="modal-overview">${data.overview || 'No description available.'}</p>
                    <p style="color:#aaa; font-size:0.9em;"><strong>Cast:</strong> ${data.cast ? data.cast.join(', ') : 'N/A'}</p>
                    ${providersHtml}
                    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:20px;">
                        <button onclick="requestMedia('${type}', ${id}, this)" class="request-btn" style="flex:2;">Request üì•</button>
                        ${trailerBtn}
                        <a href="${tmdbLink}" target="_blank" class="btn-secondary" style="text-decoration:none; display:flex; align-items:center; justify-content:center;">TMDB ‚Üó</a>
                    </div>
                </div>`;
        });
}
function closeModal() { document.getElementById('detail-modal').style.display = "none"; }

function spinWheel() {
    const cards = Array.from(document.querySelectorAll('.result-card')).filter(c => c.style.display !== 'none');
    if(cards.length === 0) return;
    let spins = 0, max = 30, idx = 0;
    function step() {
        cards.forEach(c => c.style.border = "1px solid #333");
        idx = (idx + 1) % cards.length;
        cards[idx].style.border = "3px solid var(--accent-color)";
        cards[idx].scrollIntoView({behavior: "smooth", block: "center"});
        spins++;
        if(spins < max) setTimeout(step, 50 + (spins*5));
    }
    step();
}

document.addEventListener('DOMContentLoaded', init);
</script>
{% endblock %}