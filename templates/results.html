{% extends "base.html" %}
{% block content %}

<div class="results-header">
    <a href="{{ url_for('dashboard') }}" class="back-link">â† Back to Dashboard</a>
    
    <button id="spin-btn" onclick="spinTheWheel()" title="Can't decide? Pick a winner!">
        ğŸ² Spin the Wheel
    </button>
</div>

<div id="loading" class="loading-container">
    <div class="loader"></div>
    <h2>ğŸ¤– Crunching the numbers...</h2>
    <p class="helper-text">Analyzing genres, directors, and deep-cut connections.</p>
</div>

<div id="results-container" style="display: none;">
    <h2 class="results-title">
        {% if lucky_mode %}ğŸ€ Lucky Picks{% else %}âœ¨ Top Picks For You{% endif %}
    </h2>
    
    <div id="results-grid"></div>
    
    <div class="load-more-wrapper">
        <button onclick="loadMore(this)" class="load-more-btn">Load More Results</button>
    </div>
</div>

<div id="detail-modal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <div id="modal-body" class="modal-body"></div>
    </div>
</div>

<div id="trailer-modal" class="trailer-modal-overlay" onclick="closeTrailer()">
    <div class="trailer-modal-content" onclick="event.stopPropagation()">
        <div class="close-trailer" onclick="closeTrailer()">&times;</div>
        <iframe id="yt-player" width="100%" height="100%" src="" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
    </div>
</div>

<script>
let page = 1;
const useCriticFilter = "{{ use_critic_filter|lower }}"; 
// ğŸ‘‡ Capture Lucky Mode data sent from Python
const serverMovies = {{ movies|tojson|safe if movies else 'null' }};

function init() {
    // If we have Lucky Mode movies, render them immediately
    if (serverMovies && serverMovies.length > 0) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('results-container').style.display = 'block';
        const grid = document.getElementById('results-grid');
        
        serverMovies.forEach(item => {
            grid.appendChild(createCard(item));
        });
        
        // Hide load more button in lucky mode as it's a one-off batch
        document.querySelector('.load-more-wrapper').style.display = 'none';
    } else {
        // Otherwise, load from API normally
        loadMore(null);
    }
}

// --- SHARED CARD CREATOR ---
function createCard(item) {
    // Normalize data (Lucky mode uses slightly different keys than API)
    const id = item.tmdb_id || item.id;
    const title = item.title || item.name;
    const date = item.date || item.year || 'N/A';
    const rating = item.rating || item.vote_average || 0;
    const mediaType = item.media_type || 'movie'; 
    const posterPath = item.poster_path;
    const overview = item.overview || "No description available.";

    const card = document.createElement('div');
    card.className = 'movie-card'; 
    card.id = `card-${id}`;
    
    // Normalize item object for the modal
    const cleanItem = {
        tmdb_id: id, title: title, date: date, rating: rating, 
        media_type: mediaType, poster_path: posterPath, 
        overview: overview, streaming_info: item.streaming_info,
        critic_ratings: item.critic_ratings
    };

    card.onclick = (e) => {
        if (!e.target.closest('.play-trailer-btn')) openModal(cleanItem);
    };

    let badges = '';
    if (item.is_seed) badges += `<span class="badge" title="History Match">ğŸ€</span>`;
    if (item.streaming_info) badges += `<span class="badge" title="${item.streaming_info}">ğŸ“¡</span>`;

    if (item.critic_ratings) {
        if (item.critic_ratings.rt) badges += `<span class="badge rt">ğŸ… ${item.critic_ratings.rt}</span>`;
        if (item.critic_ratings.meta) badges += `<span class="badge meta">â“‚ï¸ ${item.critic_ratings.meta}</span>`;
    } else {
        badges += `<span class="badge tmdb">â­ ${Math.round(rating * 10)}%</span>`;
    }

    const posterUrl = posterPath 
        ? `https://image.tmdb.org/t/p/w500${posterPath}` 
        : `https://placehold.co/500x750/222/888?text=No+Poster`;

    card.innerHTML = `
        <div class="poster-wrapper">
            <img src="${posterUrl}" onerror="this.src='https://placehold.co/500x750/222/888?text=No+Poster'">
            <div class="poster-overlay"><span>View Details</span></div>
            <button class="play-trailer-btn" onclick="playTrailer('${mediaType}', ${id})">â–¶</button>
        </div>
        <div class="card-info">
            <h3 class="movie-title">${title}</h3>
            <div class="movie-meta">
                <span>${date}</span>
                <div class="badges">${badges}</div>
            </div>
        </div>
    `;
    return card;
}

// --- MAIN LOAD FUNCTION ---
function loadMore(btn) {
    let originalText = "Load More Results";
    if (btn && btn.tagName === 'BUTTON') {
        originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = 'Loading...';
        btn.style.opacity = "0.7";
        btn.style.cursor = "not-allowed";
    }

    fetch(`/load_more_recs?page=${page}&critic_filter=${useCriticFilter}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('results-container').style.display = 'block';
            const grid = document.getElementById('results-grid');
            
            if (data.length === 0 && page === 1) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 50px;"><h3>No matches found ğŸ˜”</h3><p>Try relaxing your filters or choosing different seed movies.</p></div>';
                return;
            }

            data.forEach(item => {
                grid.appendChild(createCard(item));
            });
            page++;

            if (btn && btn.tagName === 'BUTTON') {
                btn.disabled = false;
                btn.innerHTML = originalText;
                btn.style.opacity = "1";
                btn.style.cursor = "pointer";
            }
        });
}

// --- SPIN THE WHEEL ---
function spinTheWheel() {
    const cards = document.querySelectorAll('.movie-card');
    if (cards.length === 0) return;
    const spinBtn = document.getElementById('spin-btn');
    spinBtn.disabled = true; spinBtn.innerHTML = "Spinning... ğŸ°";
    
    let spins = 0, maxSpins = 20 + Math.random() * 10, speed = 50, currentIndex = 0;
    cards.forEach(c => c.classList.remove('winner-card'));

    function step() {
        cards.forEach(c => c.classList.remove('highlight-card'));
        currentIndex = (currentIndex + 1) % cards.length;
        const activeCard = cards[currentIndex];
        activeCard.classList.add('highlight-card');
        activeCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        spins++;
        
        if (spins < maxSpins) {
            speed += (spins * 2); setTimeout(step, Math.min(speed, 400));
        } else {
            activeCard.classList.add('winner-card');
            spinBtn.innerHTML = "Spin Again ğŸ²"; spinBtn.disabled = false;
        }
    }
    step();
}

// --- TRAILER ---
function playTrailer(type, id) {
    const modal = document.getElementById('trailer-modal');
    modal.style.display = 'flex';
    fetch(`/get_trailer/${type}/${id}`).then(r => r.json()).then(data => {
        if (data.status === 'success') document.getElementById('yt-player').src = `https://www.youtube.com/embed/${data.key}?autoplay=1`;
        else { alert("No trailer found."); closeTrailer(); }
    });
}
function closeTrailer() {
    document.getElementById('yt-player').src = "";
    document.getElementById('trailer-modal').style.display = 'none';
}

// --- MODAL ---
function openModal(item) {
    const modal = document.getElementById('detail-modal');
    const body = document.getElementById('modal-body');
    
    let badges = '';
    if (item.streaming_info) badges += `<span class="badge" title="Streaming">ğŸ“¡ ${item.streaming_info}</span>`;
    if (item.critic_ratings && item.critic_ratings.rt) badges += `<span class="badge rt">ğŸ… ${item.critic_ratings.rt}</span>`;

    const posterUrl = item.poster_path ? `https://image.tmdb.org/t/p/w500${item.poster_path}` : `https://placehold.co/500x750/222/888?text=No+Poster`;

    body.innerHTML = `
        <div class="modal-poster">
            <img src="${posterUrl}">
        </div>
        <div class="modal-info">
            <h2>${item.title} <span style="font-size:0.6em; opacity:0.7;">(${item.date})</span></h2>
            <div style="margin: 10px 0; display:flex; gap:10px;">${badges}</div>
            <p class="modal-overview">${item.overview || "No description available."}</p>
            <div id="extra-metadata" style="margin-top: 20px; color: #888;">Loading extra info...</div>
            <button onclick="requestMedia('${item.media_type}', ${item.tmdb_id}, this)" class="request-btn">Request ğŸ“¥</button>
        </div>
    `;
    modal.style.display = "block";

    fetch(`/get_metadata/${item.media_type}/${item.tmdb_id}`).then(r => r.json()).then(data => {
        const metaDiv = document.getElementById('extra-metadata');
        let html = '';
        if (data.cast && data.cast.length > 0) html += `<div><strong>Cast:</strong> ${data.cast.join(', ')}</div>`;
        if (data.providers && data.providers.length > 0) {
            html += `<div style="margin-top:10px;"><strong>Streaming:</strong>`;
            data.providers.forEach(p => html += ` <img src="https://image.tmdb.org/t/p/original${p.logo}" title="${p.name}" style="width:30px; border-radius:4px; vertical-align:middle; margin-left:5px;">`);
            html += `</div>`;
        }
        metaDiv.innerHTML = html;
    });
}
function closeModal() { document.getElementById('detail-modal').style.display = "none"; }
function requestMedia(type, id, btn) {
    btn.innerText = "Requesting..."; btn.disabled = true;
    fetch('/request_media', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({media_type:type, tmdb_id:id})})
    .then(r=>r.json()).then(d=>{
        if(d.status==='success') { btn.innerText="Requested! âœ…"; btn.style.background="#2ecc71"; }
        else { btn.innerText="Error"; alert(d.message); }
    });
}

// Start!
document.addEventListener('DOMContentLoaded', init);
</script>
{% endblock %}