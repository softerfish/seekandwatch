{% extends "base.html" %}
{% block content %}

<div class="intro-box">
    <h3>ğŸš€ Kometa Config Builder (v1.0.1 Beta)</h3>
    <p>
        This tool generates a <strong>foundational</strong> configuration. For a full list of available collections, customization options, and advanced features, please consult the official 
        <a href="https://kometa.wiki/en/latest/defaults/collections/" target="_blank" style="color:white; text-decoration:underline; font-weight:bold;">Kometa Defaults Documentation â†—</a>.
    </p>
    
    <div style="margin: 15px 0; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 6px;">
        <h4 style="color: #f39c12; margin-top: 0; border: none; font-size: 1em;">ğŸ› ï¸ How to use this tool:</h4>
        <ol style="margin: 0; padding-left: 20px; line-height: 1.6; color: #ddd; font-size: 0.9em;">
            <li><strong>Connect:</strong> Enter your Plex & TMDb details in Tab 1 to enable scanning.</li>
            <li><strong>Select:</strong> Toggle the collections you want in Tab 3.</li>
            <li><strong>Customize (âš™ï¸):</strong> Click the Gear Icon next to any item to refine it.</li>
        </ol>
        
        <p style="margin-top: 12px; color: #ccc; font-size: 0.9em; margin-bottom: 0;">
            <strong>ğŸ’¡ Power Tip:</strong> Use the gear icon to filter huge lists.<br>
            <em>Example:</em> Enable <strong>Streaming Services</strong>, click the âš™ï¸ Gear, and add <code>Netflix, Disney+</code> to the <strong>Include</strong> field. Instead of generating 100+ collections for every service under the sun, Kometa will now only create two! <br><br>
            <strong>Remember</strong> to click Save Progress often
        </p>
    </div>

    <span class="intro-warning">âš ï¸ Warning: Selecting too many categories without custom filtering variables can result in HUNDREDS of collections. Start small!</span>
    <p style="margin-top: 15px; font-weight: bold; color: white; border-top: 1px solid #444; padding-top: 10px;">
        ğŸ“ Instructions: Copy the YAML code on the right, save it as <code>config.yml</code>, and place it in your Kometa config folder.
    </p>
</div>

<div class="header-row" style="margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center;">
    <div>
        <h2>ğŸ§© Kometa Config Builder</h2>
        <p class="text-muted">Generate a clean <code>config.yml</code> file.</p>
    </div>
    <button onclick="saveProgress()" class="btn-primary" style="padding: 10px 20px; font-weight: bold;">ğŸ’¾ Save Progress</button>
</div>

<div class="k-container">
    
    <div class="k-panel">
        
        <div class="k-tabs">
            <button class="k-tab active" onclick="switchTab('config')">1. Core Config</button>
            <button class="k-tab" onclick="switchTab('global')">2. Global Settings</button>
            <button class="k-tab" onclick="switchTab('libraries')">3. Libraries</button>
        </div>

        <div id="tab-config" class="k-section active">
            <div class="k-group" style="border-left: 4px solid #e74c3c;">
                <h4 style="border-bottom:none; margin-bottom:10px;">ğŸš¨ Required Connections</h4>
                <div style="margin-bottom:15px; font-size:0.85em; color:#aaa; border-bottom:1px solid #444; padding-bottom:10px;">These are mandatory for Kometa to function.</div>
                
                <div class="k-input-row">
                    <label>Plex URL <span class="info-icon" title="Local IP of your Plex Server">â„¹ï¸</span></label>
                    <input type="text" id="plex_url" value="{{ settings.plex_url or '' }}" placeholder="http://192.168.1.X:32400" oninput="gen()">
                </div>
                <div class="info-text">Example: http://192.168.1.50:32400</div>

                <div class="k-input-row">
                    <label>Plex Token <span class="info-icon" title="Find this in the XML of any media item in Plex">â„¹ï¸</span></label>
                    <input type="password" id="plex_token" value="{{ settings.plex_token or '' }}" placeholder="X-Plex-Token" oninput="gen()">
                </div>
                <div class="info-text">The X-Plex-Token used to authenticate.</div>

                <div class="k-input-row">
                    <label>TMDB Key <span class="info-icon" title="API Key from themoviedb.org">â„¹ï¸</span></label>
                    <input type="password" id="tmdb_key" value="{{ settings.tmdb_key or '' }}" placeholder="API Key" oninput="gen()">
                </div>
                <div class="info-text">Required to look up metadata and posters.</div>
            </div>
        </div>

        <div id="tab-global" class="k-section">
            <div class="k-group">
                <h4 style="border:none;">âš™ï¸ System & Caching</h4>
                
                <div class="k-input-row">
                    <label>Cache Enabled <span class="info-icon" title="Speeds up runs by saving TMDB/Plex data locally.">â„¹ï¸</span></label>
                    <select id="s_cache" onchange="gen()">
                        <option value="true" selected>True (Recommended)</option>
                        <option value="false">False</option>
                    </select>
                </div>
                <div class="info-text">Speeds up runs by saving TMDB/Plex data locally.</div>

                <div class="k-input-row">
                    <label>Cache Expiry (Days) <span class="info-icon" title="Days before each cache mapping expires and must be re-cached.">â„¹ï¸</span></label>
                    <input type="number" id="s_cache_expiration" value="60" oninput="gen()">
                </div>
                <div class="info-text">How long to keep metadata before refreshing it from TMDB.</div>

                <div class="k-input-row">
                    <label>Run Order <span class="info-icon" title="The order Kometa performs tasks. Default is Operations > Metadata > Collections > Overlays.">â„¹ï¸</span></label>
                    <select id="s_run_order" onchange="gen()">
                        <option value="default" selected>Default (Ops > Meta > Coll > Overlays)</option>
                        <option value="collections_first">Collections First</option>
                    </select>
                </div>
                <div class="info-text">The order Kometa performs tasks. Default is usually best.</div>
            </div>

            <div class="k-group">
                <h4 style="border:none;">ğŸ“‚ Assets & Folders</h4>
                
                <div class="k-input-row">
                    <label>Asset Folders <span class="info-icon" title="Expects one folder per item in your assets directory (e.g. Assets/Star Wars/poster.jpg).">â„¹ï¸</span></label>
                    <select id="s_asset_folders" onchange="gen()">
                        <option value="true" selected>True</option>
                        <option value="false">False</option>
                    </select>
                </div>
                <div class="info-text">Expects one folder per item in your assets directory?</div>

                <div class="k-input-row">
                    <label>Show Missing Assets <span class="info-icon" title="Logs a warning if an item is missing a custom poster in your assets folder.">â„¹ï¸</span></label>
                    <select id="s_show_missing" onchange="gen()">
                        <option value="true" selected>True</option>
                        <option value="false">False</option>
                    </select>
                </div>
                <div class="info-text">Logs a warning if an item is missing a custom poster.</div>
            </div>

            <div class="k-group">
                <h4 style="border:none;">ğŸ§¹ Collection Management</h4>

                <div class="k-input-row">
                    <label>Sync Mode <span class="info-icon" title="'Sync' removes items from collections if they no longer match the rules. 'Append' only adds new items.">â„¹ï¸</span></label>
                    <select id="s_sync_mode" onchange="gen()">
                        <option value="append" selected>Append (Add only)</option>
                        <option value="sync">Sync (Add & Remove)</option>
                    </select>
                </div>
                <div class="info-text">'Sync' will remove items from collections if they no longer match the rules.</div>

                <div class="k-input-row">
                    <label>Delete Below Min <span class="info-icon" title="Delete the entire collection if it has fewer than the minimum number of items.">â„¹ï¸</span></label>
                    <select id="s_delete_below_min" onchange="gen()">
                        <option value="false" selected>False</option>
                        <option value="true">True</option>
                    </select>
                </div>
                <div class="info-text">Delete the collection if it has fewer than the minimum items?</div>
                
                <div class="k-input-row">
                    <label>Minimum Items <span class="info-icon" title="Minimum items that must be found to create a collection.">â„¹ï¸</span></label>
                    <input type="number" id="s_minimum_items" value="1" oninput="gen()">
                </div>
            </div>

            <div class="k-group">
                <h4 style="border:none;">ğŸ¨ Overlay Quality</h4>
                
                <div class="k-input-row">
                    <label>Artwork Quality (0-100) <span class="info-icon" title="Compression level for generated posters. Higher = Larger files.">â„¹ï¸</span></label>
                    <input type="number" id="s_artwork_quality" value="90" oninput="gen()">
                </div>
                <div class="info-text">Compression level for generated posters. Higher = Larger files.</div>
            </div>
        </div>

        <div id="tab-libraries" class="k-section">
             <div class="k-group">
                <h4 style="border:none; margin-bottom:5px;">Add a Library</h4>
                <p style="color:#777; font-size:0.9em; margin-bottom:20px; border-bottom:1px solid #444; padding-bottom:10px;">Configure one or more Plex libraries.</p>

                <div class="k-input-row">
                    <label>Library <button class="btn-refresh" onclick="fetchLibs()" title="Refresh Libraries">ğŸ”„</button></label>
                    <select id="temp_lib_name" onchange="autoSelectType(); toggleOptions();">
                        <option value="" disabled selected>Loading libraries...</option>
                    </select>
                </div>
                
                <div class="k-input-row">
                    <label>Type</label>
                    <select id="temp_lib_type" onchange="filterOpts(); gen();">
                        <option value="movie">Movies ğŸ¬</option>
                        <option value="tv">TV Shows ğŸ“º</option>
                        <option value="anime">Anime ğŸ¯</option>
                    </select>
                </div>

                <div id="options-lock-wrapper" class="locked-section">
                    
                    <div class="k-sub-header">ğŸ“ˆ Popular Charts (Safe)</div>
                    <div class="k-check-grid" id="opt-container">
                        <div class="k-check-item type-all"><label title="Generates collections based on TMDb popularity (Trending, Popular, etc)."><input type="checkbox" class="t-opt" value="tmdb" onchange="gen()"> TMDB Popular</label><button class="btn-gear" onclick="editVars('tmdb', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="Generates the IMDb Top 250 Movies/Shows chart."><input type="checkbox" class="t-opt" value="imdb" onchange="gen()"> IMDb Top 250</label><button class="btn-gear" onclick="editVars('imdb', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="Generates collections for New Releases, Released Today, and Recently Added items."><input type="checkbox" class="t-opt" value="basic" onchange="gen()"> New Releases</label><button class="btn-gear" onclick="editVars('basic', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="Top rated and popular anime from AniList."><input type="checkbox" class="t-opt" value="anilist" onchange="gen()"> AniList Charts</label><button class="btn-gear" onclick="editVars('anilist', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="Popular lists and charts from Letterboxd."><input type="checkbox" class="t-opt" value="letterboxd" onchange="gen()"> Letterboxd Charts</label><button class="btn-gear" onclick="editVars('letterboxd', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="Top anime lists from MyAnimeList."><input type="checkbox" class="t-opt" value="myanimelist" onchange="gen()"> MyAnimeList Charts</label><button class="btn-gear" onclick="editVars('myanimelist', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="Various other chart providers and trending lists."><input type="checkbox" class="t-opt" value="other_chart" onchange="gen()"> Other Charts</label><button class="btn-gear" onclick="editVars('other_chart', event)">âš™ï¸</button></div>
                    </div>

                    <div class="k-sub-header">ğŸ“š Content</div>
                    <div class="k-check-grid">
                        <div class="k-check-item type-all"><label title="Generates collections for every Genre (Action, Comedy, etc.) found in your library."><input type="checkbox" class="t-opt" value="genre" onchange="gen()"> Genres</label><button class="btn-gear" onclick="editVars('genre', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="Generates collections for franchises (Star Wars, James Bond, Fast & Furious, etc.)."><input type="checkbox" class="t-opt" value="franchise" onchange="gen()"> Franchises</label><button class="btn-gear" onclick="editVars('franchise', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="Generates collections for shared universes (MCU, DCEU, Star Trek, etc.)."><input type="checkbox" class="t-opt" value="universe" onchange="gen()"> Universes</label><button class="btn-gear" onclick="editVars('universe', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="Collections based on source material (Based on Book, Based on Comic, etc.)."><input type="checkbox" class="t-opt" value="based" onchange="gen()"> Based On...</label><button class="btn-gear" onclick="editVars('based', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="Finds items that are not part of any other collection."><input type="checkbox" class="t-opt" value="collectionless" onchange="gen()"> Collectionless</label><button class="btn-gear" onclick="editVars('collectionless', event)">âš™ï¸</button></div>
                    </div>

                    <div class="k-sub-header">ğŸ‘¤ People</div>
                    <div class="k-check-grid">
                        <div class="k-check-item type-all"><label title="Collections for popular Actors."><input type="checkbox" class="t-opt" value="actor" onchange="gen()"> Actors</label><button class="btn-gear" onclick="editVars('actor', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-tv hidden"><label title="Collections for popular Directors."><input type="checkbox" class="t-opt" value="director" onchange="gen()"> Directors</label><button class="btn-gear" onclick="editVars('director', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-tv hidden"><label title="Collections for popular Producers."><input type="checkbox" class="t-opt" value="producer" onchange="gen()"> Producers</label><button class="btn-gear" onclick="editVars('producer', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-tv hidden"><label title="Collections for popular Writers."><input type="checkbox" class="t-opt" value="writer" onchange="gen()"> Writers</label><button class="btn-gear" onclick="editVars('writer', event)">âš™ï¸</button></div>
                    </div>

                    <div class="k-sub-header">ğŸ­ Production</div>
                    <div class="k-check-grid">
                        <div class="k-check-item type-tv hidden"><label title="Generates collections for TV Networks (HBO, AMC, NBC, etc.)."><input type="checkbox" class="t-opt" value="network" onchange="gen()"> Networks</label><button class="btn-gear" onclick="editVars('network', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="Generates collections for Streaming Services (Netflix, Disney+, Hulu, etc.)."><input type="checkbox" class="t-opt" value="streaming" onchange="gen()"> Streaming Services</label><button class="btn-gear" onclick="editVars('streaming', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="Generates collections for major studios (Pixar, A24, Warner Bros, etc.)."><input type="checkbox" class="t-opt" value="studio" onchange="gen()"> Studios</label><button class="btn-gear" onclick="editVars('studio', event)">âš™ï¸</button></div>
                    </div>

                    <div class="k-sub-header">ğŸ“… Time</div>
                    <div class="k-check-grid">
                        <div class="k-check-item type-movie"><label title="Generates seasonal collections (Christmas, Halloween) that appear only during specific times of year."><input type="checkbox" class="t-opt" value="seasonal" onchange="gen()"> Seasonal (Holidays)</label><button class="btn-gear" onclick="editVars('seasonal', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="Generates collections for specific release years."><input type="checkbox" class="t-opt" value="year" onchange="gen()"> Release Year</label><button class="btn-gear" onclick="editVars('year', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="Generates collections for decades (1980s, 1990s, 2000s, etc.)."><input type="checkbox" class="t-opt" value="decade" onchange="gen()"> Decades</label><button class="btn-gear" onclick="editVars('decade', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-tv hidden"><label title="Generates collections for 'Ended', 'Returning', or 'Canceled' shows."><input type="checkbox" class="t-opt" value="status" onchange="gen()"> Status (Ended/Running)</label><button class="btn-gear" onclick="editVars('status', event)">âš™ï¸</button></div>
                    </div>

                    <div class="k-sub-header">ğŸ” Content Ratings</div>
                    <div class="k-check-grid">
                        <div class="k-check-item type-all"><label title="US Ratings (G, PG, PG-13, R / TV-MA, etc)."><input type="checkbox" class="t-opt" value="content_rating_us" onchange="gen()"> US Ratings</label><button class="btn-gear" onclick="editVars('content_rating_us', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="UK Ratings (U, 12, 15, 18)."><input type="checkbox" class="t-opt" value="content_rating_uk" onchange="gen()"> UK Ratings</label><button class="btn-gear" onclick="editVars('content_rating_uk', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="German FSK Ratings."><input type="checkbox" class="t-opt" value="content_rating_de" onchange="gen()"> DE Ratings</label><button class="btn-gear" onclick="editVars('content_rating_de', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="Australian Ratings."><input type="checkbox" class="t-opt" value="content_rating_au" onchange="gen()"> AU Ratings</label><button class="btn-gear" onclick="editVars('content_rating_au', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="New Zealand Ratings."><input type="checkbox" class="t-opt" value="content_rating_nz" onchange="gen()"> NZ Ratings</label><button class="btn-gear" onclick="editVars('content_rating_nz', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="MyAnimeList Content Ratings."><input type="checkbox" class="t-opt" value="content_rating_mal" onchange="gen()"> MAL Ratings</label><button class="btn-gear" onclick="editVars('content_rating_mal', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="Common Sense Media Age Ratings."><input type="checkbox" class="t-opt" value="content_rating_cs" onchange="gen()"> Common Sense</label><button class="btn-gear" onclick="editVars('content_rating_cs', event)">âš™ï¸</button></div>
                    </div>

                    <div class="k-sub-header">ğŸ’¿ Media Attributes</div>
                    <div class="k-check-grid">
                        <div class="k-check-item type-all"><label title="Group by Aspect Ratio (e.g. 2.35:1, 16:9)."><input type="checkbox" class="t-opt" value="aspect" onchange="gen()"> Aspect Ratios</label><button class="btn-gear" onclick="editVars('aspect', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="Group by Resolution (4K, 1080p, SD)."><input type="checkbox" class="t-opt" value="resolution" onchange="gen()"> Resolutions</label><button class="btn-gear" onclick="editVars('resolution', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="Group by Audio Language tracks."><input type="checkbox" class="t-opt" value="audio_language" onchange="gen()"> Audio Languages</label><button class="btn-gear" onclick="editVars('audio_language', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="Group by Subtitle Language tracks."><input type="checkbox" class="t-opt" value="subtitle_language" onchange="gen()"> Subtitle Languages</label><button class="btn-gear" onclick="editVars('subtitle_language', event)">âš™ï¸</button></div>
                    </div>

                    <div class="k-sub-header">ğŸ† Awards</div>
                    <div class="k-check-grid">
                        <div class="k-check-item type-movie"><label title="Academy Award 'Best Picture' winners."><input type="checkbox" class="t-opt" value="oscars" onchange="gen()"> Oscars (Academy)</label><button class="btn-gear" onclick="editVars('oscars', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-movie"><label title="Golden Berlin Bear winners."><input type="checkbox" class="t-opt" value="berlinale" onchange="gen()"> Berlin (Berlinale)</label><button class="btn-gear" onclick="editVars('berlinale', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-movie"><label title="BAFTA Award winners."><input type="checkbox" class="t-opt" value="bafta" onchange="gen()"> BAFTA</label><button class="btn-gear" onclick="editVars('bafta', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-movie"><label title="Palme d'Or winners."><input type="checkbox" class="t-opt" value="cannes" onchange="gen()"> Cannes Film Festival</label><button class="btn-gear" onclick="editVars('cannes', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-movie"><label title="CÃ©sar Award winners."><input type="checkbox" class="t-opt" value="cesar" onchange="gen()"> CÃ©sar Awards</label><button class="btn-gear" onclick="editVars('cesar', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-movie"><label title="Independent Spirit Award winners."><input type="checkbox" class="t-opt" value="spirit" onchange="gen()"> Independent Spirit</label><button class="btn-gear" onclick="editVars('spirit', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-movie"><label title="National Film Registry inductees."><input type="checkbox" class="t-opt" value="nfr" onchange="gen()"> National Film Registry</label><button class="btn-gear" onclick="editVars('nfr', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-movie"><label title="Golden Raspberry Award (Razzie) winners."><input type="checkbox" class="t-opt" value="razzie" onchange="gen()"> Razzie Awards</label><button class="btn-gear" onclick="editVars('razzie', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-movie"><label title="Sundance Film Festival winners."><input type="checkbox" class="t-opt" value="sundance" onchange="gen()"> Sundance</label><button class="btn-gear" onclick="editVars('sundance', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-movie"><label title="Toronto International Film Festival People's Choice winners."><input type="checkbox" class="t-opt" value="tiff" onchange="gen()"> TIFF (Toronto)</label><button class="btn-gear" onclick="editVars('tiff', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-movie"><label title="Golden Lion winners."><input type="checkbox" class="t-opt" value="venice" onchange="gen()"> Venice Film Festival</label><button class="btn-gear" onclick="editVars('venice', event)">âš™ï¸</button></div>

                        <div class="k-check-item type-all"><label title="Emmy Award winners."><input type="checkbox" class="t-opt" value="emmy" onchange="gen()"> Emmys</label><button class="btn-gear" onclick="editVars('emmy', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="Screen Actors Guild Award winners."><input type="checkbox" class="t-opt" value="sag" onchange="gen()"> SAG Awards</label><button class="btn-gear" onclick="editVars('sag', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="People's Choice Award winners."><input type="checkbox" class="t-opt" value="pca" onchange="gen()"> People's Choice</label><button class="btn-gear" onclick="editVars('pca', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="Golden Globe winners."><input type="checkbox" class="t-opt" value="golden" onchange="gen()"> Golden Globes</label><button class="btn-gear" onclick="editVars('golden', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="Critics' Choice Award winners."><input type="checkbox" class="t-opt" value="choice" onchange="gen()"> Critics' Choice</label><button class="btn-gear" onclick="editVars('choice', event)">âš™ï¸</button></div>
                    </div>

                    <div class="k-sub-header">ğŸ† Awards/Charts (Overlay)</div>
                    <div class="k-check-grid">
                        <div class="k-check-item type-all"><label title="Adds ribbons for IMDb Top 250, Rotten Tomatoes Fresh, Oscars, etc."><input type="checkbox" class="t-opt ovl" value="ribbon" onchange="gen()"> Ribbon</label><button class="btn-gear" onclick="editVars('ribbon', event)">âš™ï¸</button></div>
                    </div>

                    <div class="k-sub-header">ğŸ“º Content (Overlay)</div>
                    <div class="k-check-grid">
                        <div class="k-check-item type-tv hidden"><label title="Overlays season/episode counts on TV posters."><input type="checkbox" class="t-opt ovl" value="episode_info" onchange="gen()"> Episode Info</label><button class="btn-gear" onclick="editVars('episode_info', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-movie"><label title="Overlays a badge if the movie has a post-credit scene."><input type="checkbox" class="t-opt ovl" value="mediastinger" onchange="gen()"> Mediastinger</label><button class="btn-gear" onclick="editVars('mediastinger', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-tv hidden"><label title="Overlays 'Airing', 'Ended', or 'Canceled' status on show posters."><input type="checkbox" class="t-opt ovl" value="status" onchange="gen()"> Status</label><button class="btn-gear" onclick="editVars('status', event)">âš™ï¸</button></div>
                    </div>

                    <div class="k-sub-header">ğŸ” Content Ratings (Overlay)</div>
                    <div class="k-check-grid">
                        <div class="k-check-item type-all"><label title="Overlay Australian classification ratings (G, PG, M, etc.)."><input type="checkbox" class="t-opt ovl" value="content_rating_au" onchange="gen()"> AU Content Ratings</label><button class="btn-gear" onclick="editVars('content_rating_au', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="Overlay Common Sense Media age-appropriate ratings."><input type="checkbox" class="t-opt ovl" value="commonsense" onchange="gen()"> Common Sense Age Rating</label><button class="btn-gear" onclick="editVars('commonsense', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="Overlay German FSK classification ratings."><input type="checkbox" class="t-opt ovl" value="content_rating_de" onchange="gen()"> DE Content Ratings</label><button class="btn-gear" onclick="editVars('content_rating_de', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="Overlay New Zealand classification ratings."><input type="checkbox" class="t-opt ovl" value="content_rating_nz" onchange="gen()"> NZ Content Ratings</label><button class="btn-gear" onclick="editVars('content_rating_nz', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="Overlay UK BBFC classification ratings."><input type="checkbox" class="t-opt ovl" value="content_rating_uk" onchange="gen()"> UK Content Ratings</label><button class="btn-gear" onclick="editVars('content_rating_uk', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-movie"><label title="Overlay US MPAA film ratings (G, PG, R, etc.)."><input type="checkbox" class="t-opt ovl" value="content_rating_us_movie" onchange="gen()"> US Content Ratings (Movie)</label><button class="btn-gear" onclick="editVars('content_rating_us_movie', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-tv hidden"><label title="Overlay US TV Parental Guidelines (TV-14, TV-MA, etc.)."><input type="checkbox" class="t-opt ovl" value="content_rating_us_show" onchange="gen()"> US Content Ratings (Show)</label><button class="btn-gear" onclick="editVars('content_rating_us_show', event)">âš™ï¸</button></div>
                    </div>

                    <div class="k-sub-header">ğŸ’¿ Media (Overlay)</div>
                    <div class="k-check-grid">
                        <div class="k-check-item type-all"><label title="Overlay the video aspect ratio (e.g., 2.35:1)."><input type="checkbox" class="t-opt ovl" value="aspect" onchange="gen()"> Aspect Ratio</label><button class="btn-gear" onclick="editVars('aspect', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="Overlay badges for audio codecs (Atmos, DTS-X, etc.)."><input type="checkbox" class="t-opt ovl" value="audio_codec" onchange="gen()"> Audio Codec</label><button class="btn-gear" onclick="editVars('audio_codec', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="Overlay the number of audio/subtitle languages available."><input type="checkbox" class="t-opt ovl" value="language_count" onchange="gen()"> Audio/Subtitle Language Count</label><button class="btn-gear" onclick="editVars('language_count', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="Overlay flags indicating available audio/subtitle languages."><input type="checkbox" class="t-opt ovl" value="languages" onchange="gen()"> Audio/Subtitle Language Flags</label><button class="btn-gear" onclick="editVars('languages', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="Overlay resolution (4K, 1080p) and edition info."><input type="checkbox" class="t-opt ovl" value="resolution" onchange="gen()"> Resolution/Editions</label><button class="btn-gear" onclick="editVars('resolution', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="Overlay the content duration on the poster."><input type="checkbox" class="t-opt ovl" value="runtimes" onchange="gen()"> Runtimes</label><button class="btn-gear" onclick="editVars('runtimes', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="Overlay a badge if multiple versions of the item exist."><input type="checkbox" class="t-opt ovl" value="versions" onchange="gen()"> Versions</label><button class="btn-gear" onclick="editVars('versions', event)">âš™ï¸</button></div>
                    </div>

                    <div class="k-sub-header">ğŸ­ Production (Overlay)</div>
                    <div class="k-check-grid">
                        <div class="k-check-item type-tv hidden"><label title="Overlay the television network logo."><input type="checkbox" class="t-opt ovl" value="network" onchange="gen()"> Network</label><button class="btn-gear" onclick="editVars('network', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="Overlay the streaming service logo."><input type="checkbox" class="t-opt ovl" value="streaming" onchange="gen()"> Streaming</label><button class="btn-gear" onclick="editVars('streaming', event)">âš™ï¸</button></div>
                        <div class="k-check-item type-all"><label title="Overlay the production studio logo."><input type="checkbox" class="t-opt ovl" value="studio" onchange="gen()"> Studio</label><button class="btn-gear" onclick="editVars('studio', event)">âš™ï¸</button></div>
                    </div>

                    <div class="k-sub-header">ğŸ› ï¸ Utility (Overlay)</div>
                    <div class="k-check-grid">
                        <div class="k-check-item type-all"><label title="Overlay a badge indicating if the item can Direct Play."><input type="checkbox" class="t-opt ovl" value="direct_play" onchange="gen()"> Direct Play</label><button class="btn-gear" onclick="editVars('direct_play', event)">âš™ï¸</button></div>
                    </div>

                    <button class="btn-add" onclick="addLibrary()" id="btn-action" disabled>â• Add/Update Library</button>
                
                </div> </div>

            <h4 style="margin-top:30px; margin-bottom:10px;">Added Libraries:</h4>
            <div id="added-libs-container" style="min-height:50px; border:1px dashed #444; padding:10px; border-radius:6px; background:#111;">
                <div style="text-align:center; color:#555; font-size:0.9em; padding:10px;">No libraries added yet.</div>
            </div>
        </div>
    </div>

    <div class="k-panel" style="position: sticky; top: 20px; min-width:400px;">
        <h3 style="margin-top:0; margin-bottom:15px; color:white;">ğŸ“„ config.yml Output</h3>
        <div class="yaml-box" id="output">
<span class="y-cmnt"># Fill in the form on the left to generate config...</span>
        </div>
        <button onclick="copyYaml()" style="width:100%; margin-top:15px; padding:12px; background:var(--accent-color); border:none; border-radius:6px; font-weight:bold; cursor:pointer;">ğŸ“‹ Copy to Clipboard</button>
    </div>
</div>

<div id="var-modal" class="modal-overlay">
    <div class="modal-box">
        <h3 style="margin-top:0;">ğŸ”§ Customize: <span id="modal-title" style="color:var(--accent-color)"></span></h3>
        <p style="font-size:0.85em; color:#aaa; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px;">
            See available variables at <a href="https://kometa.wiki/en/latest/defaults/collections/" target="_blank" style="color:var(--accent-color); font-weight:bold;">Kometa Wiki â†—</a>.<br>
            <span style="color:#e74c3c;">âš ï¸ Note: Not all variables work with every collection type. Check the wiki!</span>
        </p>

        <div class="k-sub-header" id="qs-header" style="margin-top:5px; border-bottom:none;">âš¡ Quick Settings</div>
        <div class="quick-settings" id="qs-container">
            <div class="qs-col" id="wrapper-qs-limit">
                <label>Limit (Items) <span class="info-icon" title="Maximum number of items to keep in this collection.">â„¹ï¸</span></label>
                <input type="number" id="qs-limit" placeholder="Unlimited">
            </div>
            <div class="qs-col" id="wrapper-qs-sort">
                <label>Sort By <span class="info-icon" title="How the collection items are ordered in Plex.">â„¹ï¸</span></label>
                <select id="qs-sort">
                    <option value=""></option>
                    <option value="release">Release Date (Newest)</option>
                    <option value="popularity">Popularity</option>
                    <option value="critic_rating">Critic Rating</option>
                    <option value="audience_rating">Audience Rating</option>
                    <option value="random">Random</option>
                </select>
            </div>
            <div class="qs-col" id="wrapper-qs-coll-mode">
                <label>Collection Mode <span class="info-icon" title="How the collection appears in the library (e.g. Hide items from main library).">â„¹ï¸</span></label>
                <select id="qs-coll-mode">
                    <option value=""></option>
                    <option value="hide">Hide Collection</option>
                    <option value="hide_items">Hide Items</option>
                    <option value="show_items">Show Items</option>
                </select>
            </div>
            <div class="qs-col" id="wrapper-qs-sync-mode">
                <label>Sync Mode <span class="info-icon" title="Sync (remove missing items) or Append (only add new items).">â„¹ï¸</span></label>
                <select id="qs-sync-mode">
                    <option value="">Inherit Global Setting</option>
                    <option value="sync">Sync (Add & Remove)</option>
                    <option value="append">Append (Add Only)</option>
                </select>
            </div>
            <div class="qs-col" id="wrapper-qs-include">
                <label>Include (Items) <span class="info-icon" title="Enter items separated by commas. We will format them as a YAML list automatically.">â„¹ï¸</span></label>
                <input type="text" id="qs-include" placeholder="e.g. Star Wars, Matrix">
            </div>
            <div class="qs-col" id="wrapper-qs-exclude">
                <label>Exclude (Items) <span class="info-icon" title="Enter items separated by commas. We will format them as a YAML list automatically.">â„¹ï¸</span></label>
                <input type="text" id="qs-exclude" placeholder="e.g. The Room, Cats">
            </div>

            <div class="qs-col" id="wrapper-qs-builder-level" style="display:none;">
                <label>Builder Level</label>
                <select id="qs-builder-level">
                    <option value=""></option>
                    <option value="season">Season</option>
                    <option value="episode">Episode</option>
                </select>
            </div>
            <div class="qs-col" id="wrapper-qs-style" style="display:none;">
                <label>Style</label>
                <select id="qs-style">
                    <option value=""></option>
                    <option value="compact">Compact</option>
                    <option value="standard">Standard</option>
                </select>
            </div>
            <div class="qs-col" id="wrapper-qs-minimum" style="display:none;">
                <label>Minimum</label>
                <input type="number" id="qs-minimum">
            </div>
            <div class="qs-col" id="wrapper-qs-use-subtitles" style="display:none;">
                <label>Use Subtitles</label>
                <select id="qs-use-subtitles">
                    <option value=""></option>
                    <option value="true">True</option>
                </select>
            </div>
            <div class="qs-col" id="wrapper-qs-addon-position" style="display:none;">
                <label>Addon Position</label>
                <select id="qs-addon-position">
                    <option value=""></option>
                    <option value="left">Left</option>
                    <option value="right">Right</option>
                    <option value="top">Top</option>
                    <option value="bottom">Bottom</option>
                </select>
            </div>
        </div>

        <div class="k-sub-header" style="border-bottom:none;">ğŸ”§ Advanced Custom Variables</div>
        <div id="var-container">
            </div>

        <button class="btn-secondary" onclick="addVarRow()" style="width:100%; margin-bottom:20px; border:1px dashed #444;">+ Add Variable</button>

        <div style="display:flex; justify-content:flex-end; gap:10px;">
            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn-primary" onclick="saveModal()">Save Variables</button>
        </div>
    </div>
</div>

<script>
// Load saved config (handles the legacy array format too).
const savedConfig = JSON.parse({{ settings.kometa_config|tojson if settings.kometa_config else 'null' }});let libraries = [];
let globalSettings = {};
let templateVars = {}; // Stores variables: { 'genre': { limit: 10 }, 'tmdb': { ... } }

if (Array.isArray(savedConfig)) {
    // Legacy format
    libraries = savedConfig;
} else if (savedConfig) {
    // Current format
    libraries = savedConfig.libraries || [];
    globalSettings = savedConfig.settings || {};
}

// Map overlay keys to quick settings fields.
const overlaySettingsMap = {
    'content_rating_au': ['builder_level', 'addon_position'],
    'commonsense': ['builder_level', 'addon_position'],
    'content_rating_de': ['builder_level', 'addon_position'],
    'content_rating_nz': ['builder_level', 'addon_position'],
    'content_rating_uk': ['builder_level', 'addon_position'],
    'content_rating_us_movie': ['addon_position'],
    'content_rating_us_show': ['builder_level', 'addon_position'],
    'aspect': [],
    'audio_codec': ['builder_level', 'style'],
    'language_count': ['builder_level', 'minimum', 'style']
};

// Tab switching
function switchTab(t) {
    document.querySelectorAll('.k-section').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.k-tab').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-' + t).classList.add('active');
    event.target.classList.add('active');
}

// Lock options until a library is selected.
function toggleOptions() {
    const libName = document.getElementById('temp_lib_name').value;
    const wrapper = document.getElementById('options-lock-wrapper');
    const btn = document.getElementById('btn-action');

    if (!libName || libName === "") {
        wrapper.classList.add('locked-section');
        btn.disabled = true;
    } else {
        wrapper.classList.remove('locked-section');
        btn.disabled = false;
    }
}

// Variable modal
let currentEditKey = null;

function editVars(key, e) {
    if(e) e.stopPropagation(); 
    
    // Prefer the checkbox next to the clicked gear icon to avoid duplicates.
    let checkbox = null;
    if (e && e.target) {
        const parent = e.target.closest('.k-check-item');
        if (parent) checkbox = parent.querySelector('input[type="checkbox"]');
    }

    // Fall back to a selector if we lose event context.
    if (!checkbox) {
        checkbox = document.querySelector(`.t-opt[value="${key}"]`);
    }

    // Auto-check the box if it wasn't already selected.
    if(checkbox && !checkbox.checked) {
        checkbox.checked = true;
        gen();
    }

    currentEditKey = key;
    document.getElementById('modal-title').innerText = key;
    document.getElementById('var-modal').style.display = 'flex';
    
    // Detect overlay vs collection.
    const isOverlay = checkbox && checkbox.classList.contains('ovl');
    
    const qsHeader = document.getElementById('qs-header');
    const qsContainer = document.getElementById('qs-container');

    // Reset quick settings visibility.
    document.querySelectorAll('.qs-col').forEach(el => el.style.display = 'none');
    qsHeader.style.display = 'block';
    qsContainer.style.display = 'grid';

    if (isOverlay) {
        // Overlays only show the allowed quick settings.
        const allowedFields = overlaySettingsMap[key];
        
        if (allowedFields && allowedFields.length > 0) {
            allowedFields.forEach(field => {
                // Convert underscores to dashes (e.g. builder_level -> wrapper-qs-builder-level).
                const id = 'wrapper-qs-' + field.replace(/_/g, '-');
                const el = document.getElementById(id);
                if(el) el.style.display = 'block';
            });
        } else {
            // No fields for this overlay, hide quick settings.
            qsHeader.style.display = 'none';
            qsContainer.style.display = 'none';
        }
    } else {
        // Collections show the standard quick settings.
        ['limit', 'sort', 'coll-mode', 'sync-mode', 'include', 'exclude'].forEach(f => {
             const el = document.getElementById('wrapper-qs-' + f);
             if(el) el.style.display = 'block';
        });
    }
    
    // Load existing vars (or empty).
    const vars = templateVars[key] || {};
    
    // Populate values.
    const setVal = (id, val) => { if(document.getElementById(id)) document.getElementById(id).value = val || ''; };
    setVal('qs-limit', vars.limit);
    setVal('qs-sort', vars.sort_by);
    setVal('qs-coll-mode', vars.collection_mode);
    setVal('qs-sync-mode', vars.sync_mode);
    setVal('qs-include', vars.include);
    setVal('qs-exclude', vars.exclude);
    setVal('qs-builder-level', vars.builder_level);
    setVal('qs-addon-position', vars.addon_position);
    setVal('qs-style', vars.style);
    setVal('qs-minimum', vars.minimum);
    setVal('qs-use-subtitles', vars.use_subtitles);

    // Populate custom vars.
    const container = document.getElementById('var-container');
    container.innerHTML = '';
    
    const excludedKeys = [
        'limit', 'sort_by', 'collection_mode', 'sync_mode', 'include', 'exclude', 
        'builder_level', 'addon_position', 'style', 'minimum', 'use_subtitles'
    ];
    
    const customEntries = Object.entries(vars).filter(([k, v]) => !excludedKeys.includes(k));

    if (customEntries.length === 0) {
        addVarRow(); 
    } else {
        customEntries.forEach(([k, v]) => addVarRow(k, v));
    }
}

function addVarRow(k = '', v = '') {
    const div = document.createElement('div');
    div.className = 'var-row';
    div.innerHTML = `
        <input type="text" class="var-input key" placeholder="Variable (e.g. use_year)" value="${k}">
        <input type="text" class="var-input val" placeholder="Value (e.g. true)" value="${v}">
        <button class="btn-remove" onclick="this.parentElement.remove()" style="padding:0 10px;">&times;</button>
    `;
    document.getElementById('var-container').appendChild(div);
}

function saveModal() {
    let data = {};

    // Capture quick settings (only when visible).
    const captureIfVisible = (id, key, isNum=false) => {
        const el = document.getElementById(id);
        // Only save visible fields with values.
        if(el && el.parentElement.style.display !== 'none' && el.value) {
            data[key] = isNum ? Number(el.value) : el.value;
        }
    };

    captureIfVisible('qs-limit', 'limit', true);
    captureIfVisible('qs-sort', 'sort_by');
    captureIfVisible('qs-coll-mode', 'collection_mode');
    captureIfVisible('qs-sync-mode', 'sync_mode');
    captureIfVisible('qs-include', 'include');
    captureIfVisible('qs-exclude', 'exclude');
    captureIfVisible('qs-builder-level', 'builder_level');
    captureIfVisible('qs-addon-position', 'addon_position');
    captureIfVisible('qs-style', 'style');
    captureIfVisible('qs-minimum', 'minimum', true);
    captureIfVisible('qs-use-subtitles', 'use_subtitles');

    // Capture custom rows.
    const rows = document.querySelectorAll('.var-row');
    rows.forEach(r => {
        const k = r.querySelector('.key').value.trim();
        const v = r.querySelector('.val').value.trim();
        if(k) data[k] = isNaN(v) || v === "" ? v : Number(v); // Auto-convert numbers.
    });

    if(Object.keys(data).length > 0) {
        templateVars[currentEditKey] = data;
    } else {
        delete templateVars[currentEditKey];
    }

    closeModal();
    gen(); // Regenerate YAML
}

function closeModal() {
    document.getElementById('var-modal').style.display = 'none';
    currentEditKey = null;
}

// YAML generation
function gen() {
    let y = "";

    // Core settings
    y += `plex:\n`;
    y += `  url: ${esc(document.getElementById('plex_url').value)}\n`;
    y += `  token: ${esc(document.getElementById('plex_token').value)}\n`;
    y += `  timeout: 60\n  clean_bundles: false\n  empty_trash: false\n  optimize: false\n\n`;

    y += `tmdb:\n`;
    y += `  apikey: ${esc(document.getElementById('tmdb_key').value)}\n`;
    y += `  language: en\n  cache_expiration: 60\n  region: US\n\n`;

    // Global settings
    y += `settings:\n`;
    y += `  cache: ${val('s_cache')}\n`;
    y += `  cache_expiration: ${val('s_cache_expiration')}\n`;
    y += `  asset_folders: ${val('s_asset_folders')}\n`;
    y += `  show_missing_assets: ${val('s_show_missing')}\n`;
    y += `  sync_mode: ${val('s_sync_mode')}\n`;
    y += `  minimum_items: ${val('s_minimum_items')}\n`;
    y += `  delete_below_minimum: ${val('s_delete_below_min')}\n`;
    y += `  overlay_artwork_quality: ${val('s_artwork_quality')}\n`;
    
    // Defaults that Kometa expects.
    y += `  asset_directory: config/assets\n  run_order:\n`;
    if(val('s_run_order') === 'collections_first') {
        y += `    - collections\n    - overlays\n    - metadata\n    - operations\n\n`;
    } else {
        y += `    - operations\n    - metadata\n    - collections\n    - overlays\n\n`;
    }

    // Libraries
    y += `libraries:\n`;
    
    // Merge saved libs with current preview.
    let allLibs = JSON.parse(JSON.stringify(libraries)); 
    const currentName = document.getElementById('temp_lib_name')?.value;

    if (currentName) {
        let currentCols = [];
        let currentOvls = [];
        document.querySelectorAll('.t-opt:checked').forEach(cb => {
            if (!cb.parentElement.parentElement.classList.contains('hidden')) {
                if(cb.classList.contains('ovl')) currentOvls.push(cb.value);
                else currentCols.push(cb.value);
            }
        });

        if (currentCols.length > 0 || currentOvls.length > 0) {
            const idx = allLibs.findIndex(l => l.name === currentName);
            const newObj = { name: currentName, cols: currentCols, ovls: currentOvls };
            if (idx > -1) allLibs[idx] = newObj;
            else allLibs.push(newObj);
        }
    }

    if (allLibs.length === 0) {
        y += `  # Add a library in Tab 3 to see config...`;
    } else {
        allLibs.forEach(l => {
            y += `  ${l.name}:\n`;
            if (l.cols.length > 0) {
                y += `    collection_files:\n`;
                l.cols.forEach(c => {
                    if (templateVars[c] && Object.keys(templateVars[c]).length > 0) {
                        y += `      - default: ${c}\n`;
                        y += `        template_variables:\n`;
                        Object.entries(templateVars[c]).forEach(([k, v]) => {
                            // Special handling for list-based variables.
                            if (k === 'include' || k === 'exclude') {
                                y += `          ${k}:\n`;
                                // Ensure value is treated as a list.
                                String(v).split(',').forEach(item => {
                                    const val = item.trim();
                                    if(val) y += `            - ${val}\n`;
                                });
                            } else {
                                y += `          ${k}: ${v}\n`;
                            }
                        });
                    } else {
                        y += `      - default: ${c}\n`;
                    }
                });
            }
            if (l.ovls.length > 0) {
                y += `    overlay_files:\n`;
                l.ovls.forEach(o => {
                    if (templateVars[o] && Object.keys(templateVars[o]).length > 0) {
                        y += `      - default: ${o}\n`;
                        y += `        template_variables:\n`;
                        Object.entries(templateVars[o]).forEach(([k, v]) => {
                            if (k === 'include' || k === 'exclude') {
                                y += `          ${k}:\n`;
                                String(v).split(',').forEach(item => {
                                    const val = item.trim();
                                    if(val) y += `            - ${val}\n`;
                                });
                            } else {
                                y += `          ${k}: ${v}\n`;
                            }
                        });
                    } else {
                        y += `      - default: ${o}\n`;
                    }
                });
            }
        });
    }

    document.getElementById('output').innerHTML = y;
}

// Small helpers
function esc(str) { return str ? str : "INSERT_HERE"; }
function val(id) { 
    const el = document.getElementById(id);
    return el ? el.value : ''; 
}

// Save progress
function saveProgress() {
    const btn = document.querySelector('button[onclick="saveProgress()"]');
    const oldText = btn.innerText;
    btn.innerText = "Saving...";
    btn.disabled = true;

    // Capture settings inputs.
    const currentSettings = {
        cache: val('s_cache'),
        cache_expiration: val('s_cache_expiration'),
        asset_folders: val('s_asset_folders'),
        show_missing: val('s_show_missing'),
        sync_mode: val('s_sync_mode'),
        delete_below_min: val('s_delete_below_min'),
        minimum_items: val('s_minimum_items'),
        artwork_quality: val('s_artwork_quality'),
        run_order: val('s_run_order')
    };

    const payload = {
        libraries: libraries,
        settings: currentSettings, // Save the new settings object.
        plex_url: document.getElementById('plex_url').value,
        plex_token: document.getElementById('plex_token').value,
        tmdb_key: document.getElementById('tmdb_key').value
    };

    fetch('/save_kometa_config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        btn.innerText = "Saved âœ…";
        setTimeout(() => { btn.innerText = oldText; btn.disabled = false; }, 2000);
    })
    .catch(e => {
        alert("Connection Error");
        btn.innerText = oldText;
        btn.disabled = false;
    });
}

// Fetch libraries
function fetchLibs() {
    const select = document.getElementById('temp_lib_name');
    select.innerHTML = '<option disabled selected>Loading...</option>';
    
    fetch('/get_plex_libraries')
        .then(r => r.json())
        .then(data => {
            if(data.status === 'success') {
                let html = '<option value="" disabled selected>Select a Library...</option>';
                data.libraries.forEach(l => {
                    html += `<option value="${l.name}" data-type="${l.type}">${l.name} (${l.type})</option>`;
                });
                select.innerHTML = html;
            } else {
                select.innerHTML = '<option disabled>Error: ' + data.message + '</option>';
            }
            toggleOptions(); 
        })
        .catch(e => {
            select.innerHTML = '<option disabled>Connection Failed</option>';
            toggleOptions();
        });
}

function autoSelectType() {
    const select = document.getElementById('temp_lib_name');
    const selectedOption = select.options[select.selectedIndex];
    const type = selectedOption.getAttribute('data-type');
    if (type) {
        document.getElementById('temp_lib_type').value = type;
        filterOpts(); 
        gen();
    }
}

function filterOpts() {
    const type = document.getElementById('temp_lib_type').value;
    document.querySelectorAll('.k-check-item').forEach(el => {
        if (el.classList.contains('type-all')) { el.classList.remove('hidden'); return; }
        if (type === 'movie' && el.classList.contains('type-movie')) el.classList.remove('hidden');
        else if ((type === 'tv' || type === 'anime') && el.classList.contains('type-tv')) el.classList.remove('hidden');
        else el.classList.add('hidden');
    });
}

function addLibrary() {
    const name = document.getElementById('temp_lib_name').value || "Library";
    const type = document.getElementById('temp_lib_type').value;
    
    let cols = [];
    let ovls = [];
    document.querySelectorAll('.t-opt:checked').forEach(cb => {
        if (cb.parentElement.parentElement.classList.contains('hidden')) return;
        if(cb.classList.contains('ovl')) ovls.push(cb.value);
        else cols.push(cb.value);
    });

    const existingIdx = libraries.findIndex(l => l.name === name);
    if (existingIdx > -1) {
        libraries[existingIdx] = { name, type, cols, ovls };
    } else {
        libraries.push({ name, type, cols, ovls });
    }

    renderLibs();
    gen();
    
    document.getElementById('temp_lib_name').value = "";
    document.querySelectorAll('.t-opt').forEach(cb => cb.checked = false);
    toggleOptions();
}

function editLib(idx) {
    const lib = libraries[idx];
    const select = document.getElementById('temp_lib_name');
    
    select.value = lib.name;
    if(select.selectedIndex === -1) {
       const opt = document.createElement('option');
       opt.value = lib.name;
       opt.text = lib.name + " (Saved)";
       opt.setAttribute('data-type', lib.type);
       select.add(opt);
       select.value = lib.name;
    }
    
    document.getElementById('temp_lib_type').value = lib.type;
    toggleOptions(); 
    filterOpts();

    document.querySelectorAll('.t-opt').forEach(cb => cb.checked = false);
    [...lib.cols, ...lib.ovls].forEach(val => {
        const cb = document.querySelector(`.t-opt[value="${val}"]`);
        if (cb) cb.checked = true;
    });

    document.getElementById('tab-libraries').scrollIntoView({behavior: 'smooth'});
    document.getElementById('btn-action').innerText = "ğŸ’¾ Update Library";
}

function removeLib(idx) {
    if(confirm("Remove this library?")) {
        libraries.splice(idx, 1);
        renderLibs();
        gen();
    }
}

function renderLibs() {
    const div = document.getElementById('added-libs-container');
    if (libraries.length === 0) {
        div.innerHTML = '<div style="text-align:center; color:#555; font-size:0.9em; padding:10px;">No libraries added yet.</div>';
        return;
    }
    let html = '';
    libraries.forEach((l, idx) => {
        html += `<div class="lib-item">
            <div><span>${l.name}</span> <small>(${l.type})</small></div>
            <div class="btn-group">
                <button class="btn-edit" onclick="editLib(${idx})">Edit</button>
                <button class="btn-remove" onclick="removeLib(${idx})">Remove</button>
            </div>
        </div>`;
    });
    div.innerHTML = html;
}

function copyYaml() {
    const text = document.getElementById('output').innerText;
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.position = "fixed";
    textArea.style.left = "-9999px";
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    try {
        const successful = document.execCommand('copy');
        if(successful) alert("Copied config.yml to clipboard!");
        else alert("Copy failed. Please select text manually.");
    } catch (err) { alert("Copy failed."); }
    document.body.removeChild(textArea);
}

// Bootstrapping
document.addEventListener('DOMContentLoaded', () => { 
    // Populate settings from saved state.
    if (globalSettings) {
        const setVal = (id, v) => { if(document.getElementById(id) && v !== undefined) document.getElementById(id).value = v; };
        
        setVal('s_cache', globalSettings.cache);
        setVal('s_cache_expiration', globalSettings.cache_expiration);
        setVal('s_asset_folders', globalSettings.asset_folders);
        setVal('s_show_missing', globalSettings.show_missing);
        setVal('s_sync_mode', globalSettings.sync_mode);
        setVal('s_delete_below_min', globalSettings.delete_below_min);
        setVal('s_minimum_items', globalSettings.minimum_items);
        setVal('s_artwork_quality', globalSettings.artwork_quality);
        setVal('s_run_order', globalSettings.run_order);
    }

    fetchLibs(); 
    renderLibs();
    gen();
    toggleOptions();
});
</script>
{% endblock %}