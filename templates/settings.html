{% extends "base.html" %}
{% block page_title %}Settings{% endblock %}
{% block content %}

<div class="settings-container">
    <div class="settings-header">
        <h2>Configuration</h2>
        <p class="text-muted">Manage your connections, automation engines, and system preferences.</p>
    </div>
    
    <div id="save-toast">
        <i class="fas fa-check-circle"></i> Saved
    </div>

    <div class="settings-tabs">
        <button type="button" class="tab-link active" onclick="openTab(event, 'tab-apis')">APIs & Connections</button>
        <button type="button" class="tab-link" onclick="openTab(event, 'tab-scanners')">Scanners & memory</button>
        <button type="button" class="tab-link" onclick="openTab(event, 'tab-system')">System & Maintenance</button>
        
        {% if current_user.is_admin %}
        <button type="button" class="tab-link" onclick="openTab(event, 'tab-users'); loadUsers();">User Management</button>
        {% endif %}
    </div>

{% if current_user.is_admin %}
<div id="tab-users" class="tab-content">
    <div class="card setting-card border-purple">
        <h3>Manage Users</h3>
        <p class="text-muted">Grant admin privileges or remove users from the system.</p>
        
        <div id="user-list-container" class="logs-table-container" style="border:none; max-height:none;">
            <div class="text-center" style="padding:20px;">Loading users...</div>
        </div>
    </div>
</div>

<script>
const BACKUP_DOWNLOAD_URL_PREFIX = "{{ url_for('api.download_backup', filename='') }}";
const API_ADMIN_USERS = "{{ url_for('api.get_all_users') }}";
const API_ADMIN_TOGGLE_ROLE = "{{ url_for('api.toggle_user_role') }}";
const API_ADMIN_DELETE_USER = "{{ url_for('api.admin_delete_user') }}";
const API_ADMIN_RESET_PASSWORD = "{{ url_for('api.admin_reset_password') }}";
const API_CHANGE_PASSWORD = "{{ url_for('api.change_my_password') }}";
const API_RECOVERY_CODES_GENERATE = "{{ url_for('api.generate_recovery_codes') }}";
const SETTINGS_CSRF = "{{ csrf_token() }}";
const SETTINGS_SAVE_URL = "{{ url_for('settings') }}";
const API_SCANNER_STATUS = "{{ url_for('api.scanner_status') }}";
const API_SCANNER_SAVE = "{{ url_for('api.save_scanner_settings') }}";
const API_SCANNER_RESET = "{{ url_for('api.reset_scanner') }}";
const API_GET_RADARR_SONARR_CACHE_STATUS = "{{ url_for('api.get_radarr_sonarr_cache_status_route') }}";
const API_SAVE_CACHE_SETTINGS = "{{ url_for('api.save_cache_settings') }}";
const API_FORCE_CACHE_REFRESH = "{{ url_for('api.force_cache_refresh_route') }}";
const API_GET_CACHE_STATUS = "{{ url_for('api.get_cache_status_route') }}";
const API_FORCE_RADARR_SONARR_CACHE_REFRESH = "{{ url_for('api.force_radarr_sonarr_cache_refresh_route') }}";
const API_RADARR_SONARR_SCANNER_SAVE = "{{ url_for('api.save_radarr_sonarr_scanner_settings') }}";
const API_TEST_CONNECTION = "{{ url_for('api.test_connection') }}";
const API_PLEX_PIN_CREATE = "{{ url_for('api.plex_pin_create') }}";
const API_PLEX_PIN_POLL = "{{ url_for('api.plex_pin_poll') }}";
const API_PLEX_LIBRARY_SYNC = "{{ url_for('api.plex_library_sync') }}";
const API_PLEX_UNLINK = "{{ url_for('api.plex_unlink') }}";
const API_PLEX_SET_URL = "{{ url_for('api.plex_set_url') }}";
const API_PLEX_CONNECTIONS = "{{ url_for('api.plex_connections') }}";
const API_UPDATE_IGNORE_LIST = "{{ url_for('api.update_ignore_list') }}";
const API_BACKUPS = "{{ url_for('api.get_backups_api') }}";
const API_BACKUP_CREATE = "{{ url_for('api.trigger_backup') }}";
const API_BACKUP_DELETE_BASE = "{{ url_for('api.delete_backup_api', filename='') }}";
const API_BACKUP_RESTORE_BASE = "{{ url_for('api.run_restore', filename='') }}";
const API_BACKUP_UPLOAD = "{{ url_for('api.upload_backup') }}";
function loadUsers() {
    fetch(API_ADMIN_USERS)
    .then(r => r.json())
    .then(users => {
        if(users.error) return;
        
        const container = document.getElementById('user-list-container');
        if(users.length === 0) {
            container.innerHTML = "No users found.";
            return;
        }
        
        let html = '<table class="logs-table">';
        html += '<thead><tr><th>Username</th><th>Role</th><th class="text-right">Actions</th></tr></thead><tbody>';
        
        users.forEach(u => {
            const roleColor = u.is_admin ? '#2ecc71' : '#777';
            const roleText = u.is_admin ? 'üõ°Ô∏è Admin' : 'üë§ User';
            const disableSelf = u.is_current ? 'disabled style="opacity:0.5; cursor:not-allowed;"' : '';
            const safeName = escapeHtml(String(u.username || ''));
            const safeNameAttr = String(u.username || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/</g, '').replace(/>/g, '');
            html += `
            <tr>
                <td style="font-weight:bold; color:white;">${safeName} ${u.is_current ? '(You)' : ''}</td>
                <td style="color:${roleColor};">${roleText}</td>
                <td class="text-right">
                    <button onclick="openResetPasswordModal(${u.id}, '${safeNameAttr}')" class="btn-secondary" ${disableSelf} title="Set new password for this user" style="padding: 4px 10px; font-size: 0.8em;">
                        üîë Reset password
                    </button>
                    <button onclick="toggleRole(${u.id})" class="btn-secondary" ${disableSelf} title="Toggle Admin Status" style="margin-left:6px; padding: 4px 10px; font-size: 0.8em;">
                        ${u.is_admin ? 'Demote ‚ñº' : 'Promote ‚ñ≤'}
                    </button>
                    <button onclick="deleteUser(${u.id}, '${safeNameAttr}')" class="btn-delete" ${disableSelf} style="margin-left:6px; padding: 4px 10px; font-size: 0.8em;">
                        üóëÔ∏è
                    </button>
                </td>
            </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    });
}

function toggleRole(id) {
    fetch(API_ADMIN_TOGGLE_ROLE, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({user_id: id})
    }).then(r => r.json()).then(d => {
        if(d.status === 'success') loadUsers();
        else alert(d.message);
    });
}

function deleteUser(id, name) {
    if(!confirm(`Are you sure you want to delete user "${name}"? This will delete their settings and blocklists.`)) return;
    
    fetch(API_ADMIN_DELETE_USER, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({user_id: id})
    }).then(r => r.json()).then(d => {
        if(d.status === 'success') loadUsers();
        else alert(d.message);
    });
}

// admin reset password modal
let resetPasswordUserId = null;
function openResetPasswordModal(userId, username) {
    resetPasswordUserId = userId;
    document.getElementById('reset-password-username').textContent = username;
    var usernameField = document.getElementById('reset-password-username-field');
    if (usernameField) usernameField.value = username || '';
    document.getElementById('reset-password-new').value = '';
    document.getElementById('reset-password-confirm').value = '';
    document.getElementById('modal-reset-password').classList.add('is-open');
}
function closeResetPasswordModal() {
    document.getElementById('modal-reset-password').classList.remove('is-open');
    resetPasswordUserId = null;
}
function submitChangePassword() {
    const currentPw = document.getElementById('change-pw-current').value;
    const newPw = document.getElementById('change-pw-new').value;
    const confirmPw = document.getElementById('change-pw-confirm').value;
    const msgEl = document.getElementById('change-pw-message');
    const btn = document.getElementById('btn-change-password');
    msgEl.textContent = '';
    msgEl.style.color = '';
    if (!currentPw) { msgEl.textContent = 'Enter your current password.'; msgEl.style.color = '#e74c3c'; return; }
    if (newPw.length < 8) { msgEl.textContent = 'New password must be at least 8 characters.'; msgEl.style.color = '#e74c3c'; return; }
    if (newPw !== confirmPw) { msgEl.textContent = 'New password and confirmation do not match.'; msgEl.style.color = '#e74c3c'; return; }
    btn.disabled = true;
    fetch(API_CHANGE_PASSWORD, {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': SETTINGS_CSRF},
        body: JSON.stringify({ current_password: currentPw, new_password: newPw })
    }).then(r => r.json()).then(d => {
        btn.disabled = false;
        if (d.status === 'success') {
            msgEl.textContent = d.message || 'Password updated.';
            msgEl.style.color = '#2ecc71';
            document.getElementById('change-pw-current').value = '';
            document.getElementById('change-pw-new').value = '';
            document.getElementById('change-pw-confirm').value = '';
        } else {
            msgEl.textContent = d.message || 'Failed to change password.';
            msgEl.style.color = '#e74c3c';
        }
    }).catch(() => { btn.disabled = false; msgEl.textContent = 'Request failed.'; msgEl.style.color = '#e74c3c'; });
}

function submitResetPassword() {
    const newPw = document.getElementById('reset-password-new').value;
    const confirmPw = document.getElementById('reset-password-confirm').value;
    if (newPw.length < 8) { alert('Password must be at least 8 characters.'); return; }
    if (newPw !== confirmPw) { alert('Passwords do not match.'); return; }
    const btn = document.getElementById('reset-password-submit-btn');
    btn.disabled = true;
    fetch(API_ADMIN_RESET_PASSWORD, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ user_id: resetPasswordUserId, new_password: newPw })
    }).then(r => r.json()).then(d => {
        btn.disabled = false;
        if (d.status === 'success') { closeResetPasswordModal(); loadUsers(); alert(d.message); }
        else alert(d.message);
    }).catch(() => { btn.disabled = false; alert('Request failed.'); });
}

// recovery codes: generate and show once
function generateRecoveryCodes() {
    const btn = document.getElementById('btn-generate-codes');
    if (btn) btn.disabled = true;
    fetch(API_RECOVERY_CODES_GENERATE, { method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': SETTINGS_CSRF} })
    .then(r => r.json())
    .then(d => {
        if (btn) btn.disabled = false;
        if (d.status === 'success' && d.codes && d.codes.length) {
            document.getElementById('recovery-codes-list').textContent = d.codes.join('\n');
            document.getElementById('modal-recovery-codes').classList.add('is-open');
        } else alert(d.message || 'Failed to generate codes.');
    })
    .catch(() => { if (btn) btn.disabled = false; alert('Request failed.'); });
}
function closeRecoveryCodesModal() {
    document.getElementById('modal-recovery-codes').classList.remove('is-open');
}
function copyRecoveryCodes() {
    const el = document.getElementById('recovery-codes-list');
    if (!el) return;
    var text = (el.textContent || el.innerText || '').trim();
    if (!text) { alert('No codes to copy.'); return; }
    function showCopied() { alert('Copied to clipboard.'); }
    function tryFallback() {
        try {
            var sel = window.getSelection();
            var range = document.createRange();
            range.selectNodeContents(el);
            sel.removeAllRanges();
            sel.addRange(range);
            var ok = document.execCommand('copy');
            sel.removeAllRanges();
            if (ok) showCopied();
            else alert('Copy failed. Select the codes and copy manually.');
        } catch (e) { alert('Copy failed. Select the codes and copy manually.'); }
    }
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(showCopied).catch(tryFallback);
    } else {
        tryFallback();
    }
}

</script>
{% endif %}

    <div class="settings-save-bar" style="margin-bottom: 20px; padding: 12px 0; border-bottom: 1px solid #333;">
        <button type="button" class="btn-save" id="main-save-btn" data-save-label="Save" onclick="submitActiveSettingsForm()">Save</button>
    </div>
    <!-- APIs tab DOM rules (avoids Chrome DOM warnings):
      - Container: #tab-apis must be a <div>, never a <form> (no nested forms).
      - One form = one action: each logical "service" (Plex, Metadata APIs, Overseerr, Tautulli, Radarr, Sonarr) is exactly one <form>. Do not put multiple services in one form.
      - Password forms: every <form> that contains a password/API-key input must start with a visually-hidden <input name="username" autocomplete="username"> so Chrome's "password form should have username" is satisfied.
      - Each form: onsubmit="return false;" autocomplete="off". Save uses submitActiveSettingsForm() + fetch (collects all inputs in the active tab). -->
    <section aria-label="APIs and connections" style="margin-bottom: 0;">
        <div id="tab-apis" class="tab-content active" data-settings-section="apis">
            {% if server_host %}
            <div id="auto-fill-banner" class="card" style="margin-bottom: 20px; border-left: 4px solid var(--accent-color); background: rgba(0, 204, 102, 0.1); display: none;">
                <div class="d-flex flex-between" style="align-items: flex-start;">
                    <div style="flex: 1;">
                        <h4 style="margin: 0 0 8px 0; color: var(--accent-color);">üîß Auto-Fill Available</h4>
                        <p style="margin: 0; color: #ccc; font-size: 0.9em; line-height: 1.5;">
                            We detected your server IP (<code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 3px;">{{ server_host }}</code>) and can auto-fill API URLs with default ports. 
                            This is based on the URL you're accessing SeekAndWatch from. Only empty fields will be filled.
                        </p>
                    </div>
                    <div style="display: flex; gap: 10px; margin-left: 15px; flex-shrink: 0;">
                        <button type="button" onclick="acceptAutoFill()" class="btn-primary" style="padding: 8px 16px; font-size: 0.9em;">Accept ‚úì</button>
                        <button type="button" onclick="dismissAutoFill()" class="btn-secondary" style="padding: 8px 16px; font-size: 0.9em;">Dismiss ‚úï</button>
                    </div>
                </div>
            </div>
            {% endif %}
            <form class="card setting-card border-orange" onsubmit="return false;" autocomplete="off">
                <input type="text" name="username" autocomplete="username" tabindex="-1" aria-hidden="true" style="position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0;">
                <h3>Plex Integration</h3>
                <p class="text-muted small" style="margin-top: 0; margin-bottom: 12px;">Link your Plex account (like SeekAndWatch Cloud) to get a token via API. Use <b>Sync library now</b> below to import your Plex movie/TV library into the app.</p>
                {% if settings.plex_url and settings.plex_token %}
                <p id="plex-link-status" style="margin: 0 0 16px 0; padding: 10px 14px; background: rgba(0, 204, 102, 0.15); border: 1px solid rgba(0, 204, 102, 0.5); border-radius: 8px; color: var(--accent-color); font-weight: bold;">
                    ‚úì Plex account connected
                </p>
                {% else %}
                <p id="plex-link-status" style="margin: 0 0 16px 0; padding: 10px 14px; background: rgba(128,128,128,0.15); border: 1px solid rgba(128,128,128,0.4); border-radius: 8px; color: #999; font-size: 0.95em;">
                    Plex not connected - link below or enter URL &amp; token
                </p>
                {% endif %}
                <div id="plex-pin-box" style="display: none; margin-bottom: 16px; padding: 14px; background: rgba(0,0,0,0.3); border-radius: 8px; border: 1px solid rgba(255,165,0,0.4);">
                    <div id="plex-pin-step-code">
                        <div style="font-weight: bold; margin-bottom: 6px; color: var(--text-color, #e0e0e0);">Enter this code at <a href="https://plex.tv/link" target="_blank" rel="noopener" style="color: var(--accent-color);">plex.tv/link</a>:</div>
                        <div id="plex-pin-code" style="font-size: 1.8em; letter-spacing: 0.35em; margin-bottom: 8px; font-weight: bold; color: #fff; background: rgba(0, 204, 102, 0.25); padding: 12px 16px; border-radius: 6px; display: inline-block; min-width: 120px; text-align: center;" aria-live="polite"></div>
                        <div id="plex-pin-msg" style="color: #aaa; font-size: 0.9em;">Waiting for you to authorize‚Ä¶</div>
                    </div>
                    <div id="plex-pin-step-server" style="display: none;">
                        <div style="font-weight: bold; margin-bottom: 8px; color: var(--text-color, #e0e0e0);">Select your Plex server (local suggested)</div>
                        <p class="text-muted small" style="margin: 0 0 10px 0;">Choose which address to use. Local connections usually work best from this machine.</p>
                        <select id="plex-server-select" style="width: 100%; max-width: 480px; padding: 10px; background: #111; color: #fff; border: 1px solid #444; border-radius: 6px; margin-bottom: 10px;"></select>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button type="button" id="btn-plex-use-server" class="btn-primary" style="padding: 8px 16px;">Use this server</button>
                            <button type="button" id="btn-plex-skip-server" class="btn-secondary" style="padding: 8px 16px;">Skip - enter URL below</button>
                        </div>
                    </div>
                </div>
                <div style="margin-bottom: 16px;">
                    <button type="button" id="btn-link-plex" class="btn-primary" style="padding: 8px 16px;" data-plex-linked="{{ 'true' if (settings.plex_url and settings.plex_token) else 'false' }}">{% if settings.plex_url and settings.plex_token %}Unlink Plex account{% else %}Link Plex account{% endif %}</button>
                    <p class="text-muted small" style="margin: 10px 0 0 0;">Set or change the URL and token below. Both are used to connect to your Plex server.</p>
                </div>
                <details class="help-box">
                    <summary>Where are these found?</summary>
                    <p style="margin: 0 0 10px 0;">You can use <strong>Link Plex account</strong> (auto) or enter the URL and token manually below.</p>
                    <p style="margin: 0 0 8px 0;"><b>URL:</b> Your server's local IP (e.g. <code>http://192.168.1.50:32400</code>).</p>
                    <p style="margin: 0 0 10px 0;"><b>Token:</b> <a href="https://support.plex.tv/articles/204059436-finding-an-authentication-token-x-plex-token/" target="_blank" style="color: var(--accent-color); text-decoration: underline;">View Official Guide</a>.</p>
                    <p style="margin: 0 0 6px 0;"><b>Auto adder:</b> After you authorize at plex.tv/link, we get a list of connection URLs from Plex. You may see many options because the same server can appear as a local IP, a relay address (.plex.direct), or different network interfaces. <strong>Pick the one that matches your situation:</strong> if this app runs on the same network as Plex, choose the <strong>local IP</strong> (e.g. 192.168.x.x). It is usually the fastest and most reliable. Use relay or a remote URL only if you are not on the same LAN.</p>
                </details>

                <div class="input-group" id="plex-server-dropdown-row" style="{% if not settings.plex_token %}display: none;{% endif %} margin-top: 16px;">
                    <label class="input-label">Server</label>
                    <p class="text-muted small" style="margin: 4px 0 8px 0;">Choose a connection. Use <strong>[local IP] - recommended</strong> when on the same network as Plex.</p>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <select id="plex-server-select-persistent" style="flex: 1; min-width: 280px; padding: 10px; background: #111; color: #fff; border: 1px solid #444; border-radius: 6px;">
                            <option value="">{% if settings.plex_token %}Loading‚Ä¶{% else %}-{% endif %}</option>
                        </select>
                        <button type="button" id="btn-plex-refresh-servers" class="btn-secondary" style="padding: 8px 14px;">Refresh</button>
                        <button type="button" id="btn-plex-apply-server" class="btn-primary" style="padding: 8px 14px;">Use selected</button>
                    </div>
                </div>

                <div class="input-group">
                    <label class="input-label">Plex Local URL <span style="color: var(--error);">*Required</span></label>
                    <input type="text" id="plex_url" name="plex_url" value="{{ settings.plex_url or '' }}" placeholder="http://192.168.1.50:32400" autocomplete="off">
                </div>
                
                <div class="input-group">
                    <label class="input-label">Plex Token {% if settings.plex_token %}<span class="key-saved-badge">Saved</span>{% endif %}</label>
                    <div style="display: flex; gap: 10px;">
                        <div class="password-wrapper">
                            <input type="password" id="plex_token" name="plex_token" value="" placeholder="{% if settings.plex_token %}‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢{% else %}Paste token{% endif %}" {% if settings.plex_token %}data-key-set="1"{% endif %} autocomplete="off" style="width: 100%; padding-right: 40px;">
                            {% if settings.plex_token %}<input type="hidden" name="plex_token_unchanged" value="1" id="plex_token_unchanged_h">{% endif %}
                            <button type="button" class="toggle-pass" onclick="toggleVisibility('plex_token', this)">üëÅÔ∏è</button>
                            <button type="button" class="clear-field-btn" onclick="clearPasswordField('plex_token', 'plex_token_unchanged_h')" title="Clear field (use if backspace doesn't work)">Clear</button>
                        </div>
                        <button type="button" onclick="testService('plex')" class="btn-secondary">Test</button>
                    </div>
                </div>

                <div class="input-group" style="margin-top: 12px;">
                    <label class="input-label">Import library</label>
                    <p class="text-muted small" style="margin: 0 0 8px 0;">Sync your Plex movie/TV library into the app index (like SeekAndWatch Cloud ‚ÄúSync from Plex now‚Äù). Large libraries (5000+) can take several minutes; TMDB API key required.</p>
                    <div class="plex-sync-stats">
                        <div style="font-size: 0.9em; color: #888;">Last synced: <span id="last-updated" style="color: var(--text-color); font-weight: bold;">{{ cache_age }}</span></div>
                        <div style="font-size: 0.9em; color: #888;">Items found: <span style="color: var(--text-color); font-weight: bold;">{{ alias_count|default(0) }}</span></div>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-bottom: 12px;">
                        <button type="button" id="btn-force" onclick="syncPlexLibrary()" class="btn-secondary">Sync library now</button>
                        <span id="plex-sync-library-msg" style="font-size: 0.9em; color: #888;"></span>
                    </div>
                    <div class="plex-sync-interval-row">
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 0.95em; color: var(--text-color, #e0e0e0);">
                            <input type="checkbox" id="plex-auto-sync" {% if settings.cache_interval and settings.cache_interval > 0 %}checked{% endif %}>
                            Sync library automatically
                        </label>
                        <select id="cache-interval" class="cache-interval-select">
                            <option value="12" {% if settings.cache_interval == 12 %}selected{% endif %}>Every 12 hours</option>
                            <option value="24" {% if not settings.cache_interval or settings.cache_interval == 24 %}selected{% endif %}>Every 24 hours</option>
                            <option value="48" {% if settings.cache_interval == 48 %}selected{% endif %}>Every 48 hours</option>
                            <option value="168" {% if settings.cache_interval == 168 %}selected{% endif %}>Weekly</option>
                        </select>
                        <button type="button" onclick="saveCacheSetting()" class="btn-primary">Save</button>
                    </div>
                </div>

                {% if plex_users %}
                <div class="info-panel" style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;">
                    <label class="ignore-label">üõ°Ô∏è Ignore History From:</label>
                    <div class="ignore-grid">
                        {% for user in plex_users %}
                        <label class="ignore-check-label">
                            <input type="checkbox" name="ignored_plex_users" value="{{ user }}" {% if user in current_ignored %}checked{% endif %}>
                            {{ user }}
                        </label>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </form>
            <form class="card setting-card border-green" onsubmit="return false;" autocomplete="off">
                <input type="text" name="username" autocomplete="username" tabindex="-1" aria-hidden="true" style="position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0;">
                <h3>Metadata APIs</h3>

                <div class="input-group">
                    <label class="input-label">TMDB API Key (v3) {% if settings.tmdb_key %}<span class="key-saved-badge">Saved</span>{% endif %} <span style="color: var(--error);">*Required</span></label>
                    <details class="help-box">
                        <summary>Where is this key found?</summary>
                        <ol style="line-height: 1.6; margin-bottom: 8px;">
                            <li>Create a free account at <a href="https://www.themoviedb.org/signup" target="_blank" style="color: var(--accent-color); text-decoration: underline;">themoviedb.org</a></li>
                            <li>Go to <b>Settings -> API</b> and request an API key (choose "Developer" and accept the terms)</li>
                            <li>Copy the <b>API Key (v3 auth)</b> and paste it above</li>
                        </ol>
                        <p style="margin: 0; color: #888; font-size: 0.9em;">üí° The API key is free and takes about 30 seconds to generate.</p>
                    </details>
                    <div class="test-row">
                        <div class="password-wrapper">
                            <input type="password" id="tmdb_key" name="tmdb_key" value="" placeholder="{% if settings.tmdb_key %}‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢{% else %}Paste API key{% endif %}" {% if settings.tmdb_key %}data-key-set="1"{% endif %} autocomplete="new-password">
                            {% if settings.tmdb_key %}<input type="hidden" name="tmdb_key_unchanged" value="1" id="tmdb_key_unchanged_h">{% endif %}
                            <button type="button" class="toggle-pass" onclick="toggleVisibility('tmdb_key', this)">üëÅÔ∏è</button>
                            <button type="button" class="clear-field-btn" onclick="clearPasswordField('tmdb_key', 'tmdb_key_unchanged_h')" title="Clear field (use if backspace doesn't work)">Clear</button>
                        </div>
                        <button type="button" onclick="testService('tmdb')" class="btn-secondary">Test</button>
                    </div>
                </div>

                <div class="input-group" style="border: 1px dashed #2ecc71; padding: 15px; border-radius: 8px; background: rgba(46, 204, 113, 0.05);">
                    <label class="input-label">OMDB API Key (Critics Scores) {% if settings.omdb_key %}<span class="key-saved-badge">Saved</span>{% endif %}</label>
                    <p class="helper-text">Required to filter by Rotten Tomatoes scores.</p>
                    <details class="help-box">
                        <summary>Where is this key found?</summary>
                        <ol>
                            <li>Visit <a href="https://www.omdbapi.com/apikey.aspx" target="_blank" style="color: var(--accent-color); text-decoration: underline;">omdbapi.com/apikey</a>.</li>
                            <li>Choose the free tier and submit your email.</li>
                            <li>Use the key emailed to you and paste it here.</li>
                        </ol>
                    </details>
                    <div class="test-row">
                        <div class="password-wrapper">
                            <input type="password" id="omdb_key" name="omdb_key" value="" placeholder="{% if settings.omdb_key %}‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢{% else %}xxxxxx{% endif %}" {% if settings.omdb_key %}data-key-set="1"{% endif %} autocomplete="off">
                            {% if settings.omdb_key %}<input type="hidden" name="omdb_key_unchanged" value="1" id="omdb_key_unchanged_h">{% endif %}
                            <button type="button" class="toggle-pass" onclick="toggleVisibility('omdb_key', this)">üëÅÔ∏è</button>
                            <button type="button" class="clear-field-btn" onclick="clearPasswordField('omdb_key', 'omdb_key_unchanged_h')" title="Clear field (use if backspace doesn't work)">Clear</button>
                        </div>
                        <button type="button" onclick="testService('omdb')" class="btn-secondary">Test</button>
                    </div>
                </div>

                <div class="input-group">
                    <label class="input-label">Streaming Regions</label>
                    <input type="text" id="tmdb_region" name="tmdb_region" value="{{ settings.tmdb_region or 'US' }}" placeholder="US, CA" autocomplete="off">
                    <p class="helper-text">Comma separated ISO codes (e.g. <code>US, CA, GB</code>).</p>
                </div>
            </form>
            <div class="card setting-card border-purple">
                <h3>Overseerr & Tautulli</h3>
                <form onsubmit="return false;" autocomplete="off" style="margin-bottom: 24px;">
                    <input type="text" name="username" autocomplete="username" tabindex="-1" aria-hidden="true" style="position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0;">
                    <div class="input-group">
                        <label class="input-label">Overseerr URL</label>
                        <input type="text" id="overseerr_url" name="overseerr_url" value="{{ settings.overseerr_url or '' }}" placeholder="http://192.168.1.50:5055" autocomplete="off">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Overseerr API Key {% if settings.overseerr_api_key %}<span class="key-saved-badge">Saved</span>{% endif %}</label>
                        <details class="help-box">
                            <summary>Where is this key found?</summary>
                            <ol>
                                <li>Open Overseerr and go to <b>Settings</b>.</li>
                                <li>Under <b>General</b>, copy the <b>API Key</b>.</li>
                                <li>Paste it here and click Test.</li>
                            </ol>
                        </details>
                        <div style="display: flex; gap: 10px;">
                            <div class="password-wrapper">
                                <input type="password" id="overseerr_api_key" name="overseerr_api_key" value="" placeholder="{% if settings.overseerr_api_key %}‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢{% else %}Paste API key{% endif %}" {% if settings.overseerr_api_key %}data-key-set="1"{% endif %} autocomplete="new-password" style="width: 100%; padding-right: 40px;">
                                {% if settings.overseerr_api_key %}<input type="hidden" name="overseerr_api_key_unchanged" value="1" id="overseerr_api_key_unchanged_h">{% endif %}
                                <button type="button" class="toggle-pass" onclick="toggleVisibility('overseerr_api_key', this)">üëÅÔ∏è</button>
                                <button type="button" class="clear-field-btn" onclick="clearPasswordField('overseerr_api_key', 'overseerr_api_key_unchanged_h')" title="Clear field (use if backspace doesn't work)">Clear</button>
                            </div>
                            <button type="button" onclick="testService('overseerr')" class="btn-secondary">Test</button>
                        </div>
                    </div>
                </form>
                <form onsubmit="return false;" autocomplete="off">
                    <input type="text" name="username" autocomplete="username" tabindex="-1" aria-hidden="true" style="position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0;">
                    <div class="input-group">
                        <label class="input-label">Tautulli URL</label>
                        <input type="text" id="tautulli_url" name="tautulli_url" value="{{ settings.tautulli_url or '' }}" placeholder="http://192.168.1.50:8181" autocomplete="off">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Tautulli API Key {% if settings.tautulli_api_key %}<span class="key-saved-badge">Saved</span>{% endif %}</label>
                        <details class="help-box">
                            <summary>Where is this key found?</summary>
                            <ol>
                                <li>Open Tautulli and go to <b>Settings -> Web Interface</b>.</li>
                                <li>Scroll to <b>API</b> and copy the API Key.</li>
                                <li>Paste it here and click Test.</li>
                            </ol>
                        </details>
                        <div style="display: flex; gap: 10px;">
                            <div class="password-wrapper">
                                <input type="password" id="tautulli_api_key" name="tautulli_api_key" value="" placeholder="{% if settings.tautulli_api_key %}‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢{% else %}Paste API key{% endif %}" {% if settings.tautulli_api_key %}data-key-set="1"{% endif %} autocomplete="off" style="width: 100%; padding-right: 40px;">
                                {% if settings.tautulli_api_key %}<input type="hidden" name="tautulli_api_key_unchanged" value="1" id="tautulli_api_key_unchanged_h">{% endif %}
                                <button type="button" class="toggle-pass" onclick="toggleVisibility('tautulli_api_key', this)">üëÅÔ∏è</button>
                                <button type="button" class="clear-field-btn" onclick="clearPasswordField('tautulli_api_key', 'tautulli_api_key_unchanged_h')" title="Clear field (use if backspace doesn't work)">Clear</button>
                            </div>
                            <button type="button" onclick="testService('tautulli')" class="btn-secondary">Test</button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="card setting-card border-blue">
                <h3>Radarr & Sonarr</h3>
                <form onsubmit="return false;" autocomplete="off" style="margin-bottom: 24px;">
                    <input type="text" name="username" autocomplete="username" tabindex="-1" aria-hidden="true" style="position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0;">
                    <div class="input-group">
                        <label class="input-label">Radarr URL</label>
                        <input type="text" id="radarr_url" name="radarr_url" value="{{ settings.radarr_url or '' }}" placeholder="http://192.168.1.50:7878" autocomplete="off">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Radarr API Key {% if settings.radarr_api_key %}<span class="key-saved-badge">Saved</span>{% endif %}</label>
                        <details class="help-box">
                            <summary>Where is this key found?</summary>
                            <ol>
                                <li>Open Radarr and go to <b>Settings -> General</b>.</li>
                                <li>Scroll to <b>Security</b> and copy the <b>API Key</b>.</li>
                                <li>Paste it here and click Test.</li>
                            </ol>
                        </details>
                        <div style="display: flex; gap: 10px;">
                            <div class="password-wrapper">
                                <input type="password" id="radarr_api_key" name="radarr_api_key" value="" placeholder="{% if settings.radarr_api_key %}‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢{% else %}Paste API key{% endif %}" {% if settings.radarr_api_key %}data-key-set="1"{% endif %} autocomplete="new-password" style="width: 100%; padding-right: 40px;">
                                {% if settings.radarr_api_key %}<input type="hidden" name="radarr_api_key_unchanged" value="1" id="radarr_api_key_unchanged_h">{% endif %}
                                <button type="button" class="toggle-pass" onclick="toggleVisibility('radarr_api_key', this)">üëÅÔ∏è</button>
                                <button type="button" class="clear-field-btn" onclick="clearPasswordField('radarr_api_key', 'radarr_api_key_unchanged_h')" title="Clear field (use if backspace doesn't work)">Clear</button>
                            </div>
                            <button type="button" onclick="testService('radarr')" class="btn-secondary">Test</button>
                        </div>
                    </div>
                </form>
                <form onsubmit="return false;" autocomplete="off">
                    <input type="text" name="username" autocomplete="username" tabindex="-1" aria-hidden="true" style="position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0;">
                    <div class="input-group">
                        <label class="input-label">Sonarr URL</label>
                        <input type="text" id="sonarr_url" name="sonarr_url" value="{{ settings.sonarr_url or '' }}" placeholder="http://192.168.1.50:8989" autocomplete="off">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Sonarr API Key {% if settings.sonarr_api_key %}<span class="key-saved-badge">Saved</span>{% endif %}</label>
                        <details class="help-box">
                            <summary>Where is this key found?</summary>
                            <ol>
                                <li>Open Sonarr and go to <b>Settings -> General</b>.</li>
                                <li>Scroll to <b>Security</b> and copy the <b>API Key</b>.</li>
                                <li>Paste it here and click Test.</li>
                            </ol>
                        </details>
                        <div style="display: flex; gap: 10px;">
                            <div class="password-wrapper">
                                <input type="password" id="sonarr_api_key" name="sonarr_api_key" value="" placeholder="{% if settings.sonarr_api_key %}‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢{% else %}Paste API key{% endif %}" {% if settings.sonarr_api_key %}data-key-set="1"{% endif %} autocomplete="off" style="width: 100%; padding-right: 40px;">
                                {% if settings.sonarr_api_key %}<input type="hidden" name="sonarr_api_key_unchanged" value="1" id="sonarr_api_key_unchanged_h">{% endif %}
                                <button type="button" class="toggle-pass" onclick="toggleVisibility('sonarr_api_key', this)">üëÅÔ∏è</button>
                                <button type="button" class="clear-field-btn" onclick="clearPasswordField('sonarr_api_key', 'sonarr_api_key_unchanged_h')" title="Clear field (use if backspace doesn't work)">Clear</button>
                            </div>
                            <button type="button" onclick="testService('sonarr')" class="btn-secondary">Test</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </section>
    <section aria-label="Scanners and memory" style="margin-bottom: 0;">
        <div id="tab-scanners" class="tab-content" data-settings-section="scanners">
            <fieldset class="settings-fieldset" style="border:none;margin:0;padding:0;min-width:0;">
                <legend class="visually-hidden">Keyword Memory</legend>
            <div class="card setting-card border-blue">
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:15px;">
                    <h3 style="margin:0;">Keyword Memory (Cache)</h3>
                    <span class="settings-count-badge">
                        Stored: <strong>{{ keyword_count }}</strong> / {{ settings.keyword_cache_size or 3000 }}
                    </span>
                </div>
                
                <p class="text-muted small">
                    To save API calls, we store keyword tags (e.g., "zombie", "time travel") in the database.
                    When this limit is reached, the oldest keywords are deleted to make room for new ones.
                </p>

                <div class="input-group" style="margin-bottom: 0;">
                    <label class="input-label">Max Keywords to Store <span style="font-weight:normal; color:#888;">(Recommended: 2000-6000)</span></label>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <input type="number" name="keyword_cache_size" class="form-control" 
                               value="{{ settings.keyword_cache_size or 3000 }}" 
                               min="100" max="6000" step="100" 
                               style="max-width:150px; background:#111; border:1px solid #444; color:white; padding:10px; border-radius:5px;">
                        <span style="color:#aaa; font-size:0.9em;">entries</span>
                    </div>
                </div>
            </div>
            </fieldset>
            <fieldset class="settings-fieldset" style="border:none;margin:0;padding:0;min-width:0;">
                <legend class="visually-hidden">Runtime Memory</legend>
            <div class="card setting-card border-green">
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:15px;">
                    <h3 style="margin:0;">Runtime Memory (Cache)</h3>
                    <span class="settings-count-badge">
                        Stored: <strong>{{ runtime_count }}</strong> / {{ settings.runtime_cache_size or 3000 }}
                    </span>
                </div>
                
                <p class="text-muted small">
                    To save API calls and speed up recommendations, we store movie runtime data in the database.
                    When this limit is reached, the oldest runtime entries are deleted to make room for new ones.
                </p>

                <div class="input-group" style="margin-bottom: 0;">
                    <label class="input-label">Max Runtime Entries to Store <span style="font-weight:normal; color:#888;">(Recommended: 2000-6000)</span></label>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <input type="number" name="runtime_cache_size" class="form-control" 
                               value="{{ settings.runtime_cache_size or 3000 }}" 
                               min="100" max="6000" step="100" 
                               style="max-width:150px; background:#111; border:1px solid #444; color:white; padding:10px; border-radius:5px;">
                        <span style="color:#aaa; font-size:0.9em;">entries</span>
                    </div>
                </div>
            </div>
            </fieldset>
            <fieldset class="settings-fieldset" style="border:none;margin:0;padding:0;min-width:0;">
                <legend class="visually-hidden">Library Index</legend>
            <div class="card setting-card border-purple">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center" style="padding:0; margin-bottom:15px;">
                    <h3 style="margin:0; display:flex; align-items:center; gap:10px;">Library Index</h3>
                    <span class="settings-count-badge" id="db-count-badge">Loading...</span>
                </div>
                <p class="text-muted small">
                    The Plex library sync (APIs &amp; Connections -> Plex Integration) builds a TMDB index of your Plex library in the database. Use <b>Reset Index</b> only if you need to clear the index and run a full sync again.
                </p>
                <div style="display: flex; gap: 10px; align-items: center; margin-top: 12px;">
                    <button type="button" class="btn-danger" style="padding: 8px 16px;" onclick="resetScannerIndex()">Reset Index</button>
                </div>
            </div>
            </fieldset>
            <fieldset class="settings-fieldset" style="border:none;margin:0;padding:0;min-width:0;">
                <legend class="visually-hidden">Radarr and Sonarr Scanner</legend>
            <div class="card setting-card border-blue" style="margin-top: 30px;">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center" style="padding:0; margin-bottom:15px;">
                    <h3 style="margin:0; display:flex; align-items:center; gap:10px;">Radarr & Sonarr Scanner</h3>
                    <div>
                        <span class="settings-count-badge" id="radarr-sonarr-count-badge" style="margin-right:10px;">Loading...</span>
                    </div>
                </div>
                
                <p class="text-muted small">
                    Scan your Radarr and Sonarr libraries to exclude items from recommendations. Items in Radarr/Sonarr are considered "owned" and won't appear in Smart Discovery results.
                </p>
                
                <div style="margin-bottom: 15px; padding: 10px; background: rgba(52, 152, 219, 0.1); border-radius: 6px; border: 1px solid rgba(52, 152, 219, 0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: #3498db;">Last Scan:</strong>
                            <span id="radarr-sonarr-last-scan" style="color: #ccc; margin-left: 8px;">Never</span>
                        </div>
                        <button type="button" class="btn-primary" style="background:#3498db; color:white; border:none; padding:6px 15px; border-radius:4px; cursor:pointer;" onclick="forceRadarrSonarrCacheRefresh()">
                            Force Refresh Now
                        </button>
                    </div>
                </div>
                
                <div class="scanner-row">
                    <div class="flex-item">
                        <label class="form-label text-muted small">Scan Interval (Hours)</label>
                        <select class="filter-input" id="radarr-sonarr-interval" style="width:100%;">
                            <option value="6">Every 6 Hours</option>
                            <option value="12">Every 12 Hours</option>
                            <option value="24" selected>Every 24 Hours</option>
                            <option value="48">Every 48 Hours</option>
                        </select>
                    </div>
                    <div class="spacer-col-1"></div>
                    <div class="flex-item" style="display:flex; align-items:center; padding-bottom:12px;">
                        <input type="checkbox" id="radarr-sonarr-toggle" style="width:20px; height:20px; margin-right:10px;">
                        <label for="radarr-sonarr-toggle" class="input-label" style="margin:0; cursor:pointer; display:inline;">Enable Auto-Scan</label>
                    </div>
                    <div class="flex-item" style="text-align:right;">
                        <button type="button" class="btn-primary" style="background:#2ecc71; color:white; border:none; flex: 1;" onclick="saveRadarrSonarrScannerSettings()">
                            Save
                        </button>
                    </div>
                </div>                
            </div>
            </fieldset>
        </div>
    </section>
    <section aria-label="System and maintenance" style="margin-bottom: 0;">
        <fieldset class="settings-fieldset" style="border:none;margin:0;padding:0;min-width:0;">
            <legend class="visually-hidden">System and maintenance</legend>
        <div id="tab-system" class="tab-content" data-settings-section="system">
            <div class="card setting-card border-blue">
                <h3>System Maintenance</h3>
                <div class="flex-row-wrap" style="display:flex; gap:20px; margin-bottom:20px;">
                    <div class="input-group flex-item" style="flex:1;">
                        <label class="input-label">Backup Interval (Days)</label>
                        <input type="number" id="backup_interval" name="backup_interval" value="{{ settings.backup_interval or 2 }}" min="1">
                    </div>
                    <div class="input-group flex-item" style="flex:1;">
                        <label class="input-label">Retention (Days)</label>
                        <input type="number" id="backup_retention" name="backup_retention" value="{{ settings.backup_retention or 7 }}" min="1">
                    </div>
                </div>
                
                <hr style="border-color: #333; margin: 20px 0;">
                
                <div style="margin-top:20px; border-top:1px solid #333; padding-top:20px;">
                    <div class="backup-controls" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; gap:10px;">
                        <div>
                            <h4 style="margin:0;">Existing Backups</h4>
                            <div style="font-size:0.85em; color:#888; margin-top:4px;">
                                Import a backup ZIP from a previous install to restore it here.
                            </div>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <input type="file" id="backup-upload-input" accept=".zip" style="display:none;" onchange="handleBackupUpload(this.files)">
                            <button type="button" onclick="triggerBackupUpload()" class="btn-secondary" style="padding:8px 15px;">Upload Backup</button>
                            <button type="button" onclick="createBackup()" class="btn-primary" style="padding:8px 15px;">+ Backup Now</button>
                        </div>
                    </div>
                    <div style="font-size:0.85em; color:#888; margin:8px 0 12px;">
                        üîí Admin-only: only admins can upload or restore backups.
                    </div>
                    <div id="backup-list" class="backup-list">
                        <div style="text-align:center; color:#777;">Loading...</div>
                    </div>
                </div>
            </div>

            <div class="card setting-card border-blue">
                <h3>Change password</h3>
                <p class="text-muted">Set a new password for your account. You must enter your current password.</p>
                <form id="change-password-form" method="post" action="javascript:void(0);" onsubmit="submitChangePassword(); return false;" aria-label="Change password" autocomplete="on">
                    <label for="change-pw-username" class="visually-hidden">Username</label>
                    <input type="text" id="change-pw-username" name="username" value="{{ current_user.username or '' }}" autocomplete="username" class="visually-hidden" tabindex="-1" aria-hidden="true" style="position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0;">
                    <div class="input-group" style="max-width: 320px; margin-bottom: 12px;">
                        <label class="input-label" for="change-pw-current">Current password</label>
                        <input type="password" id="change-pw-current" name="current_password" placeholder="Current password" autocomplete="current-password" style="width: 100%; padding: 10px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 6px;">
                    </div>
                    <div class="input-group" style="max-width: 320px; margin-bottom: 12px;">
                        <label class="input-label" for="change-pw-new">New password</label>
                        <input type="password" id="change-pw-new" name="new_password" placeholder="At least 8 characters" minlength="8" autocomplete="new-password" style="width: 100%; padding: 10px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 6px;">
                    </div>
                    <div class="input-group" style="max-width: 320px; margin-bottom: 12px;">
                        <label class="input-label" for="change-pw-confirm">Confirm new password</label>
                        <input type="password" id="change-pw-confirm" name="confirm_password" placeholder="Same again" minlength="8" autocomplete="new-password" style="width: 100%; padding: 10px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 6px;">
                    </div>
                    <div id="change-pw-message" style="margin-bottom: 10px; font-size: 0.9rem;"></div>
                    <button type="submit" class="btn-secondary" id="btn-change-password" style="padding:8px 15px;">Change password</button>
                </form>
            </div>

            <div class="card setting-card border-purple">
                <h3>Account recovery</h3>
                <p class="text-muted">Generate one-time recovery codes. Save them somewhere safe; if you lose your password, use one code on the login page to set a new password. Old codes are invalid when you generate new ones. If you're the only admin and get locked out with no codes, the server owner can reset your password in the database.</p>
                <button type="button" onclick="generateRecoveryCodes()" class="btn-secondary" id="btn-generate-codes" style="padding:8px 15px;">Generate recovery codes</button>
            </div>

            <div class="card danger-zone">
                <h3 style="color: var(--error); display: flex; align-items: center; gap: 10px; margin-top: 0;">
                    Danger Zone
                </h3>
                <p style="color: #ccc; margin-bottom: 20px;">
                    Permanently delete your profile, settings, and watch history.
                </p>
                <button type="button" onclick="document.getElementById('delete-account-form').submit();" class="btn-danger" style="width:100%;">
                    Delete My Account
                </button>
            </div>
        </div>
        </fieldset>
    </section>
</div>

<!-- modal: recovery codes (shown after generate; available to all users in Settings -> System & Maintenance) -->
<div id="modal-recovery-codes" class="modal-overlay">
    <div class="modal-box" style="max-width:500px;">
        <h3>Save these recovery codes</h3>
        <p class="text-muted">They are shown only once. Store them somewhere safe. Each code works once to reset your password if you forget it. Generating new codes disables any previous codes.</p>
        <pre id="recovery-codes-list" style="background:#111; padding:12px; border-radius:8px; overflow-x:auto; font-size:0.9em; max-height:200px; overflow-y:auto;"></pre>
        <div style="display:flex; gap:10px; margin-top:1rem;">
            <button type="button" class="btn-secondary" onclick="copyRecoveryCodes()">Copy</button>
            <button type="button" class="login-btn" onclick="closeRecoveryCodesModal()">Done</button>
        </div>
    </div>
</div>

{% if current_user.is_admin %}
<!-- modal: admin set password for another user (separate form, single action) -->
<div id="modal-reset-password" class="modal-overlay">
    <div class="modal-box" style="max-width:400px;">
        <h3>Reset password</h3>
        <p class="text-muted">Setting new password for <strong id="reset-password-username"></strong>. They can log in with it immediately.</p>
        <form id="reset-password-form" method="dialog" onsubmit="submitResetPassword(); return false;" aria-label="Reset user password">
            <label for="reset-password-username-field" class="visually-hidden">Username</label>
            <input type="text" id="reset-password-username-field" name="username" value="" autocomplete="username" class="visually-hidden" tabindex="-1" aria-hidden="true">
            <div class="form-group">
                <label for="reset-password-new">New password</label>
                <input type="password" id="reset-password-new" name="new_password" placeholder="At least 8 characters" minlength="8" autocomplete="new-password" required>
            </div>
            <div class="form-group">
                <label for="reset-password-confirm">Confirm new password</label>
                <input type="password" id="reset-password-confirm" name="confirm_password" placeholder="Same again" minlength="8" autocomplete="new-password" required>
            </div>
            <div style="display:flex; gap:10px; margin-top:1rem;">
                <button type="button" class="btn-secondary" onclick="closeResetPasswordModal()">Cancel</button>
                <button type="submit" class="login-btn" id="reset-password-submit-btn">Set password</button>
            </div>
        </form>
    </div>
</div>
{% endif %}

<form id="delete-account-form" action="{{ url_for('delete_profile') }}" method="POST" onsubmit="return confirm('Are you sure? This cannot be undone.');" style="display:none;" aria-label="Delete account">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
</form>

<div id="settingsModal" class="custom-modal-overlay">
    <div class="custom-modal-box">
        <div class="modal-icon" id="modalIcon">‚úÖ</div>
        <h3 class="modal-title" id="modalTitle">Settings Saved</h3>
        <p class="modal-message" id="modalMessage">Configuration updated successfully.</p>
        <button id="modalBtn" class="modal-btn">OK</button>
    </div>
</div>

<script>
// Auto-fill API URLs based on server IP
function acceptAutoFill() {
    const serverHost = "{{ server_host|default('') }}";
    if (!serverHost) return;
    
    // Default ports for each service
    const defaults = {
        'plex_url': `http://${serverHost}:32400`,
        'radarr_url': `http://${serverHost}:7878`,
        'sonarr_url': `http://${serverHost}:8989`,
        'overseerr_url': `http://${serverHost}:5055`,
        'tautulli_url': `http://${serverHost}:8181`
    };
    
    let filledCount = 0;
    // Only fill if field is empty
    Object.keys(defaults).forEach(id => {
        const field = document.getElementById(id);
        if (field && !field.value.trim()) {
            field.value = defaults[id];
            filledCount++;
        }
    });
    
    // Hide the banner
    dismissAutoFill();
    
    if (filledCount > 0) {
        showToast();
    }
}

function dismissAutoFill() {
    const banner = document.getElementById('auto-fill-banner');
    if (banner) {
        banner.style.display = 'none';
    }
}

// Tabs: only one tab visible; set inert on inactive panels so one form context is active (fixes DOM "multiple forms" notice)
function openTab(evt, tabName) {
    var i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
        tabcontent[i].classList.remove("active");
        tabcontent[i].setAttribute("inert", "");
    }
    tablinks = document.getElementsByClassName("tab-link");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    var activePanel = document.getElementById(tabName);
    if (activePanel) {
        activePanel.style.display = "block";
        activePanel.removeAttribute("inert");
    }
    setTimeout(function() {
        if (activePanel) activePanel.classList.add("active");
    }, 10);
    evt.currentTarget.className += " active";
    var saveBtn = document.getElementById("main-save-btn");
    if (saveBtn) saveBtn.style.display = "block";
}

// Small UI helpers
function toggleVisibility(id, btn) {
    const el = document.getElementById(id);
    if (el.type === "password") { el.type = "text"; btn.innerText = "üîí"; } 
    else { el.type = "password"; btn.innerText = "üëÅÔ∏è"; }
}
function clearPasswordField(inputId, unchangedId) {
    const el = document.getElementById(inputId);
    const unchanged = unchangedId ? document.getElementById(unchangedId) : null;
    if (el) { el.value = ""; el.focus(); el.removeAttribute("data-key-set"); }
    if (unchanged) unchanged.remove();
}

function showModal(icon, title, message, isSuccess) {
    const modal = document.getElementById('settingsModal');
    document.getElementById('modalIcon').innerText = icon;
    document.getElementById('modalTitle').innerText = title;
    document.getElementById('modalMessage').innerText = message;
    const btn = document.getElementById('modalBtn');
    btn.onclick = function() { modal.style.display = 'none'; if(isSuccess) location.reload(); };
    modal.style.display = 'flex';
}

function showToast() {
    const toast = document.getElementById('save-toast');
    toast.style.opacity = '1';
    setTimeout(() => { toast.style.opacity = '0'; }, 2000);
}

// Scanner + cache controls
let countdownInterval;

// Auto-fill API URLs based on server IP
function acceptAutoFill() {
    const serverHost = "{{ server_host|default('') }}";
    if (!serverHost) return;
    
    // Default ports for each service
    const defaults = {
        'plex_url': `http://${serverHost}:32400`,
        'radarr_url': `http://${serverHost}:7878`,
        'sonarr_url': `http://${serverHost}:8989`,
        'overseerr_url': `http://${serverHost}:5055`,
        'tautulli_url': `http://${serverHost}:8181`
    };
    
    let filledCount = 0;
    // Only fill if field is empty
    Object.keys(defaults).forEach(id => {
        const field = document.getElementById(id);
        if (field && !field.value.trim()) {
            field.value = defaults[id];
            filledCount++;
        }
    });
    
    // Hide the banner
    dismissAutoFill();
    
    if (filledCount > 0) {
        showToast();
    }
}

function dismissAutoFill() {
    const banner = document.getElementById('auto-fill-banner');
    if (banner) {
        banner.style.display = 'none';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Only one tab panel is active; set inert on inactive panels so one form context is active (fixes DOM "multiple forms" notice)
    var tabPanels = document.getElementsByClassName("tab-content");
    for (var i = 0; i < tabPanels.length; i++) {
        if (!tabPanels[i].classList.contains("active")) tabPanels[i].setAttribute("inert", "");
    }
    // When user types in a key field that was masked, remove _unchanged hidden so save sends the new value
    var keyFieldIds = ['plex_token', 'tmdb_key', 'omdb_key', 'overseerr_api_key', 'tautulli_api_key', 'radarr_api_key', 'sonarr_api_key'];
    keyFieldIds.forEach(function(id) {
        var el = document.getElementById(id);
        if (el) el.addEventListener('input', function() {
            var h = document.getElementById(id + '_unchanged_h');
            if (h) h.remove();
        });
    });
    loadBackups();
    fetchStatus();
    checkRadarrSonarrCacheStatus();
    setInterval(fetchStatus, 30000);
    setInterval(checkCacheStatus, 2000);
    setInterval(checkRadarrSonarrCacheStatus, 30000);
    
    // Check if auto-fill banner should be shown (only if there are empty URL fields)
    {% if server_host %}
    const serverHost = "{{ server_host }}";
    const urlFields = ['plex_url', 'radarr_url', 'sonarr_url', 'overseerr_url', 'tautulli_url'];
    const hasEmptyFields = urlFields.some(id => {
        const field = document.getElementById(id);
        return field && !field.value.trim();
    });
    
    if (hasEmptyFields) {
        const banner = document.getElementById('auto-fill-banner');
        if (banner) {
            banner.style.display = 'block';
        }
    }
    {% endif %}

    const checkboxes = document.querySelectorAll('input[name="ignored_plex_users"]');
    checkboxes.forEach(box => {
        box.addEventListener('change', function() {
            const checkedUsers = Array.from(checkboxes).filter(i => i.checked).map(i => i.value);
            fetch(API_UPDATE_IGNORE_LIST, {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ ignored_users: checkedUsers })
            }).then(r => r.json()).then(d => { if (d.status === 'success') showToast(); });
        });
    });

    const batchSelect = document.getElementById('scan-batch');
    const intervalSelect = document.getElementById('scan-interval');

    function validateScannerOptions() {
        if(!batchSelect || !intervalSelect) return;
        
        const batchVal = parseInt(batchSelect.value);
        const opt5 = intervalSelect.querySelector('option[value="5"]');
        
        if (batchVal > 200) {
            opt5.disabled = true;
            opt5.text = "Every 5 Mins (Locked üîí)";
            if (intervalSelect.value === "5") {
                intervalSelect.value = "15";
            }
        } else {
            opt5.disabled = false;
            opt5.text = "Every 5 Mins";
        }
    }

    if (batchSelect && intervalSelect) {
        batchSelect.addEventListener('change', validateScannerOptions);
        validateScannerOptions();
    }

    // Trim trailing slashes so URLs stay consistent.
    ['plex_url', 'overseerr_url', 'tautulli_url'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('blur', function(e) {
                let val = e.target.value;
                let clean = val.trim().replace(/\/+$/, '');
                if (val !== clean) {
                    e.target.value = clean;
                    console.log(`Auto-cleaned ${id}:`, clean);
                }
            });
        }
    });

    // Link / Unlink Plex account
    const btnLinkPlex = document.getElementById('btn-link-plex');
    const plexPinBox = document.getElementById('plex-pin-box');
    const plexPinCode = document.getElementById('plex-pin-code');
    const plexPinMsg = document.getElementById('plex-pin-msg');
    if (btnLinkPlex && plexPinBox && plexPinCode && plexPinMsg) {
        btnLinkPlex.addEventListener('click', function() {
            if (btnLinkPlex.getAttribute('data-plex-linked') === 'true') {
                btnLinkPlex.disabled = true;
                btnLinkPlex.textContent = 'Unlinking‚Ä¶';
                const fallback = (document.querySelector('input[name="csrf_token"]') && document.querySelector('input[name="csrf_token"]').value) || '';
                (window.getCsrfToken ? window.getCsrfToken(fallback) : Promise.resolve(SETTINGS_CSRF || fallback)).then(function(token) {
                    return fetch(API_PLEX_UNLINK, { method: 'POST', credentials: 'same-origin', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': token || '' }, body: JSON.stringify({}) });
                }).then(function(r) { return r.json(); }).then(function(d) {
                    if (d.status === 'success') window.location.reload();
                    else { btnLinkPlex.disabled = false; btnLinkPlex.textContent = 'Unlink Plex account'; }
                }).catch(function() { btnLinkPlex.disabled = false; btnLinkPlex.textContent = 'Unlink Plex account'; });
                return;
            }
            plexPinMsg.textContent = 'Creating code‚Ä¶';
            plexPinMsg.style.color = '#aaa';
            plexPinBox.style.display = 'block';
            plexPinCode.textContent = '';
            const fallback = (document.querySelector('input[name="csrf_token"]') && document.querySelector('input[name="csrf_token"]').value) || '';
            (window.getCsrfToken ? window.getCsrfToken(fallback) : Promise.resolve(SETTINGS_CSRF || fallback)).then(function(token) {
                return fetch(API_PLEX_PIN_CREATE, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': token || '' },
                    body: JSON.stringify({ csrf_token: token || '' })
                });
            }).then(function(r) { return r.json().then(function(data) { return { ok: r.ok, data: data }; }); }).then(function(res) {
                if (res.data.error) {
                    plexPinMsg.textContent = res.data.error;
                    plexPinMsg.style.color = 'var(--error, #e74c3c)';
                    return;
                }
                plexPinCode.textContent = res.data.code || '';
                plexPinMsg.textContent = 'Waiting for you to authorize at plex.tv/link‚Ä¶';
                if (res.data.link) {
                    var w = window.open(res.data.link, 'plex_link', 'width=520,height=640,scrollbars=yes,resizable=yes');
                    if (w) w.focus();
                }
                var poll = setInterval(function() {
                    fetch(API_PLEX_PIN_POLL, { credentials: 'same-origin' }).then(function(r) { return r.json(); }).then(function(d) {
                        if (d.error) {
                            clearInterval(poll);
                            plexPinMsg.textContent = d.error === 'expired' ? 'Code expired. Click Link Plex account again.' : d.error;
                            plexPinMsg.style.color = 'var(--error, #e74c3c)';
                            return;
                        }
                        if (d.done) {
                            clearInterval(poll);
                            var conns = d.connections || [];
                            if (conns.length > 0) {
                                document.getElementById('plex-pin-step-code').style.display = 'none';
                                var stepServer = document.getElementById('plex-pin-step-server');
                                var sel = document.getElementById('plex-server-select');
                                sel.innerHTML = '';
                                conns.forEach(function(c) {
                                    var opt = document.createElement('option');
                                    opt.value = c.uri;
                                    opt.textContent = c.label;
                                    sel.appendChild(opt);
                                });
                                stepServer.style.display = 'block';
                            } else {
                                plexPinMsg.textContent = 'Linked! Reloading‚Ä¶';
                                plexPinMsg.style.color = 'var(--accent-color)';
                                setTimeout(function() { window.location.reload(); }, 800);
                            }
                        }
                    });
                }, 2000);
            }).catch(function() {
                plexPinMsg.textContent = 'Could not start. Check your connection and try again.';
                plexPinMsg.style.color = 'var(--error, #e74c3c)';
            });
        });
        var btnUseServer = document.getElementById('btn-plex-use-server');
        var btnSkipServer = document.getElementById('btn-plex-skip-server');
        var plexServerSelect = document.getElementById('plex-server-select');
        if (btnUseServer && btnSkipServer && plexServerSelect) {
            btnUseServer.addEventListener('click', function() {
                var url = plexServerSelect.value;
                if (!url) return;
                btnUseServer.disabled = true;
                btnUseServer.textContent = 'Saving‚Ä¶';
                var fallback = (document.querySelector('input[name="csrf_token"]') && document.querySelector('input[name="csrf_token"]').value) || '';
                var self = this;
                (window.getCsrfToken ? window.getCsrfToken(fallback) : Promise.resolve(SETTINGS_CSRF || fallback)).then(function(token) {
                    return fetch(API_PLEX_SET_URL, { method: 'POST', credentials: 'same-origin', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': token || '' }, body: JSON.stringify({ url: url }) });
                }).then(function(r) { return r.json(); }).then(function(d) {
                    if (d.status === 'success') {
                        var pinBox = document.getElementById('plex-pin-box');
                        var dropdownRow = document.getElementById('plex-server-dropdown-row');
                        var persistentSelect = document.getElementById('plex-server-select-persistent');
                        var plexUrlInput = document.getElementById('plex_url');
                        var linkStatus = document.getElementById('plex-link-status');
                        var linkBtn = document.getElementById('btn-link-plex');
                        if (pinBox) pinBox.style.display = 'none';
                        if (dropdownRow) dropdownRow.style.display = 'block';
                        if (persistentSelect && plexServerSelect) {
                            persistentSelect.innerHTML = '';
                            for (var i = 0; i < plexServerSelect.options.length; i++) {
                                var o = plexServerSelect.options[i];
                                var opt = document.createElement('option');
                                opt.value = o.value;
                                opt.textContent = o.textContent;
                                persistentSelect.appendChild(opt);
                                if (o.value === url) persistentSelect.selectedIndex = persistentSelect.options.length - 1;
                            }
                        }
                        if (plexUrlInput) plexUrlInput.value = url;
                        if (linkStatus) { linkStatus.textContent = '‚úì Plex account connected'; linkStatus.style.background = 'rgba(0, 204, 102, 0.15)'; linkStatus.style.borderColor = 'rgba(0, 204, 102, 0.5)'; linkStatus.style.color = 'var(--accent-color)'; linkStatus.style.fontWeight = 'bold'; }
                        if (linkBtn) { linkBtn.textContent = 'Unlink Plex account'; linkBtn.setAttribute('data-plex-linked', 'true'); }
                    } else {
                        btnUseServer.disabled = false;
                        btnUseServer.textContent = 'Use this server';
                        alert(d.error || 'Failed to save');
                    }
                }).catch(function() { btnUseServer.disabled = false; btnUseServer.textContent = 'Use this server'; });
            });
            btnSkipServer.addEventListener('click', function() { window.location.reload(); });
        }
        // Persistent server dropdown (Overseerr-style): load and apply
        var plexSelectPersistent = document.getElementById('plex-server-select-persistent');
        var plexUrlInput = document.getElementById('plex_url');
        function loadPlexConnections() {
            if (!plexSelectPersistent) return;
            plexSelectPersistent.innerHTML = '<option value="">Loading‚Ä¶</option>';
            plexSelectPersistent.disabled = true;
            fetch(API_PLEX_CONNECTIONS, { credentials: 'same-origin' }).then(function(r) { return r.json(); }).then(function(d) {
                var conns = d.connections || [];
                plexSelectPersistent.innerHTML = '';
                conns.forEach(function(c) {
                    var opt = document.createElement('option');
                    opt.value = c.uri;
                    opt.textContent = c.label;
                    plexSelectPersistent.appendChild(opt);
                });
                var currentUrl = (plexUrlInput && plexUrlInput.value) ? plexUrlInput.value.trim().replace(/\/+$/, '') : '';
                if (currentUrl) {
                    for (var i = 0; i < plexSelectPersistent.options.length; i++) {
                        if (plexSelectPersistent.options[i].value.replace(/\/+$/, '') === currentUrl) {
                            plexSelectPersistent.selectedIndex = i;
                            break;
                        }
                    }
                }
                plexSelectPersistent.disabled = false;
            }).catch(function() {
                plexSelectPersistent.innerHTML = '<option value="">Failed to load</option>';
                plexSelectPersistent.disabled = false;
            });
        }
        var plexDropdownRow = document.getElementById('plex-server-dropdown-row');
        if (plexSelectPersistent && plexDropdownRow && plexDropdownRow.style.display !== 'none') loadPlexConnections();
        var btnRefreshServers = document.getElementById('btn-plex-refresh-servers');
        var btnApplyServer = document.getElementById('btn-plex-apply-server');
        if (btnRefreshServers) btnRefreshServers.addEventListener('click', loadPlexConnections);
        if (btnApplyServer && plexSelectPersistent && plexUrlInput) {
            btnApplyServer.addEventListener('click', function() {
                var url = plexSelectPersistent.value;
                if (!url) return;
                btnApplyServer.disabled = true;
                var fallback = (document.querySelector('input[name="csrf_token"]') && document.querySelector('input[name="csrf_token"]').value) || '';
                (window.getCsrfToken ? window.getCsrfToken(fallback) : Promise.resolve(SETTINGS_CSRF || fallback)).then(function(token) {
                    return fetch(API_PLEX_SET_URL, { method: 'POST', credentials: 'same-origin', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': token || '' }, body: JSON.stringify({ url: url }) });
                }).then(function(r) { return r.json(); }).then(function(d) {
                    btnApplyServer.disabled = false;
                    if (d.status === 'success') {
                        plexUrlInput.value = url;
                        if (typeof showToast === 'function') showToast();
                        else alert('Server URL updated.');
                    } else alert(d.error || 'Failed to save');
                }).catch(function() { btnApplyServer.disabled = false; });
            });
        }
    }

}); 

function fetchStatus() {
    fetch(API_SCANNER_STATUS).then(r => r.json()).then(data => {
        const toggle = document.getElementById('scan-toggle');
        if(toggle) toggle.checked = data.enabled;
        
        const batchSelect = document.getElementById('scan-batch');
        if(batchSelect) {
            const validOptions = Array.from(batchSelect.options).map(o => o.value);
            if (validOptions.includes(String(data.batch))) batchSelect.value = data.batch;
            else batchSelect.value = '50';
        }
        
        const intSelect = document.getElementById('scan-interval');
        if(intSelect) {
            intSelect.value = data.interval;
            const batchEl = document.getElementById('scan-batch');
            if(batchEl) batchEl.dispatchEvent(new Event('change'));
        }
        
        const badge = document.getElementById('db-count-badge');
        if(badge) badge.innerText = data.total_indexed + " items indexed";
        
        // Load Radarr/Sonarr scanner settings
        fetch(API_GET_RADARR_SONARR_CACHE_STATUS).then(r => r.json()).then(rsData => {
            const rsToggle = document.getElementById('radarr-sonarr-toggle');
            const rsInterval = document.getElementById('radarr-sonarr-interval');
            if(rsToggle) rsToggle.checked = rsData.enabled || false;
            if(rsInterval) rsInterval.value = rsData.interval || 24;
            checkRadarrSonarrCacheStatus();
        }).catch(() => {});
        
        const nextBadge = document.getElementById('next-scan-badge');
        if(nextBadge) {
            if(data.enabled && data.next_ts > 0) {
                startCountdown(data.next_ts);
                nextBadge.classList.remove('d-none');
            } else {
                clearInterval(countdownInterval);
                nextBadge.classList.add('d-none');
            }
        }
    }).catch(e => console.log("Scanner status fetch failed", e));
}

function startCountdown(targetTs) {
    clearInterval(countdownInterval);
    function update() {
        const now = Math.floor(Date.now() / 1000);
        const diff = targetTs - now;
        const badge = document.getElementById('next-scan-badge');
        if(!badge) return;
        
        if (diff <= 0) {
            badge.innerText = "Next Scan: Pending...";
            badge.classList.remove('text-warning');
            badge.classList.add('text-danger', 'blink');
        } else {
            const mins = Math.floor(diff / 60);
            const secs = diff % 60;
            const minStr = mins < 10 ? "0" + mins : mins;
            const secStr = secs < 10 ? "0" + secs : secs;
            badge.innerText = `Next Scan: ${minStr}:${secStr}`;
            badge.classList.remove('text-danger', 'blink');
            badge.classList.add('text-warning');
        }
    }
    update();
    countdownInterval = setInterval(update, 1000);
}

function saveScannerSettings() {
    const enabled = document.getElementById('scan-toggle').checked;
    const batch = document.getElementById('scan-batch').value;
    const interval = document.getElementById('scan-interval').value;
    
    fetch(API_SCANNER_SAVE, {
        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({enabled, batch, interval})
    }).then(r => r.json()).then(data => {
        const btn = document.querySelector('button[onclick="saveScannerSettings()"]');
        const oldText = btn ? btn.innerText : 'Save';
        if (btn) btn.innerText = "Saved ‚úÖ";
        setTimeout(() => { fetchStatus(); if (btn) btn.innerText = oldText; }, 1000);
    }).catch(() => {
        const btn = document.querySelector('button[onclick="saveScannerSettings()"]');
        if (btn) btn.innerText = 'Save';
        showModal('‚ùå', 'Error', 'Could not save scanner settings. Please try again.', false);
    });
}

function saveCacheSetting() {
    const checkEl = document.getElementById('plex-auto-sync');
    const intervalEl = document.getElementById('cache-interval');
    const val = (checkEl && !checkEl.checked) ? 0 : (intervalEl ? intervalEl.value : 24);
    fetch(API_SAVE_CACHE_SETTINGS, {
        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({interval: parseInt(val, 10)})
    }).then(r => r.json()).then(d => {
        if(d.status === 'success') showToast();
        else alert(d.message);
    }).catch(() => { showModal('‚ùå', 'Error', 'Could not save. Please try again.', false); });
}

function forceRefresh() {
    const btn = document.getElementById('btn-force');
    btn.disabled = true; 
    btn.innerText = "Refreshing... ‚è≥";
    
    fetch(API_FORCE_CACHE_REFRESH, {method: 'POST'})
    .then(r => r.json())
    .then(data => {
        if(data.status !== 'success') {
            alert("Error: " + data.message);
            btn.disabled = false;
            btn.innerText = "üîÑ Force Refresh Now";
        }
    });
}

function syncPlexLibrary() {
    const btn = document.getElementById('btn-force');
    const msg = document.getElementById('plex-sync-library-msg');
    if (!btn) return;
    btn.disabled = true;
    if (btn.innerText && !btn.innerText.includes('Refreshing')) btn.innerText = 'Syncing‚Ä¶ ‚è≥';
    if (msg) msg.textContent = '';
    const fallback = (document.querySelector('input[name="csrf_token"]') && document.querySelector('input[name="csrf_token"]').value) || '';
    (window.getCsrfToken ? window.getCsrfToken(fallback) : Promise.resolve(SETTINGS_CSRF || fallback)).then(function(token) {
        return fetch(API_PLEX_LIBRARY_SYNC, {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': token || '' },
            body: JSON.stringify({})
        });
    }).then(r => r.json()).then(data => {
        if (msg) msg.textContent = data.status === 'success' ? 'Sync started.' : (data.message || 'Error');
        if (data.status !== 'success') btn.disabled = false;
    }).catch(function() {
        if (msg) msg.textContent = 'Request failed.';
        btn.disabled = false;
    });
}

function checkCacheStatus() {
    fetch(API_GET_CACHE_STATUS).then(r => r.json()).then(data => {
        const forceBtn = document.getElementById('btn-force');
        const txt = document.getElementById('last-updated');
        if(!forceBtn) return;

        if(data.running) {
            forceBtn.disabled = true;
            forceBtn.innerText = `Syncing (${data.progress}) ‚è≥`;
        } else {
            if(forceBtn.innerText.includes("Syncing") || forceBtn.innerText.includes("Refreshing")) {
                forceBtn.disabled = false;
                forceBtn.innerText = "Sync library now";
                if(txt) txt.innerText = "Just now";
            }
        }
    });
}

function forceRadarrSonarrCacheRefresh() {
    const btn = event.target;
    btn.disabled = true; 
    btn.innerText = "Refreshing... ‚è≥";
    
    fetch(API_FORCE_RADARR_SONARR_CACHE_REFRESH, {method: 'POST'})
    .then(r => r.json())
    .then(data => {
        if(data.status !== 'success') {
            alert("Error: " + (data.message || "Failed to start refresh"));
            btn.disabled = false;
            btn.innerText = "Force Refresh Now";
        } else {
            setTimeout(() => {
                checkRadarrSonarrCacheStatus();
                btn.disabled = false;
                btn.innerText = "Force Refresh Now";
            }, 2000);
        }
    }).catch(err => {
        alert("Error: " + err.message);
        btn.disabled = false;
        btn.innerText = "Force Refresh Now";
    });
}

function checkRadarrSonarrCacheStatus() {
    fetch(API_GET_RADARR_SONARR_CACHE_STATUS).then(r => r.json()).then(data => {
        const countBadge = document.getElementById('radarr-sonarr-count-badge');
        const lastScan = document.getElementById('radarr-sonarr-last-scan');
        
        if(countBadge) {
            countBadge.innerText = `${data.count || 0} Items`;
        }
        if(lastScan) {
            lastScan.innerText = data.last_scan || "Never";
        }
    }).catch(err => {
        console.error("Failed to get Radarr/Sonarr cache status:", err);
    });
}

function saveRadarrSonarrScannerSettings() {
    const enabled = document.getElementById('radarr-sonarr-toggle').checked;
    const interval = document.getElementById('radarr-sonarr-interval').value;
    
    fetch(API_RADARR_SONARR_SCANNER_SAVE, {
        method: 'POST', 
        headers: {'Content-Type': 'application/json'}, 
        body: JSON.stringify({enabled, interval})
    }).then(r => r.json()).then(data => {
        const btn = document.querySelector('button[onclick="saveRadarrSonarrScannerSettings()"]');
        const oldText = btn.innerText;
        btn.innerText = "Saved ‚úÖ";
        setTimeout(() => { 
            checkRadarrSonarrCacheStatus(); 
            btn.innerText = oldText; 
        }, 1000);
    }).catch(err => {
        alert("Error saving settings: " + err.message);
    });
}

// Service testing + main save
function testService(service) {
    var keyIds = { plex: ['plex_token'], tmdb: ['tmdb_key'], omdb: ['omdb_key'], overseerr: ['overseerr_api_key'], tautulli: ['tautulli_api_key'], radarr: ['radarr_api_key'], sonarr: ['sonarr_api_key'] };
    var useStored = false;
    if (keyIds[service]) {
        for (var i = 0; i < keyIds[service].length; i++) {
            var el = document.getElementById(keyIds[service][i]);
            if (el && el.hasAttribute && el.hasAttribute('data-key-set') && !(el.value || '').trim()) { useStored = true; break; }
        }
    }
    var payload = { service: service };
    if (useStored) payload.use_stored = true;
    var btn;
    if (service === 'plex') {
        payload.url = document.getElementById('plex_url').value;
        if (!useStored) payload.token = document.getElementById('plex_token').value;
        btn = document.querySelector('button[onclick="testService(\'plex\')"]');
    } else if (service === 'tmdb') {
        if (!useStored) payload.api_key = document.getElementById('tmdb_key').value;
        btn = document.querySelector('button[onclick="testService(\'tmdb\')"]');
    } else if (service === 'omdb') {
        if (!useStored) payload.api_key = document.getElementById('omdb_key').value;
        btn = document.querySelector('button[onclick="testService(\'omdb\')"]');
    } else if (service === 'overseerr') {
        payload.url = document.getElementById('overseerr_url').value;
        if (!useStored) payload.api_key = document.getElementById('overseerr_api_key').value;
        btn = document.querySelector('button[onclick="testService(\'overseerr\')"]');
    } else if (service === 'tautulli') {
        payload.url = document.getElementById('tautulli_url').value;
        if (!useStored) payload.api_key = document.getElementById('tautulli_api_key').value;
        btn = document.querySelector('button[onclick="testService(\'tautulli\')"]');
    } else if (service === 'radarr') {
        payload.url = document.getElementById('radarr_url').value;
        if (!useStored) payload.api_key = document.getElementById('radarr_api_key').value;
        btn = document.querySelector('button[onclick="testService(\'radarr\')"]');
    } else if (service === 'sonarr') {
        payload.url = document.getElementById('sonarr_url').value;
        if (!useStored) payload.api_key = document.getElementById('sonarr_api_key').value;
        btn = document.querySelector('button[onclick="testService(\'sonarr\')"]');
    }
    if (!btn) return;

    const originalText = btn.innerText;
    btn.innerText = "Testing...";
    btn.disabled = true;

    fetch(API_TEST_CONNECTION, {
        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
    }).then(r => r.json()).then(data => {
        btn.disabled = false;
        btn.innerText = originalText;
        showModal(data.status==='success'?'‚úÖ':'‚ùå', data.status==='success'?'Connected!':'Connection Failed', data.message, false);
    }).catch(err => {
        btn.disabled = false;
        btn.innerText = originalText;
        showModal('‚ùå', 'Error', 'Could not reach server.', false);
    });
}

function isValidUrlField(val) {
    if (!val || !String(val).trim()) return true;
    const v = String(val).trim().toLowerCase();
    if (v.startsWith('javascript:') || v.startsWith('data:')) return false;
    return v.startsWith('http://') || v.startsWith('https://');
}

function submitActiveSettingsForm() {
    var activeTab = document.querySelector('.tab-content.active');
    if (!activeTab) return;
    var section = activeTab.getAttribute('data-settings-section');
    if (!section) return;

    var formData = new FormData();
    formData.append('csrf_token', SETTINGS_CSRF);
    formData.append('form_section', section);
    var inputs = activeTab.querySelectorAll('input[name], select[name], textarea[name]');
    for (var i = 0; i < inputs.length; i++) {
        var el = inputs[i];
        if (!el.name || el.type === 'file') continue;
        if (el.type === 'checkbox') formData.append(el.name, el.checked ? (el.value || 'on') : '');
        else formData.append(el.name, el.value || '');
    }

    if (section === 'apis') {
        var urlIds = ['plex_url', 'overseerr_url', 'tautulli_url', 'radarr_url', 'sonarr_url'];
        for (var j = 0; j < urlIds.length; j++) {
            var urlEl = activeTab.querySelector('[name="' + urlIds[j] + '"]');
            if (urlEl && urlEl.value && !isValidUrlField(urlEl.value)) {
                showModal('‚ùå', 'Invalid URL', 'URLs must start with http:// or https:// and cannot be javascript: or data:.', false);
                return;
            }
        }
        ['plex_url', 'overseerr_url', 'tautulli_url'].forEach(function(id) {
            var u = activeTab.querySelector('[name="' + id + '"]');
            if (u) u.value = (u.value || '').trim().replace(/\/+$/, '');
        });
        formData = new FormData();
        formData.append('csrf_token', SETTINGS_CSRF);
        formData.append('form_section', section);
        for (var k = 0; k < inputs.length; k++) {
            var e = inputs[k];
            if (!e.name || e.type === 'file') continue;
            if (e.type === 'checkbox') formData.append(e.name, e.checked ? (e.value || 'on') : '');
            else formData.append(e.name, e.value || '');
        }
    }

    var btn = document.getElementById('main-save-btn');
    if (!btn) return;
    var originalText = btn.getAttribute('data-save-label') || btn.innerText;
    btn.innerText = 'Saving...';
    btn.disabled = true;

    var controller = new AbortController();
    var timeoutId = setTimeout(function() { controller.abort(); }, 30000);
    fetch(SETTINGS_SAVE_URL, { method: 'POST', body: formData, signal: controller.signal })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            clearTimeout(timeoutId);
            btn.textContent = originalText;
            btn.disabled = false;
            showModal(data.status === 'success' ? '‚úÖ' : '‚ùå', data.status === 'success' ? 'Success!' : 'Error', data.message, data.status === 'success');
        })
        .catch(function(err) {
            clearTimeout(timeoutId);
            btn.textContent = originalText;
            btn.disabled = false;
            showModal('‚ùå', 'Error', err.name === 'AbortError' ? 'Request timed out. Please try again.' : 'Could not save. Please try again.', false);
        });
}

function resetScannerIndex() {
    if(!confirm("üö® Are you sure? This will wipe the alias database and force a full re-scan.")) return;
    
    const btn = document.querySelector('button[onclick="resetScannerIndex()"]');
    if (!btn) return;
    const originalText = btn.innerText;
    btn.innerText = "Wiping...";
    btn.disabled = true;

    fetch(API_SCANNER_RESET, {method: 'POST'})
    .then(r => r.json())
    .then(data => {
        btn.innerText = originalText;
        btn.disabled = false;
        showModal(data.status==='success'?'‚úÖ':'‚ùå', 'Scanner Reset', data.message, false);
        if(data.status === 'success') fetchStatus();
    })
    .catch(() => {
        btn.innerText = originalText;
        btn.disabled = false;
        showModal('‚ùå', 'Error', 'Request failed. Please try again.', false);
    });
}

// Backups
function loadBackups() {
    const div = document.getElementById('backup-list');
    fetch(API_BACKUPS).then(r => r.json()).then(data => {
        if (!div) return;
        if (!Array.isArray(data) || data.length === 0) { div.innerHTML = '<div style="text-align:center; color:#777;">No backups found.</div>'; return; }
        
        let html = '<table class="logs-table">';
        data.forEach(b => {
            html += `<tr>
                <td style="padding:8px;">${b.date}</td>
                <td style="padding:8px; color:#aaa;">${b.size}</td>
                <td style="padding:8px; text-align:right;">
                    <a href="${BACKUP_DOWNLOAD_URL_PREFIX}${b.filename}" style="text-decoration:none; margin-right:10px;">‚¨áÔ∏è</a>
                    <span onclick="restoreBackup('${b.filename}')" style="cursor:pointer; margin-right:10px;" title="Restore">‚ôªÔ∏è</span>
                    <span onclick="deleteBackup('${b.filename}')" style="cursor:pointer; color:#e74c3c;" title="Delete">üóëÔ∏è</span>
                </td></tr>`;
        });
        div.innerHTML = html + '</table>';
    }).catch(() => { if (div) div.innerHTML = '<div style="text-align:center; color:#e74c3c;">Failed to load backups.</div>'; });
}
function createBackup() {
    const btn = document.querySelector('button[onclick="createBackup()"]');
    if (btn) { btn.disabled = true; btn.innerText = 'Creating...'; }
    fetch(API_BACKUP_CREATE, {method: 'POST'})
        .then(r => r.json())
        .then(data => { loadBackups(); showModal('üì¶', 'Backup Created', data.message, false); })
        .catch(() => showModal('‚ùå', 'Error', 'Backup failed. Please try again.', false))
        .finally(() => { if (btn) { btn.disabled = false; btn.innerText = '+ Backup Now'; } });
}
function deleteBackup(f) {
    if (!confirm("Delete backup?")) return;
    fetch(API_BACKUP_DELETE_BASE + f, {method: 'DELETE'}).then(()=>loadBackups()).catch(() => showModal('‚ùå', 'Error', 'Delete failed. Please try again.', false));
}
function restoreBackup(f) {
    if (!confirm("Overwrite DB?")) return;
    fetch(API_BACKUP_RESTORE_BASE + f, {method: 'POST'})
        .then(r=>r.json())
        .then(d=>{
            if (d.status === 'success') {
                showModal('‚ôªÔ∏è', 'Restored', (d.message || 'Restored') + '\n\nReloading settings‚Ä¶', true);
                window.location.href = '/settings?restored=1';
            } else {
                showModal('‚ùå', 'Error', d.message || 'Restore failed.', false);
                loadBackups();
            }
        })
        .catch(() => { showModal('‚ùå', 'Error', 'Restore failed. Please try again.', false); loadBackups(); });
}

function triggerBackupUpload() {
    const input = document.getElementById('backup-upload-input');
    if (input) input.click();
}

function handleBackupUpload(files) {
    const file = files && files[0];
    if (!file) return;
    if (!file.name.toLowerCase().endsWith('.zip')) {
        showModal('‚ùå', 'Invalid File', 'Please select a .zip backup file.', false);
        return;
    }

    const formData = new FormData();
    formData.append('backup_file', file);

    fetch(API_BACKUP_UPLOAD, { method: 'POST', body: formData })
        .then(r => r.json())
        .then(d => {
            if (d.status === 'success') {
                loadBackups();
                showModal('‚úÖ', 'Backup Imported', d.message, false);
            } else {
                showModal('‚ùå', 'Upload Failed', d.message || 'Upload failed.', false);
            }
        })
        .catch(() => showModal('‚ùå', 'Upload Failed', 'Could not upload backup.', false))
        .finally(() => { if (input) input.value = ''; });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
<style>
    @keyframes blink { 50% { opacity: 0.5; } }
    .blink { animation: blink 1s linear infinite; }
    .key-saved-badge { display: inline-block; margin-left: 8px; padding: 2px 8px; font-size: 0.75em; font-weight: normal; color: #0c0; background: rgba(0, 204, 102, 0.2); border: 1px solid rgba(0, 204, 102, 0.5); border-radius: 4px; }
</style>
{% endblock %}