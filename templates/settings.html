{% extends "base.html" %}
{% block page_title %}Settings{% endblock %}
{% block content %}

<div class="settings-container">
    <div class="settings-header">
        <h2>‚öôÔ∏è Configuration</h2>
        <p class="text-muted">Manage your connections, automation engines, and system preferences.</p>
    </div>
    
    <div id="save-toast">
        <i class="fas fa-check-circle"></i> Saved
    </div>

    <div class="settings-tabs">
        <button type="button" class="tab-link active" onclick="openTab(event, 'tab-apis')">APIs & Connections</button>
        <button type="button" class="tab-link" onclick="openTab(event, 'tab-scanners')">Scanners & Cache</button>
        <button type="button" class="tab-link" onclick="openTab(event, 'tab-system')">System & Maintenance</button>
        
        {% if current_user.is_admin %}
        <button type="button" class="tab-link" onclick="openTab(event, 'tab-users'); loadUsers();">üë• User Management</button>
        {% endif %}
    </div>

{% if current_user.is_admin %}
<div id="tab-users" class="tab-content">
    <div class="card setting-card border-purple">
        <h3>üë• Manage Users</h3>
        <p class="text-muted">Grant admin privileges or remove users from the system.</p>
        
        <div id="user-list-container" class="logs-table-container" style="border:none; max-height:none;">
            <div class="text-center" style="padding:20px;">Loading users...</div>
        </div>
    </div>
</div>

<script>
const BACKUP_DOWNLOAD_URL_PREFIX = "{{ url_for('api.download_backup', filename='') }}";
const API_ADMIN_USERS = "{{ url_for('api.get_all_users') }}";
const API_ADMIN_TOGGLE_ROLE = "{{ url_for('api.toggle_user_role') }}";
const API_ADMIN_DELETE_USER = "{{ url_for('api.admin_delete_user') }}";
const API_ADMIN_RESET_PASSWORD = "{{ url_for('api.admin_reset_password') }}";
const API_CHANGE_PASSWORD = "{{ url_for('api.change_my_password') }}";
const API_RECOVERY_CODES_GENERATE = "{{ url_for('api.generate_recovery_codes') }}";
const SETTINGS_CSRF = "{{ csrf_token() }}";
const API_SCANNER_STATUS = "{{ url_for('api.scanner_status') }}";
const API_SCANNER_SAVE = "{{ url_for('api.save_scanner_settings') }}";
const API_SCANNER_RESET = "{{ url_for('api.reset_scanner') }}";
const API_GET_RADARR_SONARR_CACHE_STATUS = "{{ url_for('api.get_radarr_sonarr_cache_status_route') }}";
const API_SAVE_CACHE_SETTINGS = "{{ url_for('api.save_cache_settings') }}";
const API_FORCE_CACHE_REFRESH = "{{ url_for('api.force_cache_refresh_route') }}";
const API_GET_CACHE_STATUS = "{{ url_for('api.get_cache_status_route') }}";
const API_FORCE_RADARR_SONARR_CACHE_REFRESH = "{{ url_for('api.force_radarr_sonarr_cache_refresh_route') }}";
const API_RADARR_SONARR_SCANNER_SAVE = "{{ url_for('api.save_radarr_sonarr_scanner_settings') }}";
const API_TEST_CONNECTION = "{{ url_for('api.test_connection') }}";
const API_UPDATE_IGNORE_LIST = "{{ url_for('api.update_ignore_list') }}";
const API_BACKUPS = "{{ url_for('api.get_backups_api') }}";
const API_BACKUP_CREATE = "{{ url_for('api.trigger_backup') }}";
const API_BACKUP_DELETE_BASE = "{{ url_for('api.delete_backup_api', filename='') }}";
const API_BACKUP_RESTORE_BASE = "{{ url_for('api.run_restore', filename='') }}";
const API_BACKUP_UPLOAD = "{{ url_for('api.upload_backup') }}";
function loadUsers() {
    fetch(API_ADMIN_USERS)
    .then(r => r.json())
    .then(users => {
        if(users.error) return;
        
        const container = document.getElementById('user-list-container');
        if(users.length === 0) {
            container.innerHTML = "No users found.";
            return;
        }
        
        let html = '<table class="logs-table">';
        html += '<thead><tr><th>Username</th><th>Role</th><th class="text-right">Actions</th></tr></thead><tbody>';
        
        users.forEach(u => {
            const roleColor = u.is_admin ? '#2ecc71' : '#777';
            const roleText = u.is_admin ? 'üõ°Ô∏è Admin' : 'üë§ User';
            const disableSelf = u.is_current ? 'disabled style="opacity:0.5; cursor:not-allowed;"' : '';
            const safeName = escapeHtml(String(u.username || ''));
            const safeNameAttr = String(u.username || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/</g, '').replace(/>/g, '');
            html += `
            <tr>
                <td style="font-weight:bold; color:white;">${safeName} ${u.is_current ? '(You)' : ''}</td>
                <td style="color:${roleColor};">${roleText}</td>
                <td class="text-right">
                    <button onclick="openResetPasswordModal(${u.id}, '${safeNameAttr}')" class="btn-secondary" ${disableSelf} title="Set new password for this user" style="padding: 4px 10px; font-size: 0.8em;">
                        üîë Reset password
                    </button>
                    <button onclick="toggleRole(${u.id})" class="btn-secondary" ${disableSelf} title="Toggle Admin Status" style="margin-left:6px; padding: 4px 10px; font-size: 0.8em;">
                        ${u.is_admin ? 'Demote ‚ñº' : 'Promote ‚ñ≤'}
                    </button>
                    <button onclick="deleteUser(${u.id}, '${safeNameAttr}')" class="btn-delete" ${disableSelf} style="margin-left:6px; padding: 4px 10px; font-size: 0.8em;">
                        üóëÔ∏è
                    </button>
                </td>
            </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    });
}

function toggleRole(id) {
    fetch(API_ADMIN_TOGGLE_ROLE, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({user_id: id})
    }).then(r => r.json()).then(d => {
        if(d.status === 'success') loadUsers();
        else alert(d.message);
    });
}

function deleteUser(id, name) {
    if(!confirm(`Are you sure you want to delete user "${name}"? This will delete their settings and blocklists.`)) return;
    
    fetch(API_ADMIN_DELETE_USER, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({user_id: id})
    }).then(r => r.json()).then(d => {
        if(d.status === 'success') loadUsers();
        else alert(d.message);
    });
}

// admin reset password modal
let resetPasswordUserId = null;
function openResetPasswordModal(userId, username) {
    resetPasswordUserId = userId;
    document.getElementById('reset-password-username').textContent = username;
    document.getElementById('reset-password-new').value = '';
    document.getElementById('reset-password-confirm').value = '';
    document.getElementById('modal-reset-password').classList.add('is-open');
}
function closeResetPasswordModal() {
    document.getElementById('modal-reset-password').classList.remove('is-open');
    resetPasswordUserId = null;
}
function submitChangePassword() {
    const currentPw = document.getElementById('change-pw-current').value;
    const newPw = document.getElementById('change-pw-new').value;
    const confirmPw = document.getElementById('change-pw-confirm').value;
    const msgEl = document.getElementById('change-pw-message');
    const btn = document.getElementById('btn-change-password');
    msgEl.textContent = '';
    msgEl.style.color = '';
    if (!currentPw) { msgEl.textContent = 'Enter your current password.'; msgEl.style.color = '#e74c3c'; return; }
    if (newPw.length < 8) { msgEl.textContent = 'New password must be at least 8 characters.'; msgEl.style.color = '#e74c3c'; return; }
    if (newPw !== confirmPw) { msgEl.textContent = 'New password and confirmation do not match.'; msgEl.style.color = '#e74c3c'; return; }
    btn.disabled = true;
    fetch(API_CHANGE_PASSWORD, {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': SETTINGS_CSRF},
        body: JSON.stringify({ current_password: currentPw, new_password: newPw })
    }).then(r => r.json()).then(d => {
        btn.disabled = false;
        if (d.status === 'success') {
            msgEl.textContent = d.message || 'Password updated.';
            msgEl.style.color = '#2ecc71';
            document.getElementById('change-pw-current').value = '';
            document.getElementById('change-pw-new').value = '';
            document.getElementById('change-pw-confirm').value = '';
        } else {
            msgEl.textContent = d.message || 'Failed to change password.';
            msgEl.style.color = '#e74c3c';
        }
    }).catch(() => { btn.disabled = false; msgEl.textContent = 'Request failed.'; msgEl.style.color = '#e74c3c'; });
}

function submitResetPassword() {
    const newPw = document.getElementById('reset-password-new').value;
    const confirmPw = document.getElementById('reset-password-confirm').value;
    if (newPw.length < 8) { alert('Password must be at least 8 characters.'); return; }
    if (newPw !== confirmPw) { alert('Passwords do not match.'); return; }
    const btn = document.getElementById('reset-password-submit-btn');
    btn.disabled = true;
    fetch(API_ADMIN_RESET_PASSWORD, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ user_id: resetPasswordUserId, new_password: newPw })
    }).then(r => r.json()).then(d => {
        btn.disabled = false;
        if (d.status === 'success') { closeResetPasswordModal(); loadUsers(); alert(d.message); }
        else alert(d.message);
    }).catch(() => { btn.disabled = false; alert('Request failed.'); });
}

// recovery codes: generate and show once
function generateRecoveryCodes() {
    const btn = document.getElementById('btn-generate-codes');
    if (btn) btn.disabled = true;
    fetch(API_RECOVERY_CODES_GENERATE, { method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': SETTINGS_CSRF} })
    .then(r => r.json())
    .then(d => {
        if (btn) btn.disabled = false;
        if (d.status === 'success' && d.codes && d.codes.length) {
            document.getElementById('recovery-codes-list').textContent = d.codes.join('\n');
            document.getElementById('modal-recovery-codes').classList.add('is-open');
        } else alert(d.message || 'Failed to generate codes.');
    })
    .catch(() => { if (btn) btn.disabled = false; alert('Request failed.'); });
}
function closeRecoveryCodesModal() {
    document.getElementById('modal-recovery-codes').classList.remove('is-open');
}
function copyRecoveryCodes() {
    const el = document.getElementById('recovery-codes-list');
    if (!el) return;
    var text = (el.textContent || el.innerText || '').trim();
    if (!text) { alert('No codes to copy.'); return; }
    function showCopied() { alert('Copied to clipboard.'); }
    function tryFallback() {
        try {
            var sel = window.getSelection();
            var range = document.createRange();
            range.selectNodeContents(el);
            sel.removeAllRanges();
            sel.addRange(range);
            var ok = document.execCommand('copy');
            sel.removeAllRanges();
            if (ok) showCopied();
            else alert('Copy failed. Select the codes and copy manually.');
        } catch (e) { alert('Copy failed. Select the codes and copy manually.'); }
    }
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(showCopied).catch(tryFallback);
    } else {
        tryFallback();
    }
}

</script>

<!-- modal: recovery codes (shown once after generate) -->
<div id="modal-recovery-codes" class="modal-overlay">
    <div class="modal-box" style="max-width:500px;">
        <h3>üîê Save these recovery codes</h3>
        <p class="text-muted">They are shown only once. Store them somewhere safe. Each code works once to reset your password if you forget it.</p>
        <pre id="recovery-codes-list" style="background:#111; padding:12px; border-radius:8px; overflow-x:auto; font-size:0.9em; max-height:200px; overflow-y:auto;"></pre>
        <div style="display:flex; gap:10px; margin-top:1rem;">
            <button type="button" class="btn-secondary" onclick="copyRecoveryCodes()">Copy</button>
            <button type="button" class="login-btn" onclick="closeRecoveryCodesModal()">Done</button>
        </div>
    </div>
</div>

<!-- modal: admin set password for another user -->
<div id="modal-reset-password" class="modal-overlay">
    <div class="modal-box" style="max-width:400px;">
        <h3>Reset password</h3>
        <p class="text-muted">Setting new password for <strong id="reset-password-username"></strong>. They can log in with it immediately.</p>
        <div class="form-group">
            <label>New password</label>
            <input type="password" id="reset-password-new" placeholder="At least 8 characters" minlength="8" autocomplete="new-password">
        </div>
        <div class="form-group">
            <label>Confirm new password</label>
            <input type="password" id="reset-password-confirm" placeholder="Same again" minlength="8" autocomplete="new-password">
        </div>
        <div style="display:flex; gap:10px; margin-top:1rem;">
            <button type="button" class="btn-secondary" onclick="closeResetPasswordModal()">Cancel</button>
            <button type="button" class="login-btn" id="reset-password-submit-btn" onclick="submitResetPassword()">Set password</button>
        </div>
    </div>
</div>
{% endif %}


    <form id="settings-form" action="{{ url_for('settings') }}" method="POST" autocomplete="off">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>    
        <div id="tab-apis" class="tab-content active">
            {% if server_host %}
            <div id="auto-fill-banner" class="card" style="margin-bottom: 20px; border-left: 4px solid var(--accent-color); background: rgba(0, 204, 102, 0.1); display: none;">
                <div class="d-flex flex-between" style="align-items: flex-start;">
                    <div style="flex: 1;">
                        <h4 style="margin: 0 0 8px 0; color: var(--accent-color);">üîß Auto-Fill Available</h4>
                        <p style="margin: 0; color: #ccc; font-size: 0.9em; line-height: 1.5;">
                            We detected your server IP (<code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 3px;">{{ server_host }}</code>) and can auto-fill API URLs with default ports. 
                            This is based on the URL you're accessing SeekAndWatch from. Only empty fields will be filled.
                        </p>
                    </div>
                    <div style="display: flex; gap: 10px; margin-left: 15px; flex-shrink: 0;">
                        <button type="button" onclick="acceptAutoFill()" class="btn-primary" style="padding: 8px 16px; font-size: 0.9em;">Accept ‚úì</button>
                        <button type="button" onclick="dismissAutoFill()" class="btn-secondary" style="padding: 8px 16px; font-size: 0.9em;">Dismiss ‚úï</button>
                    </div>
                </div>
            </div>
            {% endif %}
            <div class="card setting-card border-orange">
                <h3>Plex Integration</h3>
                <details class="help-box">
                    <summary>‚ùì How to find your URL & Token</summary>
                    <ol>
                        <li><b>URL:</b> Your server's local IP (e.g. <code>http://192.168.1.50:32400</code>).</li>
                        <li><b>Token:</b> <a href="https://support.plex.tv/articles/204059436-finding-an-authentication-token-x-plex-token/" target="_blank" style="color: var(--accent-color); text-decoration: underline;">View Official Guide</a>.</li>
                    </ol>
                </details>
                
                <div class="input-group">
                    <label class="input-label">Plex Local URL <span style="color: var(--error);">*Required</span></label>
                    <input type="text" id="plex_url" name="plex_url" value="{{ settings.plex_url or '' }}" placeholder="http://192.168.1.50:32400" autocomplete="off">
                </div>
                
                <div class="input-group">
                    <label class="input-label">Plex Token</label>
                    <div style="display: flex; gap: 10px;">
                        <div class="password-wrapper">
                            <input type="password" id="plex_token" name="plex_token" value="{{ settings.plex_token or '' }}" autocomplete="new-password" style="width: 100%; padding-right: 40px;">
                            <button type="button" class="toggle-pass" onclick="toggleVisibility('plex_token', this)">üëÅÔ∏è</button>
                        </div>
                        <button type="button" onclick="testService('plex')" class="btn-secondary">Test ‚ö°</button>
                    </div>
                </div>

                {% if plex_users %}
                <div class="info-panel" style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;">
                    <label class="ignore-label">üõ°Ô∏è Ignore History From:</label>
                    <div class="ignore-grid">
                        {% for user in plex_users %}
                        <label class="ignore-check-label">
                            <input type="checkbox" name="ignored_plex_users" value="{{ user }}" {% if user in current_ignored %}checked{% endif %}>
                            {{ user }}
                        </label>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>

            <div class="card setting-card border-green">
                <h3>Metadata APIs</h3>

                <div class="input-group">
                    <label class="input-label">TMDB API Key (v3) <span style="color: var(--error);">*Required</span></label>
                    <details class="help-box">
                        <summary>‚ùì How to get your TMDB API key</summary>
                        <ol>
                            <li>Create a free account at <a href="https://www.themoviedb.org" target="_blank" style="color: var(--accent-color); text-decoration: underline;">themoviedb.org</a>.</li>
                            <li>Go to <b>Settings ‚Üí API</b> and request an API key.</li>
                            <li>Copy the <b>API Key (v3)</b> and paste it here.</li>
                        </ol>
                    </details>
                    <div class="test-row">
                        <div class="password-wrapper">
                            <input type="password" id="tmdb_key" name="tmdb_key" value="{{ settings.tmdb_key or '' }}" autocomplete="new-password">
                            <button type="button" class="toggle-pass" onclick="toggleVisibility('tmdb_key', this)">üëÅÔ∏è</button>
                        </div>
                        <button type="button" onclick="testService('tmdb')" class="btn-secondary">Test ‚ö°</button>
                    </div>
                </div>

                <div class="input-group" style="border: 1px dashed #2ecc71; padding: 15px; border-radius: 8px; background: rgba(46, 204, 113, 0.05);">
                    <label class="input-label">üçÖ OMDB API Key (Critics Scores)</label>
                    <p class="helper-text">Required to filter by Rotten Tomatoes scores.</p>
                    <details class="help-box">
                        <summary>‚ùì How to get your OMDB API key</summary>
                        <ol>
                            <li>Visit <a href="https://www.omdbapi.com/apikey.aspx" target="_blank" style="color: var(--accent-color); text-decoration: underline;">omdbapi.com/apikey</a>.</li>
                            <li>Choose the free tier and submit your email.</li>
                            <li>Use the key emailed to you and paste it here.</li>
                        </ol>
                    </details>
                    <div class="test-row">
                        <div class="password-wrapper">
                            <input type="password" id="omdb_key" name="omdb_key" value="{{ settings.omdb_key or '' }}" placeholder="xxxxxx" autocomplete="new-password">
                            <button type="button" class="toggle-pass" onclick="toggleVisibility('omdb_key', this)">üëÅÔ∏è</button>
                        </div>
                        <button type="button" onclick="testService('omdb')" class="btn-secondary">Test ‚ö°</button>
                    </div>
                </div>

                <div class="input-group">
                    <label class="input-label">Streaming Regions</label>
                    <input type="text" id="tmdb_region" name="tmdb_region" value="{{ settings.tmdb_region or 'US' }}" placeholder="US, CA" autocomplete="off">
                    <p class="helper-text">Comma separated ISO codes (e.g. <code>US, CA, GB</code>).</p>
                </div>
            </div>

            <div class="card setting-card border-purple">
                <h3>Overseerr & Tautulli</h3>
                
                <div class="input-group">
                    <label class="input-label">Overseerr URL</label>
                    <input type="text" id="overseerr_url" name="overseerr_url" value="{{ settings.overseerr_url or '' }}" placeholder="http://192.168.1.50:5055" autocomplete="off">
                </div>
                
                <div class="input-group">
                    <label class="input-label">Overseerr API Key</label>
                    <details class="help-box">
                        <summary>‚ùì How to find your Overseerr API key</summary>
                        <ol>
                            <li>Open Overseerr and go to <b>Settings</b>.</li>
                            <li>Under <b>General</b>, copy the <b>API Key</b>.</li>
                            <li>Paste it here and click Test.</li>
                        </ol>
                    </details>
                    <div style="display: flex; gap: 10px;">
                        <div class="password-wrapper">
                            <input type="password" id="overseerr_api_key" name="overseerr_api_key" value="{{ settings.overseerr_api_key or '' }}" autocomplete="new-password" style="width: 100%; padding-right: 40px;">
                            <button type="button" class="toggle-pass" onclick="toggleVisibility('overseerr_api_key', this)">üëÅÔ∏è</button>
                        </div>
                        <button type="button" onclick="testService('overseerr')" class="btn-secondary">Test ‚ö°</button>
                    </div>
                </div>
                
                <hr style="border: 0; border-top: 1px solid #333; margin: 20px 0;">
                
                <div class="input-group">
                    <label class="input-label">Tautulli URL</label>
                    <input type="text" id="tautulli_url" name="tautulli_url" value="{{ settings.tautulli_url or '' }}" placeholder="http://192.168.1.50:8181" autocomplete="off">
                </div>
                
                <div class="input-group">
                    <label class="input-label">Tautulli API Key</label>
                    <details class="help-box">
                        <summary>‚ùì How to find your Tautulli API key</summary>
                        <ol>
                            <li>Open Tautulli and go to <b>Settings ‚Üí Web Interface</b>.</li>
                            <li>Scroll to <b>API</b> and copy the API Key.</li>
                            <li>Paste it here and click Test.</li>
                        </ol>
                    </details>
                    <div style="display: flex; gap: 10px;">
                        <div class="password-wrapper">
                            <input type="password" id="tautulli_api_key" name="tautulli_api_key" value="{{ settings.tautulli_api_key or '' }}" autocomplete="new-password" style="width: 100%; padding-right: 40px;">
                            <button type="button" class="toggle-pass" onclick="toggleVisibility('tautulli_api_key', this)">üëÅÔ∏è</button>
                        </div>
                        <button type="button" onclick="testService('tautulli')" class="btn-secondary">Test ‚ö°</button>
                    </div>
                </div>
            </div>

            <div class="card setting-card border-blue">
                <h3>Radarr & Sonarr</h3>
                
                <div class="input-group">
                    <label class="input-label">Radarr URL</label>
                    <input type="text" id="radarr_url" name="radarr_url" value="{{ settings.radarr_url or '' }}" placeholder="http://192.168.1.50:7878" autocomplete="off">
                </div>
                
                <div class="input-group">
                    <label class="input-label">Radarr API Key</label>
                    <details class="help-box">
                        <summary>‚ùì How to find your Radarr API key</summary>
                        <ol>
                            <li>Open Radarr and go to <b>Settings ‚Üí General</b>.</li>
                            <li>Scroll to <b>Security</b> and copy the <b>API Key</b>.</li>
                            <li>Paste it here and click Test.</li>
                        </ol>
                    </details>
                    <div style="display: flex; gap: 10px;">
                        <div class="password-wrapper">
                            <input type="password" id="radarr_api_key" name="radarr_api_key" value="{{ settings.radarr_api_key or '' }}" autocomplete="new-password" style="width: 100%; padding-right: 40px;">
                            <button type="button" class="toggle-pass" onclick="toggleVisibility('radarr_api_key', this)">üëÅÔ∏è</button>
                        </div>
                        <button type="button" onclick="testService('radarr')" class="btn-secondary">Test ‚ö°</button>
                    </div>
                </div>
                
                <hr style="border: 0; border-top: 1px solid #333; margin: 20px 0;">
                
                <div class="input-group">
                    <label class="input-label">Sonarr URL</label>
                    <input type="text" id="sonarr_url" name="sonarr_url" value="{{ settings.sonarr_url or '' }}" placeholder="http://192.168.1.50:8989" autocomplete="off">
                </div>
                
                <div class="input-group">
                    <label class="input-label">Sonarr API Key</label>
                    <details class="help-box">
                        <summary>‚ùì How to find your Sonarr API key</summary>
                        <ol>
                            <li>Open Sonarr and go to <b>Settings ‚Üí General</b>.</li>
                            <li>Scroll to <b>Security</b> and copy the <b>API Key</b>.</li>
                            <li>Paste it here and click Test.</li>
                        </ol>
                    </details>
                    <div style="display: flex; gap: 10px;">
                        <div class="password-wrapper">
                            <input type="password" id="sonarr_api_key" name="sonarr_api_key" value="{{ settings.sonarr_api_key or '' }}" autocomplete="new-password" style="width: 100%; padding-right: 40px;">
                            <button type="button" class="toggle-pass" onclick="toggleVisibility('sonarr_api_key', this)">üëÅÔ∏è</button>
                        </div>
                        <button type="button" onclick="testService('sonarr')" class="btn-secondary">Test ‚ö°</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-scanners" class="tab-content">
            <div class="card setting-card border-info">
                <h3 style="display:flex; align-items:center; gap:10px;">
                    üîÑ Sync Engine & Cache
                </h3>
                <div style="color: #ccc; font-size: 0.9em; line-height: 1.6; margin-bottom: 20px;">
                    <p style="margin-top: 0;"> SeekAndWatch downloads a lightweight index of your library to a local file (Cache) to prevent crashing Plex during large scans.</p>
                    <div class="sync-warning-box">
                        <strong>‚ö†Ô∏è Important:</strong>
                        <ul style="margin: 5px 0 0 0; padding-left: 20px;">
                            <li><b>New Media:</b> If you just added a movie, click <b>"Force Refresh Now"</b> to see it immediately.</li>
                            <li><b>Time:</b> Large libraries (5000+) take <b>1-5 minutes</b> to refresh.</li>
                        </ul>
                    </div>
                    <div class="cache-control-row">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: bold; display: block; margin-bottom: 8px;">Auto-Refresh Interval</label>
                            <div style="display: flex; gap: 10px;">
                                <select id="cache-interval" style="padding: 10px; border-radius: 5px; background: #111; color: white; border: 1px solid #444; flex: 1;">
                                    <option value="12" {% if settings.cache_interval == 12 %}selected{% endif %}>Every 12 Hours (Fastest)</option>
                                    <option value="24" {% if not settings.cache_interval or settings.cache_interval == 24 %}selected{% endif %}>Every 24 Hours (Standard)</option>
                                    <option value="48" {% if settings.cache_interval == 48 %}selected{% endif %}>Every 48 Hours</option>
                                    <option value="168" {% if settings.cache_interval == 168 %}selected{% endif %}>Weekly (Low CPU)</option>
                                </select>
                                <button type="button" onclick="saveCacheSetting()" class="btn-primary">Save</button>
                            </div>
                        </div>
                        <div style="flex: 1; min-width: 200px; text-align: right;">
                            <div style="font-size: 0.85em; color: #888; margin-bottom: 15px;">
                                Last Refreshed: <span id="last-updated" style="color: var(--text-color); font-weight: bold;">{{ cache_age }}</span>
                            </div>
                            <button type="button" onclick="forceRefresh()" id="btn-force" class="btn-secondary" style="width: 100%;">
                                üîÑ Force Refresh Now
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card setting-card border-blue">
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:15px;">
                    <h3 style="margin:0;">üß† Keyword Memory (Cache)</h3>
                    <span style="font-size:0.9em; background:rgba(52, 152, 219, 0.2); color:#3498db; padding:4px 10px; border-radius:4px; border:1px solid #3498db;">
                        Stored: <strong>{{ keyword_count }}</strong> / {{ settings.keyword_cache_size or 3000 }}
                    </span>
                </div>
                
                <p class="text-muted small">
                    To save API calls, we store keyword tags (e.g., "zombie", "time travel") in the database.
                    When this limit is reached, the oldest keywords are deleted to make room for new ones.
                </p>

                <div class="input-group" style="margin-bottom: 0;">
                    <label class="input-label">Max Keywords to Store <span style="font-weight:normal; color:#888;">(Recommended: 2000-6000)</span></label>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <input type="number" name="keyword_cache_size" class="form-control" 
                               value="{{ settings.keyword_cache_size or 3000 }}" 
                               min="100" max="6000" step="100" 
                               style="max-width:150px; background:#111; border:1px solid #444; color:white; padding:10px; border-radius:5px;">
                        <span style="color:#aaa; font-size:0.9em;">entries</span>
                    </div>
                </div>
            </div>

            <div class="card setting-card border-green">
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:15px;">
                    <h3 style="margin:0;">‚è±Ô∏è Runtime Memory (Cache)</h3>
                    <span style="font-size:0.9em; background:rgba(46, 204, 113, 0.2); color:#2ecc71; padding:4px 10px; border-radius:4px; border:1px solid #2ecc71;">
                        Stored: <strong>{{ runtime_count }}</strong> / {{ settings.runtime_cache_size or 3000 }}
                    </span>
                </div>
                
                <p class="text-muted small">
                    To save API calls and speed up recommendations, we store movie runtime data in the database.
                    When this limit is reached, the oldest runtime entries are deleted to make room for new ones.
                </p>

                <div class="input-group" style="margin-bottom: 0;">
                    <label class="input-label">Max Runtime Entries to Store <span style="font-weight:normal; color:#888;">(Recommended: 2000-6000)</span></label>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <input type="number" name="runtime_cache_size" class="form-control" 
                               value="{{ settings.runtime_cache_size or 3000 }}" 
                               min="100" max="6000" step="100" 
                               style="max-width:150px; background:#111; border:1px solid #444; color:white; padding:10px; border-radius:5px;">
                        <span style="color:#aaa; font-size:0.9em;">entries</span>
                    </div>
                </div>
            </div>

            <div class="card setting-card border-purple">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center" style="padding:0; margin-bottom:15px;">
                    <h3 style="margin:0; display:flex; align-items:center; gap:10px;">üì° Background Alias Discovery</h3>
                    <div>
                        <span class="badge bg-dark border border-secondary text-warning me-2" id="next-scan-badge" style="padding:5px 10px; border-radius:4px; font-size:0.8em; margin-right:10px;">
                            <i class="fas fa-clock"></i> Next: --:--
                        </span>
                        <span class="badge bg-info" id="db-count-badge" style="background:#3498db; color:white; padding:5px 10px; border-radius:4px; font-size:0.8em;">Loading...</span>
                    </div>
                </div>
                
                <p class="text-muted small">
                    Automatically scan your Plex Cache in the background to find "hidden" aliases.
                </p>
                
                <div class="scanner-row">
                    <div class="flex-item">
                        <label class="form-label text-muted small">Batch Size</label>
                        <select class="filter-input" id="scan-batch" style="width:100%;">
                            <option value="200">200 Items</option>
                            <option value="500">500 Items</option>
                            <option value="800">800 Items (Takes ~10 mins)</option>
                        </select>
                    </div>
                    <div class="flex-item">
                        <label class="form-label text-muted small">Interval</label>
                        <select class="filter-input" id="scan-interval" style="width:100%;">
                            <option value="5">Every 5 Mins</option>
                            <option value="15" selected>Every 15 Mins</option>
                            <option value="30">Every 30 Mins</option>
                        </select>
                    </div>
                    <div class="spacer-col-1"></div>
                    <div class="flex-item" style="display:flex; align-items:center; padding-bottom:12px;">
                        <input type="checkbox" id="scan-toggle" style="width:20px; height:20px; margin-right:10px;">
                        <label for="scan-toggle" style="margin:0; cursor:pointer;">Enable Background Scan</label>
                    </div>
                    <div class="flex-item" style="text-align:right; display: flex; gap: 10px;">
                        <button type="button" class="btn-danger" style="flex: 1;" onclick="resetScannerIndex()">
                            Reset
                        </button>
                        <button type="button" class="btn-primary" style="background:#2ecc71; color:white; border:none; flex: 1;" onclick="saveScannerSettings()">
                            Save
                        </button>
                    </div>
                </div>                
            </div>

            <div class="card setting-card border-blue" style="margin-top: 30px;">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center" style="padding:0; margin-bottom:15px;">
                    <h3 style="margin:0; display:flex; align-items:center; gap:10px;">üé¨ Radarr & Sonarr Scanner</h3>
                    <div>
                        <span class="badge bg-dark border border-secondary text-info me-2" id="radarr-sonarr-count-badge" style="padding:5px 10px; border-radius:4px; font-size:0.8em; margin-right:10px;">
                            Loading...
                        </span>
                    </div>
                </div>
                
                <p class="text-muted small">
                    Scan your Radarr and Sonarr libraries to exclude items from recommendations. Items in Radarr/Sonarr are considered "owned" and won't appear in Smart Discovery results.
                </p>
                
                <div style="margin-bottom: 15px; padding: 10px; background: rgba(52, 152, 219, 0.1); border-radius: 6px; border: 1px solid rgba(52, 152, 219, 0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: #3498db;">Last Scan:</strong>
                            <span id="radarr-sonarr-last-scan" style="color: #ccc; margin-left: 8px;">Never</span>
                        </div>
                        <button type="button" class="btn-primary" style="background:#3498db; color:white; border:none; padding:6px 15px; border-radius:4px; cursor:pointer;" onclick="forceRadarrSonarrCacheRefresh()">
                            Force Refresh Now
                        </button>
                    </div>
                </div>
                
                <div class="scanner-row">
                    <div class="flex-item">
                        <label class="form-label text-muted small">Scan Interval (Hours)</label>
                        <select class="filter-input" id="radarr-sonarr-interval" style="width:100%;">
                            <option value="6">Every 6 Hours</option>
                            <option value="12">Every 12 Hours</option>
                            <option value="24" selected>Every 24 Hours</option>
                            <option value="48">Every 48 Hours</option>
                        </select>
                    </div>
                    <div class="spacer-col-1"></div>
                    <div class="flex-item" style="display:flex; align-items:center; padding-bottom:12px;">
                        <input type="checkbox" id="radarr-sonarr-toggle" style="width:20px; height:20px; margin-right:10px;">
                        <label for="radarr-sonarr-toggle" style="margin:0; cursor:pointer;">Enable Auto-Scan</label>
                    </div>
                    <div class="flex-item" style="text-align:right;">
                        <button type="button" class="btn-primary" style="background:#2ecc71; color:white; border:none; flex: 1;" onclick="saveRadarrSonarrScannerSettings()">
                            Save
                        </button>
                    </div>
                </div>                
            </div>
        </div>

        <div id="tab-system" class="tab-content">
            <div class="card setting-card border-blue">
                <h3>üñ•Ô∏è System Maintenance</h3>
                <div class="flex-row-wrap" style="display:flex; gap:20px; margin-bottom:20px;">
                    <div class="input-group flex-item" style="flex:1;">
                        <label class="input-label">Backup Interval (Days)</label>
                        <input type="number" id="backup_interval" name="backup_interval" value="{{ settings.backup_interval or 2 }}" min="1">
                    </div>
                    <div class="input-group flex-item" style="flex:1;">
                        <label class="input-label">Retention (Days)</label>
                        <input type="number" id="backup_retention" name="backup_retention" value="{{ settings.backup_retention or 7 }}" min="1">
                    </div>
                </div>
                
                <hr style="border-color: #333; margin: 20px 0;">
                
                <div style="margin-top:20px; border-top:1px solid #333; padding-top:20px;">
                    <div class="backup-controls" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; gap:10px;">
                        <div>
                            <h4 style="margin:0;">Existing Backups</h4>
                            <div style="font-size:0.85em; color:#888; margin-top:4px;">
                                Import a backup ZIP from a previous install to restore it here.
                            </div>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <input type="file" id="backup-upload-input" accept=".zip" style="display:none;" onchange="handleBackupUpload(this.files)">
                            <button type="button" onclick="triggerBackupUpload()" class="btn-secondary" style="padding:8px 15px;">Upload Backup</button>
                            <button type="button" onclick="createBackup()" class="btn-primary" style="padding:8px 15px;">+ Backup Now</button>
                        </div>
                    </div>
                    <div style="font-size:0.85em; color:#888; margin:8px 0 12px;">
                        üîí Admin-only: only admins can upload or restore backups.
                    </div>
                    <div id="backup-list" class="backup-list">
                        <div style="text-align:center; color:#777;">Loading...</div>
                    </div>
                </div>
            </div>

            <div class="card setting-card border-blue">
                <h3>üîë Change password</h3>
                <p class="text-muted">Set a new password for your account. You must enter your current password.</p>
                <div class="input-group" style="max-width: 320px; margin-bottom: 12px;">
                    <label class="input-label">Current password</label>
                    <input type="password" id="change-pw-current" placeholder="Current password" autocomplete="current-password" style="width: 100%; padding: 10px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 6px;">
                </div>
                <div class="input-group" style="max-width: 320px; margin-bottom: 12px;">
                    <label class="input-label">New password</label>
                    <input type="password" id="change-pw-new" placeholder="At least 8 characters" minlength="8" autocomplete="new-password" style="width: 100%; padding: 10px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 6px;">
                </div>
                <div class="input-group" style="max-width: 320px; margin-bottom: 12px;">
                    <label class="input-label">Confirm new password</label>
                    <input type="password" id="change-pw-confirm" placeholder="Same again" minlength="8" autocomplete="new-password" style="width: 100%; padding: 10px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 6px;">
                </div>
                <div id="change-pw-message" style="margin-bottom: 10px; font-size: 0.9rem;"></div>
                <button type="button" onclick="submitChangePassword()" class="btn-secondary" id="btn-change-password" style="padding:8px 15px;">Change password</button>
            </div>

            <div class="card setting-card border-purple">
                <h3>üîê Account recovery</h3>
                <p class="text-muted">Generate one-time recovery codes. Save them somewhere safe; if you lose your password, use one code on the login page to set a new password. Old codes are invalid when you generate new ones. If you're the only admin and get locked out with no codes, the server owner can reset your password in the database.</p>
                <button type="button" onclick="generateRecoveryCodes()" class="btn-secondary" id="btn-generate-codes" style="padding:8px 15px;">Generate recovery codes</button>
            </div>

            <div class="card danger-zone">
                <h3 style="color: var(--error); display: flex; align-items: center; gap: 10px; margin-top: 0;">
                    ‚ö†Ô∏è Danger Zone
                </h3>
                <p style="color: #ccc; margin-bottom: 20px;">
                    Permanently delete your profile, settings, and watch history.
                </p>
                <button type="button" onclick="document.getElementById('delete-account-form').submit();" class="btn-danger" style="width:100%;">
                    üóëÔ∏è Delete My Account
                </button>
            </div>
        </div>


        <button type="submit" class="btn-save" id="main-save-btn">Save Configuration üíæ</button>
    </form>
</div>

<form id="delete-account-form" action="{{ url_for('delete_profile') }}" method="POST" onsubmit="return confirm('üö® ARE YOU SURE? This cannot be undone.');" style="display:none;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
</form>

<div id="settingsModal" class="custom-modal-overlay">
    <div class="custom-modal-box">
        <div class="modal-icon" id="modalIcon">‚úÖ</div>
        <h3 class="modal-title" id="modalTitle">Settings Saved</h3>
        <p class="modal-message" id="modalMessage">Configuration updated successfully.</p>
        <button id="modalBtn" class="modal-btn">OK</button>
    </div>
</div>

<script>
// Auto-fill API URLs based on server IP
function acceptAutoFill() {
    const serverHost = "{{ server_host|default('') }}";
    if (!serverHost) return;
    
    // Default ports for each service
    const defaults = {
        'plex_url': `http://${serverHost}:32400`,
        'radarr_url': `http://${serverHost}:7878`,
        'sonarr_url': `http://${serverHost}:8989`,
        'overseerr_url': `http://${serverHost}:5055`,
        'tautulli_url': `http://${serverHost}:8181`
    };
    
    let filledCount = 0;
    // Only fill if field is empty
    Object.keys(defaults).forEach(id => {
        const field = document.getElementById(id);
        if (field && !field.value.trim()) {
            field.value = defaults[id];
            filledCount++;
        }
    });
    
    // Hide the banner
    dismissAutoFill();
    
    if (filledCount > 0) {
        showToast();
    }
}

function dismissAutoFill() {
    const banner = document.getElementById('auto-fill-banner');
    if (banner) {
        banner.style.display = 'none';
    }
}

// Tabs
function openTab(evt, tabName) {
    var i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
        tabcontent[i].classList.remove("active");
    }
    tablinks = document.getElementsByClassName("tab-link");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    document.getElementById(tabName).style.display = "block";
    setTimeout(() => {
        document.getElementById(tabName).classList.add("active");
    }, 10);
    evt.currentTarget.className += " active";
}

// Small UI helpers
function toggleVisibility(id, btn) {
    const el = document.getElementById(id);
    if (el.type === "password") { el.type = "text"; btn.innerText = "üîí"; } 
    else { el.type = "password"; btn.innerText = "üëÅÔ∏è"; }
}

function showModal(icon, title, message, isSuccess) {
    const modal = document.getElementById('settingsModal');
    document.getElementById('modalIcon').innerText = icon;
    document.getElementById('modalTitle').innerText = title;
    document.getElementById('modalMessage').innerText = message;
    const btn = document.getElementById('modalBtn');
    btn.onclick = function() { modal.style.display = 'none'; if(isSuccess) location.reload(); };
    modal.style.display = 'flex';
}

function showToast() {
    const toast = document.getElementById('save-toast');
    toast.style.opacity = '1';
    setTimeout(() => { toast.style.opacity = '0'; }, 2000);
}

// Scanner + cache controls
let countdownInterval;

// Auto-fill API URLs based on server IP
function acceptAutoFill() {
    const serverHost = "{{ server_host|default('') }}";
    if (!serverHost) return;
    
    // Default ports for each service
    const defaults = {
        'plex_url': `http://${serverHost}:32400`,
        'radarr_url': `http://${serverHost}:7878`,
        'sonarr_url': `http://${serverHost}:8989`,
        'overseerr_url': `http://${serverHost}:5055`,
        'tautulli_url': `http://${serverHost}:8181`
    };
    
    let filledCount = 0;
    // Only fill if field is empty
    Object.keys(defaults).forEach(id => {
        const field = document.getElementById(id);
        if (field && !field.value.trim()) {
            field.value = defaults[id];
            filledCount++;
        }
    });
    
    // Hide the banner
    dismissAutoFill();
    
    if (filledCount > 0) {
        showToast();
    }
}

function dismissAutoFill() {
    const banner = document.getElementById('auto-fill-banner');
    if (banner) {
        banner.style.display = 'none';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    loadBackups();
    fetchStatus();
    checkRadarrSonarrCacheStatus();
    setInterval(fetchStatus, 30000);
    setInterval(checkCacheStatus, 2000);
    setInterval(checkRadarrSonarrCacheStatus, 30000);
    
    // Check if auto-fill banner should be shown (only if there are empty URL fields)
    {% if server_host %}
    const serverHost = "{{ server_host }}";
    const urlFields = ['plex_url', 'radarr_url', 'sonarr_url', 'overseerr_url', 'tautulli_url'];
    const hasEmptyFields = urlFields.some(id => {
        const field = document.getElementById(id);
        return field && !field.value.trim();
    });
    
    if (hasEmptyFields) {
        const banner = document.getElementById('auto-fill-banner');
        if (banner) {
            banner.style.display = 'block';
        }
    }
    {% endif %}

    const checkboxes = document.querySelectorAll('input[name="ignored_plex_users"]');
    checkboxes.forEach(box => {
        box.addEventListener('change', function() {
            const checkedUsers = Array.from(checkboxes).filter(i => i.checked).map(i => i.value);
            fetch(API_UPDATE_IGNORE_LIST, {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ ignored_users: checkedUsers })
            }).then(r => r.json()).then(d => { if (d.status === 'success') showToast(); });
        });
    });

    const batchSelect = document.getElementById('scan-batch');
    const intervalSelect = document.getElementById('scan-interval');

    function validateScannerOptions() {
        if(!batchSelect || !intervalSelect) return;
        
        const batchVal = parseInt(batchSelect.value);
        const opt5 = intervalSelect.querySelector('option[value="5"]');
        
        if (batchVal > 200) {
            opt5.disabled = true;
            opt5.text = "Every 5 Mins (Locked üîí)";
            if (intervalSelect.value === "5") {
                intervalSelect.value = "15";
            }
        } else {
            opt5.disabled = false;
            opt5.text = "Every 5 Mins";
        }
    }

    if (batchSelect && intervalSelect) {
        batchSelect.addEventListener('change', validateScannerOptions);
        validateScannerOptions();
    }

    // Trim trailing slashes so URLs stay consistent.
    ['plex_url', 'overseerr_url', 'tautulli_url'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('blur', function(e) {
                let val = e.target.value;
                let clean = val.trim().replace(/\/+$/, '');
                if (val !== clean) {
                    e.target.value = clean;
                    console.log(`Auto-cleaned ${id}:`, clean);
                }
            });
        }
    });

}); 

function fetchStatus() {
    fetch(API_SCANNER_STATUS).then(r => r.json()).then(data => {
        const toggle = document.getElementById('scan-toggle');
        if(toggle) toggle.checked = data.enabled;
        
        const batchSelect = document.getElementById('scan-batch');
        if(batchSelect) {
            const validOptions = Array.from(batchSelect.options).map(o => o.value);
            if (validOptions.includes(String(data.batch))) batchSelect.value = data.batch;
            else batchSelect.value = '50';
        }
        
        const intSelect = document.getElementById('scan-interval');
        if(intSelect) {
            intSelect.value = data.interval;
            const batchEl = document.getElementById('scan-batch');
            if(batchEl) batchEl.dispatchEvent(new Event('change'));
        }
        
        const badge = document.getElementById('db-count-badge');
        if(badge) badge.innerText = data.total_indexed + " Aliases Indexed";
        
        // Load Radarr/Sonarr scanner settings
        fetch(API_GET_RADARR_SONARR_CACHE_STATUS).then(r => r.json()).then(rsData => {
            const rsToggle = document.getElementById('radarr-sonarr-toggle');
            const rsInterval = document.getElementById('radarr-sonarr-interval');
            if(rsToggle) rsToggle.checked = rsData.enabled || false;
            if(rsInterval) rsInterval.value = rsData.interval || 24;
            checkRadarrSonarrCacheStatus();
        }).catch(() => {});
        
        const nextBadge = document.getElementById('next-scan-badge');
        if(nextBadge) {
            if(data.enabled && data.next_ts > 0) {
                startCountdown(data.next_ts);
                nextBadge.classList.remove('d-none');
            } else {
                clearInterval(countdownInterval);
                nextBadge.classList.add('d-none');
            }
        }
    }).catch(e => console.log("Scanner status fetch failed", e));
}

function startCountdown(targetTs) {
    clearInterval(countdownInterval);
    function update() {
        const now = Math.floor(Date.now() / 1000);
        const diff = targetTs - now;
        const badge = document.getElementById('next-scan-badge');
        if(!badge) return;
        
        if (diff <= 0) {
            badge.innerText = "Next Scan: Pending...";
            badge.classList.remove('text-warning');
            badge.classList.add('text-danger', 'blink');
        } else {
            const mins = Math.floor(diff / 60);
            const secs = diff % 60;
            const minStr = mins < 10 ? "0" + mins : mins;
            const secStr = secs < 10 ? "0" + secs : secs;
            badge.innerText = `Next Scan: ${minStr}:${secStr}`;
            badge.classList.remove('text-danger', 'blink');
            badge.classList.add('text-warning');
        }
    }
    update();
    countdownInterval = setInterval(update, 1000);
}

function saveScannerSettings() {
    const enabled = document.getElementById('scan-toggle').checked;
    const batch = document.getElementById('scan-batch').value;
    const interval = document.getElementById('scan-interval').value;
    
    fetch(API_SCANNER_SAVE, {
        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({enabled, batch, interval})
    }).then(r => r.json()).then(data => {
        const btn = document.querySelector('button[onclick="saveScannerSettings()"]');
        const oldText = btn ? btn.innerText : 'Save';
        if (btn) btn.innerText = "Saved ‚úÖ";
        setTimeout(() => { fetchStatus(); if (btn) btn.innerText = oldText; }, 1000);
    }).catch(() => {
        const btn = document.querySelector('button[onclick="saveScannerSettings()"]');
        if (btn) btn.innerText = 'Save';
        showModal('‚ùå', 'Error', 'Could not save scanner settings. Please try again.', false);
    });
}

function saveCacheSetting() {
    const val = document.getElementById('cache-interval').value;
    fetch(API_SAVE_CACHE_SETTINGS, {
        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({interval: val})
    }).then(r => r.json()).then(d => {
        if(d.status === 'success') showToast();
        else alert(d.message);
    }).catch(() => { showModal('‚ùå', 'Error', 'Could not save. Please try again.', false); });
}

function forceRefresh() {
    const btn = document.getElementById('btn-force');
    btn.disabled = true; 
    btn.innerText = "Refreshing... ‚è≥";
    
    fetch(API_FORCE_CACHE_REFRESH, {method: 'POST'})
    .then(r => r.json())
    .then(data => {
        if(data.status !== 'success') {
            alert("Error: " + data.message);
            btn.disabled = false;
            btn.innerText = "üîÑ Force Refresh Now";
        }
    });
}

function checkCacheStatus() {
    fetch(API_GET_CACHE_STATUS).then(r => r.json()).then(data => {
        const forceBtn = document.getElementById('btn-force');
        const txt = document.getElementById('last-updated');
        if(!forceBtn) return;

        if(data.running) {
            forceBtn.disabled = true;
            forceBtn.innerText = `Refreshing (${data.progress}) ‚è≥`;
        } else {
            if(forceBtn.innerText.includes("Refreshing")) {
                forceBtn.disabled = false;
                forceBtn.innerText = "üîÑ Force Refresh Now";
                if(txt) txt.innerText = "Just Now"; 
            }
        }
    });
}

function forceRadarrSonarrCacheRefresh() {
    const btn = event.target;
    btn.disabled = true; 
    btn.innerText = "Refreshing... ‚è≥";
    
    fetch(API_FORCE_RADARR_SONARR_CACHE_REFRESH, {method: 'POST'})
    .then(r => r.json())
    .then(data => {
        if(data.status !== 'success') {
            alert("Error: " + (data.message || "Failed to start refresh"));
            btn.disabled = false;
            btn.innerText = "Force Refresh Now";
        } else {
            setTimeout(() => {
                checkRadarrSonarrCacheStatus();
                btn.disabled = false;
                btn.innerText = "Force Refresh Now";
            }, 2000);
        }
    }).catch(err => {
        alert("Error: " + err.message);
        btn.disabled = false;
        btn.innerText = "Force Refresh Now";
    });
}

function checkRadarrSonarrCacheStatus() {
    fetch(API_GET_RADARR_SONARR_CACHE_STATUS).then(r => r.json()).then(data => {
        const countBadge = document.getElementById('radarr-sonarr-count-badge');
        const lastScan = document.getElementById('radarr-sonarr-last-scan');
        
        if(countBadge) {
            countBadge.innerText = `${data.count || 0} Items`;
        }
        if(lastScan) {
            lastScan.innerText = data.last_scan || "Never";
        }
    }).catch(err => {
        console.error("Failed to get Radarr/Sonarr cache status:", err);
    });
}

function saveRadarrSonarrScannerSettings() {
    const enabled = document.getElementById('radarr-sonarr-toggle').checked;
    const interval = document.getElementById('radarr-sonarr-interval').value;
    
    fetch(API_RADARR_SONARR_SCANNER_SAVE, {
        method: 'POST', 
        headers: {'Content-Type': 'application/json'}, 
        body: JSON.stringify({enabled, interval})
    }).then(r => r.json()).then(data => {
        const btn = document.querySelector('button[onclick="saveRadarrSonarrScannerSettings()"]');
        const oldText = btn.innerText;
        btn.innerText = "Saved ‚úÖ";
        setTimeout(() => { 
            checkRadarrSonarrCacheStatus(); 
            btn.innerText = oldText; 
        }, 1000);
    }).catch(err => {
        alert("Error saving settings: " + err.message);
    });
}

// Service testing + main save
function testService(service) {
    let payload = { service: service };
    let btn;

    if (service === 'plex') {
        payload.url = document.getElementById('plex_url').value;
        payload.token = document.getElementById('plex_token').value;
        btn = document.querySelector('button[onclick="testService(\'plex\')"]');
    } else if (service === 'tmdb') {
        payload.api_key = document.getElementById('tmdb_key').value;
        btn = document.querySelector('button[onclick="testService(\'tmdb\')"]');
    } else if (service === 'omdb') {
        payload.api_key = document.getElementById('omdb_key').value;
        btn = document.querySelector('button[onclick="testService(\'omdb\')"]');
    } else if (service === 'overseerr') {
        payload.url = document.getElementById('overseerr_url').value;
        payload.api_key = document.getElementById('overseerr_api_key').value;
        btn = document.querySelector('button[onclick="testService(\'overseerr\')"]');
    } else if (service === 'tautulli') {
        payload.url = document.getElementById('tautulli_url').value;
        payload.api_key = document.getElementById('tautulli_api_key').value;
        btn = document.querySelector('button[onclick="testService(\'tautulli\')"]');
    } else if (service === 'radarr') {
        payload.url = document.getElementById('radarr_url').value;
        payload.api_key = document.getElementById('radarr_api_key').value;
        btn = document.querySelector('button[onclick="testService(\'radarr\')"]');
    } else if (service === 'sonarr') {
        payload.url = document.getElementById('sonarr_url').value;
        payload.api_key = document.getElementById('sonarr_api_key').value;
        btn = document.querySelector('button[onclick="testService(\'sonarr\')"]');
    }

    const originalText = btn.innerText;
    btn.innerText = "Testing...";
    btn.disabled = true;

    fetch(API_TEST_CONNECTION, {
        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
    }).then(r => r.json()).then(data => {
        btn.disabled = false;
        btn.innerText = originalText;
        showModal(data.status==='success'?'‚úÖ':'‚ùå', data.status==='success'?'Connected!':'Connection Failed', data.message, false);
    }).catch(err => {
        btn.disabled = false;
        btn.innerText = originalText;
        showModal('‚ùå', 'Error', 'Could not reach server.', false);
    });
}

function isValidUrlField(val) {
    if (!val || !String(val).trim()) return true;
    const v = String(val).trim().toLowerCase();
    if (v.startsWith('javascript:') || v.startsWith('data:')) return false;
    return v.startsWith('http://') || v.startsWith('https://');
}

document.addEventListener('submit', function(e) {
    // Only intercept the main settings form.
    if (e.target && e.target.id === 'settings-form') {
        e.preventDefault(); 
        
        // Validate URL fields before submit
        const urlIds = ['plex_url', 'overseerr_url', 'tautulli_url', 'radarr_url', 'sonarr_url'];
        for (const id of urlIds) {
            const el = document.getElementById(id);
            if (el && !isValidUrlField(el.value)) {
                showModal('‚ùå', 'Invalid URL', el.value ? 'URLs must start with http:// or https:// and cannot be javascript: or data:.' : '', false);
                return;
            }
        }
        
        // Trim trailing slashes before save.
        ['plex_url', 'overseerr_url', 'tautulli_url'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.value = el.value.trim().replace(/\/+$/, '');
            }
        });

        const btn = document.getElementById('main-save-btn');
        if (!btn) return;
        const originalText = btn.innerText;
        btn.innerText = "Saving... ‚è≥"; 
        btn.disabled = true;

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000);
        
        fetch(e.target.action, { method: 'POST', body: new FormData(e.target), signal: controller.signal })
        .then(response => response.json())
        .then(data => {
            clearTimeout(timeoutId);
            btn.innerText = originalText; 
            btn.disabled = false;
            showModal(data.status==='success'?'‚úÖ':'‚ùå', data.status==='success'?'Success!':'Error', data.message, data.status==='success');
        })
        .catch(err => {
            clearTimeout(timeoutId);
            btn.innerText = originalText; 
            btn.disabled = false;
            showModal('‚ùå', 'Error', err.name === 'AbortError' ? 'Request timed out. Please try again.' : 'Could not save. Please try again.', false);
        });
    }
});

function resetScannerIndex() {
    if(!confirm("üö® Are you sure? This will wipe the alias database and force a full re-scan.")) return;
    
    const btn = document.querySelector('button[onclick="resetScannerIndex()"]');
    if (!btn) return;
    const originalText = btn.innerText;
    btn.innerText = "Wiping...";
    btn.disabled = true;

    fetch(API_SCANNER_RESET, {method: 'POST'})
    .then(r => r.json())
    .then(data => {
        btn.innerText = originalText;
        btn.disabled = false;
        showModal(data.status==='success'?'‚úÖ':'‚ùå', 'Scanner Reset', data.message, false);
        if(data.status === 'success') fetchStatus();
    })
    .catch(() => {
        btn.innerText = originalText;
        btn.disabled = false;
        showModal('‚ùå', 'Error', 'Request failed. Please try again.', false);
    });
}

// Backups
function loadBackups() {
    const div = document.getElementById('backup-list');
    fetch(API_BACKUPS).then(r => r.json()).then(data => {
        if (!div) return;
        if (!Array.isArray(data) || data.length === 0) { div.innerHTML = '<div style="text-align:center; color:#777;">No backups found.</div>'; return; }
        
        let html = '<table class="logs-table">';
        data.forEach(b => {
            html += `<tr>
                <td style="padding:8px;">${b.date}</td>
                <td style="padding:8px; color:#aaa;">${b.size}</td>
                <td style="padding:8px; text-align:right;">
                    <a href="${BACKUP_DOWNLOAD_URL_PREFIX}${b.filename}" style="text-decoration:none; margin-right:10px;">‚¨áÔ∏è</a>
                    <span onclick="restoreBackup('${b.filename}')" style="cursor:pointer; margin-right:10px;" title="Restore">‚ôªÔ∏è</span>
                    <span onclick="deleteBackup('${b.filename}')" style="cursor:pointer; color:#e74c3c;" title="Delete">üóëÔ∏è</span>
                </td></tr>`;
        });
        div.innerHTML = html + '</table>';
    }).catch(() => { if (div) div.innerHTML = '<div style="text-align:center; color:#e74c3c;">Failed to load backups.</div>'; });
}
function createBackup() {
    const btn = document.querySelector('button[onclick="createBackup()"]');
    if (btn) { btn.disabled = true; btn.innerText = 'Creating...'; }
    fetch(API_BACKUP_CREATE, {method: 'POST'})
        .then(r => r.json())
        .then(data => { loadBackups(); showModal('üì¶', 'Backup Created', data.message, false); })
        .catch(() => showModal('‚ùå', 'Error', 'Backup failed. Please try again.', false))
        .finally(() => { if (btn) { btn.disabled = false; btn.innerText = '+ Backup Now'; } });
}
function deleteBackup(f) {
    if (!confirm("Delete backup?")) return;
    fetch(API_BACKUP_DELETE_BASE + f, {method: 'DELETE'}).then(()=>loadBackups()).catch(() => showModal('‚ùå', 'Error', 'Delete failed. Please try again.', false));
}
function restoreBackup(f) {
    if (!confirm("Overwrite DB?")) return;
    fetch(API_BACKUP_RESTORE_BASE + f, {method: 'POST'})
        .then(r=>r.json())
        .then(d=>{ showModal('‚ôªÔ∏è', 'Restored', d.message, true); loadBackups(); })
        .catch(() => showModal('‚ùå', 'Error', 'Restore failed. Please try again.', false));
}

function triggerBackupUpload() {
    const input = document.getElementById('backup-upload-input');
    if (input) input.click();
}

function handleBackupUpload(files) {
    const file = files && files[0];
    if (!file) return;
    if (!file.name.toLowerCase().endsWith('.zip')) {
        showModal('‚ùå', 'Invalid File', 'Please select a .zip backup file.', false);
        return;
    }

    const formData = new FormData();
    formData.append('backup_file', file);

    fetch(API_BACKUP_UPLOAD, { method: 'POST', body: formData })
        .then(r => r.json())
        .then(d => {
            if (d.status === 'success') {
                loadBackups();
                showModal('‚úÖ', 'Backup Imported', d.message, false);
            } else {
                showModal('‚ùå', 'Upload Failed', d.message || 'Upload failed.', false);
            }
        })
        .catch(() => showModal('‚ùå', 'Upload Failed', 'Could not upload backup.', false))
        .finally(() => { if (input) input.value = ''; });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
<style>
    @keyframes blink { 50% { opacity: 0.5; } }
    .blink { animation: blink 1s linear infinite; }
</style>
{% endblock %}