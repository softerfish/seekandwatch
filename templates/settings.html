{% extends "base.html" %}
{% block content %}

<div class="settings-container">
    <div class="settings-header">
        <h2>‚öôÔ∏è System Configuration</h2>
        <p class="text-muted">Manage connections to Plex, Metadata APIs, Overseerr, Tautulli, Backups, and Logs.</p>
    </div>
<div id="save-toast" style="position: fixed; top: 80px; right: 20px; background: #28a745; color: white; padding: 10px 20px; border-radius: 5px; opacity: 0; transition: opacity 0.5s; z-index: 9999; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
    <i class="fas fa-check-circle"></i> Saved
</div>
    <div id="message-container"></div>

    <form id="settings-form" action="{{ url_for('settings') }}" method="POST" autocomplete="off">
        
        <div class="card setting-card border-orange">
            <h3>Plex Integration</h3>
            
            <details class="help-box">
                <summary>‚ùì How to find your URL & Token</summary>
                <ol>
                    <li><b>URL:</b> Your server's local IP (e.g. <code>http://192.168.1.50:32400</code>).</li>
                    <li>
                        <b>Token:</b> 
                        <a href="https://support.plex.tv/articles/204059436-finding-an-authentication-token-x-plex-token/" target="_blank" style="color: var(--accent-color); text-decoration: underline;">View Official Guide</a> 
                        or open any media XML in Plex Web and look for <code>X-Plex-Token=...</code> in the URL.
                    </li>
                </ol>
            </details>

            <div class="input-group">
                <label class="input-label">Plex Local URL <span style="color: var(--error);">*Required</span></label>
                <input type="text" id="plex_url" name="plex_url" value="{{ settings.plex_url or '' }}" 
                       placeholder="http://192.168.1.50:32400" autocomplete="off">
            </div>

            <div class="input-group">
                <label class="input-label">Plex Token</label>
                <div class="test-wrapper">
                    <div class="password-wrapper" style="flex: 1;">
                        <input type="password" id="plex_token" name="plex_token" value="{{ settings.plex_token or '' }}" autocomplete="new-password">
                        <button type="button" class="toggle-pass" onclick="toggleVisibility('plex_token', this)">üëÅÔ∏è</button>
                    </div>
                    <button type="button" class="btn-test" onclick="testService('plex')">Test ‚ö°</button>
                </div>
            </div>

            {% if plex_users %}
            <div class="info-panel">
                <label class="ignore-label">üõ°Ô∏è Ignore History From:</label>
                <div class="ignore-grid">
                    {% for user in plex_users %}
                    <label class="ignore-check-label">
                        <input type="checkbox" name="ignored_plex_users" value="{{ user }}" {% if user in current_ignored %}checked{% endif %}>
                        {{ user }}
                    </label>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <div class="card setting-card border-green">
            <h3>Metadata APIs</h3>

            <div class="input-group">
                <label class="input-label">TMDB API Key (v3) <span style="color: var(--error);">*Required</span></label>
                <div class="test-wrapper">
                    <div class="password-wrapper" style="flex: 1;">
                        <input type="password" id="tmdb_key" name="tmdb_key" value="{{ settings.tmdb_key or '' }}" autocomplete="new-password">
                        <button type="button" class="toggle-pass" onclick="toggleVisibility('tmdb_key', this)">üëÅÔ∏è</button>
                    </div>
                    <button type="button" class="btn-test" onclick="testService('tmdb')">Test ‚ö°</button>
                </div>
            </div>

            <div class="input-group highlight-box green-dashed">
                <label class="input-label">üçÖ OMDB API Key (Critics Scores)</label>
                <p class="helper-text">Required to filter by Rotten Tomatoes scores.</p>
                <div class="test-wrapper">
                    <div class="password-wrapper" style="flex: 1;">
                        <input type="password" id="omdb_key" name="omdb_key" value="{{ settings.omdb_key or '' }}" placeholder="xxxxxx" autocomplete="new-password">
                        <button type="button" class="toggle-pass" onclick="toggleVisibility('omdb_key', this)">üëÅÔ∏è</button>
                    </div>
                    <button type="button" class="btn-test" onclick="testService('omdb')">Test ‚ö°</button>
                </div>
            </div>

            <div class="input-group" style="margin-top: 20px;">
                <label class="input-label">Streaming Regions</label>
                <p class="helper-text">Comma separated ISO codes (e.g. <code>US, CA, GB</code>).</p>
                <input type="text" id="tmdb_region" name="tmdb_region" value="{{ settings.tmdb_region or 'US' }}" 
                       placeholder="US, CA" autocomplete="off">
            </div>
        </div>

        <div class="card setting-card border-purple">
            <h3>Overseerr & Tautulli</h3>
            
            <div class="input-group">
                <label class="input-label">Overseerr URL</label>
                <input type="text" id="overseerr_url" name="overseerr_url" value="{{ settings.overseerr_url or '' }}" 
                       placeholder="http://192.168.1.50:5055" autocomplete="off">
            </div>
            
            <div class="input-group">
                <label class="input-label">Overseerr API Key</label>
                <div class="test-wrapper">
                    <div class="password-wrapper" style="flex: 1;">
                        <input type="password" id="overseerr_api_key" name="overseerr_api_key" value="{{ settings.overseerr_api_key or '' }}" autocomplete="new-password">
                        <button type="button" class="toggle-pass" onclick="toggleVisibility('overseerr_api_key', this)">üëÅÔ∏è</button>
                    </div>
                    <button type="button" class="btn-test" onclick="testService('overseerr')">Test ‚ö°</button>
                </div>
            </div>

            <div style="background: rgba(88, 101, 242, 0.1); padding: 12px; border-left: 3px solid #5865F2; border-radius: 4px; margin-bottom: 25px; font-size: 0.9em; color: #ccc;">
                <strong>üí° Tip:</strong> You can enable or disable <b>Auto-Search</b> for requested releases inside your actual <b>Overseerr Settings</b>. 
                <br>SeekAndWatch simply sends the request; Overseerr handles the download logic.
            </div>

            <hr style="border: 0; border-top: 1px solid #333; margin: 20px 0;">

            <div class="input-group">
                <label class="input-label">Tautulli URL</label>
                <input type="text" id="tautulli_url" name="tautulli_url" value="{{ settings.tautulli_url or '' }}" 
                       placeholder="http://192.168.1.50:8181" autocomplete="off">
            </div>
            
            <div class="input-group">
                <label class="input-label">Tautulli API Key</label>
                <div class="test-wrapper">
                    <div class="password-wrapper" style="flex: 1;">
                        <input type="password" id="tautulli_api_key" name="tautulli_api_key" value="{{ settings.tautulli_api_key or '' }}" autocomplete="new-password">
                        <button type="button" class="toggle-pass" onclick="toggleVisibility('tautulli_api_key', this)">üëÅÔ∏è</button>
                    </div>
                    <button type="button" class="btn-test" onclick="testService('tautulli')">Test ‚ö°</button>
                </div>
            </div>
        </div>

        <div class="card setting-card border-blue">
            <h3>üñ•Ô∏è System Maintenance</h3>
            
            <div class="flex-row-wrap">
                <div class="input-group flex-item">
                    <label class="input-label">Backup Interval (Days)</label>
                    <input type="number" id="backup_interval" name="backup_interval" value="{{ settings.backup_interval or 2 }}" min="1">
                </div>
                <div class="input-group flex-item">
                    <label class="input-label">Retention (Days)</label>
                    <input type="number" id="backup_retention" name="backup_retention" value="{{ settings.backup_retention or 7 }}" min="1">
                </div>
            </div>

            <hr style="border-color: #333; margin: 20px 0;">

            <div class="input-group">
                <label class="input-label">üìú Max Log Size (MB)</label>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <input type="number" id="max_log_size" name="max_log_size" value="{{ settings.max_log_size }}" min="0" max="100" style="width: 100px;">
                    <span style="font-size: 0.85em; color: #aaa;">(0 = Unlimited)</span>
                </div>
            </div>

            <hr style="border-color: #333; margin: 20px 0;">

            <div class="card mb-4 shadow-sm" style="border: 1px solid #444; background: #222;">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center" style="padding: 10px 15px; border-bottom: 1px solid #444;">
                    <h4 class="mb-0" style="font-size: 1em; display:flex; align-items:center;">
                        <span style="font-size:1.2em; margin-right:8px;">üåç</span> Community Alias Database
                    </h4>
                    <span class="badge bg-primary rounded-pill" id="aliasCountBadge" style="background:#007bff; color:white; padding:4px 10px; border-radius:15px; font-size:0.8em;">
                        {{ alias_count }} Entries
                    </span>
                </div>
                <div class="card-body" style="padding: 15px;">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <p class="card-text text-muted mb-2" style="color:#aaa; font-size:0.9em; margin-top:0;">
                                Downloads alternative titles for better matching.
                            </p>
                        </div>
                        <div class="col-md-4 text-end" style="text-align:right; margin-top:10px;">
                            <button type="button" id="forceSyncBtn" class="btn btn-outline-primary" onclick="syncAliases()" style="background:transparent; border:1px solid #007bff; color:#007bff; padding:5px 15px; cursor:pointer; border-radius:4px;">
                                Force Sync Now
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top:20px; border-top:1px solid #333; padding-top:20px;">
                <div class="backup-controls">
                    <h4 style="margin:0;">Existing Backups</h4>
                    <button type="button" onclick="createBackup()" class="btn-blue">+ Backup Now</button>
                </div>
                <div id="backup-list" class="backup-list">
                    <div style="text-align:center; color:#777;">Loading...</div>
                </div>
            </div>
        </div>

        <button type="submit" class="btn-save">Save Configuration üíæ</button>
    </form>

    <div class="card danger-zone">
        <h3 style="color: var(--error); display: flex; align-items: center; gap: 10px; margin-top: 0;">
            ‚ö†Ô∏è Danger Zone
        </h3>
        <p style="color: #ccc; margin-bottom: 20px;">
            Permanently delete your profile, settings, and watch history.
        </p>
        <form action="{{ url_for('delete_profile') }}" method="POST" onsubmit="return confirm('üö® ARE YOU SURE? This cannot be undone.');">
            <button type="submit" class="btn-danger">üóëÔ∏è Delete My Account</button>
        </form>
    </div>
</div>

<div id="settingsModal" class="custom-modal-overlay">
    <div class="custom-modal-box">
        <div class="modal-icon" id="modalIcon">‚úÖ</div>
        <h3 class="modal-title" id="modalTitle">Settings Saved</h3>
        <p class="modal-message" id="modalMessage">Configuration updated successfully.</p>
        <button id="modalBtn" class="modal-btn">OK</button>
    </div>
</div>

<script>
// 1. Password Visibility
function toggleVisibility(id, btn) {
    const el = document.getElementById(id);
    if (el.type === "password") { el.type = "text"; btn.innerText = "üîí"; } 
    else { el.type = "password"; btn.innerText = "üëÅÔ∏è"; }
}

// 2. Modal Helper
function showModal(icon, title, message, isSuccess) {
    const modal = document.getElementById('settingsModal');
    document.getElementById('modalIcon').innerText = icon;
    document.getElementById('modalTitle').innerText = title;
    document.getElementById('modalMessage').innerText = message;
    const btn = document.getElementById('modalBtn');
    btn.onclick = function() { modal.style.display = 'none'; if(isSuccess) location.reload(); };
    modal.style.display = 'flex';
}

// 3. API TESTING LOGIC
function testService(service) {
    let payload = { service: service };
    let btn;

    if (service === 'plex') {
        payload.url = document.getElementById('plex_url').value;
        payload.token = document.getElementById('plex_token').value;
        btn = document.querySelector('button[onclick="testService(\'plex\')"]');
    } else if (service === 'tmdb') {
        payload.api_key = document.getElementById('tmdb_key').value;
        btn = document.querySelector('button[onclick="testService(\'tmdb\')"]');
    } else if (service === 'omdb') {
        payload.api_key = document.getElementById('omdb_key').value;
        btn = document.querySelector('button[onclick="testService(\'omdb\')"]');
    } else if (service === 'overseerr') {
        payload.url = document.getElementById('overseerr_url').value;
        payload.api_key = document.getElementById('overseerr_api_key').value;
        btn = document.querySelector('button[onclick="testService(\'overseerr\')"]');
    } else if (service === 'tautulli') {
        payload.url = document.getElementById('tautulli_url').value;
        payload.api_key = document.getElementById('tautulli_api_key').value;
        btn = document.querySelector('button[onclick="testService(\'tautulli\')"]');
    }

    const originalText = btn.innerText;
    btn.innerText = "Testing...";
    btn.disabled = true;

    fetch('/test_connection', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        btn.disabled = false;
        btn.innerText = originalText;
        if(data.status === 'success') {
            showModal('‚úÖ', 'Connected!', data.message, false);
        } else {
            showModal('‚ùå', 'Connection Failed', data.message, false);
        }
    })
    .catch(err => {
        btn.disabled = false;
        btn.innerText = originalText;
        showModal('‚ùå', 'Error', 'Could not reach server.', false);
    });
}

// 4. Save Form
document.addEventListener('submit', function(e) {
    if (e.target && e.target.id === 'settings-form') {
        e.preventDefault(); 
        const btn = e.target.querySelector('.btn-save');
        const originalText = btn.innerText;
        btn.innerText = "Saving... ‚è≥"; btn.disabled = true;

        fetch(e.target.action, { method: 'POST', body: new FormData(e.target) })
        .then(response => response.json())
        .then(data => {
            btn.innerText = originalText; btn.disabled = false;
            showModal(data.status==='success'?'‚úÖ':'‚ùå', data.status==='success'?'Success!':'Error', data.message, data.status==='success');
        })
        .catch(error => {
            btn.innerText = originalText; btn.disabled = false;
            showModal('‚ùå', 'System Error', "Could not connect to server.", false);
        });
    }
});

// 5. Existing Functions (Backup/Alias)
function loadBackups() {
    fetch('/api/backups').then(r => r.json()).then(data => {
        const div = document.getElementById('backup-list');
        if(data.length === 0) { div.innerHTML = '<div style="text-align:center; color:#777;">No backups found.</div>'; return; }
        let html = '<table style="width:100%; border-collapse:collapse; font-size:0.9em;">';
        data.forEach(b => {
            html += `<tr style="border-bottom:1px solid #333;">
                <td style="padding:8px;">${b.date}</td>
                <td style="padding:8px; color:#aaa;">${b.size}</td>
                <td style="padding:8px; text-align:right;">
                    <a href="/api/backup/download/${b.filename}" style="text-decoration:none; margin-right:10px;">‚¨áÔ∏è</a>
                    <span onclick="restoreBackup('${b.filename}')" style="cursor:pointer; margin-right:10px;" title="Restore">‚ôªÔ∏è</span>
                    <span onclick="deleteBackup('${b.filename}')" style="cursor:pointer; color:#e74c3c;" title="Delete">üóëÔ∏è</span>
                </td></tr>`;
        });
        div.innerHTML = html + '</table>';
    });
}
function createBackup() { fetch('/api/backup/create', {method: 'POST'}).then(r => r.json()).then(data => { loadBackups(); showModal('üì¶', 'Backup Created', data.message, false); }); }
function deleteBackup(f) { if(confirm("Delete backup?")) fetch('/api/backup/delete/' + f, {method: 'DELETE'}).then(()=>loadBackups()); }
function restoreBackup(f) { if(confirm("Overwrite DB?")) fetch('/api/backup/restore/' + f, {method: 'POST'}).then(r=>r.json()).then(d=>showModal('‚ôªÔ∏è', 'Restored', d.message, true)); }
function syncAliases() {
    const btn = document.getElementById('forceSyncBtn'); btn.disabled = true; btn.innerText = "Syncing...";
    fetch('/api/sync_aliases', { method: 'POST' }).then(r=>r.json()).then(data => {
        btn.innerText = "Synced! ‚úÖ"; btn.style.color = "#2ecc71";
        setTimeout(() => { btn.disabled = false; btn.innerText = "Force Sync Now"; btn.style.color = "#007bff"; }, 3000);
        if(document.getElementById('aliasCountBadge')) document.getElementById('aliasCountBadge').innerText = (data.count || 0) + " Entries";
    });
}

document.addEventListener('DOMContentLoaded', loadBackups);
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 1. Select all checkboxes inside the Ignore List container
    // (Assuming your checkboxes have name="ignored_users")
    const checkboxes = document.querySelectorAll('input[name="ignored_plex_users"]');
    const toast = document.getElementById('save-toast');

    checkboxes.forEach(box => {
        box.addEventListener('change', function() {
            // 2. Gather all CHECKED boxes
            const checkedUsers = Array.from(checkboxes)
                                      .filter(i => i.checked)
                                      .map(i => i.value);

            // 3. Send to Server silently
            fetch('/update_ignore_list', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ ignored_users: checkedUsers })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast();
                } else {
                    console.error('Save failed:', data.message);
                }
            });
        });
    });

    function showToast() {
        toast.style.opacity = '1';
        setTimeout(() => {
            toast.style.opacity = '0';
        }, 2000); // Disappear after 2 seconds
    }
});
</script>
{% endblock %}