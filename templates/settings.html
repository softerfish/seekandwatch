{% extends "base.html" %}
{% block content %}

<div class="settings-container">
    <div class="settings-header">
        <h2>‚öôÔ∏è Configuration</h2>
        <p class="text-muted">Manage your connections, automation engines, and system preferences.</p>
    </div>
    
    <div id="save-toast">
        <i class="fas fa-check-circle"></i> Saved
    </div>

    <div class="settings-tabs">
        <button type="button" class="tab-link active" onclick="openTab(event, 'tab-apis')">APIs & Connections</button>
        <button type="button" class="tab-link" onclick="openTab(event, 'tab-scanners')">Scanners & Cache</button>
        <button type="button" class="tab-link" onclick="openTab(event, 'tab-system')">System & Maintenance</button>
        <button type="button" class="tab-link" onclick="openTab(event, 'tab-logs')">System Logs</button>
        
        {% if current_user.is_admin %}
        <button type="button" class="tab-link" onclick="openTab(event, 'tab-users'); loadUsers();">üë• User Management</button>
        {% endif %}
    </div>

{% if current_user.is_admin %}
<div id="tab-users" class="tab-content">
    <div class="card setting-card border-purple">
        <h3>üë• Manage Users</h3>
        <p class="text-muted">Grant admin privileges or remove users from the system.</p>
        
        <div id="user-list-container" class="logs-table-container" style="border:none; max-height:none;">
            <div class="text-center" style="padding:20px;">Loading users...</div>
        </div>
    </div>
</div>

<script>
function loadUsers() {
    fetch('/api/admin/users')
    .then(r => r.json())
    .then(users => {
        if(users.error) return;
        
        const container = document.getElementById('user-list-container');
        if(users.length === 0) {
            container.innerHTML = "No users found.";
            return;
        }
        
        let html = '<table class="logs-table">';
        html += '<thead><tr><th>Username</th><th>Role</th><th class="text-right">Actions</th></tr></thead><tbody>';
        
        users.forEach(u => {
            const roleColor = u.is_admin ? '#2ecc71' : '#777';
            const roleText = u.is_admin ? 'üõ°Ô∏è Admin' : 'üë§ User';
            const disableSelf = u.is_current ? 'disabled style="opacity:0.5; cursor:not-allowed;"' : '';
            
            html += `
            <tr>
                <td style="font-weight:bold; color:white;">${u.username} ${u.is_current ? '(You)' : ''}</td>
                <td style="color:${roleColor};">${roleText}</td>
                <td class="text-right">
                    <button onclick="toggleRole(${u.id})" class="btn-secondary" ${disableSelf} title="Toggle Admin Status" style="padding: 4px 10px; font-size: 0.8em;">
                        ${u.is_admin ? 'Demote ‚ñº' : 'Promote ‚ñ≤'}
                    </button>
                    <button onclick="deleteUser(${u.id}, '${u.username}')" class="btn-delete" ${disableSelf} style="margin-left:10px; padding: 4px 10px; font-size: 0.8em;">
                        üóëÔ∏è
                    </button>
                </td>
            </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    });
}

function toggleRole(id) {
    fetch('/api/admin/toggle_role', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({user_id: id})
    }).then(r => r.json()).then(d => {
        if(d.status === 'success') loadUsers();
        else alert(d.message);
    });
}

function deleteUser(id, name) {
    if(!confirm(`Are you sure you want to delete user "${name}"? This will delete their settings and blocklists.`)) return;
    
    fetch('/api/admin/delete_user', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({user_id: id})
    }).then(r => r.json()).then(d => {
        if(d.status === 'success') loadUsers();
        else alert(d.message);
    });
}
</script>
{% endif %}

    <form id="settings-form" action="{{ url_for('settings') }}" method="POST" autocomplete="off">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>    
        <div id="tab-apis" class="tab-content active">
            <div class="card setting-card border-orange">
                <h3>Plex Integration</h3>
                <details class="help-box">
                    <summary>‚ùì How to find your URL & Token</summary>
                    <ol>
                        <li><b>URL:</b> Your server's local IP (e.g. <code>http://192.168.1.50:32400</code>).</li>
                        <li><b>Token:</b> <a href="https://support.plex.tv/articles/204059436-finding-an-authentication-token-x-plex-token/" target="_blank" style="color: var(--accent-color); text-decoration: underline;">View Official Guide</a>.</li>
                    </ol>
                </details>
                
                <div class="input-group">
                    <label class="input-label">Plex Local URL <span style="color: var(--error);">*Required</span></label>
                    <input type="text" id="plex_url" name="plex_url" value="{{ settings.plex_url or '' }}" placeholder="http://192.168.1.50:32400" autocomplete="off">
                </div>
                
                <div class="input-group">
                    <label class="input-label">Plex Token</label>
                    <div style="display: flex; gap: 10px;">
                        <div class="password-wrapper">
                            <input type="password" id="plex_token" name="plex_token" value="{{ settings.plex_token or '' }}" autocomplete="new-password" style="width: 100%; padding-right: 40px;">
                            <button type="button" class="toggle-pass" onclick="toggleVisibility('plex_token', this)">üëÅÔ∏è</button>
                        </div>
                        <button type="button" onclick="testService('plex')" class="btn-secondary">Test ‚ö°</button>
                    </div>
                </div>

                {% if plex_users %}
                <div class="info-panel" style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;">
                    <label class="ignore-label">üõ°Ô∏è Ignore History From:</label>
                    <div class="ignore-grid">
                        {% for user in plex_users %}
                        <label class="ignore-check-label">
                            <input type="checkbox" name="ignored_plex_users" value="{{ user }}" {% if user in current_ignored %}checked{% endif %}>
                            {{ user }}
                        </label>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>

            <div class="card setting-card border-green">
    <h3>Metadata APIs</h3>
    
    <div class="input-group">
        <label class="input-label">TMDB API Key (v3) <span style="color: var(--error);">*Required</span></label>
        <div class="test-row">
            <div class="password-wrapper">
                <input type="password" id="tmdb_key" name="tmdb_key" value="{{ settings.tmdb_key or '' }}" autocomplete="new-password">
                <button type="button" class="toggle-pass" onclick="toggleVisibility('tmdb_key', this)">üëÅÔ∏è</button>
            </div>
            <button type="button" onclick="testService('tmdb')" class="btn-secondary">Test ‚ö°</button>
        </div>
    </div>

    <div class="input-group" style="border: 1px dashed #2ecc71; padding: 15px; border-radius: 8px; background: rgba(46, 204, 113, 0.05);">
        <label class="input-label">üçÖ OMDB API Key (Critics Scores)</label>
        <p class="helper-text">Required to filter by Rotten Tomatoes scores.</p>
        <div class="test-row">
            <div class="password-wrapper">
                <input type="password" id="omdb_key" name="omdb_key" value="{{ settings.omdb_key or '' }}" placeholder="xxxxxx" autocomplete="new-password">
                <button type="button" class="toggle-pass" onclick="toggleVisibility('omdb_key', this)">üëÅÔ∏è</button>
            </div>
            <button type="button" onclick="testService('omdb')" class="btn-secondary">Test ‚ö°</button>
        </div>
    </div>

    <div class="input-group">
        <label class="input-label">Streaming Regions</label>
        <input type="text" id="tmdb_region" name="tmdb_region" value="{{ settings.tmdb_region or 'US' }}" placeholder="US, CA" autocomplete="off">
        <p class="helper-text">Comma separated ISO codes (e.g. <code>US, CA, GB</code>).</p>
    </div>
</div>

            <div class="card setting-card border-purple">
                <h3>Overseerr & Tautulli</h3>
                
                <div class="input-group">
                    <label class="input-label">Overseerr URL</label>
                    <input type="text" id="overseerr_url" name="overseerr_url" value="{{ settings.overseerr_url or '' }}" placeholder="http://192.168.1.50:5055" autocomplete="off">
                </div>
                
                <div class="input-group">
                    <label class="input-label">Overseerr API Key</label>
                    <div style="display: flex; gap: 10px;">
                        <div class="password-wrapper">
                            <input type="password" id="overseerr_api_key" name="overseerr_api_key" value="{{ settings.overseerr_api_key or '' }}" autocomplete="new-password" style="width: 100%; padding-right: 40px;">
                            <button type="button" class="toggle-pass" onclick="toggleVisibility('overseerr_api_key', this)">üëÅÔ∏è</button>
                        </div>
                        <button type="button" onclick="testService('overseerr')" class="btn-secondary">Test ‚ö°</button>
                    </div>
                </div>
                
                <hr style="border: 0; border-top: 1px solid #333; margin: 20px 0;">
                
                <div class="input-group">
                    <label class="input-label">Tautulli URL</label>
                    <input type="text" id="tautulli_url" name="tautulli_url" value="{{ settings.tautulli_url or '' }}" placeholder="http://192.168.1.50:8181" autocomplete="off">
                </div>
                
                <div class="input-group">
                    <label class="input-label">Tautulli API Key</label>
                    <div style="display: flex; gap: 10px;">
                        <div class="password-wrapper">
                            <input type="password" id="tautulli_api_key" name="tautulli_api_key" value="{{ settings.tautulli_api_key or '' }}" autocomplete="new-password" style="width: 100%; padding-right: 40px;">
                            <button type="button" class="toggle-pass" onclick="toggleVisibility('tautulli_api_key', this)">üëÅÔ∏è</button>
                        </div>
                        <button type="button" onclick="testService('tautulli')" class="btn-secondary">Test ‚ö°</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-scanners" class="tab-content">
            <div class="card setting-card border-info">
                <h3 style="display:flex; align-items:center; gap:10px;">
                    üîÑ Sync Engine & Cache
                </h3>
                <div style="color: #ccc; font-size: 0.9em; line-height: 1.6; margin-bottom: 20px;">
                    <p style="margin-top: 0;"> SeekAndWatch downloads a lightweight index of your library to a local file (Cache) to prevent crashing Plex during large scans.</p>
                    <div class="sync-warning-box">
                        <strong>‚ö†Ô∏è Important:</strong>
                        <ul style="margin: 5px 0 0 0; padding-left: 20px;">
                            <li><b>New Media:</b> If you just added a movie, click <b>"Force Refresh Now"</b> to see it immediately.</li>
                            <li><b>Time:</b> Large libraries (5000+) take <b>1-5 minutes</b> to refresh.</li>
                        </ul>
                    </div>
                    <div class="cache-control-row">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: bold; display: block; margin-bottom: 8px;">Auto-Refresh Interval</label>
                            <div style="display: flex; gap: 10px;">
                                <select id="cache-interval" style="padding: 10px; border-radius: 5px; background: #111; color: white; border: 1px solid #444; flex: 1;">
                                    <option value="12" {% if settings.cache_interval == 12 %}selected{% endif %}>Every 12 Hours (Fastest)</option>
                                    <option value="24" {% if not settings.cache_interval or settings.cache_interval == 24 %}selected{% endif %}>Every 24 Hours (Standard)</option>
                                    <option value="48" {% if settings.cache_interval == 48 %}selected{% endif %}>Every 48 Hours</option>
                                    <option value="168" {% if settings.cache_interval == 168 %}selected{% endif %}>Weekly (Low CPU)</option>
                                </select>
                                <button type="button" onclick="saveCacheSetting()" class="btn-primary">Save</button>
                            </div>
                        </div>
                        <div style="flex: 1; min-width: 200px; text-align: right;">
                            <div style="font-size: 0.85em; color: #888; margin-bottom: 15px;">
                                Last Refreshed: <span id="last-updated" style="color: var(--text-color); font-weight: bold;">{{ cache_age }}</span>
                            </div>
                            <button type="button" onclick="forceRefresh()" id="btn-force" class="btn-secondary" style="width: 100%;">
                                üîÑ Force Refresh Now
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card setting-card border-blue">
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:15px;">
                    <h3 style="margin:0;">üß† Keyword Memory (Cache)</h3>
                    <span style="font-size:0.9em; background:rgba(52, 152, 219, 0.2); color:#3498db; padding:4px 10px; border-radius:4px; border:1px solid #3498db;">
                        Stored: <strong>{{ keyword_count }}</strong> / {{ settings.keyword_cache_size or 1000 }}
                    </span>
                </div>
                
                <p class="text-muted small">
                    To save API calls, we store keyword tags (e.g., "zombie", "time travel") in the database.
                    When this limit is reached, the oldest keywords are deleted to make room for new ones.
                </p>

                <div class="input-group" style="margin-bottom: 0;">
                    <label class="input-label">Max Keywords to Store <span style="font-weight:normal; color:#888;">(Recommended: 1000-5000)</span></label>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <input type="number" name="keyword_cache_size" class="form-control" 
                               value="{{ settings.keyword_cache_size or 2000 }}" 
                               min="100" max="100000" step="100" 
                               style="max-width:150px; background:#111; border:1px solid #444; color:white; padding:10px; border-radius:5px;">
                        <span style="color:#aaa; font-size:0.9em;">entries</span>
                    </div>
                </div>
            </div>

            <div class="card setting-card border-purple">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center" style="padding:0; margin-bottom:15px;">
                    <h3 style="margin:0; display:flex; align-items:center; gap:10px;">üì° Background Alias Discovery</h3>
                    <div>
                        <span class="badge bg-dark border border-secondary text-warning me-2" id="next-scan-badge" style="padding:5px 10px; border-radius:4px; font-size:0.8em; margin-right:10px;">
                            <i class="fas fa-clock"></i> Next: --:--
                        </span>
                        <span class="badge bg-info" id="db-count-badge" style="background:#3498db; color:white; padding:5px 10px; border-radius:4px; font-size:0.8em;">Loading...</span>
                    </div>
                </div>
                
                <p class="text-muted small">
                    Automatically scan your Plex Cache in the background to find "hidden" aliases.
                </p>
                
                <div class="scanner-row">
                    <div class="flex-item">
                        <label class="form-label text-muted small">Batch Size</label>
                        <select class="filter-input" id="scan-batch" style="width:100%;">
                            <option value="200">200 Items</option>
                            <option value="500">500 Items</option>
                            <option value="800">800 Items (Takes ~10 mins)</option>
                        </select>
                    </div>
                    <div class="flex-item">
                        <label class="form-label text-muted small">Interval</label>
                        <select class="filter-input" id="scan-interval" style="width:100%;">
                            <option value="5">Every 5 Mins</option>
                            <option value="15" selected>Every 15 Mins</option>
                            <option value="30">Every 30 Mins</option>
                        </select>
                    </div>
                    <div class="spacer-col-1"></div>
                    <div class="flex-item" style="display:flex; align-items:center; padding-bottom:12px;">
                        <input type="checkbox" id="scan-toggle" style="width:20px; height:20px; margin-right:10px;">
                        <label for="scan-toggle" style="margin:0; cursor:pointer;">Enable Background Scan</label>
                    </div>
                    <div class="flex-item" style="text-align:right; display: flex; gap: 10px;">
                        <button type="button" class="btn-danger" style="flex: 1;" onclick="resetScannerIndex()">
                            Reset
                        </button>
                        <button type="button" class="btn-primary" style="background:#2ecc71; color:white; border:none; flex: 1;" onclick="saveScannerSettings()">
                            Save
                        </button>
                    </div>
                </div>                
            </div>
            
            <div class="card setting-card" style="margin-top: 30px; border-top: 4px solid #f1c40f;">
                <h3>üö´ Content Management</h3>
                <p class="text-muted">
                    Manage your blocklist. Titles listed here will be excluded from all recommendations and searches.
                </p>
                <a href="{{ url_for('manage_blocklist') }}">
                    <button class="btn btn-secondary" type="button">Manage Blocklist</button>
                </a>
            </div>
        </div>

        <div id="tab-system" class="tab-content">
            <div class="card setting-card border-blue">
                <h3>üñ•Ô∏è System Maintenance</h3>
                <div class="flex-row-wrap" style="display:flex; gap:20px; margin-bottom:20px;">
                    <div class="input-group flex-item" style="flex:1;">
                        <label class="input-label">Backup Interval (Days)</label>
                        <input type="number" id="backup_interval" name="backup_interval" value="{{ settings.backup_interval or 2 }}" min="1">
                    </div>
                    <div class="input-group flex-item" style="flex:1;">
                        <label class="input-label">Retention (Days)</label>
                        <input type="number" id="backup_retention" name="backup_retention" value="{{ settings.backup_retention or 7 }}" min="1">
                    </div>
                </div>
                
                <hr style="border-color: #333; margin: 20px 0;">
                
                <div style="margin-top:20px; border-top:1px solid #333; padding-top:20px;">
                    <div class="backup-controls" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h4 style="margin:0;">Existing Backups</h4>
                        <button type="button" onclick="createBackup()" class="btn-primary" style="padding:8px 15px;">+ Backup Now</button>
                    </div>
                    <div id="backup-list" class="backup-list">
                        <div style="text-align:center; color:#777;">Loading...</div>
                    </div>
                </div>
            </div>

            <div class="card danger-zone">
                <h3 style="color: var(--error); display: flex; align-items: center; gap: 10px; margin-top: 0;">
                    ‚ö†Ô∏è Danger Zone
                </h3>
                <p style="color: #ccc; margin-bottom: 20px;">
                    Permanently delete your profile, settings, and watch history.
                </p>
                <button type="button" onclick="document.getElementById('delete-account-form').submit();" class="btn-danger" style="width:100%;">
                    üóëÔ∏è Delete My Account
                </button>
            </div>
        </div>

        <div id="tab-logs" class="tab-content">
            <div class="card setting-card" style="border-top: 4px solid #95a5a6;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h3 style="margin:0;">üìú System Event Log</h3>
                    <div style="display:flex; gap:10px;">
                         <button type="button" onclick="clearLogs()" class="btn-delete" style="padding: 6px 12px;">Clear All</button>
                         <button type="button" onclick="location.reload()" class="btn-secondary" style="padding: 6px 12px; font-size:0.9em;">Refresh</button>
                    </div>
                </div>
                
                <p class="text-muted small" style="margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px;">
                    Tracks general system health, including scheduled backups, collection syncs, cache refreshes, and application errors.
                </p>

                <div style="background:rgba(0,0,0,0.2); border-radius:8px; padding:15px; margin-bottom:20px; display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between; gap:15px;">
                    
                    <div style="display:flex; align-items:center; gap:15px;">
                        <div>
                            <strong style="color:#ddd; display:block;">Live Recording</strong>
                            <div style="font-size:0.8em; color:#888;">Capture system events</div>
                        </div>
                        <label class="switch-container">
                            <input type="checkbox" id="log-toggle" {% if settings.logging_enabled %}checked{% endif %} onchange="toggleLogging()">
                            <span class="switch-label" style="color: var(--accent-color);">
                                {% if settings.logging_enabled %}ON{% else %}OFF{% endif %}
                            </span>
                        </label>
                    </div>

                    <div style="display:flex; align-items:center; gap:10px; background:rgba(255,255,255,0.05); padding:8px 12px; border-radius:6px;">
                        <label for="max_log_size" style="font-size:0.9em; font-weight:bold; color:#ccc;">Log Limit (MB):</label>
                        <input type="number" id="max_log_size" name="max_log_size" value="{{ settings.max_log_size }}" min="0" max="100" style="width: 70px; padding: 5px; background: #111; color: white; border: 1px solid #444; border-radius: 4px; text-align:center;">
                        <span style="font-size: 0.8em; color: #888;">(0=‚àû)</span>
                    </div>
                </div>

                <div class="logs-table-container">
                    <table class="logs-table">
                        <thead>
                            <tr>
                                <th style="width: 140px;">Time</th>
                                <th style="width: 80px;">Module</th>
                                <th style="width: 60px;">Level</th>
                                <th>Message</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in logs %}
                            <tr>
                                <td style="white-space:nowrap; color: #888;">{{ log.timestamp.strftime('%m-%d %H:%M') }}</td>
                                <td><code>{{ log.category }}</code></td>
                                <td>
                                    {% if log.level == 'INFO' %} <span class="log-badge info">INFO</span>
                                    {% elif log.level == 'SUCCESS' %} <span class="log-badge success">OK</span>
                                    {% elif log.level == 'WARNING' %} <span class="log-badge warning">WARN</span>
                                    {% elif log.level == 'ERROR' %} <span class="log-badge error">ERR</span>
                                    {% else %} <span class="log-badge default">{{ log.level }}</span>
                                    {% endif %}
                                </td>
                                <td style="line-height: 1.4; color:#ccc;">{{ log.message }}</td>
                            </tr>
                            {% else %}
                            <tr><td colspan="4" class="text-center" style="padding: 30px; color: #666;">No logs recorded yet.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card setting-card" style="margin-top: 20px; border-top: 4px solid #34495e;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="margin:0;">üìü Live Scanner Output</h3>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <div class="input-group" style="margin:0; width:auto; display:flex; align-items:center; gap:5px;">
                            <span style="font-size:0.8em; color:#aaa;">Limit (MB):</span>
                            <input type="number" name="scanner_log_size" value="{{ settings.scanner_log_size or 10 }}" min="1" max="100" style="width:60px; padding:5px; background:#111; border:1px solid #444; color:white; border-radius:4px; text-align:center;">
                        </div>
                    </div>
                </div>
                
                <p class="text-muted small" style="margin-bottom: 15px;">
                    Real-time feed of the background worker. Auto-refreshes every 2 seconds.
                </p>

                <div id="scanner-terminal">Waiting for logs...</div>

                <div class="text-right">
                    <button type="button" onclick="refreshScannerLogs()" class="btn-secondary" style="font-size:0.8em;">üîÑ Refresh Now</button>
                </div>
            </div>
        </div>

        <button type="submit" class="btn-save" id="main-save-btn">Save Configuration üíæ</button>
    </form>
</div>

<form id="delete-account-form" action="{{ url_for('delete_profile') }}" method="POST" onsubmit="return confirm('üö® ARE YOU SURE? This cannot be undone.');" style="display:none;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
</form>

<div id="settingsModal" class="custom-modal-overlay">
    <div class="custom-modal-box">
        <div class="modal-icon" id="modalIcon">‚úÖ</div>
        <h3 class="modal-title" id="modalTitle">Settings Saved</h3>
        <p class="modal-message" id="modalMessage">Configuration updated successfully.</p>
        <button id="modalBtn" class="modal-btn">OK</button>
    </div>
</div>

<script>
// --- TABS LOGIC ---
function openTab(evt, tabName) {
    var i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
        tabcontent[i].classList.remove("active");
    }
    tablinks = document.getElementsByClassName("tab-link");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    document.getElementById(tabName).style.display = "block";
    setTimeout(() => {
        document.getElementById(tabName).classList.add("active");
    }, 10);
    evt.currentTarget.className += " active";
}

// --- GLOBAL & UI HELPERS ---
function toggleVisibility(id, btn) {
    const el = document.getElementById(id);
    if (el.type === "password") { el.type = "text"; btn.innerText = "üîí"; } 
    else { el.type = "password"; btn.innerText = "üëÅÔ∏è"; }
}

function showModal(icon, title, message, isSuccess) {
    const modal = document.getElementById('settingsModal');
    document.getElementById('modalIcon').innerText = icon;
    document.getElementById('modalTitle').innerText = title;
    document.getElementById('modalMessage').innerText = message;
    const btn = document.getElementById('modalBtn');
    btn.onclick = function() { modal.style.display = 'none'; if(isSuccess) location.reload(); };
    modal.style.display = 'flex';
}

function showToast() {
    const toast = document.getElementById('save-toast');
    toast.style.opacity = '1';
    setTimeout(() => { toast.style.opacity = '0'; }, 2000);
}

// --- LOGGING FUNCTIONS ---
function toggleLogging() {
    const enabled = document.getElementById('log-toggle').checked;
    fetch('/toggle_logging', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({enabled: enabled})
    }).then(r => r.json()).then(d => {
        if(d.status === 'success') showToast();
        else alert("Error: " + d.message);
    });
}

function clearLogs() {
    if(!confirm("Are you sure you want to delete all history?")) return;
    fetch('/clear_logs', {method: 'POST'})
    .then(r => r.json())
    .then(d => {
        if(d.status === 'success') location.reload();
        else alert("Error: " + d.message);
    });
}

// --- SCANNER & CACHE LOGIC ---
let countdownInterval;

document.addEventListener('DOMContentLoaded', function() {
    loadBackups();
    fetchStatus();
    setInterval(fetchStatus, 30000);
    setInterval(checkCacheStatus, 2000);

    const checkboxes = document.querySelectorAll('input[name="ignored_plex_users"]');
    checkboxes.forEach(box => {
        box.addEventListener('change', function() {
            const checkedUsers = Array.from(checkboxes).filter(i => i.checked).map(i => i.value);
            fetch('/update_ignore_list', {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ ignored_users: checkedUsers })
            }).then(r => r.json()).then(d => { if (d.status === 'success') showToast(); });
        });
    });

    const batchSelect = document.getElementById('scan-batch');
    const intervalSelect = document.getElementById('scan-interval');

    function validateScannerOptions() {
        if(!batchSelect || !intervalSelect) return;
        
        const batchVal = parseInt(batchSelect.value);
        const opt5 = intervalSelect.querySelector('option[value="5"]');
        
        if (batchVal > 200) {
            opt5.disabled = true;
            opt5.text = "Every 5 Mins (Locked üîí)";
            if (intervalSelect.value === "5") {
                intervalSelect.value = "15";
            }
        } else {
            opt5.disabled = false;
            opt5.text = "Every 5 Mins";
        }
    }

    if (batchSelect && intervalSelect) {
        batchSelect.addEventListener('change', validateScannerOptions);
        validateScannerOptions();
    }

    // ... existing URL cleaner code ...
    ['plex_url', 'overseerr_url', 'tautulli_url'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('blur', function(e) {
                let val = e.target.value;
                let clean = val.trim().replace(/\/+$/, '');
                if (val !== clean) {
                    e.target.value = clean;
                    console.log(`Auto-cleaned ${id}:`, clean);
                }
            });
        }
    });

}); 

function fetchStatus() {
    fetch('/api/scanner/status').then(r => r.json()).then(data => {
        const toggle = document.getElementById('scan-toggle');
        if(toggle) toggle.checked = data.enabled;
        
        const batchSelect = document.getElementById('scan-batch');
        if(batchSelect) {
            const validOptions = Array.from(batchSelect.options).map(o => o.value);
            if (validOptions.includes(String(data.batch))) batchSelect.value = data.batch;
            else batchSelect.value = '50';
        }
        
        const intSelect = document.getElementById('scan-interval');
        if(intSelect) {
            intSelect.value = data.interval;
            const batchEl = document.getElementById('scan-batch');
            if(batchEl) batchEl.dispatchEvent(new Event('change'));
        }
        
        const badge = document.getElementById('db-count-badge');
        if(badge) badge.innerText = data.total_indexed + " Aliases Indexed";
        
        const nextBadge = document.getElementById('next-scan-badge');
        if(nextBadge) {
            if(data.enabled && data.next_ts > 0) {
                startCountdown(data.next_ts);
                nextBadge.classList.remove('d-none');
            } else {
                clearInterval(countdownInterval);
                nextBadge.classList.add('d-none');
            }
        }
    }).catch(e => console.log("Scanner status fetch failed", e));
}

function startCountdown(targetTs) {
    clearInterval(countdownInterval);
    function update() {
        const now = Math.floor(Date.now() / 1000);
        const diff = targetTs - now;
        const badge = document.getElementById('next-scan-badge');
        if(!badge) return;
        
        if (diff <= 0) {
            badge.innerText = "Next Scan: Pending...";
            badge.classList.remove('text-warning');
            badge.classList.add('text-danger', 'blink');
        } else {
            const mins = Math.floor(diff / 60);
            const secs = diff % 60;
            const minStr = mins < 10 ? "0" + mins : mins;
            const secStr = secs < 10 ? "0" + secs : secs;
            badge.innerText = `Next Scan: ${minStr}:${secStr}`;
            badge.classList.remove('text-danger', 'blink');
            badge.classList.add('text-warning');
        }
    }
    update();
    countdownInterval = setInterval(update, 1000);
}

function saveScannerSettings() {
    const enabled = document.getElementById('scan-toggle').checked;
    const batch = document.getElementById('scan-batch').value;
    const interval = document.getElementById('scan-interval').value;
    
    fetch('/api/scanner/save', {
        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({enabled, batch, interval})
    }).then(r => r.json()).then(data => {
        const btn = document.querySelector('button[onclick="saveScannerSettings()"]');
        const oldText = btn.innerText;
        btn.innerText = "Saved ‚úÖ";
        setTimeout(() => { fetchStatus(); btn.innerText = oldText; }, 1000);
    });
}

function saveCacheSetting() {
    const val = document.getElementById('cache-interval').value;
    fetch('/save_cache_settings', {
        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({interval: val})
    }).then(r => r.json()).then(d => {
        if(d.status === 'success') showToast();
        else alert(d.message);
    });
}

function forceRefresh() {
    const btn = document.getElementById('btn-force');
    btn.disabled = true; 
    btn.innerText = "Refreshing... ‚è≥";
    
    fetch('/force_cache_refresh', {method: 'POST'})
    .then(r => r.json())
    .then(data => {
        if(data.status !== 'success') {
            alert("Error: " + data.message);
            btn.disabled = false;
            btn.innerText = "üîÑ Force Refresh Now";
        }
    });
}

function checkCacheStatus() {
    fetch('/get_cache_status').then(r => r.json()).then(data => {
        const forceBtn = document.getElementById('btn-force');
        const txt = document.getElementById('last-updated');
        if(!forceBtn) return;

        if(data.running) {
            forceBtn.disabled = true;
            forceBtn.innerText = `Refreshing (${data.progress}) ‚è≥`;
        } else {
            if(forceBtn.innerText.includes("Refreshing")) {
                forceBtn.disabled = false;
                forceBtn.innerText = "üîÑ Force Refresh Now";
                if(txt) txt.innerText = "Just Now"; 
            }
        }
    });
}

// --- SERVICE TESTING & MAIN SAVE ---
function testService(service) {
    let payload = { service: service };
    let btn;

    if (service === 'plex') {
        payload.url = document.getElementById('plex_url').value;
        payload.token = document.getElementById('plex_token').value;
        btn = document.querySelector('button[onclick="testService(\'plex\')"]');
    } else if (service === 'tmdb') {
        payload.api_key = document.getElementById('tmdb_key').value;
        btn = document.querySelector('button[onclick="testService(\'tmdb\')"]');
    } else if (service === 'omdb') {
        payload.api_key = document.getElementById('omdb_key').value;
        btn = document.querySelector('button[onclick="testService(\'omdb\')"]');
    } else if (service === 'overseerr') {
        payload.url = document.getElementById('overseerr_url').value;
        payload.api_key = document.getElementById('overseerr_api_key').value;
        btn = document.querySelector('button[onclick="testService(\'overseerr\')"]');
    } else if (service === 'tautulli') {
        payload.url = document.getElementById('tautulli_url').value;
        payload.api_key = document.getElementById('tautulli_api_key').value;
        btn = document.querySelector('button[onclick="testService(\'tautulli\')"]');
    }

    const originalText = btn.innerText;
    btn.innerText = "Testing...";
    btn.disabled = true;

    fetch('/test_connection', {
        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
    }).then(r => r.json()).then(data => {
        btn.disabled = false;
        btn.innerText = originalText;
        showModal(data.status==='success'?'‚úÖ':'‚ùå', data.status==='success'?'Connected!':'Connection Failed', data.message, false);
    }).catch(err => {
        btn.disabled = false;
        btn.innerText = originalText;
        showModal('‚ùå', 'Error', 'Could not reach server.', false);
    });
}

document.addEventListener('submit', function(e) {
    // Only handle the main settings form
    if (e.target && e.target.id === 'settings-form') {
        e.preventDefault(); 
        
        // --- 1. FORCE CLEAN URLs NOW ---
        ['plex_url', 'overseerr_url', 'tautulli_url'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.value = el.value.trim().replace(/\/+$/, '');
            }
        });

        // --- 2. SEND DATA ---
        const btn = document.getElementById('main-save-btn');
        const originalText = btn.innerText;
        btn.innerText = "Saving... ‚è≥"; 
        btn.disabled = true;

        fetch(e.target.action, { method: 'POST', body: new FormData(e.target) })
        .then(response => response.json())
        .then(data => {
            btn.innerText = originalText; 
            btn.disabled = false;
            showModal(data.status==='success'?'‚úÖ':'‚ùå', data.status==='success'?'Success!':'Error', data.message, data.status==='success');
        });
    }
});

function resetScannerIndex() {
    if(!confirm("üö® Are you sure? This will wipe the alias database and force a full re-scan.")) return;
    
    const btn = document.querySelector('button[onclick="resetScannerIndex()"]');
    const originalText = btn.innerText;
    btn.innerText = "Wiping...";
    btn.disabled = true;

    fetch('/api/scanner/reset', {method: 'POST'})
    .then(r => r.json())
    .then(data => {
        btn.innerText = originalText;
        btn.disabled = false;
        showModal(data.status==='success'?'‚úÖ':'‚ùå', 'Scanner Reset', data.message, false);
        if(data.status === 'success') fetchStatus();
    });
}

// --- BACKUP HELPERS ---
function loadBackups() {
    fetch('/api/backups').then(r => r.json()).then(data => {
        const div = document.getElementById('backup-list');
        if(data.length === 0) { div.innerHTML = '<div style="text-align:center; color:#777;">No backups found.</div>'; return; }
        
        let html = '<table class="logs-table">';
        data.forEach(b => {
            html += `<tr>
                <td style="padding:8px;">${b.date}</td>
                <td style="padding:8px; color:#aaa;">${b.size}</td>
                <td style="padding:8px; text-align:right;">
                    <a href="/api/backup/download/${b.filename}" style="text-decoration:none; margin-right:10px;">‚¨áÔ∏è</a>
                    <span onclick="restoreBackup('${b.filename}')" style="cursor:pointer; margin-right:10px;" title="Restore">‚ôªÔ∏è</span>
                    <span onclick="deleteBackup('${b.filename}')" style="cursor:pointer; color:#e74c3c;" title="Delete">üóëÔ∏è</span>
                </td></tr>`;
        });
        div.innerHTML = html + '</table>';
    });
}
function createBackup() { fetch('/api/backup/create', {method: 'POST'}).then(r => r.json()).then(data => { loadBackups(); showModal('üì¶', 'Backup Created', data.message, false); }); }
function deleteBackup(f) { if(confirm("Delete backup?")) fetch('/api/backup/delete/' + f, {method: 'DELETE'}).then(()=>loadBackups()); }
function restoreBackup(f) { if(confirm("Overwrite DB?")) fetch('/api/backup/restore/' + f, {method: 'POST'}).then(r=>r.json()).then(d=>showModal('‚ôªÔ∏è', 'Restored', d.message, true)); }

// --- SCANNER LOG POLLING ---
let scannerLogInterval;

function refreshScannerLogs() {
    fetch('/api/scanner/logs_stream')
    .then(r => r.json())
    .then(data => {
        const term = document.getElementById('scanner-terminal');
        if(term) {
            term.innerText = data.logs;
            term.scrollTop = term.scrollHeight;
        }
    });
}

// Start polling when the Scanner tab is opened
document.addEventListener('DOMContentLoaded', function() {
    scannerLogInterval = setInterval(function() {
        // Only poll if the Scanner Tab is visible to save bandwidth
        const scannerTab = document.getElementById('tab-logs');
        if (scannerTab && scannerTab.style.display === 'block') {
            refreshScannerLogs();
        }
    }, 2000);
});
</script>
<style>
    @keyframes blink { 50% { opacity: 0.5; } }
    .blink { animation: blink 1s linear infinite; }
</style>
{% endblock %}