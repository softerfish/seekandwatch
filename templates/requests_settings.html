{% extends "base.html" %}
{% block page_title %}Requests Settings{% endblock %}
{% block content %}
<style>
    .input-group-text { background-color: #2a2a2a; border-color: #444; color: #fff; display: flex; align-items: center; }
    #cloudApiKey { background-color: #1e1e1e; border-color: #444; color: #fff; }
    .requests-settings-card .form-control { background: #1e1e1e; color: white; border-color: #444; }
</style>

<div class="container mt-4">
    <!-- Cloud requests sync notice (dismissible) -->
    <div id="requests-sync-notice" class="requests-sync-notice">
        <i class="fas fa-check-circle"></i>
        <span>No approved items to sync.</span>
        <button type="button" class="requests-sync-dismiss" id="requests-sync-dismiss" title="Dismiss" aria-label="Dismiss"><i class="fas fa-times"></i></button>
    </div>

    <!-- SeekAndWatch beta notice (dismissible) -->
    <div id="seekandwatch-promo" class="card mb-4 border-info seekandwatch-promo-settings" style="display: none;">
        <div class="card-header bg-info text-dark d-flex justify-content-between align-items-center py-2">
            <span class="font-weight-bold"><i class="fas fa-info-circle mr-1"></i> What is SeekAndWatch?</span>
            <button type="button" class="btn btn-sm btn-outline-dark btn-close-promo" id="promo-dismiss" title="Close and don't show again" aria-label="Close"><i class="fas fa-times"></i></button>
        </div>
        <div class="card-body bg-dark text-white">
            <p class="mb-2"><strong>SeekAndWatch</strong> (<a href="https://seekandwatch.com" target="_blank" rel="noopener" class="text-info">seekandwatch.com</a>) lets your friends and family <strong>request movies and TV shows</strong> from your Plex server without needing access to Plex or Radarr/Sonarr. Approved items sync to this app and are sent to Radarr/Sonarr (or Overseerr).</p>
            <p class="mb-2"><strong>Why it's safe:</strong> Your Plex URL and tokens stay on your machine. The cloud service only relays requests and connection keys; it does not store your media or control your server.</p>
            <p class="mb-0">
                <span class="badge badge-warning text-dark">Beta</span> SeekAndWatch is currently in <strong>beta</strong>. To request access, go to <a href="https://www.reddit.com/r/SeekAndWatch/" target="_blank" rel="noopener" class="text-info font-weight-bold">r/SeekAndWatch</a> and either <strong>post for access</strong> or <strong>send a mod a PM</strong>.
            </p>
        </div>
    </div>
    <script>
    (function() {
        var NOTICE_KEY = 'seekandwatch_requests_sync_notice_dismissed';
        var PROMO_KEY = 'seekandwatch_promo_dismissed';
        var notice = document.getElementById('requests-sync-notice');
        var promo = document.getElementById('seekandwatch-promo');
        var dismissNotice = document.getElementById('requests-sync-dismiss');
        var dismissPromo = document.getElementById('promo-dismiss');
        try {
            if (localStorage.getItem(NOTICE_KEY) === '1') { if (notice) notice.style.display = 'none'; }
            if (localStorage.getItem(PROMO_KEY) === 'true') { if (promo) promo.style.display = 'none'; }
            else if (promo) promo.style.display = 'block';
        } catch (e) {}
        if (dismissNotice) dismissNotice.addEventListener('click', function() {
            try { localStorage.setItem(NOTICE_KEY, '1'); } catch (e) {}
            if (notice) notice.style.display = 'none';
        });
        if (dismissPromo) dismissPromo.addEventListener('click', function() {
            try { localStorage.setItem(PROMO_KEY, 'true'); } catch (e) {}
            if (promo) promo.style.display = 'none';
        });
    })();
    </script>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Requests Settings</h2>
        <a href="{{ url_for('settings') }}" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Back to Configuration</a>
    </div>

    <div class="card mb-4 requests-settings-card">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0">SeekAndWatch Cloud</h5>
        </div>
        <div class="card-body bg-dark text-white">
            <form method="POST" action="{{ url_for('save_cloud_settings') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="form-group mb-4">
                    <label for="cloudApiKey" class="font-weight-bold text-white">SeekAndWatch Cloud API Key {% if settings.cloud_api_key %}<span class="badge bg-success ms-2" style="font-size: 0.7em; font-weight: normal;">Saved</span>{% endif %}</label>
                    <div class="d-flex gap-2 align-items-center flex-wrap">
                        <input type="password" class="form-control" name="cloud_api_key" id="cloudApiKey" style="max-width: 400px;"
                               value="" placeholder="{% if settings.cloud_api_key %}••••••••{% else %}Paste your key here (e.g. 8f9a...){% endif %}"
                               {% if settings.cloud_api_key %}data-key-set="1"{% endif %} autocomplete="off">
                        <button type="button" class="btn btn-info" id="cloudTestBtn" onclick="testCloudConnection()">Test connection</button>
                        <span id="cloudTestResult" class="small ms-2" style="display: none;"></span>
                    </div>
                    {% if settings.cloud_api_key %}<input type="hidden" name="cloud_api_key_unchanged" value="1" id="cloudApiKey_unchanged_h">{% endif %}
                    <small class="form-text text-muted">
                        {% if settings.cloud_api_key %}Key is set. Leave blank to keep it, or enter a new key to replace. {% endif %}Get this key from your <a href="https://seekandwatch.com/dashboard.php" target="_blank" class="text-info">Cloud Dashboard</a> under "Local Server Connection".
                    </small>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="movieHandler" class="font-weight-bold text-white">Movies Handler</label>
                            <select name="cloud_movie_handler" id="movieHandler" class="form-control">
                                <option value="direct" {% if settings.cloud_movie_handler == 'direct' %}selected{% endif %}>Radarr</option>
                                <option value="overseerr" {% if settings.cloud_movie_handler == 'overseerr' %}selected{% endif %}>Overseerr / Jellyseerr</option>
                            </select>
                            <small class="form-text text-muted">Where to send approved movies.</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="tvHandler" class="font-weight-bold text-white">TV Shows Handler</label>
                            <select name="cloud_tv_handler" id="tvHandler" class="form-control">
                                <option value="direct" {% if settings.cloud_tv_handler == 'direct' %}selected{% endif %}>Sonarr</option>
                                <option value="overseerr" {% if settings.cloud_tv_handler == 'overseerr' %}selected{% endif %}>Overseerr / Jellyseerr</option>
                            </select>
                            <small class="form-text text-muted">Where to send approved shows.</small>
                        </div>
                    </div>
                </div>

                <hr style="border-color: #444; margin: 24px 0;">

                <h6 class="text-white mb-3">Sync with SeekAndWatch (poll API)</h6>
                <p class="text-muted small mb-2">This app uses the <strong>poll API</strong>: it calls SeekAndWatch for approved requests, adds them to Radarr/Sonarr (or Overseerr), then marks them synced. You can also click <strong>Refresh</strong> on the Requests page to sync immediately. No URL or tunnel needed.</p>
                <div class="form-group mb-3">
                    <label class="font-weight-bold text-white d-flex align-items-center" style="gap: 10px;">
                        <input type="checkbox" name="cloud_sync_owned_enabled" id="syncOwnedCheck" {% if settings.cloud_sync_owned_enabled %}checked{% endif %} style="width: 20px; height: 20px;">
                        Enable cloud sync
                    </label>
                    <small class="form-text text-muted">When on, the app polls for approved requests and adds them to your handlers. When off, the key is saved but no syncing runs.</small>
                    <div class="mt-2 d-flex align-items-center gap-2" style="font-size: 0.9em;">
                        <span class="text-muted">Last poll:</span>
                        <span id="lastPollTime">{% if settings.last_cloud_poll_at %}{{ settings.last_cloud_poll_at.strftime('%Y-%m-%d %H:%M') }}{% else %}Never{% endif %}</span>
                        {% if settings.last_cloud_poll_at %}
                        {% if settings.last_cloud_poll_ok %}
                        <span class="text-success" title="Last poll succeeded">●</span>
                        {% else %}
                        <span class="text-danger" title="Last poll failed">●</span>
                        {% endif %}
                        {% else %}
                        <span class="text-secondary" title="No poll yet">●</span>
                        {% endif %}
                    </div>
                </div>
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="cloudPollIntervalMin" class="font-weight-bold text-white">Poll interval min (seconds)</label>
                            <input type="number" class="form-control" name="cloud_poll_interval_min" id="cloudPollIntervalMin" min="30" step="1"
                                   value="{{ settings.cloud_poll_interval_min if settings.cloud_poll_interval_min is not none else '' }}"
                                   placeholder="75">
                            <small class="form-text text-muted">Leave blank for default (75). Minimum 30.</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="cloudPollIntervalMax" class="font-weight-bold text-white">Poll interval max (seconds)</label>
                            <input type="number" class="form-control" name="cloud_poll_interval_max" id="cloudPollIntervalMax" min="30" step="1"
                                   value="{{ settings.cloud_poll_interval_max if settings.cloud_poll_interval_max is not none else '' }}"
                                   placeholder="120">
                            <small class="form-text text-muted">Leave blank for default (120). Must be &ge; min.</small>
                        </div>
                    </div>
                </div>

                <hr style="border-color: #444; margin: 24px 0;">

                <h6 class="text-white mb-2 d-flex align-items-center flex-wrap" style="font-size:0.95rem; gap: 8px;">
                    Instant sync (webhook)
                    <span class="badge bg-success" style="font-size: 0.7em; font-weight: 600;">RECOMMENDED</span>
                    <a href="https://github.com/softerfish/seekandwatch/wiki/SeekAndWatch-Cloud-%E2%80%90-Server-Owners-Guide" target="_blank" rel="noopener" class="text-info small" title="Configuration guide">Wiki: Server Owners Guide <i class="fas fa-external-link-alt fa-xs"></i></a>
                </h6>
                <p class="text-muted small mb-1">Get approved requests synced instantly and reduce cloud API calls. With webhook set, backup polling runs every 30-45 min. Leave blank to use poll only (75-120 s). Same network: local/LAN URL; any network: public tunnel URL.</p>
                <p class="text-muted small mb-3" style="font-size: 0.85rem;">If you don’t open the GitHub link, the instructions below are all you need.</p>
                <div class="alert alert-info py-2 px-3 mb-3" style="background: #1a2a2a; border-color: #2a4a4a; color: #9ab;">
                    <strong>Add your URL</strong> including the path, e.g. <code>http://192.168.2.20:5000/api/seekandwatch/approved</code>. The host and port may be different for your install (use the address where this app is reachable). Use a <strong>random password</strong> for the webhook secret and enter the same value here and in any tunnel/proxy config if needed.
                </div>
                <div class="form-group mb-3">
                    <label for="cloudWebhookUrl" class="font-weight-bold text-white">Local app URL</label>
                    <input type="url" class="form-control" name="cloud_webhook_url" id="cloudWebhookUrl"
                           value="{{ settings.cloud_webhook_url or '' }}"
                           placeholder="e.g. http://192.168.2.20:5000/api/seekandwatch/approved">
                    <small class="form-text text-muted">Full URL including path. Host/port depend on your install. Blank = poll only.</small>
                </div>
                <div class="form-group mb-4">
                    <label for="cloudWebhookSecret" class="font-weight-bold text-white">Webhook secret {% if settings.cloud_webhook_secret %}<span class="badge bg-success ms-2" style="font-size: 0.7em; font-weight: normal;">Saved</span>{% endif %}</label>
                    <input type="password" class="form-control" name="cloud_webhook_secret" id="cloudWebhookSecret"
                           value="" placeholder="{% if settings.cloud_webhook_secret %}••••••••{% else %}Random password (e.g. generate one){% endif %}"
                           {% if settings.cloud_webhook_secret %}data-key-set="1"{% endif %} autocomplete="off">
                    {% if settings.cloud_webhook_secret %}<input type="hidden" name="cloud_webhook_secret_unchanged" value="1" id="cloudWebhookSecret_unchanged_h">{% endif %}
                    <small class="form-text text-muted">Use a random password; the cloud sends it in the <code>X-Webhook-Secret</code> header. Required when URL is set.</small>
                </div>

                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Settings
                </button>
            </form>
        </div>
    </div>

    <!-- Last 20 imported (cloud webhook/poll) -->
    <div class="card mb-4 requests-settings-card">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0">Last 20 imported</h5>
        </div>
        <div class="card-body bg-dark text-white p-0">
            {% if cloud_import_log is defined and cloud_import_log %}
            <div class="table-responsive">
                <table class="table table-dark table-hover table-sm mb-0">
                    <thead>
                        <tr>
                            <th>Time (UTC)</th>
                            <th>Source</th>
                            <th>Title</th>
                            <th>Type</th>
                            <th>Result</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for e in cloud_import_log %}
                        <tr>
                            <td class="text-nowrap">{{ e.at }}</td>
                            <td><code>{{ e.source }}</code></td>
                            <td>{{ e.title }}</td>
                            <td>{{ e.media_type }}</td>
                            <td>{% if e.success %}<span class="text-success">OK</span>{% else %}<span class="text-danger">Failed</span>{% endif %}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted mb-0 p-3">No imports yet. Entries appear when the app adds items from the cloud (webhook or poll).</p>
            {% endif %}
        </div>
    </div>
</div>
<script>
function testCloudConnection() {
    var btn = document.getElementById('cloudTestBtn');
    var resultEl = document.getElementById('cloudTestResult');
    var keyEl = document.getElementById('cloudApiKey');
    var key = (keyEl && keyEl.value) ? keyEl.value.trim() : '';
    var payload = {};
    if (key) payload.api_key = key;
    var csrf = document.querySelector('input[name="csrf_token"]');
    var headers = { 'Content-Type': 'application/json' };
    if (csrf && csrf.value) headers['X-CSRFToken'] = csrf.value;
    if (btn) { btn.disabled = true; btn.textContent = 'Testing...'; }
    if (resultEl) { resultEl.style.display = 'none'; resultEl.className = 'small ms-2'; }
    fetch('{{ url_for("test_cloud_connection") }}', { method: 'POST', headers: headers, body: JSON.stringify(payload) })
        .then(function(r) { return r.json(); })
        .then(function(d) {
            if (resultEl) {
                resultEl.style.display = 'inline';
                resultEl.textContent = d.message || (d.status === 'success' ? 'OK' : (d.status === 'warning' ? 'Rate limited' : 'Failed'));
                var cls = d.status === 'success' ? 'text-success' : (d.status === 'warning' ? 'text-warning' : 'text-danger');
                resultEl.classList.add(cls);
            }
        })
        .catch(function() {
            if (resultEl) { resultEl.style.display = 'inline'; resultEl.className = 'small ms-2 text-danger'; resultEl.textContent = 'Request failed.'; }
        })
        .finally(function() {
            if (!btn) return;
            var waitSec = 120;
            btn.disabled = true;
            var tick = function() {
                if (waitSec <= 0) {
                    btn.disabled = false;
                    btn.textContent = 'Test connection';
                    return;
                }
                var m = Math.floor(waitSec / 60);
                var s = waitSec % 60;
                btn.textContent = 'Try again in ' + m + ':' + (s < 10 ? '0' : '') + s;
                waitSec--;
                setTimeout(tick, 1000);
            };
            tick();
        });
}
document.addEventListener('DOMContentLoaded', function() {
    ['cloudApiKey', 'cloudWebhookSecret'].forEach(function(id) {
        var el = document.getElementById(id);
        if (el) el.addEventListener('input', function() {
            var h = document.getElementById(id + '_unchanged_h');
            if (h) h.remove();
        });
    });
});
</script>
{% endblock %}
