{% extends "base.html" %}
{% block page_title %}Requests Settings{% endblock %}
{% block content %}
<style>
    .input-group-text { background-color: #2a2a2a; border-color: #444; color: #fff; display: flex; align-items: center; }
    #cloudApiKey { background-color: #1e1e1e; border-color: #444; color: #fff; }
    .requests-settings-card .form-control { 
        background: #1e1e1e; 
        color: white; 
        border-color: #444; 
        border-radius: 6px;
        height: 42px;
    }
    
    /* New Layout Styles */
    .seekandwatch-promo-settings {
        background-color: #000000; /* Pure black */
        border: 1px solid #00bcd4; /* Cyan border */
        border-radius: 8px;
    }
    .seekandwatch-promo-settings .card-header {
        background-color: #00bcd4 !important; /* Cyan header */
        color: #000 !important;
        border-bottom: none;
        font-weight: bold;
        border-radius: 7px 7px 0 0;
    }
    .seekandwatch-promo-settings .card-body {
        background-color: transparent !important;
        color: #fff !important;
    }
    .seekandwatch-promo-settings a {
        color: #00bcd4 !important;
        text-decoration: underline;
    }
    
    .btn-back-config {
        background-color: transparent;
        border: 1px solid #6f42c1; /* Purple border */
        color: #a0a0a0;
        border-radius: 20px;
        padding: 5px 15px;
        font-size: 0.9em;
        transition: all 0.2s;
    }
    .btn-back-config:hover {
        background-color: #6f42c1;
        color: white;
        text-decoration: none;
    }
    
    .btn-test-connection {
        background-color: #7c5dfa;
        border-color: #7c5dfa;
        color: #000000;
        font-weight: bold;
        border-radius: 6px;
        padding: 0 20px;
        height: 42px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    .btn-test-connection:hover {
        background-color: #7c5dfa;
        border-color: #7c5dfa;
        color: #000000;
        filter: brightness(1.1);
    }

    .btn-save-settings {
        background-color: #7c5dfa;
        border-color: #7c5dfa;
        color: #000000;
        font-weight: bold;
        border-radius: 6px;
    }
    .btn-save-settings:hover {
        background-color: #7c5dfa;
        border-color: #7c5dfa;
        color: #000000;
        filter: brightness(1.1);
    }
    /* Checkbox custom style */
    .custom-checkbox-container {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 15px;
        font-weight: bold;
    }
    .custom-checkbox-container input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: #7c5dfa; /* Purple check */
        cursor: pointer;
    }
</style>

<div class="container mt-4">
    <!-- SeekAndWatch beta notice (dismissible) -->
    <div id="seekandwatch-promo" class="card mb-4 seekandwatch-promo-settings" style="display: none;">
        <div class="card-header d-flex justify-content-between align-items-center py-2">
            <span><i class="fas fa-info-circle mr-1"></i> What is SeekAndWatch?</span>
            <button type="button" class="btn btn-sm btn-link text-dark btn-close-promo" id="promo-dismiss" title="Close and don't show again" aria-label="Close" style="text-decoration: none;"><i class="fas fa-times"></i></button>
        </div>
        <div class="card-body">
            <p class="mb-2"><strong>SeekAndWatch</strong> (<a href="https://seekandwatch.com" target="_blank" rel="noopener">seekandwatch.com</a>) lets your friends and family <strong>request movies and TV shows</strong> from your Plex server without needing access to Plex or Radarr/Sonarr. Approved items sync to this app and are sent to Radarr/Sonarr (or Overseerr).</p>
            <p class="mb-2"><strong>Why it's safe:</strong> Your Plex URL and tokens stay on your machine. The cloud service only relays requests and connection keys; it does not store your media or control your server.</p>
            <p class="mb-0">
                SeekAndWatch is currently in <strong>beta</strong>. To request access, go to <a href="https://www.reddit.com/r/SeekAndWatch/" target="_blank" rel="noopener">r/SeekAndWatch</a> and either <strong>post for access</strong> or <strong>send a mod a PM</strong>.
            </p>
        </div>
    </div>
    <script>
    (function() {
        var PROMO_KEY = 'seekandwatch_promo_dismissed';
        var promo = document.getElementById('seekandwatch-promo');
        var dismissPromo = document.getElementById('promo-dismiss');
        try {
            if (localStorage.getItem(PROMO_KEY) === 'true') { if (promo) promo.style.display = 'none'; }
            else if (promo) promo.style.display = 'block';
        } catch (e) {}
        if (dismissPromo) dismissPromo.addEventListener('click', function() {
            try { localStorage.setItem(PROMO_KEY, 'true'); } catch (e) {}
            if (promo) promo.style.display = 'none';
        });
    })();
    </script>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Requests Settings</h2>
        <a href="{{ url_for('settings') }}" class="btn btn-back-config"><i class="fas fa-arrow-left"></i> Back to Configuration</a>
    </div>

    <div class="card mb-4 requests-settings-card">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0">SeekAndWatch Cloud</h5>
        </div>
        <div class="card-body bg-dark text-white">
            <!-- Pairing Section (Zero Config) -->
            {% if not settings.cloud_api_key %}
            <div id="pairing-section" class="mb-4 text-center p-4" style="background: rgba(124, 93, 250, 0.1); border: 2px dashed #7c5dfa; border-radius: 8px;">
                <h6 class="text-white mb-3">Connect to SeekAndWatch Cloud</h6>
                <p class="text-muted small">The easiest way to sync your requests. No manual key entry required.</p>
                <button type="button" class="btn btn-test-connection" id="btnPairStart" onclick="startPairing()">
                    <i class="fas fa-link me-2"></i>One-Click Pair with Cloud
                </button>
                <div id="pairingStatus" class="mt-2 small d-none"></div>
            </div>
            {% endif %}

            <form method="POST" action="{{ url_for('save_cloud_settings') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="movieHandler" class="font-weight-bold text-white">Movies Handler</label>
                            <select name="cloud_movie_handler" id="movieHandler" class="form-control">
                                <option value="direct" {% if settings.cloud_movie_handler == 'direct' %}selected{% endif %}>Radarr</option>
                                <option value="overseerr" {% if settings.cloud_movie_handler == 'overseerr' %}selected{% endif %}>Overseerr / Jellyseerr</option>
                            </select>
                            <small class="form-text text-muted">Where to send approved movies.</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="tvHandler" class="font-weight-bold text-white">TV Shows Handler</label>
                            <select name="cloud_tv_handler" id="tvHandler" class="form-control">
                                <option value="direct" {% if settings.cloud_tv_handler == 'direct' %}selected{% endif %}>Sonarr</option>
                                <option value="overseerr" {% if settings.cloud_tv_handler == 'overseerr' %}selected{% endif %}>Overseerr / Jellyseerr</option>
                            </select>
                            <small class="form-text text-muted">Where to send approved shows.</small>
                        </div>
                    </div>
                </div>

                <hr style="border-color: #444; margin: 24px 0;">

                <h6 class="text-white mb-3">Sync with SeekAndWatch (poll API)</h6>
                <p class="text-muted small mb-2">This app uses the <strong>poll API</strong>: it calls SeekAndWatch for approved requests, adds them to Radarr/Sonarr (or Overseerr), then marks them synced. You can also click <strong>Refresh</strong> on the Requests page to sync immediately. No URL or tunnel needed.</p>
                
                <div class="custom-checkbox-container">
                    <input type="checkbox" name="cloud_sync_owned_enabled" id="syncOwnedCheck" {% if settings.cloud_sync_owned_enabled %}checked{% endif %}>
                    <label for="syncOwnedCheck" class="mb-0 text-white cursor-pointer">Enable cloud sync</label>
                </div>

                <hr style="border-color: #444; margin: 24px 0;">

                <h6 class="text-white mb-3">Webhook notifications (instant sync)</h6>
                <p class="text-muted small mb-2">For instant notifications when requests are approved, set up a Cloudflare Tunnel. This creates a secure connection so SeekAndWatch can notify your app immediately.</p>
                
                <div class="alert alert-info" style="background-color: #1a1a2e; border-color: #2d2d44; color: #a0a0a0;">
                    <strong style="color: #fff;">Choose your setup method:</strong>
                    <div class="mt-2">
                        <p class="mb-1"><strong>Option 1: Quick Tunnel (Easiest)</strong></p>
                        <p class="small mb-2">No Cloudflare account or domain needed. Just click the green "Enable Tunnel" button below. A random URL will be generated automatically.</p>
                        
                        <p class="mb-1"><strong>Option 2: Persistent Tunnel (Advanced)</strong></p>
                        <p class="small mb-0">Use your own domain and a persistent URL. Requires a Cloudflare account and API token:</p>
                        <ol class="small mb-0 mt-1" style="padding-left: 20px;">
                            <li>Go to <a href="https://dash.cloudflare.com/profile/api-tokens" target="_blank" class="text-info">api-tokens</a> and create a token with <b>Cloudflare Tunnel: Edit</b> and <b>Account Settings: Read</b> permissions.</li>
                            <li>Paste the token below and click <b>Save Settings</b> before enabling.</li>
                        </ol>
                    </div>
                </div>
                
                <details class="mb-3">
                    <summary class="text-info small cursor-pointer" style="cursor: pointer;">Advanced: Persistent Tunnel & Manual Key</summary>
                    
                    <div class="form-group mt-3">
                        <label for="cloudApiKey" class="text-white small">SeekAndWatch Cloud API Key {% if settings.cloud_api_key %}<span class="badge bg-success ms-2" style="font-size: 0.7em; font-weight: normal;">Saved</span>{% endif %}</label>
                        <div class="d-flex gap-2 align-items-center flex-wrap">
                            <div class="input-group" style="max-width: 400px;">
                                <input type="password" class="form-control form-control-sm" name="cloud_api_key" id="cloudApiKey"
                                       value="{{ settings.cloud_api_key or '' }}" placeholder="{% if settings.cloud_api_key %}••••••••{% else %}Paste your key here (e.g. 8f9a...){% endif %}"
                                       {% if settings.cloud_api_key %}data-key-set="1"{% endif %} autocomplete="off">
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="togglePasswordVisibility('cloudApiKey', this)" title="Show/hide key">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-info" id="cloudTestBtn" onclick="testCloudConnection()">Test key</button>
                            {% if settings.cloud_api_key %}
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearCloudKey()">Clear</button>
                            {% endif %}
                            <span id="cloudTestResult" class="small ms-2" style="display: none;"></span>
                        </div>
                        {% if settings.cloud_api_key %}<input type="hidden" name="cloud_api_key_unchanged" value="1" id="cloudApiKey_unchanged_h">{% endif %}
                        <small class="form-text text-muted">
                            Only needed if One-Click pairing fails.
                        </small>
                    </div>

                    <div class="form-group mt-3">
                        <label for="cloudflareApiToken" class="text-white small">Cloudflare API Token</label>
                        <div class="input-group" style="max-width: 500px;">
                            <input type="password" class="form-control form-control-sm" name="cloudflare_api_token" id="cloudflareApiToken" 
                                   placeholder="Paste your Cloudflare API token here" value="{{ settings.cloudflare_api_token or '' }}">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="togglePasswordVisibility('cloudflareApiToken', this)" title="Show/hide token">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <small class="form-text text-muted">
                            Optional. Only needed for persistent tunnels with custom domains.
                        </small>
                    </div>
                    
                    <div class="form-group mt-3">
                        <label for="cloudflareAccountId" class="text-white small">Cloudflare Account ID (optional)</label>
                        <input type="text" class="form-control form-control-sm" name="cloudflare_account_id" id="cloudflareAccountId" 
                               placeholder="Leave blank to auto-detect" style="max-width: 500px;" value="{{ settings.cloudflare_account_id or '' }}">
                    </div>
                </details>
                
                <div class="form-group mt-3">
                    <label for="webhookFailsafe" class="text-white small">Webhook Failsafe Poll Interval</label>
                    <select class="form-control form-control-sm" name="cloud_webhook_failsafe_hours" id="webhookFailsafe" style="max-width: 300px;">
                        <option value="6" {% if settings.cloud_webhook_failsafe_hours == 6 %}selected{% endif %}>Every 6 hours</option>
                        <option value="12" {% if settings.cloud_webhook_failsafe_hours == 12 %}selected{% endif %}>Every 12 hours</option>
                        <option value="24" {% if settings.cloud_webhook_failsafe_hours == 24 %}selected{% endif %}>Every 24 hours</option>
                    </select>
                    <small class="form-text text-muted">
                        When webhook is enabled, polling runs less frequently as a failsafe backup. Webhooks deliver requests instantly.
                    </small>
                </div>
                
                <div id="tunnelStatus" class="mt-3" style="{% if settings.tunnel_enabled %}display: block;{% else %}display: none;{% endif %}max-width: 600px;">
                    <div class="alert {% if settings.tunnel_status == 'connected' %}alert-success{% elif settings.tunnel_status == 'error' %}alert-danger{% else %}alert-info{% endif %} mb-2 text-center fw-bold" id="tunnelStatusMessage">
                        {% if settings.tunnel_enabled and settings.tunnel_status == 'connected' %}
                            <span id="tunnelStatusText">Tunnel connected</span>
                        {% elif settings.tunnel_enabled and settings.tunnel_status == 'error' %}
                            <span id="tunnelStatusText">Tunnel error: {{ settings.tunnel_last_error or 'Unknown error' }}</span>
                        {% elif settings.tunnel_enabled %}
                            <span id="tunnelStatusText">Tunnel is starting...</span>
                        {% else %}
                            <span id="tunnelStatusText">Tunnel not enabled</span>
                        {% endif %}
                    </div>
                    
                    <div id="tunnelError" style="display: none;">
                        <div class="alert alert-danger mb-2">
                            <strong>Error:</strong> <span id="tunnelErrorMessage"></span>
                        </div>
                        <p class="text-muted small" id="tunnelErrorGuidance"></p>
                    </div>
                </div>
                
                <div class="mt-3">
                    {% if settings.tunnel_enabled %}
                        <button type="button" class="btn btn-danger" onclick="disableTunnel()">
                            <i class="fas fa-stop-circle mr-2"></i>Disable Tunnel
                        </button>
                    {% else %}
                        <button type="button" class="btn btn-success" onclick="enableTunnel()">
                            <i class="fas fa-play-circle mr-2"></i>Enable Tunnel
                        </button>
                    {% endif %}
                </div>

                <!-- Hidden inputs for legacy/advanced settings -->
                <input type="hidden" name="cloud_poll_interval_min" value="{{ settings.cloud_poll_interval_min or 75 }}">
                <input type="hidden" name="cloud_poll_interval_max" value="{{ settings.cloud_poll_interval_max or 120 }}">
                <input type="hidden" name="cloud_webhook_secret_unchanged" value="1">

                <button type="submit" class="btn btn-save-settings mt-4">
                    Save Settings
                </button>
            </form>
        </div>
    </div>

    <!-- Last 20 imported (cloud webhook/poll) -->
    <div class="card mb-4 requests-settings-card">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0">Last 20 imported</h5>
        </div>
        <div class="card-body bg-dark text-white p-0">
            {% if cloud_import_log is defined and cloud_import_log %}
            <div class="table-responsive">
                <table class="table table-dark table-hover table-sm mb-0">
                    <thead>
                        <tr>
                            <th>Time (UTC)</th>
                            <th>Source</th>
                            <th>Title</th>
                            <th>Type</th>
                            <th>Result</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for e in cloud_import_log %}
                        <tr>
                            <td class="text-nowrap">{{ e.at }}</td>
                            <td><code>{{ e.source }}</code></td>
                            <td>{{ e.title }}</td>
                            <td>{{ e.media_type }}</td>
                            <td>{% if e.success %}<span class="text-success">OK</span>{% else %}<span class="text-danger">Failed</span>{% endif %}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted mb-0 p-3">No imports yet. Entries appear when the app adds items from the cloud (webhook or poll).</p>
            {% endif %}
        </div>
    </div>
</div>
<script>
function testCloudConnection() {
    var btn = document.getElementById('cloudTestBtn');
    var resultEl = document.getElementById('cloudTestResult');
    var keyEl = document.getElementById('cloudApiKey');
    var key = (keyEl && keyEl.value) ? keyEl.value.trim() : '';
    var payload = {};
    if (key) payload.api_key = key;
    var csrf = document.querySelector('input[name="csrf_token"]');
    var headers = { 'Content-Type': 'application/json' };
    if (csrf && csrf.value) headers['X-CSRFToken'] = csrf.value;
    if (btn) { btn.disabled = true; btn.textContent = 'Testing...'; }
    if (resultEl) { resultEl.style.display = 'none'; resultEl.className = 'small ms-2'; }
    fetch('{{ url_for("test_cloud_connection") }}', { method: 'POST', headers: headers, body: JSON.stringify(payload) })
        .then(function(r) { return r.json(); })
        .then(function(d) {
            if (resultEl) {
                resultEl.style.display = 'inline';
                resultEl.textContent = d.message || (d.status === 'success' ? 'OK' : (d.status === 'warning' ? 'Rate limited' : 'Failed'));
                var cls = d.status === 'success' ? 'text-success' : (d.status === 'warning' ? 'text-warning' : 'text-danger');
                resultEl.classList.add(cls);
            }
        })
        .catch(function() {
            if (resultEl) { resultEl.style.display = 'inline'; resultEl.className = 'small ms-2 text-danger'; resultEl.textContent = 'Request failed.'; }
        })
        .finally(function() {
            if (!btn) return;
            var waitSec = 120;
            btn.disabled = true;
            var tick = function() {
                if (waitSec <= 0) {
                    btn.disabled = false;
                    btn.textContent = 'Test key';
                    return;
                }
                var m = Math.floor(waitSec / 60);
                var s = waitSec % 60;
                btn.textContent = 'Try again in ' + m + ':' + (s < 10 ? '0' : '') + s;
                waitSec--;
                setTimeout(tick, 1000);
            };
            tick();
        });
}

function clearCloudKey() {
    if (!confirm("Are you sure you want to clear the saved API key? This will disconnect your app from SeekAndWatch Cloud.")) return;
    const input = document.getElementById('cloudApiKey');
    const hidden = document.getElementById('cloudApiKey_unchanged_h');
    const badge = document.querySelector('.key-saved-badge') || document.querySelector('.badge.bg-success');
    
    input.value = '';
    input.placeholder = 'Paste your key here (e.g. 8f9a...)';
    input.removeAttribute('data-key-set');
    if (hidden) hidden.remove();
    if (badge) badge.remove();
    
    // Auto-save the empty state
    input.form.submit();
}

function startPairing() {
    const btn = document.getElementById('btnPairStart');
    const status = document.getElementById('pairingStatus');
    
    // Open a blank window immediately to satisfy popup blockers
    const popup = window.open('about:blank', 'seekandwatch_pair', 'width=600,height=700');
    if (!popup || popup.closed || typeof popup.closed == 'undefined') {
        status.className = 'mt-2 small text-warning';
        status.textContent = 'Popup blocked! Please allow popups for this site and try again.';
        btn.disabled = false;
        return;
    }
    
    popup.document.write('<html><body style="background:#1a1a2e; color:white; display:flex; align-items:center; justify-content:center; height:100vh; font-family:sans-serif;"><div><h2>Connecting...</h2><p>Please wait while we establish a secure handshake.</p></div></body></html>');

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Starting Tunnel...';
    status.className = 'mt-2 small text-info';
    status.textContent = 'Establishing secure connection... this can take 30-60 seconds.';
    status.classList.remove('d-none');

    fetch('/api/pair/start', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            status.innerHTML = 'Connection established! If the window didn\'t open, <a href="' + data.pair_url + '" target="_blank" class="text-white text-decoration-underline">click here to link manually</a>.';
            btn.innerHTML = '<i class="fas fa-check me-2"></i>Handshake Ready';
            
            // Update the already-open popup
            popup.location.href = data.pair_url;
            
            // Start polling for success
            const checkPair = setInterval(() => {
                fetch('{{ url_for("test_cloud_connection") }}', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value }
                })
                .then(r => r.json())
                .then(d => {
                    if (d.status === 'success') {
                        clearInterval(checkPair);
                        status.className = 'mt-2 small text-success';
                        status.textContent = 'Successfully paired! Reloading...';
                        setTimeout(() => location.reload(), 1500);
                    }
                });
            }, 3000);
        } else {
            popup.close();
            status.className = 'mt-2 small text-danger';
            status.textContent = 'Pairing failed: ' + (data.error || 'Unknown error');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-link me-2"></i>One-Click Pair with Cloud';
        }
    })
    .catch(err => {
        popup.close();
        status.className = 'mt-2 small text-danger';
        status.textContent = 'Request failed. Please check your logs.';
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-link me-2"></i>One-Click Pair with Cloud';
    });
}

document.addEventListener('DOMContentLoaded', function() {
    ['cloudApiKey', 'cloudWebhookSecret'].forEach(function(id) {
        var el = document.getElementById(id);
        if (el) el.addEventListener('input', function() {
            var h = document.getElementById(id + '_unchanged_h');
            if (h) h.remove();
        });
    });
    
    // check tunnel status on page load if enabled
    {% if settings.tunnel_enabled %}
        updateTunnelStatus();
        // poll status every 30 seconds
        setInterval(updateTunnelStatus, 30000);
    {% endif %}
});

function enableTunnel() {
    var statusDiv = document.getElementById('tunnelStatus');
    var statusMsg = document.getElementById('tunnelStatusMessage');
    var statusText = document.getElementById('tunnelStatusText');
    
    // show status
    statusDiv.style.display = 'block';
    statusMsg.className = 'alert alert-info mb-2';
    statusText.textContent = 'Creating and starting tunnel...';
    
    // call API to enable tunnel
    fetch('/api/tunnel/enable', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        }
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            statusMsg.className = 'alert alert-success mb-2';
            statusText.textContent = 'Tunnel enabled successfully! Reloading page...';
            // reload page to show new state
            setTimeout(function() { window.location.reload(); }, 2000);
        } else {
            statusMsg.className = 'alert alert-danger mb-2';
            statusText.textContent = 'Failed to enable tunnel: ' + (data.error || 'Unknown error');
            
            // show error details if available
            if (data.guidance) {
                document.getElementById('tunnelErrorMessage').textContent = data.error;
                document.getElementById('tunnelErrorGuidance').textContent = data.guidance;
                document.getElementById('tunnelError').style.display = 'block';
            }
        }
    })
    .catch(function(err) {
        statusMsg.className = 'alert alert-danger mb-2';
        statusText.textContent = 'Request failed';
    });
}

function disableTunnel() {
    if (!confirm('Are you sure you want to disable the tunnel? Webhook notifications will stop working.')) {
        return;
    }
    
    var statusDiv = document.getElementById('tunnelStatus');
    var statusMsg = document.getElementById('tunnelStatusMessage');
    var statusText = document.getElementById('tunnelStatusText');
    
    statusDiv.style.display = 'block';
    statusMsg.className = 'alert alert-info mb-2';
    statusText.textContent = 'Stopping tunnel...';
    
    // call API to disable tunnel
    fetch('/api/tunnel/disable', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        }
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            statusMsg.className = 'alert alert-success mb-2';
            statusText.textContent = 'Tunnel disabled. Reloading page...';
            setTimeout(function() { window.location.reload(); }, 2000);
        } else {
            statusMsg.className = 'alert alert-danger mb-2';
            statusText.textContent = 'Failed to disable tunnel: ' + (data.error || 'Unknown error');
        }
    })
    .catch(function(err) {
        statusMsg.className = 'alert alert-danger mb-2';
        statusText.textContent = 'Request failed';
    });
}

function updateTunnelStatus() {
    fetch('/api/tunnel/status', {
        headers: {
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        }
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success && data.status) {
            var status = data.status;
            var statusDiv = document.getElementById('tunnelStatus');
            var statusMsg = document.getElementById('tunnelStatusMessage');
            var statusText = document.getElementById('tunnelStatusText');
            var detailsDiv = document.getElementById('tunnelDetails');
            var errorDiv = document.getElementById('tunnelError');
            
            if (!statusDiv || !statusMsg || !statusText) {
                console.error('Tunnel status elements not found');
                return;
            }
            
            statusDiv.style.display = 'block';
            
            if (status.status === 'connected') {
                statusMsg.className = 'alert alert-success mb-2';
                statusText.textContent = 'Tunnel connected';
                if (detailsDiv) detailsDiv.style.display = 'block';
                if (errorDiv) errorDiv.style.display = 'none';
                
                if (status.url) {
                    var urlDisplay = document.getElementById('tunnelUrlDisplay');
                    if (urlDisplay) urlDisplay.value = status.url + '/webhook';
                }
            } else if (status.status === 'error') {
                statusMsg.className = 'alert alert-danger mb-2';
                statusText.textContent = 'Tunnel error';
                if (detailsDiv) detailsDiv.style.display = 'none';
                if (errorDiv) errorDiv.style.display = 'block';
                
                if (status.last_error) {
                    var errorMsg = document.getElementById('tunnelErrorMessage');
                    if (errorMsg) errorMsg.textContent = status.last_error;
                }
            } else {
                statusMsg.className = 'alert alert-warning mb-2';
                statusText.textContent = 'Tunnel ' + status.status;
                if (detailsDiv) detailsDiv.style.display = 'none';
                if (errorDiv) errorDiv.style.display = 'none';
            }
        }
    })
    .catch(function(err) {
        console.error('Failed to get tunnel status:', err);
    });
}

function testTunnelConnection() {
    var resultDiv = document.getElementById('tunnelTestResult');
    resultDiv.style.display = 'block';
    resultDiv.className = 'alert alert-info mt-2';
    resultDiv.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Testing connection...';
    
    fetch('/api/tunnel/test', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        }
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            resultDiv.className = 'alert alert-success mt-2';
            resultDiv.innerHTML = '<i class="fas fa-check-circle mr-2"></i>' + (data.message || 'Connection test passed');
        } else {
            resultDiv.className = 'alert alert-danger mt-2';
            resultDiv.innerHTML = '<i class="fas fa-times-circle mr-2"></i>' + (data.error || 'Connection test failed');
        }
    })
    .catch(function(err) {
        resultDiv.className = 'alert alert-danger mt-2';
        resultDiv.textContent = 'Request failed';
    });
}

function resetTunnelConfig() {
    if (!confirm('Are you sure you want to reset the tunnel configuration? This will stop the tunnel and clear all settings.')) {
        return;
    }
    
    var statusMsg = document.getElementById('tunnelStatusMessage');
    var statusText = document.getElementById('tunnelStatusText');
    
    if (!statusMsg || !statusText) {
        console.error('Tunnel status elements not found');
        return;
    }
    
    statusMsg.className = 'alert alert-info mb-2';
    statusText.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Resetting configuration...';
    
    fetch('/api/tunnel/reset', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        }
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            statusMsg.className = 'alert alert-success mb-2';
            statusText.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Configuration reset successfully';
            var tunnelCheck = document.getElementById('tunnelEnabledCheck');
            if (tunnelCheck) tunnelCheck.checked = false;
            var tunnelDetails = document.getElementById('tunnelDetails');
            if (tunnelDetails) tunnelDetails.style.display = 'none';
            setTimeout(function() { 
                var tunnelStatus = document.getElementById('tunnelStatus');
                if (tunnelStatus) tunnelStatus.style.display = 'none'; 
            }, 3000);
        } else {
            statusMsg.className = 'alert alert-danger mb-2';
            statusText.textContent = 'Failed to reset: ' + (data.error || 'Unknown error');
        }
    })
    .catch(function(err) {
        statusMsg.className = 'alert alert-danger mb-2';
        statusText.textContent = 'Request failed';
    });
}

function copyTunnelUrl() {
    var urlInput = document.getElementById('tunnelUrlDisplay');
    urlInput.select();
    document.execCommand('copy');
    
    // show feedback
    var btn = event.target.closest('button');
    var originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-check"></i>';
    setTimeout(function() {
        btn.innerHTML = originalHtml;
    }, 2000);
}

// poll tunnel status every 30 seconds if enabled
setInterval(function() {
    var tunnelCheck = document.getElementById('tunnelEnabledCheck');
    if (tunnelCheck && tunnelCheck.checked) {
        updateTunnelStatus();
    }
}, 30000);

function togglePasswordVisibility(fieldId, button) {
    var field = document.getElementById(fieldId);
    if (!field) return;
    
    var icon = button.querySelector('i');
    if (!icon) return;
    
    if (field.type === 'password') {
        field.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
        button.title = 'Hide';
    } else {
        field.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
        button.title = 'Show';
    }
}
</script>{% endblock %}