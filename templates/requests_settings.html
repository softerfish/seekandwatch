{% extends "base.html" %}
{% block page_title %}Requests Settings{% endblock %}
{% block content %}
<style>
    .input-group-text { background-color: #2a2a2a; border-color: #444; color: #fff; display: flex; align-items: center; }
    #cloudApiKey { background-color: #1e1e1e; border-color: #444; color: #fff; }
    .requests-settings-card .form-control { 
        background: #1e1e1e; 
        color: white; 
        border-color: #444; 
        border-radius: 6px;
        height: 42px;
    }
    
    /* New Layout Styles */
    .seekandwatch-promo-settings {
        background-color: #000000; /* Pure black */
        border: 1px solid #00bcd4; /* Cyan border */
        border-radius: 8px;
    }
    .seekandwatch-promo-settings .card-header {
        background-color: #00bcd4 !important; /* Cyan header */
        color: #000 !important;
        border-bottom: none;
        font-weight: bold;
        border-radius: 7px 7px 0 0;
    }
    .seekandwatch-promo-settings .card-body {
        background-color: transparent !important;
        color: #fff !important;
    }
    .seekandwatch-promo-settings a {
        color: #00bcd4 !important;
        text-decoration: underline;
    }
    
    .btn-back-config {
        background-color: transparent;
        border: 1px solid #6f42c1; /* Purple border */
        color: #a0a0a0;
        border-radius: 20px;
        padding: 5px 15px;
        font-size: 0.9em;
        transition: all 0.2s;
    }
    .btn-back-config:hover {
        background-color: #6f42c1;
        color: white;
        text-decoration: none;
    }
    
    .btn-test-connection {
        background-color: #7c5dfa;
        border-color: #7c5dfa;
        color: #000000;
        font-weight: bold;
        border-radius: 6px;
        padding: 0 20px;
        height: 42px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    .btn-test-connection:hover {
        background-color: #7c5dfa;
        border-color: #7c5dfa;
        color: #000000;
        filter: brightness(1.1);
    }

    .btn-save-settings {
        background-color: #7c5dfa;
        border-color: #7c5dfa;
        color: #000000;
        font-weight: bold;
        border-radius: 6px;
    }
    .btn-save-settings:hover {
        background-color: #7c5dfa;
        border-color: #7c5dfa;
        color: #000000;
        filter: brightness(1.1);
    }
    /* Checkbox custom style */
    .custom-checkbox-container {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 15px;
        font-weight: bold;
    }
    .custom-checkbox-container input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: #7c5dfa; /* Purple check */
        cursor: pointer;
    }
</style>

<div class="container mt-4">
    <!-- SeekAndWatch beta notice (dismissible) -->
    <div id="seekandwatch-promo" class="card mb-4 seekandwatch-promo-settings" style="display: none;">
        <div class="card-header d-flex justify-content-between align-items-center py-2">
            <span><i class="fas fa-info-circle mr-1"></i> What is SeekAndWatch?</span>
            <button type="button" class="btn btn-sm btn-link text-dark btn-close-promo" id="promo-dismiss" title="Close and don't show again" aria-label="Close" style="text-decoration: none;"><i class="fas fa-times"></i></button>
        </div>
        <div class="card-body">
            <p class="mb-2"><strong>SeekAndWatch</strong> (<a href="https://seekandwatch.com" target="_blank" rel="noopener">seekandwatch.com</a>) lets your friends and family <strong>request movies and TV shows</strong> from your Plex server without needing access to Plex or Radarr/Sonarr. Approved items sync to this app and are sent to Radarr/Sonarr (or Overseerr).</p>
            <p class="mb-2"><strong>Why it's safe:</strong> Your Plex URL and tokens stay on your machine. The cloud service only relays requests and connection keys; it does not store your media or control your server.</p>
            <p class="mb-0">
                SeekAndWatch is currently in <strong>beta</strong>. To request access, go to <a href="https://www.reddit.com/r/SeekAndWatch/" target="_blank" rel="noopener">r/SeekAndWatch</a> and either <strong>post for access</strong> or <strong>send a mod a PM</strong>.
            </p>
        </div>
    </div>
    <script>
    (function() {
        var PROMO_KEY = 'seekandwatch_promo_dismissed';
        var promo = document.getElementById('seekandwatch-promo');
        var dismissPromo = document.getElementById('promo-dismiss');
        try {
            if (localStorage.getItem(PROMO_KEY) === 'true') { if (promo) promo.style.display = 'none'; }
            else if (promo) promo.style.display = 'block';
        } catch (e) {}
        if (dismissPromo) dismissPromo.addEventListener('click', function() {
            try { localStorage.setItem(PROMO_KEY, 'true'); } catch (e) {}
            if (promo) promo.style.display = 'none';
        });
    })();
    </script>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Requests Settings</h2>
        <a href="{{ url_for('settings') }}" class="btn btn-back-config"><i class="fas fa-arrow-left"></i> Back to Configuration</a>
    </div>

    <div class="card mb-4 requests-settings-card">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0">SeekAndWatch Cloud</h5>
        </div>
        <div class="card-body bg-dark text-white">
            <form method="POST" action="{{ url_for('save_cloud_settings') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="form-group mb-4">
                    <label for="cloudApiKey" class="font-weight-bold text-white">SeekAndWatch Cloud API Key {% if settings.cloud_api_key %}<span class="badge bg-success ms-2" style="font-size: 0.7em; font-weight: normal;">Saved</span>{% endif %}</label>
                    <div class="d-flex gap-2 align-items-center flex-wrap">
                        <input type="password" class="form-control" name="cloud_api_key" id="cloudApiKey" style="max-width: 400px;"
                               value="" placeholder="{% if settings.cloud_api_key %}••••••••{% else %}Paste your key here (e.g. 8f9a...){% endif %}"
                               {% if settings.cloud_api_key %}data-key-set="1"{% endif %} autocomplete="off">
                        <button type="button" class="btn btn-test-connection" id="cloudTestBtn" onclick="testCloudConnection()">Test connection</button>
                        <span id="cloudTestResult" class="small ms-2" style="display: none;"></span>
                    </div>
                    {% if settings.cloud_api_key %}<input type="hidden" name="cloud_api_key_unchanged" value="1" id="cloudApiKey_unchanged_h">{% endif %}
                    <small class="form-text text-muted">
                        {% if settings.cloud_api_key %}Key is set. Leave blank to keep it, or enter a new key to replace. {% endif %}Get this key from your <a href="https://seekandwatch.com/dashboard.php" target="_blank" class="text-info">Cloud Dashboard</a> under "Local Server Connection".
                    </small>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="movieHandler" class="font-weight-bold text-white">Movies Handler</label>
                            <select name="cloud_movie_handler" id="movieHandler" class="form-control">
                                <option value="direct" {% if settings.cloud_movie_handler == 'direct' %}selected{% endif %}>Radarr</option>
                                <option value="overseerr" {% if settings.cloud_movie_handler == 'overseerr' %}selected{% endif %}>Overseerr / Jellyseerr</option>
                            </select>
                            <small class="form-text text-muted">Where to send approved movies.</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="tvHandler" class="font-weight-bold text-white">TV Shows Handler</label>
                            <select name="cloud_tv_handler" id="tvHandler" class="form-control">
                                <option value="direct" {% if settings.cloud_tv_handler == 'direct' %}selected{% endif %}>Sonarr</option>
                                <option value="overseerr" {% if settings.cloud_tv_handler == 'overseerr' %}selected{% endif %}>Overseerr / Jellyseerr</option>
                            </select>
                            <small class="form-text text-muted">Where to send approved shows.</small>
                        </div>
                    </div>
                </div>

                <hr style="border-color: #444; margin: 24px 0;">

                <h6 class="text-white mb-3">Instant sync webhook (recommended)</h6>
                <p class="text-muted small mb-3">When you approve a request on SeekAndWatch Cloud, it can instantly POST to your local app via webhook instead of waiting for the next poll. This is faster and more reliable.</p>
                
                <p class="text-muted small mb-3"><strong>Setup options:</strong> Cloudflare Tunnel, ngrok, Tailscale, port forwarding, or direct public URL. <a href="https://github.com/softerfish/seekandwatch/wiki/SeekAndWatch-Cloud-Server-Owners-Guide#instant-sync-webhook---recommended" target="_blank" rel="noopener" class="text-info">Full setup guide</a></p>

                <div class="form-group mb-3">
                    <label for="cloudWebhookUrl" class="font-weight-bold text-white">Webhook URL</label>
                    <input type="text" class="form-control" name="cloud_webhook_url" id="cloudWebhookUrl" 
                           value="{{ settings.cloud_webhook_url or '' }}" 
                           placeholder="https://your-domain.com/api/webhook/approved"
                           autocomplete="off">
                    <small class="form-text text-muted">Use your public URL (requires ngrok, Cloudflare Tunnel, or port forwarding). Leave blank to use poll only.</small>
                </div>

                <div class="form-group mb-4">
                    <label for="cloudWebhookSecret" class="font-weight-bold text-white">Webhook Secret {% if settings.cloud_webhook_secret %}<span class="badge bg-success ms-2" style="font-size: 0.7em; font-weight: normal;">Saved</span>{% endif %}</label>
                    <div class="d-flex gap-2 align-items-center flex-wrap">
                        <input type="password" class="form-control" name="cloud_webhook_secret" id="cloudWebhookSecret" style="max-width: 400px;"
                               value="" 
                               placeholder="{% if settings.cloud_webhook_secret %}••••••••{% else %}Generate a random string (e.g. openssl rand -hex 32){% endif %}"
                               {% if settings.cloud_webhook_secret %}data-key-set="1"{% endif %}
                               autocomplete="off">
                        <button type="button" class="btn btn-secondary" id="webhookTestBtn" onclick="testWebhook()" style="padding: 0 20px; height: 42px;">Test webhook</button>
                        <span id="webhookTestResult" class="small ms-2" style="display: none;"></span>
                    </div>
                    {% if settings.cloud_webhook_secret %}<input type="hidden" name="cloud_webhook_secret_unchanged" value="1" id="cloudWebhookSecret_unchanged_h">{% endif %}
                    <small class="form-text text-muted">{% if settings.cloud_webhook_secret %}Secret is set. Leave blank to keep it, or enter a new one to replace. {% endif %}Used to verify webhook requests from the cloud. Keep this private.</small>
                </div>

                <div class="form-group mb-4">
                    <label for="cloudWebhookBackupHours" class="font-weight-bold text-white">Backup poll interval (when webhook is enabled)</label>
                    <select name="cloud_webhook_backup_hours" id="cloudWebhookBackupHours" class="form-control" style="max-width: 200px;">
                        <option value="6" {% if (settings.cloud_webhook_backup_hours or 6) == 6 %}selected{% endif %}>6 hours</option>
                        <option value="12" {% if settings.cloud_webhook_backup_hours == 12 %}selected{% endif %}>12 hours</option>
                        <option value="24" {% if settings.cloud_webhook_backup_hours == 24 %}selected{% endif %}>24 hours</option>
                    </select>
                    <small class="form-text text-muted">When webhook is configured, the app still polls the cloud as a backup (in case webhook fails). This controls how often that backup poll runs.</small>
                </div>

                <hr style="border-color: #444; margin: 24px 0;">

                <h6 class="text-white mb-3">Sync with SeekAndWatch (poll API)</h6>
                <p class="text-muted small mb-2">This app uses the <strong>poll API</strong>: it calls SeekAndWatch for approved requests, adds them to Radarr/Sonarr (or Overseerr), then marks them synced. You can also click <strong>Refresh</strong> on the Requests page to sync immediately. No URL or tunnel needed.</p>
                
                <div class="custom-checkbox-container">
                    <input type="checkbox" name="cloud_sync_owned_enabled" id="syncOwnedCheck" {% if settings.cloud_sync_owned_enabled %}checked{% endif %}>
                    <label for="syncOwnedCheck" class="mb-0 text-white cursor-pointer">Enable cloud sync</label>
                </div>

                <!-- Hidden inputs for legacy/advanced settings -->
                <input type="hidden" name="cloud_poll_interval_min" value="{{ settings.cloud_poll_interval_min or 75 }}">
                <input type="hidden" name="cloud_poll_interval_max" value="{{ settings.cloud_poll_interval_max or 120 }}">

                <!-- Save button is usually at the bottom, but screenshot doesn't show it. Assuming it's needed. -->
                <!-- If the user wants strictly the screenshot layout, maybe the form autosaves or the button is hidden? 
                     But typical settings pages have save buttons. I'll keep it but maybe move it or style it if needed. 
                     The screenshot cuts off after the checkbox. I'll assume the save button is still there below the fold or user didn't capture it.
                     However, to be safe, I'll keep the button. -->
                
                <button type="submit" class="btn btn-save-settings mt-4">
                    Save Settings
                </button>
            </form>
        </div>
    </div>

    <!-- Last 20 imported (cloud webhook/poll) -->
    <div class="card mb-4 requests-settings-card">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0">Last 20 imported</h5>
        </div>
        <div class="card-body bg-dark text-white p-0">
            {% if cloud_import_log is defined and cloud_import_log %}
            <div class="table-responsive">
                <table class="table table-dark table-hover table-sm mb-0">
                    <thead>
                        <tr>
                            <th>Time (UTC)</th>
                            <th>Source</th>
                            <th>Title</th>
                            <th>Type</th>
                            <th>Result</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for e in cloud_import_log %}
                        <tr>
                            <td class="text-nowrap">{{ e.at }}</td>
                            <td><code>{{ e.source }}</code></td>
                            <td>{{ e.title }}</td>
                            <td>{{ e.media_type }}</td>
                            <td>{% if e.success %}<span class="text-success">OK</span>{% else %}<span class="text-danger">Failed</span>{% endif %}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted mb-0 p-3">No imports yet. Entries appear when the app adds items from the cloud (webhook or poll).</p>
            {% endif %}
        </div>
    </div>
</div>
<script>
function testCloudConnection() {
    var btn = document.getElementById('cloudTestBtn');
    var resultEl = document.getElementById('cloudTestResult');
    var keyEl = document.getElementById('cloudApiKey');
    var key = (keyEl && keyEl.value) ? keyEl.value.trim() : '';
    var payload = {};
    if (key) payload.api_key = key;
    var csrf = document.querySelector('input[name="csrf_token"]');
    var headers = { 'Content-Type': 'application/json' };
    if (csrf && csrf.value) headers['X-CSRFToken'] = csrf.value;
    if (btn) { btn.disabled = true; btn.textContent = 'Testing...'; }
    if (resultEl) { resultEl.style.display = 'none'; resultEl.className = 'small ms-2'; }
    fetch('{{ url_for("test_cloud_connection") }}', { method: 'POST', headers: headers, body: JSON.stringify(payload) })
        .then(function(r) { return r.json(); })
        .then(function(d) {
            if (resultEl) {
                resultEl.style.display = 'inline';
                resultEl.textContent = d.message || (d.status === 'success' ? 'OK' : (d.status === 'warning' ? 'Rate limited' : 'Failed'));
                var cls = d.status === 'success' ? 'text-success' : (d.status === 'warning' ? 'text-warning' : 'text-danger');
                resultEl.classList.add(cls);
            }
        })
        .catch(function() {
            if (resultEl) { resultEl.style.display = 'inline'; resultEl.className = 'small ms-2 text-danger'; resultEl.textContent = 'Request failed.'; }
        })
        .finally(function() {
            if (!btn) return;
            var waitSec = 120;
            btn.disabled = true;
            var tick = function() {
                if (waitSec <= 0) {
                    btn.disabled = false;
                    btn.textContent = 'Test connection';
                    return;
                }
                var m = Math.floor(waitSec / 60);
                var s = waitSec % 60;
                btn.textContent = 'Try again in ' + m + ':' + (s < 10 ? '0' : '') + s;
                waitSec--;
                setTimeout(tick, 1000);
            };
            tick();
        });
}

function testWebhook() {
    var btn = document.getElementById('webhookTestBtn');
    var resultEl = document.getElementById('webhookTestResult');
    var csrf = document.querySelector('input[name="csrf_token"]');
    var headers = { 'Content-Type': 'application/json' };
    if (csrf && csrf.value) headers['X-CSRFToken'] = csrf.value;
    if (btn) { btn.disabled = true; btn.textContent = 'Testing...'; }
    if (resultEl) { resultEl.style.display = 'none'; resultEl.className = 'small ms-2'; }
    fetch('{{ url_for("test_webhook_delivery") }}', { method: 'POST', headers: headers })
        .then(function(r) { return r.json(); })
        .then(function(d) {
            if (resultEl) {
                resultEl.style.display = 'inline';
                resultEl.textContent = d.message || (d.status === 'success' ? 'OK' : 'Failed');
                var cls = d.status === 'success' ? 'text-success' : 'text-danger';
                resultEl.classList.add(cls);
            }
        })
        .catch(function() {
            if (resultEl) { resultEl.style.display = 'inline'; resultEl.className = 'small ms-2 text-danger'; resultEl.textContent = 'Request failed.'; }
        })
        .finally(function() {
            if (btn) { btn.disabled = false; btn.textContent = 'Test webhook'; }
        });
}

document.addEventListener('DOMContentLoaded', function() {
    ['cloudApiKey', 'cloudWebhookSecret'].forEach(function(id) {
        var el = document.getElementById(id);
        if (el) el.addEventListener('input', function() {
            var h = document.getElementById(id + '_unchanged_h');
            if (h) h.remove();
        });
    });
});
</script>
{% endblock %}
