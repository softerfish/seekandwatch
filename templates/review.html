{% extends "base.html" %}
{% block content %}
<form id="generateForm" action="{{ url_for('generate') }}" method="POST">
    <input type="hidden" name="media_type" value="{{ media_type }}">
    <input type="hidden" name="critic_filter" value="{{ session.get('critic_filter', '') }}">
    
    <div class="step-header">
        <h2 style="font-weight: 800;">Step 2: Curate & Filter</h2>
        <button type="submit" name="lucky_mode" value="true" class="btn btn-lucky-glow">
            üçÄ I'm Feeling Lucky
        </button>
    </div>

    <div class="card">
        <div class="filter-grid">
            <div class="filter-col">
                <label class="input-label" title="Restricts recommendations to a specific genre">
                    Genre Filter ‚ÑπÔ∏è
                </label>
                <p class="helper-text" style="margin-bottom: 8px;">
                    Restricts the recommendations to a specific genre (e.g., only Sci-Fi).
                </p>
                <select name="genre_filter">
                    <option value="">All Genres (Mixed)</option>
                    {% for g in genres %}<option value="{{ g.id }}">{{ g.name }}</option>{% endfor %}
                </select>
            </div>

            <div class="filter-col">
                <label class="input-label" title="Filters based on TheMovieDB User Score">
                    Min. TMDB Rating: <span id="rating-val" style="color:var(--accent-color);">0</span>/10
                </label>
                <p class="helper-text" style="margin-bottom: 8px;">
                    Exclude content with a TMDB audience score lower than this.
                </p>
                <input type="range" name="min_rating" min="0" max="9" step="0.5" value="0" 
                       style="width:100%; accent-color:var(--accent-color);" 
                       oninput="document.getElementById('rating-val').innerText=this.value">
            </div>
        </div>

        <div style="border-top: 1px solid #333; padding-top: 20px;">
            <label class="input-label">üì° Available on Streaming</label>
            
            <div class="info-box" style="margin-bottom: 15px; font-size: 0.9em; border-left: 4px solid var(--info);">
                <strong>üí° How this works:</strong><br>
                Click icons to find movies available on your specific services (e.g., Netflix).<br>
                <em style="color: #aaa;">If <b>no services</b> are selected, we will search <b>all providers</b> automatically.</em>
            </div>

            {% if providers %}
            <div class="provider-grid">
                {% for p in providers %}
                <div class="provider-check">
                    <input type="checkbox" name="provider_filter" value="{{ p.provider_id }}" id="prov-{{ p.provider_id }}">
                    <label for="prov-{{ p.provider_id }}" title="{{ p.provider_name }}">
                        <img src="https://image.tmdb.org/t/p/original{{ p.logo_path }}">
                    </label>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div style="color:#888;">No streaming providers found for your region. Check Settings > Streaming Regions.</div>
            {% endif %}
        </div>
    </div>

    <p style="color: #888; margin: 25px 0 15px 0;">Select titles to influence recommendations:</p>
    
    <div class="selection-grid">
        {% for movie in movies %}
        <div class="selection-card" onclick="toggleSelection(this)">
            <div class="selection-poster">
                {% if movie.thumb %}
                    <img src="{{ movie.thumb }}">
                {% elif movie.poster_path %}
                    <img src="https://image.tmdb.org/t/p/w300{{ movie.poster_path }}">
                {% else %}
                    <div class="no-poster"><span>üé¨</span><span>No Poster</span></div>
                {% endif %}
                
                <div class="selection-overlay">
                    <input type="checkbox" name="selected_movies" value="{{ movie.title }}" checked class="custom-check">
                </div>

                <button type="button" class="btn-block-floating" onclick="blockItem(event, '{{ movie.title|replace("'", "\\'") }}', '{{ media_type }}', this)" title="Block this title">üö´</button>
            </div>
            <div class="selection-info">
                <div class="selection-title">{{ movie.title }}</div>
                <div style="font-size:0.8em; color:#777;">{{ movie.year }}</div>
            </div>
        </div>
        {% endfor %}
    </div>

    <button type="submit" class="btn btn-save" style="margin-top:40px;">Generate Recommendations üöÄ</button>
</form>

<div id="loadingOverlay">
    <div class="spinner"></div>
    <h2 style="color: white; margin-top: 25px;">Analysing your taste...</h2>
</div>

<script>
function toggleSelection(card) {
    const cb = card.querySelector('input[type="checkbox"]');
    cb.checked = !cb.checked;
    card.style.opacity = cb.checked ? "1" : "0.5";
    card.style.transform = cb.checked ? "scale(1)" : "scale(0.95)";
}
function blockItem(e, title, type, btn) {
    e.stopPropagation();
    if(!confirm(`Permanently block "${title}" from future recommendations?`)) return;
    fetch('/block_movie', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body:JSON.stringify({title:title, media_type:type})
    }).then(r=>{
        if(r.ok) {
            const card = btn.closest('.selection-card');
            card.style.opacity='0'; setTimeout(()=>card.remove(),300);
        }
    });
}
const form = document.getElementById('generateForm');
const overlay = document.getElementById('loadingOverlay');
form.addEventListener('submit', () => overlay.style.display = 'flex');
</script>
{% endblock %}