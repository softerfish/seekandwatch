{% extends "base.html" %}

{% block content %}


<div id="nuclear-loader">
    <div class="nuclear-spinner"></div>
    <h2 style="color: white; font-weight: 800; margin: 0; font-size: 2em;">Running Scan...</h2>
    <p style="color: #ccc; margin-top: 10px; font-size: 1.1em;">Analyzing your library history.</p>
</div>

<div style="text-align: center; padding-top: 20px;">

    <div class="setup-notice" data-notice-key="sync-engine">
        <div class="setup-notice__header">
            <strong>‚ö†Ô∏è Important Setup Requirement</strong>
            <button type="button" class="setup-notice__toggle" aria-expanded="true">Minimize</button>
        </div>
        <div class="setup-notice__body">
            To prevent duplicates and ensure accurate recommendations, you <b>must</b> enable
            <b>Sync Engine</b> & <b>Background Alias Discovery</b> in
            <a href="{{ url_for('settings') }}">Settings</a>
            and allow them to complete a full cycle.
        </div>
    </div>

<div class="section-title" style="margin-top: 30px;">
        <i class="fas fa-fire"></i> Trending on Server
    </div>
    {% if not (settings.tautulli_url and settings.tautulli_api_key) %}
        <div class="tautulli-banner">
            <div>
                <strong style="color: #e74c3c; font-size: 1.1em; display:block; margin-bottom:5px;">üìä Connect Tautulli</strong>
                <span style="color: #ccc; font-size: 0.9em; line-height: 1.4;">
                    Link your Tautulli API in Settings to see what's popular on your server and generate recommendations based on what your friends are watching!
                </span>
            </div>
            <a href="{{ url_for('settings') }}" class="btn-secondary" style="font-size:0.9em; white-space:nowrap; padding: 8px 15px;">Go to Settings ‚Üó</a>
        </div>
    {% else %}
        <div class="card" style="margin-bottom: 40px; max-width: 950px; margin-left: auto; margin-right: auto;">
            <div class="trending-header">
                <div style="display:flex; align-items:center; gap:15px;">
                    <h3 style="margin:0; font-size:1.2em;">Top 5</h3>
                    <div class="trending-tabs">
                        <button class="t-tab active" onclick="loadTrending('movie')" id="tab-movie">Movies</button>
                        <button class="t-tab" onclick="loadTrending('tv')" id="tab-tv">TV Shows</button>
                    </div>
                </div>
                <button class="btn-find-similar" onclick="findSimilarToTrending()" title="Get recommendations based on these items">
                    <span>üîç Find Similar</span>
                </button>
            </div>
            
            <div id="trending-grid" class="trending-grid">
                <div style="grid-column:1/-1; text-align:center; padding:50px; color:#666;">
                    Loading stats from Tautulli...
                </div>
            </div>
        </div>
    {% endif %}

    <div class="card discovery-card">
        <h3 style="margin-top: 0; color: var(--accent-color); text-align: center;">üé¨ Smart Discovery</h3>
        
        <div class="info-box">
            <strong style="color: white; display: block; margin-bottom: 5px;">üí° How it works:</strong>
            <ul style="margin: 0; padding-left: 20px;">
                <li><strong>Scanning:</strong> We analyze your last <b>5000 Plex history entries</b>.</li>
                <li><strong>Curation:</strong> You can set how many unique titles to pull from history.</li>
                <li><strong>Filtering:</strong> Ignored profiles are skipped.</li>
                <li><strong>Variety:</strong> Results change every time because we shuffle your history and randomize the discovery path to keep recommendations fresh.</li>
                <li><strong>üçÄ Lucky Mode:</strong> Instantly picks a random favorite from your history and finds a top-rated match.</li>
            </ul>
        </div>

        <form id="mainScanForm" action="{{ url_for('review_history') }}" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="hidden" id="mediaTypeInput" name="media_type" value="movie">

            <div style="margin-bottom: 20px; text-align: center;">
                <label style="color: #888; font-size: 0.9em;">Number of titles to pull from history:</label>
                <div style="display: flex; align-items: center; justify-content: center; margin-top: 5px;">
                    <input type="number" name="history_limit" value="20" min="1" max="100" class="history-limit-input">
                </div>
                <p style="font-size: 0.8em; color: #e74c3c; margin-top: 8px; margin-bottom: 0;">
                    ‚ö†Ô∏è <b>Tip:</b> Keep this under 30 for fast results. High numbers (50+) will significantly slow down the scan.
                </p>
            </div>

            {% if has_omdb %}
            <div style="margin-bottom: 20px; text-align: center;">
                <label class="critic-label">
                    <input type="checkbox" name="critic_filter" id="critic-filter" onchange="toggleCritic()" style="width: 16px; height: 16px; accent-color: #ff6347;">
                    <span style="color: #ddd;">üçÖ Certified Fresh</span>
                    <input type="number" name="critic_threshold" id="critic-input" value="70" min="0" max="100" 
                           onclick="event.stopPropagation();" class="critic-input">
                    <span id="critic-percent" style="color: #ddd; display: none;">%</span>
                </label>
            </div>
            <script>
            function toggleCritic() {
                const isChecked = document.getElementById('critic-filter').checked;
                document.getElementById('critic-input').style.display = isChecked ? 'inline-block' : 'none';
                document.getElementById('critic-percent').style.display = isChecked ? 'inline' : 'none';
            }
            </script>
            {% endif %}
            <div style="margin-bottom: 20px; text-align: center;">
                <label class="critic-label" style="background: rgba(52, 152, 219, 0.1); border-color: #3498db; color: #3498db;">
                    <input type="checkbox" name="future_mode" value="true" style="width: 16px; height: 16px; accent-color: #3498db;">
                    <span>üöÄ Search Future Releases Only</span>
                </label>
            </div>
            <div style="margin-bottom: 20px; text-align: center;">
                <label class="critic-label" style="background: rgba(155, 89, 182, 0.1); border-color: #9b59b6; color: #9b59b6;">
                    <input type="checkbox" name="include_obscure" value="true" style="width: 16px; height: 16px; accent-color: #9b59b6;">
                    <span>üåç Include International & Obscure</span>
                </label>
            </div>
            {% if plex_libraries %}
            <div style="margin-bottom: 20px; text-align: left; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; border: 1px solid #333;">
                <label style="color: #aaa; font-size: 0.9em; display: block; margin-bottom: 8px; text-align: center;">
                    üö´ Exclude Libraries (Optional)
                </label>
                
                <div class="library-grid" style="max-height: 150px; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));">
                    {% for lib in plex_libraries %}
                    <div class="lib-check-item" style="padding: 6px;">
                        <input type="checkbox" id="dash-lib-{{ loop.index }}" name="ignored_libraries" value="{{ lib }}">
                        <label for="dash-lib-{{ loop.index }}" style="font-size: 0.85em;">{{ lib }}</label>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            <div class="scan-btn-group">
                <a href="javascript:void(0)" class="btn btn-scan movie" onclick="nuclearSubmit('movie')" style="text-align: center; text-decoration: none;">
                    Scan Movies
                </a>
                <a href="javascript:void(0)" class="btn btn-scan tv" onclick="nuclearSubmit('tv')" style="text-align: center; text-decoration: none;">
                    Scan TV Shows
                </a>
            </div>
        </form>

        <form id="luckyForm" action="{{ url_for('generate') }}" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="hidden" name="lucky_mode" value="true">
            <a href="javascript:void(0)" class="btn btn-lucky" onclick="nuclearLucky()" style="text-align: center; text-decoration: none;">
                üçÄ I'm Feeling Lucky
            </a>
        </form>
    </div>

    <div style="margin: 20px 0; color: #555;">‚Äî OR SEARCH BY TITLE ‚Äî</div>
    
    <div style="max-width: 600px; margin: 0 auto; position: relative;">
        <input type="text" id="main-search" placeholder="Type a title (e.g. Inception)..." class="main-search">
        <div id="search-results"></div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Move the loader to <body> so it doesn't get clipped.
        const loader = document.getElementById('nuclear-loader');
        if (loader && document.body) {
            document.body.appendChild(loader);
        }
    });

    function nuclearSubmit(type) {
        document.getElementById('nuclear-loader').style.display = 'flex';
        const input = document.getElementById('mediaTypeInput');
        if (input) input.value = type;
        setTimeout(function() {
            document.getElementById('mainScanForm').submit();
        }, 50);
    }

    function nuclearLucky() {
        document.getElementById('nuclear-loader').style.display = 'flex';
        setTimeout(function() {
            document.getElementById('luckyForm').submit();
        }, 50);
    }

    // Search wiring.
    const searchInput = document.getElementById('main-search');
    const resultsDiv = document.getElementById('search-results');
    let debounceTimer;

    searchInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        const query = this.value.trim();
        if (query.length < 2) { resultsDiv.style.display = 'none'; return; }
        debounceTimer = setTimeout(() => {
            fetch(`/tmdb_search_proxy?query=${encodeURIComponent(query)}&type=movie`)
                .then(res => res.json())
                .then(data => {
                    if (data.results && data.results.length > 0) {
                        let html = '';
                        data.results.forEach(item => {
                            const safeTitle = item.title.replace(/'/g, "\\'");
                            html += `<div class="search-result-item" onclick="selectItem('${safeTitle}')">
                                <img src="https://image.tmdb.org/t/p/w92${item.poster}" style="width: 40px; border-radius: 4px;" onerror="this.style.display='none'">
                                <div><div style="font-weight: bold; color: var(--text-color);">${escapeHtml(item.title)}</div><div style="font-size: 0.8em; color: #888;">${item.year}</div></div></div>`;
                        });
                        resultsDiv.innerHTML = html; resultsDiv.style.display = 'block';
                    } else { resultsDiv.style.display = 'none'; }
                });
        }, 300);
    });

    function selectItem(title) {
        document.getElementById('nuclear-loader').style.display = 'flex';
        
        const form = document.createElement('form'); 
        form.method = 'POST'; 
        form.action = "{{ url_for('review_history') }}";
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrf_token';
        csrfInput.value = "{{ csrf_token() }}";
        form.appendChild(csrfInput);
        
        const input = document.createElement('input'); 
        input.type = 'hidden'; input.name = 'manual_query'; input.value = title;
        
        const typeInput = document.createElement('input'); 
        typeInput.type = 'hidden'; typeInput.name = 'media_type'; typeInput.value = 'movie';
        
        form.appendChild(input); 
        form.appendChild(typeInput); 
        document.body.appendChild(form); 
        
        setTimeout(() => form.submit(), 50);
    }
    
    document.addEventListener('click', function(e) { 
        if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) { 
            resultsDiv.style.display = 'none'; 
        } 
    });

let currentTrendingType = 'movie';

    function loadTrending(type) {
        currentTrendingType = type;
        
        // Update the tab UI.
        const tabs = document.querySelectorAll('.t-tab');
        if(tabs.length > 0) {
            tabs.forEach(b => b.classList.remove('active'));
            const activeTab = document.getElementById('tab-' + type);
            if(activeTab) activeTab.classList.add('active');
        }
        
        // If the widget isn't present, bail (API not configured).
        const grid = document.getElementById('trending-grid');
        if(!grid) return; 

        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:50px; color:#666;">Loading Tautulli stats...</div>';
        
        fetch('/get_local_trending?type=' + type)
        .then(r => r.json())
        .then(data => {
            if(data.status === 'success' && data.items.length > 0) {
                let html = '';
                data.items.forEach((item, idx) => {
                    const poster = item.poster_path ? 'https://image.tmdb.org/t/p/w200' + item.poster_path : 'https://via.placeholder.com/200x300?text=No+Poster';
                    html += `
                    <div class="t-card" title="${item.title}" onclick="selectItem('${item.title.replace(/'/g, "\\'")}')">
                        <div class="t-rank">#${idx + 1}</div>
                        <img src="${poster}" class="t-poster">
                        <div class="t-info">${item.title}</div>
                    </div>`;
                });
                grid.innerHTML = html;
            } else {
                grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:50px; color:#777;">No trending data found.</div>';
            }
        })
        .catch(err => { console.error(err); grid.innerHTML = 'Error loading stats.'; });
    }

    function findSimilarToTrending() {
        window.location.href = '/recommend_from_trending?type=' + currentTrendingType;
    }

    // Only initialize if the grid exists.
    document.addEventListener('DOMContentLoaded', () => {
        if(document.getElementById('trending-grid')) {
            loadTrending('movie');
        }
    });
</script>
{% endblock %}