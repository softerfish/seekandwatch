{% extends "base.html" %}
{% block content %}

<style>
    /* Info Icon & Tooltip CSS */
    .tooltip-container { position: relative; display: inline-block; cursor: help; margin-left: 5px; }
    .info-icon { font-size: 0.9em; opacity: 0.7; }
    .tooltip-text {
        visibility: hidden; width: 200px; background-color: #222; color: #fff; text-align: left;
        border-radius: 6px; padding: 10px; position: absolute; z-index: 100;
        bottom: 125%; left: 50%; margin-left: -100px; opacity: 0; transition: opacity 0.3s;
        font-size: 0.8em; box-shadow: 0 4px 15px rgba(0,0,0,0.8); border: 1px solid #444;
        line-height: 1.4;
    }
    .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }
    
    /* Control Row Styling */
    .control-row {
        display: flex; justify-content: space-between; align-items: center; 
        margin-bottom: 8px; font-size: 0.85em; color: #ccc;
    }
    .control-select {
        background: #333; border: 1px solid #555; color: white; 
        padding: 4px; border-radius: 4px; font-size: 0.9em; width: 110px;
    }
    .control-select:disabled {
        background: #222; color: #777; border-color: #333; cursor: not-allowed;
    }
    .locked-badge {
        font-size: 0.85em; color: var(--accent-color); font-weight: bold; display: flex; align-items: center; gap: 4px;
    }
</style>

<div class="playlist-header">
    <h2>âœ¨ Plex Collections</h2>
    <p class="media-sub">Curated lists, imported text, and custom builders.</p>

    <div style="max-width: 800px; margin: 0 auto 20px auto; background: rgba(243, 156, 18, 0.1); border-left: 4px solid #f39c12; padding: 15px; text-align: left; border-radius: 4px;">
        <strong style="color: #f39c12; display: block; margin-bottom: 5px;">âš ï¸ Important Setup Requirement:</strong> 
        <span style="color: #ccc; font-size: 0.95em; line-height: 1.5; display: block;">
            To ensure accurate collections and remove duplicates, you <b>must</b> enable 
            <b>Sync Engine</b> & <b>Background Alias Discovery</b> in 
            <a href="{{ url_for('settings') }}" style="text-decoration: underline; color: white; font-weight: bold;">Settings</a> 
            and allow them to complete a full cycle.
        </span>
    </div>

    <div class="stats-bar">
        <span title="Your custom created lists">ğŸ› ï¸ <b>{{ custom_presets|length }}</b> Custom</span>
        <span class="stats-label">|</span>
        <span title="Available built-in presets">ğŸ“š <b>{{ presets|length }}</b> Presets</span>
    </div>

    <div class="action-bar">
        <a href="{{ url_for('builder') }}">
            <button class="btn-builder" id="btn-builder-nav">ğŸ› ï¸ Custom Builder</button>
        </a>
        <button onclick="openImportModal()" class="btn-import" id="btn-import-open">ğŸ“‹ Import List</button>
    </div>

    <div class="type-toggle-group">
        <button onclick="filterType('movie')" id="btn-movie" class="type-toggle-btn active">Movies ğŸ¬</button>
        <button onclick="filterType('tv')" id="btn-tv" class="type-toggle-btn">TV Shows ğŸ“º</button>
    </div>
</div>

<div id="preview-modal" class="import-modal">
    <div class="import-content wide">
        <span onclick="document.getElementById('preview-modal').style.display='none'" class="close-btn">&times;</span>
        <h2 id="preview-title" style="margin-top:0;">ğŸ‘€ Collection Preview</h2>
        <div id="preview-grid" class="preview-grid"></div>
    </div>
</div>

<div id="import-modal" class="import-modal">
    <div class="import-content">
        <span onclick="closeImportModal()" class="close-btn">&times;</span>
        <h2 style="margin-top:0;">ğŸ“‹ Import from List</h2>
        
        <details class="help-box">
            <summary>â“ How does this work?</summary>
            <ol>
                <li><b>Copy & Paste:</b> Grab a list from Letterboxd, IMDb, or Reddit. We handle newlines, commas, or pipes `|`.</li>
                <li><b>Smart Matching:</b> "The Matrix (1999)" and "The Matrix" both work.</li>
                <li><b>One-Time Import:</b> These collections are static and cannot be auto-updated.</li>
            </ol>
        </details>
        
        <textarea id="import-text" rows="10" placeholder="The Matrix&#10;Inception, Interstellar&#10;The Dark Knight (2008)" class="import-textarea"></textarea>
        
        <div class="import-input-row">
            <input type="text" id="import-title" placeholder="Collection Name">
            <select id="import-library" class="import-select">
                <option value="" disabled selected>Loading Libraries...</option>
            </select>
        </div>
        
        <button onclick="analyzeList()" id="analyze-btn" class="btn-analyze">ğŸ” Analyze & Match</button>
        
        <div id="import-results" class="import-results-container"></div>
        
        <button onclick="createImportedCollection()" id="create-import-btn" class="btn-create-import">âœ… Create Collection</button>
    </div>
</div>

<div class="card p-3 mb-4">
    <h5>Global Schedule Time</h5>
    <p class="text-muted small">All "Daily" collections will run automatically after this time.</p>
    <div class="d-flex gap-2" style="max-width: 300px;">
        <input type="time" id="globalTime" class="form-control" value="{{ schedule_time }}">
        <button class="btn btn-primary" onclick="saveGlobalTime()">Save</button>
    </div>
</div>

<script>
function saveGlobalTime() {
    let t = document.getElementById('globalTime').value;
    fetch('/save_schedule_time', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': '{{ csrf_token() }}'},
        body: 'time=' + t
    })
    .then(r => r.json())
    .then(data => {
        if(data.status === 'success') alert('Time Saved!');
        else alert(data.message);
    });
}
</script>

{% if custom_presets %}
<div class="category-header playlist-section" data-type="any">
    <span>ğŸ› ï¸</span> Your Custom Collections
</div>
<div class="playlist-grid">
    {% for key, playlist in custom_presets.items() %}
    <div class="card playlist-card" data-type="{{ playlist.media_type }}">
        <div>
            <div class="playlist-header-row">
                <div class="playlist-icon">{% if 'Imported' in playlist.description %}ğŸ“‹{% else %}ğŸ› ï¸{% endif %}</div>
                <button onclick="deleteCustom('{{ key }}')" class="btn-delete">Delete ğŸ—‘ï¸</button>
            </div>
            <h3 class="playlist-title">{{ playlist.title }}</h3>
            <p class="playlist-desc">{{ playlist.description }}</p>
        </div>
        
        <div class="playlist-controls">
            {% if 'Imported' not in playlist.description %}
            
            <div class="control-row">
                <label>Auto-Update:</label>
                <select id="freq-{{ key }}" onchange="saveSettings('{{ key }}')" class="control-select">
                    <option value="manual" {% if schedules.get(key) == 'manual' %}selected{% endif %}>Off</option>
                    <option value="daily" {% if schedules.get(key) == 'daily' %}selected{% endif %}>Daily</option>
                    <option value="weekly" {% if schedules.get(key) == 'weekly' %}selected{% endif %}>Weekly</option>
                </select>
            </div>

            <div class="control-row">
                <label style="display:flex; align-items:center;">
                    Sync Mode:
                    <div class="tooltip-container">
                        <span class="info-icon">â„¹ï¸</span>
                        <div class="tooltip-text">
                            <strong>Sync (Strict):</strong> Adds new items AND removes old ones.<br><br>
                            <strong>Append:</strong> Only adds new items. Never removes. Best for growing lists.
                        </div>
                    </div>
                </label>
                {% set saved_mode = playlist.get('sync_mode', 'append') %}
                <select id="sync-{{ key }}" onchange="saveSettings('{{ key }}')" class="control-select">
                    <option value="append" {% if saved_mode == 'append' %}selected{% endif %}>Append (Grow)</option>
                    <option value="sync" {% if saved_mode == 'sync' %}selected{% endif %}>Sync (Strict)</option>
                </select>
            </div>

            <div class="sync-row" style="margin-top: 10px;">
                <button onclick="previewCollection('{{ key }}', '{{ playlist.title|replace("'", "\\'") }}')" class="btn-preview" title="Preview Contents">ğŸ‘€</button>
                <button onclick="createCollection('{{ key }}')" id="btn-{{ key }}" class="btn-sync">Sync Now ğŸª„</button>
            </div>
            
            {% else %}
            <div class="static-badge">Static Import</div>
            <button disabled class="btn-synced-disabled">Synced âœ…</button>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

{% set categories = ['Regional Trending', 'International & World', 'Decades', 'Themes & Vibes', 'Awards & Acclaim', 'Studios & Networks', 'Genre (Movies)', 'Genre (TV)', 'Content Ratings'] %}

{% for cat in categories %}
<div class="category-header playlist-section" data-cat="{{ cat }}">
    <span>ğŸ“‚</span> {{ cat }}
</div>
<div class="playlist-grid">
    {% for key, playlist in presets.items() %}
    {% if playlist.category == cat %}
    <div class="card playlist-card" data-type="{{ playlist.media_type }}">
        <div>
            <div class="playlist-icon">{{ playlist.icon }}</div>
            <h3 class="playlist-title">{{ playlist.title }}</h3>
            <p class="playlist-desc">{{ playlist.description }}</p>
        </div>
        
        <div class="playlist-controls">
            <div class="control-row">
                <label>Auto-Update:</label>
                <select id="freq-{{ key }}" onchange="saveSettings('{{ key }}')" class="control-select">
                    <option value="manual" {% if schedules.get(key) == 'manual' %}selected{% endif %}>Off</option>
                    <option value="daily" {% if schedules.get(key) == 'daily' %}selected{% endif %}>Daily</option>
                    <option value="weekly" {% if schedules.get(key) == 'weekly' %}selected{% endif %}>Weekly</option>
                </select>
            </div>

            <div class="control-row">
                <label style="display:flex; align-items:center;">
                    Sync Mode:
                    {% if 'Trending' not in playlist.title %}
                    <div class="tooltip-container">
                        <span class="info-icon">â„¹ï¸</span>
                        <div class="tooltip-text">
                            <strong>Sync (Strict):</strong> Adds new items AND removes items not on the list.<br><br>
                            <strong>Append:</strong> Only adds. Never removes.
                        </div>
                    </div>
                    {% endif %}
                </label>

                {% if 'Trending' in playlist.title or 'Trending' in playlist.category %}
                    <div class="locked-badge">
                        ğŸ”’ Strict Sync
                        <input type="hidden" id="sync-{{ key }}" value="sync">
                    </div>
                {% else %}
                    {% set saved_mode = playlist.get('sync_mode', 'append') %}
                    <select id="sync-{{ key }}" onchange="saveSettings('{{ key }}')" class="control-select">
                        <option value="append" {% if saved_mode == 'append' %}selected{% endif %}>Append (Grow)</option>
                        <option value="sync" {% if saved_mode == 'sync' %}selected{% endif %}>Sync (Strict)</option>
                    </select>
                {% endif %}
            </div>

            <div class="sync-row" style="margin-top: 10px;">
                <button onclick="previewCollection('{{ key }}', '{{ playlist.title|replace("'", "\\'") }}')" class="btn-preview" title="Preview Contents">ğŸ‘€</button>
                <button onclick="createCollection('{{ key }}')" id="btn-{{ key }}" class="btn-sync">Run Now ğŸª„</button>
            </div>
        </div>
    </div>
    {% endif %}
    {% endfor %}
</div>
{% endfor %}

<script>
// --- POLLING FOR LOCKOUT ---
setInterval(checkCacheStatus, 2000); 

function checkCacheStatus() {
    fetch('/get_cache_status').then(r => r.json()).then(data => {
        const btns = document.querySelectorAll('.btn-sync');
        const importBtn = document.getElementById('btn-import-open');
        const builderBtn = document.getElementById('btn-builder-nav');
        
        if(data.running) {
            btns.forEach(b => {
                b.disabled = true; b.innerText = "System Busy â³"; 
                b.style.opacity = "0.5"; b.style.cursor = "not-allowed";
            });
            if(importBtn) { importBtn.disabled = true; importBtn.style.opacity = "0.5"; }
            if(builderBtn) { builderBtn.disabled = true; builderBtn.style.opacity = "0.5"; }
        } else {
            btns.forEach(b => {
                if(b.disabled && b.innerText.includes("System Busy")) {
                    b.innerText = "Run Now ğŸª„"; // Default text, might need logic to restore 'Sync Now' for custom
                    if(b.id.startsWith("btn-custom")) b.innerText = "Sync Now ğŸª„"; // Rough guess
                    b.disabled = false; b.innerText = "Run Now ğŸª„"; 
                    b.style.opacity = "1"; b.style.cursor = "pointer";
                }
            });
            if(importBtn) { importBtn.disabled = false; importBtn.style.opacity = "1"; }
            if(builderBtn) { builderBtn.disabled = false; builderBtn.style.opacity = "1"; }
        }
    });
}

// Filter Logic
function filterType(type) {
    document.getElementById('btn-movie').classList.remove('active');
    document.getElementById('btn-tv').classList.remove('active');
    document.getElementById('btn-' + type).classList.add('active');
    const cards = document.querySelectorAll('.playlist-card');
    cards.forEach(card => {
        card.style.display = (card.dataset.type === type) ? 'flex' : 'none';
    });
    const grids = document.querySelectorAll('.playlist-grid');
    grids.forEach(grid => {
        let hasVisible = false;
        const children = grid.querySelectorAll('.playlist-card');
        children.forEach(c => { if(c.style.display !== 'none') hasVisible = true; });
        const header = grid.previousElementSibling;
        if(header && header.classList.contains('category-header')) {
            header.style.display = hasVisible ? 'flex' : 'none';
            grid.style.display = hasVisible ? 'grid' : 'none';
        }
    });
}
document.addEventListener('DOMContentLoaded', () => { filterType('movie'); });

// PREVIEW LOGIC
function previewCollection(key, title) {
    document.getElementById('preview-title').innerText = "ğŸ‘€ " + title;
    const grid = document.getElementById('preview-grid');
    grid.innerHTML = '<div style="text-align:center; grid-column:1/-1; padding:20px; color:#aaa;">Loading live data from TMDB...</div>';
    document.getElementById('preview-modal').style.display = 'block';
    
    fetch('/preview_preset_items/' + key)
    .then(r => r.json())
    .then(data => {
        if(data.status === 'success') {
            let html = '';
            data.items.forEach(item => {
                const opacity = item.owned ? '1' : '0.6';
                const status = item.owned ? 'âœ… Owned' : 'missing';
                const poster = item.poster_path ? 'https://image.tmdb.org/t/p/w200' + item.poster_path : 'https://via.placeholder.com/200x300?text=No+Poster';
                html += `<div class="preview-item" style="opacity: ${opacity};">
                    <img src="${poster}" class="preview-poster">
                    <div class="preview-title">${item.title}</div>
                    <div class="preview-meta">${item.year} â€¢ ${status}</div>
                </div>`;
            });
            grid.innerHTML = html;
        } else {
            grid.innerHTML = `<div style="color:var(--error); grid-column:1/-1; text-align:center;">Error: ${data.message}</div>`;
        }
    });
}

// DELETE CUSTOM
function deleteCustom(key) {
    if (!confirm("Delete from SeekAndWatch AND Plex?")) return;
    fetch('/delete_custom_collection/' + key, {method: 'POST'})
    .then(res => res.json()).then(data => { location.reload(); });
}

// SYNC STANDARD
function createCollection(key) {
    const btn = document.getElementById('btn-' + key);
    const originalText = btn.innerText;
    btn.disabled = true; btn.innerText = "Processing... â³"; btn.style.background = "#555";
    fetch('/create_collection/' + key, {method: 'POST'})
    .then(r => r.json()).then(d => {
        if (d.status === 'success') { btn.innerText = "Done! âœ…"; btn.style.background = "#2ecc71"; alert(d.message); }
        else { btn.innerText = "Error âŒ"; btn.style.background = "#e74c3c"; alert(d.message); }
        setTimeout(() => { btn.innerText = originalText; btn.disabled = false; btn.style.background = "#333"; }, 3000);
    });
}

// --- NEW: SAVE SETTINGS (Handles Frequency AND Sync Mode) ---
function saveSettings(key) {
    const freqEl = document.getElementById('freq-' + key);
    const syncEl = document.getElementById('sync-' + key);
    
    const freq = freqEl ? freqEl.value : 'manual';
    // If sync element is hidden (Trending locked), default to 'sync'
    const sync = syncEl ? syncEl.value : 'sync';

    fetch('/schedule_collection', { // Note: ensure route is /schedule_collection in app.py
        method: 'POST', headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: `preset_key=${key}&frequency=${freq}&sync_mode=${sync}`
    });
}

// --- IMPORT MODAL LOGIC ---
let matchedKeys = [];
function openImportModal() { document.getElementById('import-modal').style.display = 'block'; document.body.style.overflow = 'hidden'; fetchLibraries(); }
function closeImportModal() { document.getElementById('import-modal').style.display = 'none'; document.body.style.overflow = 'auto'; }

function fetchLibraries() {
    fetch('/get_plex_libraries').then(r => r.json()).then(data => {
        const select = document.getElementById('import-library');
        if(data.status === 'success') {
            let html = '';
            data.libraries.forEach(lib => {
                const icon = lib.type === 'movie' ? 'ğŸ¬' : 'ğŸ“º';
                html += `<option value="${lib.title}">${icon} ${lib.title}</option>`;
            });
            select.innerHTML = html;
        } else { select.innerHTML = '<option disabled>Error fetching libraries</option>'; }
    });
}

function analyzeList() {
    const text = document.getElementById('import-text').value;
    const library = document.getElementById('import-library').value;
    const btn = document.getElementById('analyze-btn');
    if(!text.trim()) { alert("Paste some titles first!"); return; }
    if(!library) { alert("Select a library!"); return; }
    
    btn.innerText = "Analyzing... â³"; btn.disabled = true;
    
    fetch('/match_bulk_titles', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({titles: text, target_library: library})
    }).then(res => res.json()).then(data => {
        btn.innerText = "ğŸ” Analyze & Match"; btn.disabled = false;
        if(data.status === 'success') {
            const resDiv = document.getElementById('import-results');
            resDiv.style.display = 'block';
            let html = '<table class="result-table">';
            matchedKeys = [];
            data.results.forEach(r => {
                const statusClass = r.found ? 'status-found' : 'status-missing';
                const statusText = r.found ? 'âœ… Found' : 'âŒ Missing';
                if(r.found) matchedKeys.push(r.key);
                html += `<tr class="result-row"><td class="result-cell query">${r.query}</td><td class="result-cell">${r.title}</td><td class="result-cell ${statusClass}">${statusText}</td></tr>`;
            });
            html += '</table>';
            resDiv.innerHTML = html;
            if(matchedKeys.length > 0) {
                document.getElementById('create-import-btn').style.display = 'block';
                document.getElementById('create-import-btn').innerText = `âœ… Create Collection (${matchedKeys.length} items)`;
            }
        }
    });
}

function createImportedCollection() {
    const title = document.getElementById('import-title').value;
    const library = document.getElementById('import-library').value;
    if(!title) { alert("Please name your collection!"); return; }
    
    fetch('/create_bulk_collection', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({collection_title: title, rating_keys: matchedKeys, target_library: library})
    }).then(res => res.json()).then(data => {
        if(data.status === 'success') { alert(data.message); closeImportModal(); location.reload(); } 
        else { alert(data.message); }
    });
}
</script>
{% endblock %}