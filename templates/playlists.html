{% extends "base.html" %}
{% block content %}

<div class="playlist-header">
    <h2>âœ¨ Plex Collections</h2>
    <p class="media-sub">Curated lists, imported text, and custom builders.</p>

    <div class="card" style="border-left: 4px solid var(--info); text-align: left; margin-bottom: 20px;">
        <h3 style="margin-top: 0; display:flex; align-items:center; gap:10px;">
            âš™ï¸ Sync Engine Settings
        </h3>
        
        <div style="color: #ccc; font-size: 0.9em; line-height: 1.6; margin-bottom: 20px;">
            <p style="margin-top: 0;">
                <b>How it works:</b> To make collection creation <i>instant</i> and prevent crashing your Plex server, 
                SeekAndWatch downloads a lightweight index of your library to a local file (Cache).
                When you click "Sync Now", we read this local file instead of querying Plex 1,000 times.
            </p>

            <div style="background: rgba(255, 255, 255, 0.05); padding: 10px; border-radius: 5px; border-left: 3px solid #f39c12;">
                <strong>âš ï¸ Important Notes:</strong>
                <ul style="margin: 5px 0 0 0; padding-left: 20px;">
                    <li style="margin-bottom: 5px;">
                        <b>New Media:</b> If you just added a movie to Plex, it won't appear in collections until the cache updates. Click <b>"Force Refresh Now"</b> to include it immediately.
                    </li>
                    <li>
                        <b>Large Libraries:</b> If you have 5000+ items, the cache refresh may take <b>1-5 minutes</b>.
                    </li>
                </ul>
            </div>
        </div>

        <div style="display: flex; gap: 20px; align-items: flex-end; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
                <label style="font-weight: bold; display: block; margin-bottom: 8px;">ğŸ”„ Auto-Refresh Cache</label>
                <div style="display: flex; gap: 10px;">
                    <select id="cache-interval" style="padding: 10px; border-radius: 5px; background: #111; color: white; border: 1px solid #444; flex: 1;">
                        <option value="12" {% if settings.cache_interval == 12 %}selected{% endif %}>Every 12 Hours (Fastest)</option>
                        <option value="24" {% if not settings.cache_interval or settings.cache_interval == 24 %}selected{% endif %}>Every 24 Hours (Standard)</option>
                        <option value="48" {% if settings.cache_interval == 48 %}selected{% endif %}>Every 48 Hours</option>
                        <option value="168" {% if settings.cache_interval == 168 %}selected{% endif %}>Weekly (Low CPU)</option>
                    </select>
                    <button onclick="saveCacheSetting()" class="btn-preview" style="background: var(--accent-color); color: black; font-weight: bold;">Save</button>
                </div>
            </div>

            <div style="flex: 1; min-width: 200px; text-align: right;">
                <div style="font-size: 0.85em; color: #888; margin-bottom: 15px;">
                    Last Refreshed: <span id="last-updated" style="color: var(--text-color); font-weight: bold;">{{ cache_age }}</span>
                </div>
                <button onclick="forceRefresh()" id="btn-force" class="btn-secondary" style="font-size: 0.9em; padding: 10px 15px;">
                    ğŸ”„ Force Refresh Now
                </button>
            </div>
        </div>
    </div>

    <div class="card mb-4 shadow-sm" style="border: 1px solid #444; background: #222; text-align: left; margin-bottom: 30px;">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center" style="padding: 10px 15px; border-bottom: 1px solid #444; display: flex; justify-content: space-between;">
            <h4 class="mb-0" style="font-size: 1em; display:flex; align-items:center; margin: 0;">
                <span style="font-size:1.2em; margin-right:8px;">ğŸŒ</span> Community Alias Database
            </h4>
            <span class="badge bg-primary rounded-pill" id="aliasCountBadge" style="background:#007bff; color:white; padding:4px 10px; border-radius:15px; font-size:0.8em;">
                {{ alias_count }} Entries
            </span>
        </div>
        <div class="card-body" style="padding: 15px;">
            <div class="row align-items-center" style="display: flex; gap: 20px;">
                <div class="col-md-8" style="flex: 1;">
                    <p class="card-text text-muted mb-2" style="color:#aaa; font-size:0.9em; margin-top:0;">
                        <strong>What is this?</strong> A community-curated list of alternative titles to help SeekAndWatch match your requests correctly (e.g., matching "Zootropolis" to "Zootopia").
                    </p>
                    <p class="card-text text-muted mb-3" style="color:#777; font-size:0.85em; margin-bottom: 0;">
                        <small>
                            <i class="fas fa-lock me-1"></i>
                            <strong>Privacy Note:</strong> This is a 100% one-way download. 
                            No data about your library is sent to SeekAndWatch.
                        </small>
                    </p>
                </div>
                <div class="col-md-4 text-end" style="text-align:right;">
                    <button type="button" id="forceSyncBtn" class="btn btn-outline-primary" onclick="syncAliases()" style="background:transparent; border:1px solid #007bff; color:#007bff; padding:5px 15px; cursor:pointer; border-radius:4px;">
                        Force Sync Now
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="stats-bar">
        <span title="Your custom created lists">ğŸ› ï¸ <b>{{ custom_presets|length }}</b> Custom</span>
        <span class="stats-label">|</span>
        <span title="Available built-in presets">ğŸ“š <b>{{ presets|length }}</b> Presets</span>
    </div>

    <div class="action-bar">
        <a href="{{ url_for('builder') }}">
            <button class="btn-builder" id="btn-builder-nav">ğŸ› ï¸ Custom Builder</button>
        </a>
        <button onclick="openImportModal()" class="btn-import" id="btn-import-open">ğŸ“‹ Import List</button>
    </div>

    <div class="type-toggle-group">
        <button onclick="filterType('movie')" id="btn-movie" class="type-toggle-btn active">Movies ğŸ¬</button>
        <button onclick="filterType('tv')" id="btn-tv" class="type-toggle-btn">TV Shows ğŸ“º</button>
    </div>
</div>

<div id="preview-modal" class="import-modal">
    <div class="import-content wide">
        <span onclick="document.getElementById('preview-modal').style.display='none'" class="close-btn">&times;</span>
        <h2 id="preview-title" style="margin-top:0;">ğŸ‘€ Collection Preview</h2>
        <div id="preview-grid" class="preview-grid">
            </div>
    </div>
</div>

<div id="import-modal" class="import-modal">
    <div class="import-content">
        <span onclick="closeImportModal()" class="close-btn">&times;</span>
        <h2 style="margin-top:0;">ğŸ“‹ Import from List</h2>
        
        <details class="help-box">
            <summary>â“ How does this work?</summary>
            <ol>
                <li><b>Copy & Paste:</b> Grab a list from Letterboxd, IMDb, or Reddit. We handle newlines, commas, or pipes `|`.</li>
                <li><b>Smart Matching:</b> "The Matrix (1999)" and "The Matrix" both work.</li>
                <li><b>One-Time Import:</b> These collections are static and cannot be auto-updated.</li>
            </ol>
        </details>
        
        <textarea id="import-text" rows="10" placeholder="The Matrix&#10;Inception, Interstellar&#10;The Dark Knight (2008)" class="import-textarea"></textarea>
        
        <div class="import-input-row">
            <input type="text" id="import-title" placeholder="Collection Name">
            <select id="import-library" class="import-select">
                <option value="" disabled selected>Loading Libraries...</option>
            </select>
        </div>
        
        <button onclick="analyzeList()" id="analyze-btn" class="btn-analyze">ğŸ” Analyze & Match</button>
        
        <div id="import-results" class="import-results-container"></div>
        
        <button onclick="createImportedCollection()" id="create-import-btn" class="btn-create-import">âœ… Create Collection</button>
    </div>
</div>

{% if custom_presets %}
<div class="category-header playlist-section" data-type="any">
    <span>ğŸ› ï¸</span> Your Custom Collections
</div>
<div class="playlist-grid">
    {% for key, playlist in custom_presets.items() %}
    <div class="card playlist-card" data-type="{{ playlist.media_type }}">
        <div>
            <div class="playlist-header-row">
                <div class="playlist-icon">{% if 'Imported' in playlist.description %}ğŸ“‹{% else %}ğŸ› ï¸{% endif %}</div>
                <button onclick="deleteCustom('{{ key }}')" class="btn-delete">Delete ğŸ—‘ï¸</button>
            </div>
            <h3 class="playlist-title">{{ playlist.title }}</h3>
            <p class="playlist-desc">{{ playlist.description }}</p>
        </div>
        <div class="playlist-controls">
            {% if 'Imported' not in playlist.description %}
            <div class="schedule-row">
                <label style="font-size: 0.8em; color: #aaa;">Auto-Update:</label>
                <select onchange="saveSchedule('{{ key }}', this.value)" class="schedule-select">
                    <option value="manual" {% if schedules.get(key) == 'manual' %}selected{% endif %}>Off</option>
                    <option value="daily" {% if schedules.get(key) == 'daily' %}selected{% endif %}>Daily</option>
                    <option value="weekly" {% if schedules.get(key) == 'weekly' %}selected{% endif %}>Weekly</option>
                </select>
            </div>
            <div class="sync-row">
                <button onclick="previewCollection('{{ key }}', '{{ playlist.title|replace("'", "\\'") }}')" class="btn-preview" title="Preview Contents">ğŸ‘€</button>
                <button onclick="createCollection('{{ key }}')" id="btn-{{ key }}" class="btn-sync">Sync Now ğŸª„</button>
            </div>
            {% else %}
            <div class="static-badge">Static Import</div>
            <button disabled class="btn-synced-disabled">Synced âœ…</button>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

{% set categories = ['Regional Trending', 'International & World', 'Decades', 'Themes & Vibes', 'Franchises', 'Awards & Acclaim', 'Studios & Networks', 'Genre (Movies)', 'Genre (TV)', 'Content Ratings'] %}

{% for cat in categories %}
<div class="category-header playlist-section" data-cat="{{ cat }}">
    <span>ğŸ“‚</span> {{ cat }}
</div>
<div class="playlist-grid">
    {% for key, playlist in presets.items() %}
    {% if playlist.category == cat %}
    <div class="card playlist-card" data-type="{{ playlist.media_type }}">
        <div>
            <div class="playlist-icon">{{ playlist.icon }}</div>
            <h3 class="playlist-title">{{ playlist.title }}</h3>
            <p class="playlist-desc">{{ playlist.description }}</p>
        </div>
        <div class="playlist-controls">
            <div class="schedule-row">
                <label style="font-size: 0.8em; color: #aaa;">Auto-Update:</label>
                <select onchange="saveSchedule('{{ key }}', this.value)" class="schedule-select">
                    <option value="manual" {% if schedules.get(key) == 'manual' %}selected{% endif %}>Off</option>
                    <option value="daily" {% if schedules.get(key) == 'daily' %}selected{% endif %}>Daily</option>
                    <option value="weekly" {% if schedules.get(key) == 'weekly' %}selected{% endif %}>Weekly</option>
                </select>
            </div>
            <div class="sync-row">
                <button onclick="previewCollection('{{ key }}', '{{ playlist.title|replace("'", "\\'") }}')" class="btn-preview" title="Preview Contents">ğŸ‘€</button>
                <button onclick="createCollection('{{ key }}')" id="btn-{{ key }}" class="btn-sync">Run Now ğŸª„</button>
            </div>
        </div>
    </div>
    {% endif %}
    {% endfor %}
</div>
{% endfor %}

<script>
// --- CACHE MANAGEMENT ---
function saveCacheSetting() {
    const val = document.getElementById('cache-interval').value;
    fetch('/save_cache_settings', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({interval: val})
    }).then(r => r.json()).then(d => alert(d.message));
}

function forceRefresh() {
    const btn = document.getElementById('btn-force');
    btn.disabled = true; 
    btn.innerText = "Refreshing... â³";
    
    fetch('/force_cache_refresh', {method: 'POST'})
    .then(r => r.json())
    .then(data => {
        if(data.status === 'success') {
            alert(data.message);
        } else {
            alert("Error: " + data.message);
            btn.disabled = false;
            btn.innerText = "ğŸ”„ Force Refresh Now";
        }
    });
}

// --- POLLING FOR LOCKOUT ---
setInterval(checkCacheStatus, 2000); 

function checkCacheStatus() {
    fetch('/get_cache_status')
    .then(r => r.json())
    .then(data => {
        // SELECT ALL ACTION BUTTONS
        const btns = document.querySelectorAll('.btn-sync');
        const forceBtn = document.getElementById('btn-force');
        const importBtn = document.getElementById('btn-import-open');
        const builderBtn = document.getElementById('btn-builder-nav');
        const modalCreateBtn = document.getElementById('create-import-btn');
        const txt = document.getElementById('last-updated');
        
        if(data.running) {
            // LOCKOUT MODE
            btns.forEach(b => {
                b.disabled = true;
                b.innerText = "System Busy â³";
                b.style.opacity = "0.5";
                b.style.cursor = "not-allowed";
            });
            
            // Lock Nav Buttons
            if(importBtn) { importBtn.disabled = true; importBtn.style.opacity = "0.5"; }
            if(builderBtn) { builderBtn.disabled = true; builderBtn.style.opacity = "0.5"; }
            if(modalCreateBtn) { modalCreateBtn.disabled = true; }

            forceBtn.disabled = true;
            forceBtn.innerText = `Refreshing (${data.progress}) â³`;
        } else {
            // IDLE MODE
            btns.forEach(b => {
                if(b.disabled && b.innerText.includes("System Busy")) {
                    b.disabled = false;
                    b.innerText = "Sync Now ğŸª„"; // Or "Run Now"
                    b.style.opacity = "1";
                    b.style.cursor = "pointer";
                }
            });
            
            // Unlock Nav Buttons
            if(importBtn) { importBtn.disabled = false; importBtn.style.opacity = "1"; }
            if(builderBtn) { builderBtn.disabled = false; builderBtn.style.opacity = "1"; }
            if(modalCreateBtn) { modalCreateBtn.disabled = false; }

            if(forceBtn.innerText.includes("Refreshing")) {
                forceBtn.disabled = false;
                forceBtn.innerText = "ğŸ”„ Force Refresh Now";
                txt.innerText = "Just Now"; 
            }
        }
    });
}

// Filter Logic
function filterType(type) {
    document.getElementById('btn-movie').classList.remove('active');
    document.getElementById('btn-tv').classList.remove('active');
    document.getElementById('btn-' + type).classList.add('active');

    // 1. Filter Individual Cards
    const cards = document.querySelectorAll('.playlist-card');
    cards.forEach(card => {
        if (card.dataset.type === type) {
            card.style.display = 'flex';
        } else {
            card.style.display = 'none';
        }
    });

    // 2. Hide Empty Categories
    const grids = document.querySelectorAll('.playlist-grid');
    grids.forEach(grid => {
        let hasVisible = false;
        const children = grid.querySelectorAll('.playlist-card');
        children.forEach(c => {
            if(c.style.display !== 'none') hasVisible = true;
        });
        
        const header = grid.previousElementSibling;
        if(header && header.classList.contains('category-header')) {
            if(hasVisible) {
                header.style.display = 'flex';
                grid.style.display = 'grid';
            } else {
                header.style.display = 'none';
                grid.style.display = 'none';
            }
        }
    });
}
document.addEventListener('DOMContentLoaded', () => { filterType('movie'); });

// PREVIEW LOGIC
function previewCollection(key, title) {
    document.getElementById('preview-title').innerText = "ğŸ‘€ " + title;
    const grid = document.getElementById('preview-grid');
    grid.innerHTML = '<div style="text-align:center; grid-column:1/-1; padding:20px; color:#aaa;">Loading live data from TMDB...</div>';
    document.getElementById('preview-modal').style.display = 'block';
    
    fetch('/preview_preset_items/' + key)
    .then(r => r.json())
    .then(data => {
        if(data.status === 'success') {
            let html = '';
            data.items.forEach(item => {
                const opacity = item.owned ? '1' : '0.6';
                const status = item.owned ? 'âœ… Owned' : 'missing';
                const poster = item.poster_path ? 'https://image.tmdb.org/t/p/w200' + item.poster_path : 'https://via.placeholder.com/200x300?text=No+Poster';
                
                // Using new classes from style.css
                html += `
                <div class="preview-item" style="opacity: ${opacity};">
                    <img src="${poster}" class="preview-poster">
                    <div class="preview-title">${item.title}</div>
                    <div class="preview-meta">${item.year} â€¢ ${status}</div>
                </div>`;
            });
            grid.innerHTML = html;
        } else {
            grid.innerHTML = `<div style="color:var(--error); grid-column:1/-1; text-align:center;">Error: ${data.message}</div>`;
        }
    });
}

// DELETE CUSTOM
function deleteCustom(key) {
    if (!confirm("Delete from SeekAndWatch AND Plex?")) return;
    fetch('/delete_custom_collection/' + key, {method: 'POST'})
    .then(res => res.json()).then(data => { location.reload(); });
}

// SYNC STANDARD
function createCollection(key) {
    const btn = document.getElementById('btn-' + key);
    const originalText = btn.innerText;
    btn.disabled = true; btn.innerText = "Processing... â³"; btn.style.background = "#555";
    fetch('/create_collection/' + key, {method: 'POST'})
    .then(r => r.json()).then(d => {
        if (d.status === 'success') { btn.innerText = "Done! âœ…"; btn.style.background = "#2ecc71"; alert(d.message); }
        else { btn.innerText = "Error âŒ"; btn.style.background = "#e74c3c"; alert(d.message); }
        setTimeout(() => { btn.innerText = originalText; btn.disabled = false; btn.style.background = "#333"; }, 3000);
    });
}

// SAVE SCHEDULE
function saveSchedule(key, freq) {
    fetch('/save_schedule', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({key: key, frequency: freq})
    });
}

// --- IMPORT MODAL LOGIC ---
let matchedKeys = [];

function openImportModal() { 
    document.getElementById('import-modal').style.display = 'block'; 
    document.body.style.overflow = 'hidden';
    fetchLibraries();
}

function closeImportModal() { 
    document.getElementById('import-modal').style.display = 'none'; 
    document.body.style.overflow = 'auto';
}

function fetchLibraries() {
    fetch('/get_plex_libraries')
    .then(r => r.json())
    .then(data => {
        const select = document.getElementById('import-library');
        if(data.status === 'success') {
            let html = '';
            data.libraries.forEach(lib => {
                const icon = lib.type === 'movie' ? 'ğŸ¬' : 'ğŸ“º';
                html += `<option value="${lib.title}">${icon} ${lib.title}</option>`;
            });
            select.innerHTML = html;
        } else {
            select.innerHTML = '<option disabled>Error fetching libraries</option>';
        }
    });
}

function analyzeList() {
    const text = document.getElementById('import-text').value;
    const library = document.getElementById('import-library').value;
    const btn = document.getElementById('analyze-btn');
    
    if(!text.trim()) { alert("Paste some titles first!"); return; }
    if(!library) { alert("Select a library!"); return; }
    
    btn.innerText = "Analyzing... â³";
    btn.disabled = true;
    
    fetch('/match_bulk_titles', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({titles: text, target_library: library})
    })
    .then(res => res.json())
    .then(data => {
        btn.innerText = "ğŸ” Analyze & Match";
        btn.disabled = false;
        
        if(data.status === 'success') {
            const resDiv = document.getElementById('import-results');
            resDiv.style.display = 'block';
            let html = '<table class="result-table">';
            matchedKeys = [];
            
            data.results.forEach(r => {
                const statusClass = r.found ? 'status-found' : 'status-missing';
                const statusText = r.found ? 'âœ… Found' : 'âŒ Missing';
                if(r.found) matchedKeys.push(r.key);
                
                // Using new classes
                html += `<tr class="result-row">
                    <td class="result-cell query">${r.query}</td>
                    <td class="result-cell">${r.title}</td>
                    <td class="result-cell ${statusClass}">${statusText}</td>
                </tr>`;
            });
            html += '</table>';
            resDiv.innerHTML = html;
            
            if(matchedKeys.length > 0) {
                document.getElementById('create-import-btn').style.display = 'block';
                document.getElementById('create-import-btn').innerText = `âœ… Create Collection (${matchedKeys.length} items)`;
            }
        }
    });
}

function createImportedCollection() {
    const title = document.getElementById('import-title').value;
    const library = document.getElementById('import-library').value;
    
    if(!title) { alert("Please name your collection!"); return; }
    
    fetch('/create_bulk_collection', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({collection_title: title, rating_keys: matchedKeys, target_library: library})
    })
    .then(res => res.json())
    .then(data => {
        if(data.status === 'success') {
            alert(data.message);
            closeImportModal();
            location.reload(); 
        } else {
            alert(data.message);
        }
    });
}

// ALIAS SYNC (NEW)
function syncAliases() {
    const btn = document.getElementById('forceSyncBtn');
    const badge = document.getElementById('aliasCountBadge');
    const originalText = btn.innerText;
    
    btn.disabled = true;
    btn.innerText = "Syncing...";

    fetch('/api/sync_aliases', { method: 'POST' })
    .then(r => r.json())
    .then(data => {
        if(data.status === 'success') {
            // Update Badge Logic
            if(badge && data.count) {
                badge.innerText = data.count + " Entries";
            }
            
            btn.innerText = "Synced! âœ…";
            btn.style.color = "#2ecc71";
            btn.style.borderColor = "#2ecc71";
        } else {
            alert("Error: " + data.message);
            btn.innerText = originalText;
        }
        
        setTimeout(() => {
            btn.disabled = false;
            btn.innerText = originalText;
            btn.style.color = "#007bff";
            btn.style.borderColor = "#007bff";
        }, 3000);
    })
    .catch(err => {
        console.error(err);
        btn.innerText = "Error";
        btn.disabled = false;
    });
}
</script>

{% endblock %}