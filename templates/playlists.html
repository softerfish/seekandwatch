{% extends "base.html" %}
{% block page_title %}Plex Collections{% endblock %}
{% block content %}

    <div class="playlist-header">
        <h2>âœ¨ Plex Collections</h2>
        <div class="tab-header">
            <button class="tab-btn active" onclick="openTab(event, 'tab-manager')">âš¡ Auto-Manager</button>
            <button class="tab-btn" onclick="openTab(event, 'tab-viewer'); loadLiveCollections();">ğŸ“‚ Library Browser</button>
        </div>
    </div>
    <div id="tab-manager" class="tab-content active playlists-center">
        <p class="media-sub">Curated lists, imported text, and custom builders.</p>

        <div class="setup-notice setup-notice--center" data-notice-key="sync-engine">
            <div class="setup-notice__header">
                <strong>âš ï¸ Important Setup Requirement</strong>
                <button type="button" class="setup-notice__toggle" aria-expanded="true">Minimize</button>
            </div>
            <div class="setup-notice__body">
                To ensure accurate collections and remove duplicates, you <b>must</b> enable
                <b>Sync Engine</b> & <b>Background Alias Discovery</b> in
                <a href="{{ url_for('settings') }}">Settings</a>
                and allow them to complete a full cycle.
            </div>
        </div>

    <div class="stats-bar">
        <span title="Your custom created lists">ğŸ› ï¸ <b>{{ custom_presets|length }}</b> Custom</span>
        <span class="stats-label">|</span>
        <span title="Available built-in presets">ğŸ“š <b>{{ presets|length }}</b> Presets</span>
        <span id="schedule-save-feedback" style="display:none; margin-left:12px; color: var(--success, #2ecc71); font-size: 0.9em;"></span>
    </div>

    <div class="action-bar">
        <a href="{{ url_for('builder') }}">
            <button class="btn-builder" id="btn-builder-nav">ğŸ› ï¸ Custom Builder</button>
        </a>
        <button onclick="openImportModal()" class="btn-import" id="btn-import-open">ğŸ“‹ Import List</button>
    </div>

        <div class="type-toggle-group">
        <button onclick="filterType('movie')" id="btn-movie" class="type-toggle-btn active">Movies ğŸ¬</button>
        <button onclick="filterType('tv')" id="btn-tv" class="type-toggle-btn">TV Shows ğŸ“º</button>
        </div>

        <div class="schedule-time-compact">
            <span class="schedule-label">Global Schedule Time:</span>
            <input type="time" id="globalTime" class="form-control schedule-time-input" value="{{ schedule_time }}">
            <button class="btn btn-primary schedule-save-btn" onclick="saveGlobalTime()">Save</button>
            <span id="save-time-feedback" class="save-feedback" style="display:none;">Saved</span>
        </div>
    </div>
    <div id="tab-viewer" class="tab-content">
        <div style="text-align:center; color:#aaa; margin-bottom: 30px;">
            <p>A live view of all collections currently existing on your Plex server.</p>
        </div>

        <div id="viewer-loading" style="text-align:center; padding:50px;">
            <div class="spinner"></div>
            <h3 style="color:#ccc;">Fetching from Plex...</h3>
        </div>

        <div id="viewer-grid" class="playlist-grid" style="display:none; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));">
        </div>
    </div>
<div id="preview-modal" class="import-modal" onclick="if(event.target===this) closePreviewModal()">
    <div class="import-content wide">
        <span onclick="closePreviewModal()" class="close-btn">&times;</span>
        <h2 id="preview-title" style="margin-top:0;">ğŸ‘€ Collection Preview</h2>
        <div id="preview-grid" class="preview-grid"></div>
    </div>
</div>

<div id="import-modal" class="import-modal">
    <div class="import-content">
        <span onclick="closeImportModal()" class="close-btn">&times;</span>
        <h2 style="margin-top:0;">ğŸ“‹ Import from List</h2>
        
        <details class="help-box">
            <summary>â“ How does this work?</summary>
            <ol>
                <li><b>Copy & Paste:</b> Grab a list from Letterboxd, IMDb, or Reddit. We handle newlines, commas, or pipes `|`.</li>
                <li><b>Smart Matching:</b> "The Matrix (1999)" and "The Matrix" both work.</li>
                <li><b>One-Time Import:</b> These collections are static and cannot be auto-updated.</li>
            </ol>
        </details>
        
        <textarea id="import-text" rows="10" placeholder="The Matrix&#10;Inception, Interstellar&#10;The Dark Knight (2008)" class="import-textarea"></textarea>
        
        <div class="import-input-row">
            <input type="text" id="import-title" placeholder="Collection Name">
            <select id="import-library" class="import-select">
                <option value="" disabled selected>Loading Libraries...</option>
            </select>
        </div>
        
        <button onclick="analyzeList()" id="analyze-btn" class="btn-analyze">ğŸ” Analyze & Match</button>
        
        <div id="import-results" class="import-results-container"></div>
        
        <button onclick="createImportedCollection()" id="create-import-btn" class="btn-create-import">âœ… Create Collection</button>
    </div>
</div>

<script>
function saveGlobalTime() {
    const t = document.getElementById('globalTime').value;
    const feedback = document.getElementById('save-time-feedback');
    fetch('/save_schedule_time', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': '{{ csrf_token() }}'},
        body: 'time=' + encodeURIComponent(t)
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            if (feedback) { feedback.style.display = 'inline'; feedback.textContent = 'Saved'; setTimeout(() => { feedback.style.display = 'none'; }, 2500); }
        } else {
            alert(data.message || 'Could not save time');
        }
    })
    .catch(() => alert('Could not save schedule time'));
}
</script>

{% if custom_presets %}
<div class="category-header playlist-section" data-type="any">
    <span>ğŸ› ï¸</span> Your Custom Collections
</div>
<div class="playlist-grid">
    {% for key, playlist in custom_presets.items() %}
    <div class="card playlist-card" data-type="{{ playlist.media_type }}">
        <div>
            <div class="playlist-header-row">
                <div class="playlist-icon">{% if 'Imported' in playlist.description %}ğŸ“‹{% else %}ğŸ› ï¸{% endif %}</div>
                <button onclick="deleteCustom('{{ key }}')" class="btn-delete">Delete ğŸ—‘ï¸</button>
            </div>
            <h3 class="playlist-title">{{ playlist.title }}</h3>
            <p class="playlist-desc">{{ playlist.description }}</p>
        </div>
        
        <div class="playlist-controls">
            {% if 'Imported' not in playlist.description %}
            
            <div class="control-row">
                <label>Auto-Update:</label>
                <select id="freq-{{ key }}" onchange="saveSettings('{{ key }}')" class="control-select">
                    <option value="manual" {% if schedules.get(key) == 'manual' %}selected{% endif %}>Off</option>
                    <option value="daily" {% if schedules.get(key) == 'daily' %}selected{% endif %}>Daily</option>
                    <option value="weekly" {% if schedules.get(key) == 'weekly' %}selected{% endif %}>Weekly</option>
                </select>
            </div>

            <div class="control-row">
                <label style="display:flex; align-items:center;">
                    Sync Mode:
                    <div class="tooltip-container">
                        <span class="info-icon">â„¹ï¸</span>
                        <div class="tooltip-text">
                            <strong>Sync (Strict):</strong> Adds new items AND removes old ones.<br><br>
                            <strong>Append:</strong> Only adds new items. Never removes. Best for growing lists.
                        </div>
                    </div>
                </label>
                {% set sm = (sync_modes or {}).get(key, 'append') %}
                <select id="sync-{{ key }}" onchange="saveSettings('{{ key }}')" class="control-select">
                    <option value="append" {% if sm == 'append' %}selected{% endif %}>Append (Grow)</option>
                    <option value="sync" {% if sm == 'sync' %}selected{% endif %}>Sync (Strict)</option>
                </select>
            </div>

            <div class="sync-row" style="margin-top: 10px;">
                <button onclick="previewCollection('{{ key }}', '{{ playlist.title|replace("'", "\\'") }}')" class="btn-preview" title="Preview Contents">ğŸ‘€</button>
                <button onclick="createCollection('{{ key }}')" id="btn-{{ key }}" class="btn-sync">Sync Now ğŸª„</button>
            </div>
            
            {% else %}
            <div class="static-badge">Static Import</div>
            <button disabled class="btn-synced-disabled">Synced âœ…</button>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

{% set categories = ['Regional Trending', 'International & World', 'Decades', 'Themes & Vibes', 'Awards & Acclaim', 'Studios & Networks', 'Genre (Movies)', 'Genre (TV)', 'Content Ratings'] %}

{% for cat in categories %}
<div class="category-header playlist-section" data-cat="{{ cat }}">
    <span>ğŸ“‚</span> {{ cat }}
</div>
<div class="playlist-grid">
    {% for key, playlist in presets.items() %}
    {% if playlist.category == cat %}
    <div class="card playlist-card" data-type="{{ playlist.media_type }}">
        <div>
            <div class="playlist-icon">{{ playlist.icon }}</div>
            <h3 class="playlist-title">{{ playlist.title }}</h3>
            <p class="playlist-desc">{{ playlist.description }}</p>
        </div>
        
        <div class="playlist-controls">
            <div class="control-row">
                <label>Auto-Update:</label>
                <select id="freq-{{ key }}" onchange="saveSettings('{{ key }}')" class="control-select">
                    <option value="manual" {% if schedules.get(key) == 'manual' %}selected{% endif %}>Off</option>
                    <option value="daily" {% if schedules.get(key) == 'daily' %}selected{% endif %}>Daily</option>
                    <option value="weekly" {% if schedules.get(key) == 'weekly' %}selected{% endif %}>Weekly</option>
                </select>
            </div>

            <div class="control-row">
                <label style="display:flex; align-items:center;">
                    Sync Mode:
                    {% if 'Trending' not in playlist.title %}
                    <div class="tooltip-container">
                        <span class="info-icon">â„¹ï¸</span>
                        <div class="tooltip-text">
                            <strong>Sync (Strict):</strong> Adds new items AND removes items not on the list.<br><br>
                            <strong>Append:</strong> Only adds. Never removes.
                        </div>
                    </div>
                    {% endif %}
                </label>

                {% if 'Trending' in playlist.title or 'Trending' in playlist.category %}
                    <div class="locked-badge">
                        ğŸ”’ Strict Sync
                        <input type="hidden" id="sync-{{ key }}" value="sync">
                    </div>
                {% else %}
                    {% set sm = (sync_modes or {}).get(key, 'append') %}
                    <select id="sync-{{ key }}" onchange="saveSettings('{{ key }}')" class="control-select">
                        <option value="append" {% if sm == 'append' %}selected{% endif %}>Append (Grow)</option>
                        <option value="sync" {% if sm == 'sync' %}selected{% endif %}>Sync (Strict)</option>
                    </select>
                {% endif %}
            </div>

            <div class="sync-row" style="margin-top: 10px;">
                <button onclick="previewCollection('{{ key }}', '{{ playlist.title|replace("'", "\\'") }}')" class="btn-preview" title="Preview Contents">ğŸ‘€</button>
                <button onclick="createCollection('{{ key }}')" id="btn-{{ key }}" class="btn-sync">Run Now ğŸª„</button>
            </div>
        </div>
    </div>
    {% endif %}
    {% endfor %}
</div>
{% endfor %}

<script>
function openTab(evt, tabName) {
        // Hide every tab panel first.
        var tabcontent = document.getElementsByClassName("tab-content");
        for (var i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
            tabcontent[i].classList.remove("active");
        }
        
        // Clear active state on tabs.
        var tablinks = document.getElementsByClassName("tab-btn");
        for (var i = 0; i < tablinks.length; i++) {
            tablinks[i].classList.remove("active");
        }
        
        // Show selected tab and mark it active.
        document.getElementById(tabName).style.display = "block";
        // Small delay so the transition has a frame to kick in.
        setTimeout(() => document.getElementById(tabName).classList.add("active"), 10);
        evt.currentTarget.classList.add("active");
    }

    // Live collections viewer
    let viewerLoaded = false;
    function loadLiveCollections() {
        if(viewerLoaded) return; // Avoid repeat API calls.
        
        fetch('/get_plex_collections')
        .then(r => r.json())
        .then(data => {
            document.getElementById('viewer-loading').style.display = 'none';
            const grid = document.getElementById('viewer-grid');
            grid.style.display = 'grid';
            
            if(data.status === 'success' && data.collections.length > 0) {
                let html = '';
                data.collections.forEach(c => {
                    const thumb = c.thumb || 'https://via.placeholder.com/200x300?text=No+Art';
                    html += `
                    <div class="viewer-card" onclick="window.open('${c.url}', '_blank')">
                        <img src="${thumb}" style="width:100%; height:100%; object-fit:cover;">
                        <div class="viewer-badge">${c.count}</div>
                        <div class="viewer-info">
                            <div style="font-weight:bold; color:white; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${c.title}</div>
                            <div style="font-size:0.8em; color:#ccc;">${c.library}</div>
                        </div>
                    </div>`;
                });
                grid.innerHTML = html;
                viewerLoaded = true;
            } else {
                grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:50px; color:#666;">No collections found.</div>';
            }
        });
    }
// Check cache lockout so we don't fire while busy.
setInterval(checkCacheStatus, 2000); 

function checkCacheStatus() {
    fetch('/get_cache_status').then(r => r.json()).then(data => {
        const btns = document.querySelectorAll('.btn-sync');
        const importBtn = document.getElementById('btn-import-open');
        const builderBtn = document.getElementById('btn-builder-nav');
        
        if(data.running) {
            btns.forEach(b => {
                b.disabled = true; b.innerText = "System Busy â³"; 
                b.style.opacity = "0.5"; b.style.cursor = "not-allowed";
            });
            if(importBtn) { importBtn.disabled = true; importBtn.style.opacity = "0.5"; }
            if(builderBtn) { builderBtn.disabled = true; builderBtn.style.opacity = "0.5"; }
        } else {
            btns.forEach(b => {
                if(b.disabled && b.innerText.includes("System Busy")) {
                    b.disabled = false;
                    b.style.opacity = "1";
                    b.style.cursor = "pointer";
                    b.innerText = (b.id && b.id.startsWith("btn-custom")) ? "Sync Now ğŸª„" : "Run Now ğŸª„";
                }
            });
            if(importBtn) { importBtn.disabled = false; importBtn.style.opacity = "1"; }
            if(builderBtn) { builderBtn.disabled = false; builderBtn.style.opacity = "1"; }
        }
    });
}

// Filter cards by media type.
function filterType(type) {
    document.getElementById('btn-movie').classList.remove('active');
    document.getElementById('btn-tv').classList.remove('active');
    document.getElementById('btn-' + type).classList.add('active');
    const cards = document.querySelectorAll('.playlist-card');
    cards.forEach(card => {
        card.style.display = (card.dataset.type === type) ? 'flex' : 'none';
    });
    const grids = document.querySelectorAll('.playlist-grid');
    grids.forEach(grid => {
        let hasVisible = false;
        const children = grid.querySelectorAll('.playlist-card');
        children.forEach(c => { if(c.style.display !== 'none') hasVisible = true; });
        const header = grid.previousElementSibling;
        if(header && header.classList.contains('category-header')) {
            header.style.display = hasVisible ? 'flex' : 'none';
            grid.style.display = hasVisible ? 'grid' : 'none';
        }
    });
}
document.addEventListener('DOMContentLoaded', () => { filterType('movie'); });

// Preview modal
function previewCollection(key, title) {
    document.getElementById('preview-title').innerText = "ğŸ‘€ " + title;
    const grid = document.getElementById('preview-grid');
    grid.innerHTML = '<div style="text-align:center; grid-column:1/-1; padding:20px; color:#aaa;">Loading live data from TMDB...</div>';
    document.getElementById('preview-modal').style.display = 'block';
    document.body.style.overflow = 'hidden';
    
    fetch('/preview_preset_items/' + encodeURIComponent(key))
    .then(r => r.json())
    .then(data => {
        if(data.status === 'success') {
            let html = '';
            data.items.forEach(item => {
                const opacity = item.owned ? '1' : '0.6';
                const status = item.owned ? 'âœ… Owned' : 'missing';
                const poster = item.poster_path ? 'https://image.tmdb.org/t/p/w200' + item.poster_path : 'https://via.placeholder.com/200x300?text=No+Poster';
                html += `<div class="preview-item" style="opacity: ${opacity};">
                    <img src="${poster}" class="preview-poster">
                    <div class="preview-title">${item.title}</div>
                    <div class="preview-meta">${item.year} â€¢ ${status}</div>
                </div>`;
            });
            grid.innerHTML = html;
        } else {
            grid.innerHTML = `<div style="color:var(--error); grid-column:1/-1; text-align:center;">Error: ${(data.message || 'Unknown error').replace(/</g, '&lt;')}</div>`;
        }
    });
}

function closePreviewModal() {
    const modal = document.getElementById('preview-modal');
    if (modal) { modal.style.display = 'none'; document.body.style.overflow = ''; }
}

// Delete a custom preset (from SeekAndWatch and Plex).
function deleteCustom(key) {
    if (!confirm("Delete this collection from SeekAndWatch AND Plex?")) return;
    fetch('/delete_custom_collection/' + encodeURIComponent(key), { method: 'POST' })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'success') {
            alert(data.message || 'Collection deleted.');
            location.reload();
        } else {
            alert(data.message || 'Could not delete collection.');
        }
    })
    .catch(() => alert('Could not delete collection.'));
}

// Run a preset now.
function createCollection(key) {
    const btn = document.getElementById('btn-' + key);
    if (!btn) return;
    const originalText = btn.innerText;
    btn.disabled = true; btn.innerText = "Processing... â³"; btn.style.background = "#555";
    fetch('/create_collection/' + encodeURIComponent(key), {method: 'POST'})
    .then(r => r.json()).then(d => {
        if (d.status === 'success') { btn.innerText = "Done! âœ…"; btn.style.background = "#2ecc71"; alert(d.message); }
        else { btn.innerText = "Error âŒ"; btn.style.background = "#e74c3c"; alert(d.message); }
        setTimeout(() => { btn.innerText = originalText; btn.disabled = false; btn.style.background = "#333"; }, 3000);
    });
}

// Save schedule settings (frequency + sync mode).
function saveSettings(key) {
    const freqEl = document.getElementById('freq-' + key);
    const syncEl = document.getElementById('sync-' + key);
    
    const freq = freqEl ? freqEl.value : 'manual';
    const sync = (syncEl && syncEl.value) ? syncEl.value : 'sync';

    fetch('/schedule_collection', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': '{{ csrf_token() }}'},
        body: `preset_key=${encodeURIComponent(key)}&frequency=${encodeURIComponent(freq)}&sync_mode=${encodeURIComponent(sync)}`
    })
    .then(r => r.json())
    .then(data => {
        const fb = document.getElementById('schedule-save-feedback');
        if (data.status === 'success' && fb) {
            fb.textContent = 'Settings saved';
            fb.style.display = 'inline';
            setTimeout(() => { fb.style.display = 'none'; }, 2500);
        } else if (data.message) {
            alert(data.message);
        }
    })
    .catch(() => alert('Could not save settings'));
}

// Import modal
let matchedKeys = [];
function openImportModal() { document.getElementById('import-modal').style.display = 'block'; document.body.style.overflow = 'hidden'; fetchLibraries(); }
function closeImportModal() { document.getElementById('import-modal').style.display = 'none'; document.body.style.overflow = 'auto'; }

function fetchLibraries() {
    fetch('/get_plex_libraries').then(r => r.json()).then(data => {
        const select = document.getElementById('import-library');
        if(data.status === 'success') {
            let html = '';
            data.libraries.forEach(lib => {
                const icon = lib.type === 'movie' ? 'ğŸ¬' : 'ğŸ“º';
                html += `<option value="${lib.title}">${icon} ${lib.title}</option>`;
            });
            select.innerHTML = html;
        } else { select.innerHTML = '<option disabled>Error fetching libraries</option>'; }
    });
}

function analyzeList() {
    const text = document.getElementById('import-text').value;
    const library = document.getElementById('import-library').value;
    const btn = document.getElementById('analyze-btn');
    if(!text.trim()) { alert("Paste some titles first!"); return; }
    if(!library) { alert("Select a library!"); return; }
    
    btn.innerText = "Analyzing... â³"; btn.disabled = true;
    
    fetch('/match_bulk_titles', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({titles: text, target_library: library})
    }).then(res => res.json()).then(data => {
        btn.innerText = "ğŸ” Analyze & Match"; btn.disabled = false;
        if(data.status === 'success') {
            const resDiv = document.getElementById('import-results');
            resDiv.style.display = 'block';
            let html = '<table class="result-table">';
            matchedKeys = [];
            data.results.forEach(r => {
                const statusClass = r.found ? 'status-found' : 'status-missing';
                const statusText = r.found ? 'âœ… Found' : 'âŒ Missing';
                if(r.found) matchedKeys.push(r.key);
                html += `<tr class="result-row"><td class="result-cell query">${r.query}</td><td class="result-cell">${r.title}</td><td class="result-cell ${statusClass}">${statusText}</td></tr>`;
            });
            html += '</table>';
            resDiv.innerHTML = html;
            if(matchedKeys.length > 0) {
                document.getElementById('create-import-btn').style.display = 'block';
                document.getElementById('create-import-btn').innerText = `âœ… Create Collection (${matchedKeys.length} items)`;
            }
        }
    });
}

function createImportedCollection() {
    const title = document.getElementById('import-title').value;
    const library = document.getElementById('import-library').value;
    if(!title) { alert("Please name your collection!"); return; }
    
    fetch('/create_bulk_collection', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({collection_title: title, rating_keys: matchedKeys, target_library: library})
    }).then(res => res.json()).then(data => {
        if(data.status === 'success') { alert(data.message); closeImportModal(); location.reload(); } 
        else { alert(data.message); }
    });
}

document.addEventListener('keydown', function(e) {
    if (e.key !== 'Escape') return;
    const preview = document.getElementById('preview-modal');
    const importModal = document.getElementById('import-modal');
    if (preview && preview.style.display === 'block') closePreviewModal();
    else if (importModal && importModal.style.display === 'block') closeImportModal();
});
</script>
{% endblock %}