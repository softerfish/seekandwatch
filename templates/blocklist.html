{% extends "base.html" %}
{% block content %}
<h2>Manage Blocklist</h2>
<p>Preemptively block titles or manage existing bans.</p>

<div style="margin-bottom: 20px;">
    <button onclick="showTab('movie')" class="tab-btn active" id="btn-movie">Movies</button>
    <button onclick="showTab('tv')" class="tab-btn" id="btn-tv">TV Shows</button>
</div>

<div class="card" style="background: #2a2a2a;">
    <h3>âž• Add to Blocklist</h3>
    <div style="position: relative;">
        <input type="text" id="searchInput" placeholder="Start typing a title..." 
               style="width: 100%; padding: 12px; font-size: 1.1em; background: #333; color: white; border: 1px solid #555;">
        <div id="suggestions" style="position: absolute; width: 100%; background: #333; z-index: 100; border: 1px solid #555; display: none;"></div>
    </div>
</div>

<div id="list-movie" class="block-list-container">
    <h3>ðŸš« Blocked Movies</h3>
    <div class="grid">
        {% for block in blocks if block.media_type == 'movie' %}
            {% include 'block_item_partial.html' %}
        {% else %}
            <p style="color: #777;">No movies blocked.</p>
        {% endfor %}
    </div>
</div>

<div id="list-tv" class="block-list-container" style="display: none;">
    <h3>ðŸš« Blocked TV Shows</h3>
    <div class="grid">
        {% for block in blocks if block.media_type == 'tv' %}
            {% include 'block_item_partial.html' %}
        {% else %}
            <p style="color: #777;">No TV shows blocked.</p>
        {% endfor %}
    </div>
</div>

<script>
let currentTab = 'movie';
let typingTimer;

function showTab(type) {
    currentTab = type;
    document.getElementById('list-movie').style.display = (type === 'movie') ? 'block' : 'none';
    document.getElementById('list-tv').style.display = (type === 'tv') ? 'block' : 'none';
    document.getElementById('btn-movie').className = (type === 'movie') ? 'tab-btn active' : 'tab-btn';
    document.getElementById('btn-tv').className = (type === 'tv') ? 'tab-btn active' : 'tab-btn';
    document.getElementById('searchInput').value = '';
    document.getElementById('suggestions').style.display = 'none';
}

const searchInput = document.getElementById('searchInput');
searchInput.addEventListener('keyup', () => {
    clearTimeout(typingTimer);
    if(searchInput.value.length < 3) { document.getElementById('suggestions').style.display = 'none'; return; }
    typingTimer = setTimeout(() => {
        fetch(`/tmdb_search_proxy?query=${searchInput.value}&type=${currentTab}`)
            .then(res => res.json()).then(data => showSuggestions(data.results));
    }, 500);
});

function showSuggestions(results) {
    const box = document.getElementById('suggestions');
    box.innerHTML = '';
    if(results.length === 0) { box.style.display = 'none'; return; }
    results.forEach(item => {
        const div = document.createElement('div');
        div.style.padding = '10px'; div.style.borderBottom = '1px solid #444'; div.style.cursor = 'pointer';
        div.style.display = 'flex'; div.style.alignItems = 'center'; div.style.gap = '10px';
        div.onmouseover = () => div.style.background = '#444';
        div.onmouseout = () => div.style.background = 'transparent';
        const img = item.poster ? `<img src="https://image.tmdb.org/t/p/w92${item.poster}" width="30">` : '';
        div.innerHTML = `${img} <span>${item.title} (${item.year})</span>`;
        div.onclick = () => addBlock(item.title);
        box.appendChild(div);
    });
    box.style.display = 'block';
}

function addBlock(title) {
    fetch('/block_movie', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ title: title, media_type: currentTab })
    }).then(res => { if(res.ok) location.reload(); });
}

function unblock(id) {
    if(!confirm("Unblock this title?")) return;
    fetch('/unblock_movie', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ id: id })
    }).then(res => { if(res.ok) document.getElementById(`block-${id}`).remove(); });
}
</script>

<style>
    .tab-btn { padding: 10px 20px; background: #444; color: #aaa; border: none; cursor: pointer; font-size: 1.1em; }
    .tab-btn.active { background: #e5a00d; color: black; font-weight: bold; }
</style>
{% endblock %}